"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Validator = void 0;
const spec = require("@jsii/spec");
const Case = require("case");
// eslint-disable-next-line @typescript-eslint/no-require-imports
const deepEqual = require("deep-equal");
const ts = require("typescript");
const jsii_diagnostic_1 = require("./jsii-diagnostic");
const node_bindings_1 = require("./node-bindings");
const bindings = require("./node-bindings");
class Validator {
    constructor(projectInfo, assembly) {
        this.projectInfo = projectInfo;
        this.assembly = assembly;
        this._diagnostics = new Array();
    }
    async emit() {
        this._diagnostics = [];
        for (const validation of Validator.VALIDATIONS) {
            validation(this, this.assembly, (diag) => this._diagnostics.push(diag));
        }
        try {
            return await Promise.resolve({
                diagnostics: this._diagnostics,
                emitSkipped: this._diagnostics.some((diag) => diag.category === ts.DiagnosticCategory.Error),
            });
        }
        finally {
            // Clearing ``this._diagnostics`` to allow contents to be garbage-collected.
            delete this._diagnostics;
        }
    }
}
exports.Validator = Validator;
Validator.VALIDATIONS = _defaultValidations();
function _defaultValidations() {
    return [
        _typeNamesMustUsePascalCase,
        _enumMembersMustUserUpperSnakeCase,
        _memberNamesMustUseCamelCase,
        _staticConstantNamesMustUseUpperSnakeCase,
        _memberNamesMustNotLookLikeJavaGettersOrSetters,
        _allTypeReferencesAreValid,
        _inehritanceDoesNotChangeContracts,
        _staticMembersAndNestedTypesMustNotSharePascalCaseName,
    ];
    function _typeNamesMustUsePascalCase(_, assembly, diagnostic) {
        for (const type of _allTypes(assembly)) {
            if (type.name !== Case.pascal(type.name)) {
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_8000_PASCAL_CASED_TYPE_NAMES.createDetached(type.name));
            }
        }
    }
    function _enumMembersMustUserUpperSnakeCase(_, assembly, diagnostic) {
        for (const type of _allTypes(assembly)) {
            if (!spec.isEnumType(type)) {
                continue;
            }
            for (const member of type.members) {
                if (member.name && !isConstantCase(member.name)) {
                    diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_8001_ALL_CAPS_ENUM_MEMBERS.createDetached(member.name, type.fqn));
                }
            }
        }
    }
    function _memberNamesMustUseCamelCase(_, assembly, diagnostic) {
        for (const { member, type } of _allMembers(assembly)) {
            if (member.static && member.const) {
                continue;
            }
            if (member.name && member.name !== Case.camel(member.name)) {
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_8002_CAMEL_CASED_MEMBERS.createDetached(member.name, type.fqn));
            }
        }
    }
    function _staticConstantNamesMustUseUpperSnakeCase(_, assembly, diagnostic) {
        for (const { member, type } of _allMembers(assembly)) {
            if (!member.static || !member.const) {
                continue;
            }
            if (member.name &&
                !isConstantCase(member.name) &&
                member.name !== Case.pascal(member.name) &&
                member.name !== Case.camel(member.name)) {
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_8003_STATIC_CONST_CASING.createDetached(member.name, type.name));
            }
        }
    }
    function _memberNamesMustNotLookLikeJavaGettersOrSetters(_, assembly, diagnostic) {
        var _a;
        for (const { member, type } of _allMembers(assembly)) {
            if (!member.name) {
                continue;
            }
            const snakeName = Case.snake(member.name);
            if (snakeName.startsWith('get_') &&
                _isEmpty(member.parameters)) {
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_5000_JAVA_GETTERS.createDetached(member.name, type.name));
            }
            else if (snakeName.startsWith('set_') &&
                ((_a = member.parameters) !== null && _a !== void 0 ? _a : []).length === 1) {
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_5001_JAVA_SETTERS.createDetached(member.name, type.name));
            }
        }
    }
    function _allTypeReferencesAreValid(validator, assembly, diagnostic) {
        var _a, _b;
        for (const typeRef of _allTypeReferences(assembly)) {
            const [assm] = typeRef.fqn.split('.');
            if (assembly.name === assm) {
                if (!(typeRef.fqn in ((_a = assembly.types) !== null && _a !== void 0 ? _a : {}))) {
                    diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_3000_EXPORTED_API_USES_HIDDEN_TYPE.create(typeRef.node, // Pretend there is always a value
                    typeRef.fqn));
                }
                continue;
            }
            const foreignAssm = validator.projectInfo.dependencyClosure.find((dep) => dep.name === assm);
            if (!foreignAssm) {
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_9000_UNKNOWN_MODULE.createDetached(assm));
                continue;
            }
            if (!(typeRef.fqn in ((_b = foreignAssm.types) !== null && _b !== void 0 ? _b : {}))) {
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_9001_TYPE_NOT_FOUND.createDetached(typeRef));
            }
        }
    }
    function _inehritanceDoesNotChangeContracts(validator, assembly, diagnostic) {
        var _a, _b, _c, _d, _e, _f;
        for (const type of _allTypes(assembly)) {
            if (spec.isClassType(type)) {
                for (const method of (_a = type.methods) !== null && _a !== void 0 ? _a : []) {
                    _validateMethodOverride(method, type);
                }
                for (const property of (_b = type.properties) !== null && _b !== void 0 ? _b : []) {
                    _validatePropertyOverride(property, type);
                }
            }
            if (spec.isClassOrInterfaceType(type) &&
                ((_d = (_c = type.interfaces) === null || _c === void 0 ? void 0 : _c.length) !== null && _d !== void 0 ? _d : 0) > 0) {
                for (const method of (_e = type.methods) !== null && _e !== void 0 ? _e : []) {
                    // Overrides "win" over implementations
                    if (method.overrides) {
                        continue;
                    }
                    _validateMethodImplementation(method, type);
                }
                for (const property of (_f = type.properties) !== null && _f !== void 0 ? _f : []) {
                    _validatePropertyImplementation(property, type);
                }
            }
        }
        function _validateMethodOverride(method, type) {
            var _a;
            if (!type.base) {
                return false;
            }
            const baseType = _dereference(type.base, assembly, validator);
            if (!baseType) {
                return false;
            }
            const overridden = ((_a = baseType.methods) !== null && _a !== void 0 ? _a : []).find((m) => m.name === method.name);
            if (!overridden) {
                return _validateMethodOverride(method, baseType);
            }
            _assertSignaturesMatch(overridden, method, `${type.fqn}#${method.name}`, `overriding ${baseType.fqn}`);
            method.overrides = baseType.fqn;
            return true;
        }
        function _validatePropertyOverride(property, type) {
            var _a;
            if (!type.base) {
                return false;
            }
            const baseType = _dereference(type.base, assembly, validator);
            if (!baseType) {
                return false;
            }
            const overridden = ((_a = baseType.properties) !== null && _a !== void 0 ? _a : []).find((p) => p.name === property.name);
            if (!overridden) {
                return _validatePropertyOverride(property, baseType);
            }
            _assertPropertiesMatch(overridden, property, `${type.fqn}#${property.name}`, `overriding ${baseType.fqn}`);
            property.overrides = baseType.fqn;
            return true;
        }
        function _validateMethodImplementation(method, type) {
            var _a;
            if (!type.interfaces) {
                // Abstract classes may not directly implement all members, need to check their supertypes...
                if (spec.isClassType(type) && type.base && type.abstract) {
                    return _validateMethodImplementation(method, _dereference(type.base, assembly, validator));
                }
                return false;
            }
            for (const iface of type.interfaces) {
                const ifaceType = _dereference(iface, assembly, validator);
                const implemented = ((_a = ifaceType.methods) !== null && _a !== void 0 ? _a : []).find((m) => m.name === method.name);
                if (implemented) {
                    _assertSignaturesMatch(implemented, method, `${type.fqn}#${method.name}`, `implementing ${ifaceType.fqn}`);
                    method.overrides = iface;
                    return true;
                }
                if (_validateMethodImplementation(method, ifaceType)) {
                    return true;
                }
            }
            return false;
        }
        function _validatePropertyImplementation(property, type) {
            var _a;
            if (!type.interfaces) {
                // Abstract classes may not directly implement all members, need to check their supertypes...
                if (spec.isClassType(type) && type.base && type.abstract) {
                    return _validatePropertyImplementation(property, _dereference(type.base, assembly, validator));
                }
                return false;
            }
            for (const iface of type.interfaces) {
                const ifaceType = _dereference(iface, assembly, validator);
                const implemented = ((_a = ifaceType.properties) !== null && _a !== void 0 ? _a : []).find((p) => p.name === property.name);
                if (implemented) {
                    _assertPropertiesMatch(implemented, property, `${type.fqn}#${property.name}`, `implementing ${ifaceType.fqn}`);
                    property.overrides = ifaceType.fqn;
                    return true;
                }
                if (_validatePropertyImplementation(property, ifaceType)) {
                    return true;
                }
            }
            return false;
        }
        function _assertSignaturesMatch(expected, actual, label, action) {
            var _a, _b, _c, _d;
            if (!!expected.protected !== !!actual.protected) {
                const expVisibility = expected.protected ? 'protected' : 'public';
                const actVisibility = actual.protected ? 'protected' : 'public';
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_5002_OVERRIDE_CHANGES_VISIBILITY.createDetached(label, action, actVisibility, expVisibility));
            }
            if (!deepEqual(actual.returns, expected.returns)) {
                const expType = spec.describeTypeReference((_a = expected.returns) === null || _a === void 0 ? void 0 : _a.type);
                const actType = spec.describeTypeReference((_b = actual.returns) === null || _b === void 0 ? void 0 : _b.type);
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_5003_OVERRIDE_CHANGES_RETURN_TYPE.createDetached(label, action, actType, expType));
            }
            const expectedParams = (_c = expected.parameters) !== null && _c !== void 0 ? _c : [];
            const actualParams = (_d = actual.parameters) !== null && _d !== void 0 ? _d : [];
            if (expectedParams.length !== actualParams.length) {
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_5005_OVERRIDE_CHANGES_PARAM_COUNT.createDetached(label, action, actualParams.length, expectedParams.length));
                return;
            }
            for (let i = 0; i < expectedParams.length; i++) {
                const expParam = expectedParams[i];
                const actParam = actualParams[i];
                if (!deepEqual(expParam.type, actParam.type)) {
                    diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_5006_OVERRIDE_CHANGES_PARAM_TYPE.createDetached(label, action, actParam, expParam));
                }
                // Not-ing those to force the values to a strictly boolean context (they're optional, undefined means false)
                if (expParam.variadic !== actParam.variadic) {
                    diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_5007_OVERRIDE_CHANGES_VARIADIC.createDetached(label, action, actParam.variadic, expParam.variadic));
                }
                if (expParam.optional !== actParam.optional) {
                    diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_5008_OVERRIDE_CHANGES_PARAM_OPTIONAL.createDetached(label, action, actParam, expParam));
                }
            }
        }
        function _assertPropertiesMatch(expected, actual, label, action) {
            if (!!expected.protected !== !!actual.protected) {
                const expVisibility = expected.protected ? 'protected' : 'public';
                const actVisibility = actual.protected ? 'protected' : 'public';
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_5002_OVERRIDE_CHANGES_VISIBILITY.createDetached(label, action, actVisibility, expVisibility));
            }
            if (!deepEqual(expected.type, actual.type)) {
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_5004_OVERRIDE_CHANGES_PROP_TYPE.createDetached(label, action, actual.type, expected.type));
            }
            if (expected.immutable !== actual.immutable) {
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_5010_OVERRIDE_CHANGES_MUTABILITY.createDetached(label, action, actual.immutable, expected.immutable));
            }
            if (expected.optional !== actual.optional) {
                diagnostic(jsii_diagnostic_1.JsiiDiagnostic.JSII_5009_OVERRIDE_CHANGES_PROP_OPTIONAL.createDetached(label, action, actual.optional, expected.optional));
            }
        }
    }
    function _staticMembersAndNestedTypesMustNotSharePascalCaseName(_, assembly, diagnostic) {
        var _a;
        for (const nestedType of Object.values((_a = assembly.types) !== null && _a !== void 0 ? _a : {})) {
            if (nestedType.namespace == null) {
                continue;
            }
            const nestingType = assembly.types[`${assembly.name}.${nestedType.namespace}`];
            if (nestingType == null) {
                continue;
            }
            const nestedTypeName = Case.pascal(nestedType.name);
            for (const { name, member } of staticMembers(nestingType)) {
                if (name === nestedTypeName) {
                    let diag = jsii_diagnostic_1.JsiiDiagnostic.JSII_5020_STATIC_MEMBER_CONFLICTS_WITH_NESTED_TYPE.create(node_bindings_1.getRelatedNode(member), nestingType, member, nestedType);
                    const nestedTypeNode = node_bindings_1.getRelatedNode(nestedType);
                    if (nestedTypeNode != null) {
                        diag = diag.addRelatedInformation(nestedTypeNode, 'This is the conflicting nested type declaration');
                    }
                    diagnostic(diag);
                }
            }
        }
        function staticMembers(type) {
            var _a, _b, _c, _d;
            if (spec.isClassOrInterfaceType(type)) {
                return [
                    ...((_b = (_a = type.methods) === null || _a === void 0 ? void 0 : _a.filter((method) => method.static)) !== null && _b !== void 0 ? _b : []),
                    ...((_d = (_c = type.properties) === null || _c === void 0 ? void 0 : _c.filter((prop) => prop.static)) !== null && _d !== void 0 ? _d : []),
                ].map((member) => ({ name: Case.pascal(member.name), member }));
            }
            return type.members.map((member) => ({ name: member.name, member }));
        }
    }
}
function _allTypes(assm) {
    var _a;
    return Object.values((_a = assm.types) !== null && _a !== void 0 ? _a : {});
}
function _allMethods(assm) {
    const methods = new Array();
    for (const type of _allTypes(assm)) {
        if (!spec.isClassOrInterfaceType(type)) {
            continue;
        }
        if (!type.methods) {
            continue;
        }
        type.methods.forEach((method) => methods.push({ member: method, type }));
    }
    return methods;
}
function _allProperties(assm) {
    const properties = new Array();
    for (const type of _allTypes(assm)) {
        if (!spec.isClassOrInterfaceType(type)) {
            continue;
        }
        if (!type.properties) {
            continue;
        }
        type.properties.forEach((property) => properties.push({ member: property, type }));
    }
    return properties;
}
function _allMembers(assm) {
    return [..._allMethods(assm), ..._allProperties(assm)];
}
function _allTypeReferences(assm) {
    var _a, _b, _c, _d, _e, _f, _g, _h;
    const typeReferences = new Array();
    for (const type of _allTypes(assm)) {
        if (!spec.isClassOrInterfaceType(type)) {
            continue;
        }
        if (spec.isClassType(type)) {
            const node = bindings.getClassRelatedNode(type);
            if (type.base) {
                typeReferences.push({
                    fqn: type.base,
                    node: (_b = (_a = node === null || node === void 0 ? void 0 : node.heritageClauses) === null || _a === void 0 ? void 0 : _a.find((hc) => hc.token === ts.SyntaxKind.ExtendsKeyword)) === null || _b === void 0 ? void 0 : _b.types[0],
                });
            }
            if ((_c = type.initializer) === null || _c === void 0 ? void 0 : _c.parameters) {
                for (const param of type.initializer.parameters) {
                    _collectTypeReferences(param.type, (_d = bindings.getParameterRelatedNode(param)) === null || _d === void 0 ? void 0 : _d.type);
                }
            }
        }
        if (type.interfaces) {
            const node = bindings.getClassOrInterfaceRelatedNode(type);
            type.interfaces.forEach((iface) => {
                var _a;
                return typeReferences.push({
                    fqn: iface,
                    node: (_a = node === null || node === void 0 ? void 0 : node.heritageClauses) === null || _a === void 0 ? void 0 : _a.find((hc) => hc.token ===
                        (spec.isInterfaceType(type)
                            ? ts.SyntaxKind.ImplementsKeyword
                            : ts.SyntaxKind.ExtendsKeyword)),
                });
            });
        }
    }
    for (const { member: prop } of _allProperties(assm)) {
        _collectTypeReferences(prop.type, (_e = bindings.getPropertyRelatedNode(prop)) === null || _e === void 0 ? void 0 : _e.type);
    }
    for (const { member: meth } of _allMethods(assm)) {
        if (meth.returns) {
            _collectTypeReferences(meth.returns.type, (_f = bindings.getMethodRelatedNode(meth)) === null || _f === void 0 ? void 0 : _f.type);
        }
        for (const param of (_g = meth.parameters) !== null && _g !== void 0 ? _g : []) {
            _collectTypeReferences(param.type, (_h = bindings.getParameterRelatedNode(param)) === null || _h === void 0 ? void 0 : _h.type);
        }
    }
    return typeReferences;
    function _collectTypeReferences(type, node) {
        if (spec.isNamedTypeReference(type)) {
            typeReferences.push({ ...type, node });
        }
        else if (spec.isCollectionTypeReference(type)) {
            _collectTypeReferences(type.collection.elementtype, node);
        }
        else if (spec.isUnionTypeReference(type)) {
            type.union.types.forEach((type) => _collectTypeReferences(type, node));
        }
    }
}
function _dereference(typeRef, assembly, validator) {
    var _a, _b;
    if (typeof typeRef !== 'string') {
        typeRef = typeRef.fqn;
    }
    const [assm] = typeRef.split('.');
    if (assembly.name === assm) {
        return (_a = assembly.types) === null || _a === void 0 ? void 0 : _a[typeRef];
    }
    const foreignAssm = validator.projectInfo.dependencyClosure.find((dep) => dep.name === assm);
    return (_b = foreignAssm === null || foreignAssm === void 0 ? void 0 : foreignAssm.types) === null || _b === void 0 ? void 0 : _b[typeRef];
}
function _isEmpty(array) {
    return array == null || array.length === 0;
}
/**
 * Return whether an identifier only consists of upperchase characters, digits and underscores
 *
 * We have our own check here (isConstantCase) which is more lenient than what
 * `case.constant()` prescribes. We also want to allow combinations of letters
 * and digits without underscores: `C5A`, which `case` would force to `C5_A`.
 * The hint we print will still use `case.constant()` but that is fine.
 */
function isConstantCase(x) {
    return !/[^A-Z0-9_]/.exec(x);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidmFsaWRhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFtQztBQUNuQyw2QkFBNkI7QUFDN0IsaUVBQWlFO0FBQ2pFLHdDQUF5QztBQUN6QyxpQ0FBaUM7QUFHakMsdURBQW1EO0FBQ25ELG1EQUFpRDtBQUNqRCw0Q0FBNEM7QUFHNUMsTUFBYSxTQUFTO0lBS3BCLFlBQ2tCLFdBQXdCLEVBQ3hCLFFBQXVCO1FBRHZCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLGFBQVEsR0FBUixRQUFRLENBQWU7UUFKakMsaUJBQVksR0FBRyxJQUFJLEtBQUssRUFBa0IsQ0FBQztJQUtoRCxDQUFDO0lBRUcsS0FBSyxDQUFDLElBQUk7UUFDZixJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUV2QixLQUFLLE1BQU0sVUFBVSxJQUFJLFNBQVMsQ0FBQyxXQUFXLEVBQUU7WUFDOUMsVUFBVSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1NBQ3pFO1FBRUQsSUFBSTtZQUNGLE9BQU8sTUFBTSxPQUFPLENBQUMsT0FBTyxDQUFDO2dCQUMzQixXQUFXLEVBQUUsSUFBSSxDQUFDLFlBQVk7Z0JBQzlCLFdBQVcsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FDakMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLEtBQUssRUFBRSxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FDeEQ7YUFDRixDQUFDLENBQUM7U0FDSjtnQkFBUztZQUNSLDRFQUE0RTtZQUM1RSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7U0FDMUI7SUFDSCxDQUFDOztBQTVCSCw4QkE2QkM7QUE1QmUscUJBQVcsR0FB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Q0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDL0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHNwZWMgZnJvbSAnQGpzaWkvc3BlYyc7XG5pbXBvcnQgKiBhcyBDYXNlIGZyb20gJ2Nhc2UnO1xuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1yZXF1aXJlLWltcG9ydHNcbmltcG9ydCBkZWVwRXF1YWwgPSByZXF1aXJlKCdkZWVwLWVxdWFsJyk7XG5pbXBvcnQgKiBhcyB0cyBmcm9tICd0eXBlc2NyaXB0JztcblxuaW1wb3J0IHsgRW1pdHRlciB9IGZyb20gJy4vZW1pdHRlcic7XG5pbXBvcnQgeyBKc2lpRGlhZ25vc3RpYyB9IGZyb20gJy4vanNpaS1kaWFnbm9zdGljJztcbmltcG9ydCB7IGdldFJlbGF0ZWROb2RlIH0gZnJvbSAnLi9ub2RlLWJpbmRpbmdzJztcbmltcG9ydCAqIGFzIGJpbmRpbmdzIGZyb20gJy4vbm9kZS1iaW5kaW5ncyc7XG5pbXBvcnQgeyBQcm9qZWN0SW5mbyB9IGZyb20gJy4vcHJvamVjdC1pbmZvJztcblxuZXhwb3J0IGNsYXNzIFZhbGlkYXRvciBpbXBsZW1lbnRzIEVtaXR0ZXIge1xuICBwdWJsaWMgc3RhdGljIFZBTElEQVRJT05TOiBWYWxpZGF0aW9uRnVuY3Rpb25bXSA9IF9kZWZhdWx0VmFsaWRhdGlvbnMoKTtcblxuICBwcml2YXRlIF9kaWFnbm9zdGljcyA9IG5ldyBBcnJheTxKc2lpRGlhZ25vc3RpYz4oKTtcblxuICBwdWJsaWMgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHJlYWRvbmx5IHByb2plY3RJbmZvOiBQcm9qZWN0SW5mbyxcbiAgICBwdWJsaWMgcmVhZG9ubHkgYXNzZW1ibHk6IHNwZWMuQXNzZW1ibHksXG4gICkge31cblxuICBwdWJsaWMgYXN5bmMgZW1pdCgpOiBQcm9taXNlPHRzLkVtaXRSZXN1bHQ+IHtcbiAgICB0aGlzLl9kaWFnbm9zdGljcyA9IFtdO1xuXG4gICAgZm9yIChjb25zdCB2YWxpZGF0aW9uIG9mIFZhbGlkYXRvci5WQUxJREFUSU9OUykge1xuICAgICAgdmFsaWRhdGlvbih0aGlzLCB0aGlzLmFzc2VtYmx5LCAoZGlhZykgPT4gdGhpcy5fZGlhZ25vc3RpY3MucHVzaChkaWFnKSk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICBkaWFnbm9zdGljczogdGhpcy5fZGlhZ25vc3RpY3MsXG4gICAgICAgIGVtaXRTa2lwcGVkOiB0aGlzLl9kaWFnbm9zdGljcy5zb21lKFxuICAgICAgICAgIChkaWFnKSA9PiBkaWFnLmNhdGVnb3J5ID09PSB0cy5EaWFnbm9zdGljQ2F0ZWdvcnkuRXJyb3IsXG4gICAgICAgICksXG4gICAgICB9KTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgLy8gQ2xlYXJpbmcgYGB0aGlzLl9kaWFnbm9zdGljc2BgIHRvIGFsbG93IGNvbnRlbnRzIHRvIGJlIGdhcmJhZ2UtY29sbGVjdGVkLlxuICAgICAgZGVsZXRlIHRoaXMuX2RpYWdub3N0aWNzO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgdHlwZSBEaWFnbm9zdGljRW1pdHRlciA9IChkaWFnOiBKc2lpRGlhZ25vc3RpYykgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIFZhbGlkYXRpb25GdW5jdGlvbiA9IChcbiAgdmFsaWRhdG9yOiBWYWxpZGF0b3IsXG4gIGFzc2VtYmx5OiBzcGVjLkFzc2VtYmx5LFxuICBkaWFnbm9zdGljOiBEaWFnbm9zdGljRW1pdHRlcixcbikgPT4gdm9pZDtcblxuZnVuY3Rpb24gX2RlZmF1bHRWYWxpZGF0aW9ucygpOiBWYWxpZGF0aW9uRnVuY3Rpb25bXSB7XG4gIHJldHVybiBbXG4gICAgX3R5cGVOYW1lc011c3RVc2VQYXNjYWxDYXNlLFxuICAgIF9lbnVtTWVtYmVyc011c3RVc2VyVXBwZXJTbmFrZUNhc2UsXG4gICAgX21lbWJlck5hbWVzTXVzdFVzZUNhbWVsQ2FzZSxcbiAgICBfc3RhdGljQ29uc3RhbnROYW1lc011c3RVc2VVcHBlclNuYWtlQ2FzZSxcbiAgICBfbWVtYmVyTmFtZXNNdXN0Tm90TG9va0xpa2VKYXZhR2V0dGVyc09yU2V0dGVycyxcbiAgICBfYWxsVHlwZVJlZmVyZW5jZXNBcmVWYWxpZCxcbiAgICBfaW5laHJpdGFuY2VEb2VzTm90Q2hhbmdlQ29udHJhY3RzLFxuICAgIF9zdGF0aWNNZW1iZXJzQW5kTmVzdGVkVHlwZXNNdXN0Tm90U2hhcmVQYXNjYWxDYXNlTmFtZSxcbiAgXTtcblxuICBmdW5jdGlvbiBfdHlwZU5hbWVzTXVzdFVzZVBhc2NhbENhc2UoXG4gICAgXzogVmFsaWRhdG9yLFxuICAgIGFzc2VtYmx5OiBzcGVjLkFzc2VtYmx5LFxuICAgIGRpYWdub3N0aWM6IERpYWdub3N0aWNFbWl0dGVyLFxuICApIHtcbiAgICBmb3IgKGNvbnN0IHR5cGUgb2YgX2FsbFR5cGVzKGFzc2VtYmx5KSkge1xuICAgICAgaWYgKHR5cGUubmFtZSAhPT0gQ2FzZS5wYXNjYWwodHlwZS5uYW1lKSkge1xuICAgICAgICBkaWFnbm9zdGljKFxuICAgICAgICAgIEpzaWlEaWFnbm9zdGljLkpTSUlfODAwMF9QQVNDQUxfQ0FTRURfVFlQRV9OQU1FUy5jcmVhdGVEZXRhY2hlZChcbiAgICAgICAgICAgIHR5cGUubmFtZSxcbiAgICAgICAgICApLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIF9lbnVtTWVtYmVyc011c3RVc2VyVXBwZXJTbmFrZUNhc2UoXG4gICAgXzogVmFsaWRhdG9yLFxuICAgIGFzc2VtYmx5OiBzcGVjLkFzc2VtYmx5LFxuICAgIGRpYWdub3N0aWM6IERpYWdub3N0aWNFbWl0dGVyLFxuICApIHtcbiAgICBmb3IgKGNvbnN0IHR5cGUgb2YgX2FsbFR5cGVzKGFzc2VtYmx5KSkge1xuICAgICAgaWYgKCFzcGVjLmlzRW51bVR5cGUodHlwZSkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGZvciAoY29uc3QgbWVtYmVyIG9mIHR5cGUubWVtYmVycykge1xuICAgICAgICBpZiAobWVtYmVyLm5hbWUgJiYgIWlzQ29uc3RhbnRDYXNlKG1lbWJlci5uYW1lKSkge1xuICAgICAgICAgIGRpYWdub3N0aWMoXG4gICAgICAgICAgICBKc2lpRGlhZ25vc3RpYy5KU0lJXzgwMDFfQUxMX0NBUFNfRU5VTV9NRU1CRVJTLmNyZWF0ZURldGFjaGVkKFxuICAgICAgICAgICAgICBtZW1iZXIubmFtZSxcbiAgICAgICAgICAgICAgdHlwZS5mcW4sXG4gICAgICAgICAgICApLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBfbWVtYmVyTmFtZXNNdXN0VXNlQ2FtZWxDYXNlKFxuICAgIF86IFZhbGlkYXRvcixcbiAgICBhc3NlbWJseTogc3BlYy5Bc3NlbWJseSxcbiAgICBkaWFnbm9zdGljOiBEaWFnbm9zdGljRW1pdHRlcixcbiAgKSB7XG4gICAgZm9yIChjb25zdCB7IG1lbWJlciwgdHlwZSB9IG9mIF9hbGxNZW1iZXJzKGFzc2VtYmx5KSkge1xuICAgICAgaWYgKG1lbWJlci5zdGF0aWMgJiYgKG1lbWJlciBhcyBzcGVjLlByb3BlcnR5KS5jb25zdCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGlmIChtZW1iZXIubmFtZSAmJiBtZW1iZXIubmFtZSAhPT0gQ2FzZS5jYW1lbChtZW1iZXIubmFtZSkpIHtcbiAgICAgICAgZGlhZ25vc3RpYyhcbiAgICAgICAgICBKc2lpRGlhZ25vc3RpYy5KU0lJXzgwMDJfQ0FNRUxfQ0FTRURfTUVNQkVSUy5jcmVhdGVEZXRhY2hlZChcbiAgICAgICAgICAgIG1lbWJlci5uYW1lLFxuICAgICAgICAgICAgdHlwZS5mcW4sXG4gICAgICAgICAgKSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBfc3RhdGljQ29uc3RhbnROYW1lc011c3RVc2VVcHBlclNuYWtlQ2FzZShcbiAgICBfOiBWYWxpZGF0b3IsXG4gICAgYXNzZW1ibHk6IHNwZWMuQXNzZW1ibHksXG4gICAgZGlhZ25vc3RpYzogRGlhZ25vc3RpY0VtaXR0ZXIsXG4gICkge1xuICAgIGZvciAoY29uc3QgeyBtZW1iZXIsIHR5cGUgfSBvZiBfYWxsTWVtYmVycyhhc3NlbWJseSkpIHtcbiAgICAgIGlmICghbWVtYmVyLnN0YXRpYyB8fCAhKG1lbWJlciBhcyBzcGVjLlByb3BlcnR5KS5jb25zdCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAgbWVtYmVyLm5hbWUgJiZcbiAgICAgICAgIWlzQ29uc3RhbnRDYXNlKG1lbWJlci5uYW1lKSAmJlxuICAgICAgICBtZW1iZXIubmFtZSAhPT0gQ2FzZS5wYXNjYWwobWVtYmVyLm5hbWUpICYmXG4gICAgICAgIG1lbWJlci5uYW1lICE9PSBDYXNlLmNhbWVsKG1lbWJlci5uYW1lKVxuICAgICAgKSB7XG4gICAgICAgIGRpYWdub3N0aWMoXG4gICAgICAgICAgSnNpaURpYWdub3N0aWMuSlNJSV84MDAzX1NUQVRJQ19DT05TVF9DQVNJTkcuY3JlYXRlRGV0YWNoZWQoXG4gICAgICAgICAgICBtZW1iZXIubmFtZSxcbiAgICAgICAgICAgIHR5cGUubmFtZSxcbiAgICAgICAgICApLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIF9tZW1iZXJOYW1lc011c3ROb3RMb29rTGlrZUphdmFHZXR0ZXJzT3JTZXR0ZXJzKFxuICAgIF86IFZhbGlkYXRvcixcbiAgICBhc3NlbWJseTogc3BlYy5Bc3NlbWJseSxcbiAgICBkaWFnbm9zdGljOiBEaWFnbm9zdGljRW1pdHRlcixcbiAgKSB7XG4gICAgZm9yIChjb25zdCB7IG1lbWJlciwgdHlwZSB9IG9mIF9hbGxNZW1iZXJzKGFzc2VtYmx5KSkge1xuICAgICAgaWYgKCFtZW1iZXIubmFtZSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHNuYWtlTmFtZSA9IENhc2Uuc25ha2UobWVtYmVyLm5hbWUpO1xuICAgICAgaWYgKFxuICAgICAgICBzbmFrZU5hbWUuc3RhcnRzV2l0aCgnZ2V0XycpICYmXG4gICAgICAgIF9pc0VtcHR5KChtZW1iZXIgYXMgc3BlYy5NZXRob2QpLnBhcmFtZXRlcnMpXG4gICAgICApIHtcbiAgICAgICAgZGlhZ25vc3RpYyhcbiAgICAgICAgICBKc2lpRGlhZ25vc3RpYy5KU0lJXzUwMDBfSkFWQV9HRVRURVJTLmNyZWF0ZURldGFjaGVkKFxuICAgICAgICAgICAgbWVtYmVyLm5hbWUsXG4gICAgICAgICAgICB0eXBlLm5hbWUsXG4gICAgICAgICAgKSxcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgIHNuYWtlTmFtZS5zdGFydHNXaXRoKCdzZXRfJykgJiZcbiAgICAgICAgKChtZW1iZXIgYXMgc3BlYy5NZXRob2QpLnBhcmFtZXRlcnMgPz8gW10pLmxlbmd0aCA9PT0gMVxuICAgICAgKSB7XG4gICAgICAgIGRpYWdub3N0aWMoXG4gICAgICAgICAgSnNpaURpYWdub3N0aWMuSlNJSV81MDAxX0pBVkFfU0VUVEVSUy5jcmVhdGVEZXRhY2hlZChcbiAgICAgICAgICAgIG1lbWJlci5uYW1lLFxuICAgICAgICAgICAgdHlwZS5uYW1lLFxuICAgICAgICAgICksXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gX2FsbFR5cGVSZWZlcmVuY2VzQXJlVmFsaWQoXG4gICAgdmFsaWRhdG9yOiBWYWxpZGF0b3IsXG4gICAgYXNzZW1ibHk6IHNwZWMuQXNzZW1ibHksXG4gICAgZGlhZ25vc3RpYzogRGlhZ25vc3RpY0VtaXR0ZXIsXG4gICkge1xuICAgIGZvciAoY29uc3QgdHlwZVJlZiBvZiBfYWxsVHlwZVJlZmVyZW5jZXMoYXNzZW1ibHkpKSB7XG4gICAgICBjb25zdCBbYXNzbV0gPSB0eXBlUmVmLmZxbi5zcGxpdCgnLicpO1xuICAgICAgaWYgKGFzc2VtYmx5Lm5hbWUgPT09IGFzc20pIHtcbiAgICAgICAgaWYgKCEodHlwZVJlZi5mcW4gaW4gKGFzc2VtYmx5LnR5cGVzID8/IHt9KSkpIHtcbiAgICAgICAgICBkaWFnbm9zdGljKFxuICAgICAgICAgICAgSnNpaURpYWdub3N0aWMuSlNJSV8zMDAwX0VYUE9SVEVEX0FQSV9VU0VTX0hJRERFTl9UWVBFLmNyZWF0ZShcbiAgICAgICAgICAgICAgdHlwZVJlZi5ub2RlISwgLy8gUHJldGVuZCB0aGVyZSBpcyBhbHdheXMgYSB2YWx1ZVxuICAgICAgICAgICAgICB0eXBlUmVmLmZxbixcbiAgICAgICAgICAgICksXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGZvcmVpZ25Bc3NtID0gdmFsaWRhdG9yLnByb2plY3RJbmZvLmRlcGVuZGVuY3lDbG9zdXJlLmZpbmQoXG4gICAgICAgIChkZXApID0+IGRlcC5uYW1lID09PSBhc3NtLFxuICAgICAgKTtcbiAgICAgIGlmICghZm9yZWlnbkFzc20pIHtcbiAgICAgICAgZGlhZ25vc3RpYyhcbiAgICAgICAgICBKc2lpRGlhZ25vc3RpYy5KU0lJXzkwMDBfVU5LTk9XTl9NT0RVTEUuY3JlYXRlRGV0YWNoZWQoYXNzbSksXG4gICAgICAgICk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKCEodHlwZVJlZi5mcW4gaW4gKGZvcmVpZ25Bc3NtLnR5cGVzID8/IHt9KSkpIHtcbiAgICAgICAgZGlhZ25vc3RpYyhcbiAgICAgICAgICBKc2lpRGlhZ25vc3RpYy5KU0lJXzkwMDFfVFlQRV9OT1RfRk9VTkQuY3JlYXRlRGV0YWNoZWQodHlwZVJlZiksXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gX2luZWhyaXRhbmNlRG9lc05vdENoYW5nZUNvbnRyYWN0cyhcbiAgICB2YWxpZGF0b3I6IFZhbGlkYXRvcixcbiAgICBhc3NlbWJseTogc3BlYy5Bc3NlbWJseSxcbiAgICBkaWFnbm9zdGljOiBEaWFnbm9zdGljRW1pdHRlcixcbiAgKSB7XG4gICAgZm9yIChjb25zdCB0eXBlIG9mIF9hbGxUeXBlcyhhc3NlbWJseSkpIHtcbiAgICAgIGlmIChzcGVjLmlzQ2xhc3NUeXBlKHR5cGUpKSB7XG4gICAgICAgIGZvciAoY29uc3QgbWV0aG9kIG9mIHR5cGUubWV0aG9kcyA/PyBbXSkge1xuICAgICAgICAgIF92YWxpZGF0ZU1ldGhvZE92ZXJyaWRlKG1ldGhvZCwgdHlwZSk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiB0eXBlLnByb3BlcnRpZXMgPz8gW10pIHtcbiAgICAgICAgICBfdmFsaWRhdGVQcm9wZXJ0eU92ZXJyaWRlKHByb3BlcnR5LCB0eXBlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICBzcGVjLmlzQ2xhc3NPckludGVyZmFjZVR5cGUodHlwZSkgJiZcbiAgICAgICAgKHR5cGUuaW50ZXJmYWNlcz8ubGVuZ3RoID8/IDApID4gMFxuICAgICAgKSB7XG4gICAgICAgIGZvciAoY29uc3QgbWV0aG9kIG9mIHR5cGUubWV0aG9kcyA/PyBbXSkge1xuICAgICAgICAgIC8vIE92ZXJyaWRlcyBcIndpblwiIG92ZXIgaW1wbGVtZW50YXRpb25zXG4gICAgICAgICAgaWYgKG1ldGhvZC5vdmVycmlkZXMpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBfdmFsaWRhdGVNZXRob2RJbXBsZW1lbnRhdGlvbihtZXRob2QsIHR5cGUpO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgdHlwZS5wcm9wZXJ0aWVzID8/IFtdKSB7XG4gICAgICAgICAgX3ZhbGlkYXRlUHJvcGVydHlJbXBsZW1lbnRhdGlvbihwcm9wZXJ0eSwgdHlwZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBfdmFsaWRhdGVNZXRob2RPdmVycmlkZShcbiAgICAgIG1ldGhvZDogc3BlYy5NZXRob2QsXG4gICAgICB0eXBlOiBzcGVjLkNsYXNzVHlwZSxcbiAgICApOiBib29sZWFuIHtcbiAgICAgIGlmICghdHlwZS5iYXNlKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGJhc2VUeXBlID0gX2RlcmVmZXJlbmNlKFxuICAgICAgICB0eXBlLmJhc2UsXG4gICAgICAgIGFzc2VtYmx5LFxuICAgICAgICB2YWxpZGF0b3IsXG4gICAgICApIGFzIHNwZWMuQ2xhc3NUeXBlO1xuICAgICAgaWYgKCFiYXNlVHlwZSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICBjb25zdCBvdmVycmlkZGVuID0gKGJhc2VUeXBlLm1ldGhvZHMgPz8gW10pLmZpbmQoXG4gICAgICAgIChtKSA9PiBtLm5hbWUgPT09IG1ldGhvZC5uYW1lLFxuICAgICAgKTtcbiAgICAgIGlmICghb3ZlcnJpZGRlbikge1xuICAgICAgICByZXR1cm4gX3ZhbGlkYXRlTWV0aG9kT3ZlcnJpZGUobWV0aG9kLCBiYXNlVHlwZSk7XG4gICAgICB9XG4gICAgICBfYXNzZXJ0U2lnbmF0dXJlc01hdGNoKFxuICAgICAgICBvdmVycmlkZGVuLFxuICAgICAgICBtZXRob2QsXG4gICAgICAgIGAke3R5cGUuZnFufSMke21ldGhvZC5uYW1lfWAsXG4gICAgICAgIGBvdmVycmlkaW5nICR7YmFzZVR5cGUuZnFufWAsXG4gICAgICApO1xuICAgICAgbWV0aG9kLm92ZXJyaWRlcyA9IGJhc2VUeXBlLmZxbjtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIF92YWxpZGF0ZVByb3BlcnR5T3ZlcnJpZGUoXG4gICAgICBwcm9wZXJ0eTogc3BlYy5Qcm9wZXJ0eSxcbiAgICAgIHR5cGU6IHNwZWMuQ2xhc3NUeXBlLFxuICAgICk6IGJvb2xlYW4ge1xuICAgICAgaWYgKCF0eXBlLmJhc2UpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgY29uc3QgYmFzZVR5cGUgPSBfZGVyZWZlcmVuY2UoXG4gICAgICAgIHR5cGUuYmFzZSxcbiAgICAgICAgYXNzZW1ibHksXG4gICAgICAgIHZhbGlkYXRvcixcbiAgICAgICkgYXMgc3BlYy5DbGFzc1R5cGU7XG4gICAgICBpZiAoIWJhc2VUeXBlKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG92ZXJyaWRkZW4gPSAoYmFzZVR5cGUucHJvcGVydGllcyA/PyBbXSkuZmluZChcbiAgICAgICAgKHApID0+IHAubmFtZSA9PT0gcHJvcGVydHkubmFtZSxcbiAgICAgICk7XG4gICAgICBpZiAoIW92ZXJyaWRkZW4pIHtcbiAgICAgICAgcmV0dXJuIF92YWxpZGF0ZVByb3BlcnR5T3ZlcnJpZGUocHJvcGVydHksIGJhc2VUeXBlKTtcbiAgICAgIH1cbiAgICAgIF9hc3NlcnRQcm9wZXJ0aWVzTWF0Y2goXG4gICAgICAgIG92ZXJyaWRkZW4sXG4gICAgICAgIHByb3BlcnR5LFxuICAgICAgICBgJHt0eXBlLmZxbn0jJHtwcm9wZXJ0eS5uYW1lfWAsXG4gICAgICAgIGBvdmVycmlkaW5nICR7YmFzZVR5cGUuZnFufWAsXG4gICAgICApO1xuICAgICAgcHJvcGVydHkub3ZlcnJpZGVzID0gYmFzZVR5cGUuZnFuO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gX3ZhbGlkYXRlTWV0aG9kSW1wbGVtZW50YXRpb24oXG4gICAgICBtZXRob2Q6IHNwZWMuTWV0aG9kLFxuICAgICAgdHlwZTogc3BlYy5DbGFzc1R5cGUgfCBzcGVjLkludGVyZmFjZVR5cGUsXG4gICAgKTogYm9vbGVhbiB7XG4gICAgICBpZiAoIXR5cGUuaW50ZXJmYWNlcykge1xuICAgICAgICAvLyBBYnN0cmFjdCBjbGFzc2VzIG1heSBub3QgZGlyZWN0bHkgaW1wbGVtZW50IGFsbCBtZW1iZXJzLCBuZWVkIHRvIGNoZWNrIHRoZWlyIHN1cGVydHlwZXMuLi5cbiAgICAgICAgaWYgKHNwZWMuaXNDbGFzc1R5cGUodHlwZSkgJiYgdHlwZS5iYXNlICYmIHR5cGUuYWJzdHJhY3QpIHtcbiAgICAgICAgICByZXR1cm4gX3ZhbGlkYXRlTWV0aG9kSW1wbGVtZW50YXRpb24oXG4gICAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgICBfZGVyZWZlcmVuY2UodHlwZS5iYXNlLCBhc3NlbWJseSwgdmFsaWRhdG9yKSBhcyBzcGVjLkNsYXNzVHlwZSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgaWZhY2Ugb2YgdHlwZS5pbnRlcmZhY2VzKSB7XG4gICAgICAgIGNvbnN0IGlmYWNlVHlwZSA9IF9kZXJlZmVyZW5jZShcbiAgICAgICAgICBpZmFjZSxcbiAgICAgICAgICBhc3NlbWJseSxcbiAgICAgICAgICB2YWxpZGF0b3IsXG4gICAgICAgICkgYXMgc3BlYy5JbnRlcmZhY2VUeXBlO1xuICAgICAgICBjb25zdCBpbXBsZW1lbnRlZCA9IChpZmFjZVR5cGUubWV0aG9kcyA/PyBbXSkuZmluZChcbiAgICAgICAgICAobSkgPT4gbS5uYW1lID09PSBtZXRob2QubmFtZSxcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKGltcGxlbWVudGVkKSB7XG4gICAgICAgICAgX2Fzc2VydFNpZ25hdHVyZXNNYXRjaChcbiAgICAgICAgICAgIGltcGxlbWVudGVkLFxuICAgICAgICAgICAgbWV0aG9kLFxuICAgICAgICAgICAgYCR7dHlwZS5mcW59IyR7bWV0aG9kLm5hbWV9YCxcbiAgICAgICAgICAgIGBpbXBsZW1lbnRpbmcgJHtpZmFjZVR5cGUuZnFufWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgICBtZXRob2Qub3ZlcnJpZGVzID0gaWZhY2U7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF92YWxpZGF0ZU1ldGhvZEltcGxlbWVudGF0aW9uKG1ldGhvZCwgaWZhY2VUeXBlKSkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gX3ZhbGlkYXRlUHJvcGVydHlJbXBsZW1lbnRhdGlvbihcbiAgICAgIHByb3BlcnR5OiBzcGVjLlByb3BlcnR5LFxuICAgICAgdHlwZTogc3BlYy5DbGFzc1R5cGUgfCBzcGVjLkludGVyZmFjZVR5cGUsXG4gICAgKTogYm9vbGVhbiB7XG4gICAgICBpZiAoIXR5cGUuaW50ZXJmYWNlcykge1xuICAgICAgICAvLyBBYnN0cmFjdCBjbGFzc2VzIG1heSBub3QgZGlyZWN0bHkgaW1wbGVtZW50IGFsbCBtZW1iZXJzLCBuZWVkIHRvIGNoZWNrIHRoZWlyIHN1cGVydHlwZXMuLi5cbiAgICAgICAgaWYgKHNwZWMuaXNDbGFzc1R5cGUodHlwZSkgJiYgdHlwZS5iYXNlICYmIHR5cGUuYWJzdHJhY3QpIHtcbiAgICAgICAgICByZXR1cm4gX3ZhbGlkYXRlUHJvcGVydHlJbXBsZW1lbnRhdGlvbihcbiAgICAgICAgICAgIHByb3BlcnR5LFxuICAgICAgICAgICAgX2RlcmVmZXJlbmNlKHR5cGUuYmFzZSwgYXNzZW1ibHksIHZhbGlkYXRvcikgYXMgc3BlYy5DbGFzc1R5cGUsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICBmb3IgKGNvbnN0IGlmYWNlIG9mIHR5cGUuaW50ZXJmYWNlcykge1xuICAgICAgICBjb25zdCBpZmFjZVR5cGUgPSBfZGVyZWZlcmVuY2UoXG4gICAgICAgICAgaWZhY2UsXG4gICAgICAgICAgYXNzZW1ibHksXG4gICAgICAgICAgdmFsaWRhdG9yLFxuICAgICAgICApIGFzIHNwZWMuSW50ZXJmYWNlVHlwZTtcbiAgICAgICAgY29uc3QgaW1wbGVtZW50ZWQgPSAoaWZhY2VUeXBlLnByb3BlcnRpZXMgPz8gW10pLmZpbmQoXG4gICAgICAgICAgKHApID0+IHAubmFtZSA9PT0gcHJvcGVydHkubmFtZSxcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKGltcGxlbWVudGVkKSB7XG4gICAgICAgICAgX2Fzc2VydFByb3BlcnRpZXNNYXRjaChcbiAgICAgICAgICAgIGltcGxlbWVudGVkLFxuICAgICAgICAgICAgcHJvcGVydHksXG4gICAgICAgICAgICBgJHt0eXBlLmZxbn0jJHtwcm9wZXJ0eS5uYW1lfWAsXG4gICAgICAgICAgICBgaW1wbGVtZW50aW5nICR7aWZhY2VUeXBlLmZxbn1gLFxuICAgICAgICAgICk7XG4gICAgICAgICAgcHJvcGVydHkub3ZlcnJpZGVzID0gaWZhY2VUeXBlLmZxbjtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoX3ZhbGlkYXRlUHJvcGVydHlJbXBsZW1lbnRhdGlvbihwcm9wZXJ0eSwgaWZhY2VUeXBlKSkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gX2Fzc2VydFNpZ25hdHVyZXNNYXRjaChcbiAgICAgIGV4cGVjdGVkOiBzcGVjLk1ldGhvZCxcbiAgICAgIGFjdHVhbDogc3BlYy5NZXRob2QsXG4gICAgICBsYWJlbDogc3RyaW5nLFxuICAgICAgYWN0aW9uOiBzdHJpbmcsXG4gICAgKSB7XG4gICAgICBpZiAoISFleHBlY3RlZC5wcm90ZWN0ZWQgIT09ICEhYWN0dWFsLnByb3RlY3RlZCkge1xuICAgICAgICBjb25zdCBleHBWaXNpYmlsaXR5ID0gZXhwZWN0ZWQucHJvdGVjdGVkID8gJ3Byb3RlY3RlZCcgOiAncHVibGljJztcbiAgICAgICAgY29uc3QgYWN0VmlzaWJpbGl0eSA9IGFjdHVhbC5wcm90ZWN0ZWQgPyAncHJvdGVjdGVkJyA6ICdwdWJsaWMnO1xuICAgICAgICBkaWFnbm9zdGljKFxuICAgICAgICAgIEpzaWlEaWFnbm9zdGljLkpTSUlfNTAwMl9PVkVSUklERV9DSEFOR0VTX1ZJU0lCSUxJVFkuY3JlYXRlRGV0YWNoZWQoXG4gICAgICAgICAgICBsYWJlbCxcbiAgICAgICAgICAgIGFjdGlvbixcbiAgICAgICAgICAgIGFjdFZpc2liaWxpdHksXG4gICAgICAgICAgICBleHBWaXNpYmlsaXR5LFxuICAgICAgICAgICksXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoIWRlZXBFcXVhbChhY3R1YWwucmV0dXJucywgZXhwZWN0ZWQucmV0dXJucykpIHtcbiAgICAgICAgY29uc3QgZXhwVHlwZSA9IHNwZWMuZGVzY3JpYmVUeXBlUmVmZXJlbmNlKGV4cGVjdGVkLnJldHVybnM/LnR5cGUpO1xuICAgICAgICBjb25zdCBhY3RUeXBlID0gc3BlYy5kZXNjcmliZVR5cGVSZWZlcmVuY2UoYWN0dWFsLnJldHVybnM/LnR5cGUpO1xuICAgICAgICBkaWFnbm9zdGljKFxuICAgICAgICAgIEpzaWlEaWFnbm9zdGljLkpTSUlfNTAwM19PVkVSUklERV9DSEFOR0VTX1JFVFVSTl9UWVBFLmNyZWF0ZURldGFjaGVkKFxuICAgICAgICAgICAgbGFiZWwsXG4gICAgICAgICAgICBhY3Rpb24sXG4gICAgICAgICAgICBhY3RUeXBlLFxuICAgICAgICAgICAgZXhwVHlwZSxcbiAgICAgICAgICApLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgY29uc3QgZXhwZWN0ZWRQYXJhbXMgPSBleHBlY3RlZC5wYXJhbWV0ZXJzID8/IFtdO1xuICAgICAgY29uc3QgYWN0dWFsUGFyYW1zID0gYWN0dWFsLnBhcmFtZXRlcnMgPz8gW107XG4gICAgICBpZiAoZXhwZWN0ZWRQYXJhbXMubGVuZ3RoICE9PSBhY3R1YWxQYXJhbXMubGVuZ3RoKSB7XG4gICAgICAgIGRpYWdub3N0aWMoXG4gICAgICAgICAgSnNpaURpYWdub3N0aWMuSlNJSV81MDA1X09WRVJSSURFX0NIQU5HRVNfUEFSQU1fQ09VTlQuY3JlYXRlRGV0YWNoZWQoXG4gICAgICAgICAgICBsYWJlbCxcbiAgICAgICAgICAgIGFjdGlvbixcbiAgICAgICAgICAgIGFjdHVhbFBhcmFtcy5sZW5ndGgsXG4gICAgICAgICAgICBleHBlY3RlZFBhcmFtcy5sZW5ndGgsXG4gICAgICAgICAgKSxcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBleHBlY3RlZFBhcmFtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBleHBQYXJhbSA9IGV4cGVjdGVkUGFyYW1zW2ldO1xuICAgICAgICBjb25zdCBhY3RQYXJhbSA9IGFjdHVhbFBhcmFtc1tpXTtcbiAgICAgICAgaWYgKCFkZWVwRXF1YWwoZXhwUGFyYW0udHlwZSwgYWN0UGFyYW0udHlwZSkpIHtcbiAgICAgICAgICBkaWFnbm9zdGljKFxuICAgICAgICAgICAgSnNpaURpYWdub3N0aWMuSlNJSV81MDA2X09WRVJSSURFX0NIQU5HRVNfUEFSQU1fVFlQRS5jcmVhdGVEZXRhY2hlZChcbiAgICAgICAgICAgICAgbGFiZWwsXG4gICAgICAgICAgICAgIGFjdGlvbixcbiAgICAgICAgICAgICAgYWN0UGFyYW0sXG4gICAgICAgICAgICAgIGV4cFBhcmFtLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIC8vIE5vdC1pbmcgdGhvc2UgdG8gZm9yY2UgdGhlIHZhbHVlcyB0byBhIHN0cmljdGx5IGJvb2xlYW4gY29udGV4dCAodGhleSdyZSBvcHRpb25hbCwgdW5kZWZpbmVkIG1lYW5zIGZhbHNlKVxuICAgICAgICBpZiAoZXhwUGFyYW0udmFyaWFkaWMgIT09IGFjdFBhcmFtLnZhcmlhZGljKSB7XG4gICAgICAgICAgZGlhZ25vc3RpYyhcbiAgICAgICAgICAgIEpzaWlEaWFnbm9zdGljLkpTSUlfNTAwN19PVkVSUklERV9DSEFOR0VTX1ZBUklBRElDLmNyZWF0ZURldGFjaGVkKFxuICAgICAgICAgICAgICBsYWJlbCxcbiAgICAgICAgICAgICAgYWN0aW9uLFxuICAgICAgICAgICAgICBhY3RQYXJhbS52YXJpYWRpYyxcbiAgICAgICAgICAgICAgZXhwUGFyYW0udmFyaWFkaWMsXG4gICAgICAgICAgICApLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGV4cFBhcmFtLm9wdGlvbmFsICE9PSBhY3RQYXJhbS5vcHRpb25hbCkge1xuICAgICAgICAgIGRpYWdub3N0aWMoXG4gICAgICAgICAgICBKc2lpRGlhZ25vc3RpYy5KU0lJXzUwMDhfT1ZFUlJJREVfQ0hBTkdFU19QQVJBTV9PUFRJT05BTC5jcmVhdGVEZXRhY2hlZChcbiAgICAgICAgICAgICAgbGFiZWwsXG4gICAgICAgICAgICAgIGFjdGlvbixcbiAgICAgICAgICAgICAgYWN0UGFyYW0sXG4gICAgICAgICAgICAgIGV4cFBhcmFtLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gX2Fzc2VydFByb3BlcnRpZXNNYXRjaChcbiAgICAgIGV4cGVjdGVkOiBzcGVjLlByb3BlcnR5LFxuICAgICAgYWN0dWFsOiBzcGVjLlByb3BlcnR5LFxuICAgICAgbGFiZWw6IHN0cmluZyxcbiAgICAgIGFjdGlvbjogc3RyaW5nLFxuICAgICkge1xuICAgICAgaWYgKCEhZXhwZWN0ZWQucHJvdGVjdGVkICE9PSAhIWFjdHVhbC5wcm90ZWN0ZWQpIHtcbiAgICAgICAgY29uc3QgZXhwVmlzaWJpbGl0eSA9IGV4cGVjdGVkLnByb3RlY3RlZCA/ICdwcm90ZWN0ZWQnIDogJ3B1YmxpYyc7XG4gICAgICAgIGNvbnN0IGFjdFZpc2liaWxpdHkgPSBhY3R1YWwucHJvdGVjdGVkID8gJ3Byb3RlY3RlZCcgOiAncHVibGljJztcbiAgICAgICAgZGlhZ25vc3RpYyhcbiAgICAgICAgICBKc2lpRGlhZ25vc3RpYy5KU0lJXzUwMDJfT1ZFUlJJREVfQ0hBTkdFU19WSVNJQklMSVRZLmNyZWF0ZURldGFjaGVkKFxuICAgICAgICAgICAgbGFiZWwsXG4gICAgICAgICAgICBhY3Rpb24sXG4gICAgICAgICAgICBhY3RWaXNpYmlsaXR5LFxuICAgICAgICAgICAgZXhwVmlzaWJpbGl0eSxcbiAgICAgICAgICApLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKCFkZWVwRXF1YWwoZXhwZWN0ZWQudHlwZSwgYWN0dWFsLnR5cGUpKSB7XG4gICAgICAgIGRpYWdub3N0aWMoXG4gICAgICAgICAgSnNpaURpYWdub3N0aWMuSlNJSV81MDA0X09WRVJSSURFX0NIQU5HRVNfUFJPUF9UWVBFLmNyZWF0ZURldGFjaGVkKFxuICAgICAgICAgICAgbGFiZWwsXG4gICAgICAgICAgICBhY3Rpb24sXG4gICAgICAgICAgICBhY3R1YWwudHlwZSxcbiAgICAgICAgICAgIGV4cGVjdGVkLnR5cGUsXG4gICAgICAgICAgKSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChleHBlY3RlZC5pbW11dGFibGUgIT09IGFjdHVhbC5pbW11dGFibGUpIHtcbiAgICAgICAgZGlhZ25vc3RpYyhcbiAgICAgICAgICBKc2lpRGlhZ25vc3RpYy5KU0lJXzUwMTBfT1ZFUlJJREVfQ0hBTkdFU19NVVRBQklMSVRZLmNyZWF0ZURldGFjaGVkKFxuICAgICAgICAgICAgbGFiZWwsXG4gICAgICAgICAgICBhY3Rpb24sXG4gICAgICAgICAgICBhY3R1YWwuaW1tdXRhYmxlLFxuICAgICAgICAgICAgZXhwZWN0ZWQuaW1tdXRhYmxlLFxuICAgICAgICAgICksXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoZXhwZWN0ZWQub3B0aW9uYWwgIT09IGFjdHVhbC5vcHRpb25hbCkge1xuICAgICAgICBkaWFnbm9zdGljKFxuICAgICAgICAgIEpzaWlEaWFnbm9zdGljLkpTSUlfNTAwOV9PVkVSUklERV9DSEFOR0VTX1BST1BfT1BUSU9OQUwuY3JlYXRlRGV0YWNoZWQoXG4gICAgICAgICAgICBsYWJlbCxcbiAgICAgICAgICAgIGFjdGlvbixcbiAgICAgICAgICAgIGFjdHVhbC5vcHRpb25hbCxcbiAgICAgICAgICAgIGV4cGVjdGVkLm9wdGlvbmFsLFxuICAgICAgICAgICksXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gX3N0YXRpY01lbWJlcnNBbmROZXN0ZWRUeXBlc011c3ROb3RTaGFyZVBhc2NhbENhc2VOYW1lKFxuICAgIF86IFZhbGlkYXRvcixcbiAgICBhc3NlbWJseTogc3BlYy5Bc3NlbWJseSxcbiAgICBkaWFnbm9zdGljOiBEaWFnbm9zdGljRW1pdHRlcixcbiAgKSB7XG4gICAgZm9yIChjb25zdCBuZXN0ZWRUeXBlIG9mIE9iamVjdC52YWx1ZXMoYXNzZW1ibHkudHlwZXMgPz8ge30pKSB7XG4gICAgICBpZiAobmVzdGVkVHlwZS5uYW1lc3BhY2UgPT0gbnVsbCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG5lc3RpbmdUeXBlID1cbiAgICAgICAgYXNzZW1ibHkudHlwZXMhW2Ake2Fzc2VtYmx5Lm5hbWV9LiR7bmVzdGVkVHlwZS5uYW1lc3BhY2V9YF07XG4gICAgICBpZiAobmVzdGluZ1R5cGUgPT0gbnVsbCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG5lc3RlZFR5cGVOYW1lID0gQ2FzZS5wYXNjYWwobmVzdGVkVHlwZS5uYW1lKTtcbiAgICAgIGZvciAoY29uc3QgeyBuYW1lLCBtZW1iZXIgfSBvZiBzdGF0aWNNZW1iZXJzKG5lc3RpbmdUeXBlKSkge1xuICAgICAgICBpZiAobmFtZSA9PT0gbmVzdGVkVHlwZU5hbWUpIHtcbiAgICAgICAgICBsZXQgZGlhZyA9XG4gICAgICAgICAgICBKc2lpRGlhZ25vc3RpYy5KU0lJXzUwMjBfU1RBVElDX01FTUJFUl9DT05GTElDVFNfV0lUSF9ORVNURURfVFlQRS5jcmVhdGUoXG4gICAgICAgICAgICAgIGdldFJlbGF0ZWROb2RlKG1lbWJlcikhLFxuICAgICAgICAgICAgICBuZXN0aW5nVHlwZSxcbiAgICAgICAgICAgICAgbWVtYmVyLFxuICAgICAgICAgICAgICBuZXN0ZWRUeXBlLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICBjb25zdCBuZXN0ZWRUeXBlTm9kZSA9IGdldFJlbGF0ZWROb2RlKG5lc3RlZFR5cGUpO1xuICAgICAgICAgIGlmIChuZXN0ZWRUeXBlTm9kZSAhPSBudWxsKSB7XG4gICAgICAgICAgICBkaWFnID0gZGlhZy5hZGRSZWxhdGVkSW5mb3JtYXRpb24oXG4gICAgICAgICAgICAgIG5lc3RlZFR5cGVOb2RlLFxuICAgICAgICAgICAgICAnVGhpcyBpcyB0aGUgY29uZmxpY3RpbmcgbmVzdGVkIHR5cGUgZGVjbGFyYXRpb24nLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZGlhZ25vc3RpYyhkaWFnKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIHN0YXRpY01lbWJlcnModHlwZTogc3BlYy5UeXBlKSB7XG4gICAgICBpZiAoc3BlYy5pc0NsYXNzT3JJbnRlcmZhY2VUeXBlKHR5cGUpKSB7XG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgLi4uKHR5cGUubWV0aG9kcz8uZmlsdGVyKChtZXRob2QpID0+IG1ldGhvZC5zdGF0aWMpID8/IFtdKSxcbiAgICAgICAgICAuLi4odHlwZS5wcm9wZXJ0aWVzPy5maWx0ZXIoKHByb3ApID0+IHByb3Auc3RhdGljKSA/PyBbXSksXG4gICAgICAgIF0ubWFwKChtZW1iZXIpID0+ICh7IG5hbWU6IENhc2UucGFzY2FsKG1lbWJlci5uYW1lKSwgbWVtYmVyIH0pKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0eXBlLm1lbWJlcnMubWFwKChtZW1iZXIpID0+ICh7IG5hbWU6IG1lbWJlci5uYW1lLCBtZW1iZXIgfSkpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBfYWxsVHlwZXMoYXNzbTogc3BlYy5Bc3NlbWJseSk6IHNwZWMuVHlwZVtdIHtcbiAgcmV0dXJuIE9iamVjdC52YWx1ZXMoYXNzbS50eXBlcyA/PyB7fSk7XG59XG5cbmZ1bmN0aW9uIF9hbGxNZXRob2RzKFxuICBhc3NtOiBzcGVjLkFzc2VtYmx5LFxuKTogQXJyYXk8eyBtZW1iZXI6IHNwZWMuTWV0aG9kOyB0eXBlOiBzcGVjLlR5cGUgfT4ge1xuICBjb25zdCBtZXRob2RzID0gbmV3IEFycmF5PHsgbWVtYmVyOiBzcGVjLk1ldGhvZDsgdHlwZTogc3BlYy5UeXBlIH0+KCk7XG4gIGZvciAoY29uc3QgdHlwZSBvZiBfYWxsVHlwZXMoYXNzbSkpIHtcbiAgICBpZiAoIXNwZWMuaXNDbGFzc09ySW50ZXJmYWNlVHlwZSh0eXBlKSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGlmICghdHlwZS5tZXRob2RzKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgdHlwZS5tZXRob2RzLmZvckVhY2goKG1ldGhvZCkgPT4gbWV0aG9kcy5wdXNoKHsgbWVtYmVyOiBtZXRob2QsIHR5cGUgfSkpO1xuICB9XG4gIHJldHVybiBtZXRob2RzO1xufVxuXG5mdW5jdGlvbiBfYWxsUHJvcGVydGllcyhcbiAgYXNzbTogc3BlYy5Bc3NlbWJseSxcbik6IEFycmF5PHsgbWVtYmVyOiBzcGVjLlByb3BlcnR5OyB0eXBlOiBzcGVjLlR5cGUgfT4ge1xuICBjb25zdCBwcm9wZXJ0aWVzID0gbmV3IEFycmF5PHsgbWVtYmVyOiBzcGVjLlByb3BlcnR5OyB0eXBlOiBzcGVjLlR5cGUgfT4oKTtcbiAgZm9yIChjb25zdCB0eXBlIG9mIF9hbGxUeXBlcyhhc3NtKSkge1xuICAgIGlmICghc3BlYy5pc0NsYXNzT3JJbnRlcmZhY2VUeXBlKHR5cGUpKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgaWYgKCF0eXBlLnByb3BlcnRpZXMpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICB0eXBlLnByb3BlcnRpZXMuZm9yRWFjaCgocHJvcGVydHkpID0+XG4gICAgICBwcm9wZXJ0aWVzLnB1c2goeyBtZW1iZXI6IHByb3BlcnR5LCB0eXBlIH0pLFxuICAgICk7XG4gIH1cbiAgcmV0dXJuIHByb3BlcnRpZXM7XG59XG5cbmZ1bmN0aW9uIF9hbGxNZW1iZXJzKFxuICBhc3NtOiBzcGVjLkFzc2VtYmx5LFxuKTogQXJyYXk8eyBtZW1iZXI6IHNwZWMuUHJvcGVydHkgfCBzcGVjLk1ldGhvZDsgdHlwZTogc3BlYy5UeXBlIH0+IHtcbiAgcmV0dXJuIFsuLi5fYWxsTWV0aG9kcyhhc3NtKSwgLi4uX2FsbFByb3BlcnRpZXMoYXNzbSldO1xufVxuXG5pbnRlcmZhY2UgQW5ub3RhdGVkVHlwZVJlZmVyZW5jZSBleHRlbmRzIHNwZWMuTmFtZWRUeXBlUmVmZXJlbmNlIHtcbiAgcmVhZG9ubHkgbm9kZTogdHMuTm9kZSB8IHVuZGVmaW5lZDtcbn1cblxuZnVuY3Rpb24gX2FsbFR5cGVSZWZlcmVuY2VzKFxuICBhc3NtOiBzcGVjLkFzc2VtYmx5LFxuKTogcmVhZG9ubHkgQW5ub3RhdGVkVHlwZVJlZmVyZW5jZVtdIHtcbiAgY29uc3QgdHlwZVJlZmVyZW5jZXMgPSBuZXcgQXJyYXk8QW5ub3RhdGVkVHlwZVJlZmVyZW5jZT4oKTtcbiAgZm9yIChjb25zdCB0eXBlIG9mIF9hbGxUeXBlcyhhc3NtKSkge1xuICAgIGlmICghc3BlYy5pc0NsYXNzT3JJbnRlcmZhY2VUeXBlKHR5cGUpKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgaWYgKHNwZWMuaXNDbGFzc1R5cGUodHlwZSkpIHtcbiAgICAgIGNvbnN0IG5vZGUgPSBiaW5kaW5ncy5nZXRDbGFzc1JlbGF0ZWROb2RlKHR5cGUpO1xuICAgICAgaWYgKHR5cGUuYmFzZSkge1xuICAgICAgICB0eXBlUmVmZXJlbmNlcy5wdXNoKHtcbiAgICAgICAgICBmcW46IHR5cGUuYmFzZSxcbiAgICAgICAgICBub2RlOiBub2RlPy5oZXJpdGFnZUNsYXVzZXM/LmZpbmQoXG4gICAgICAgICAgICAoaGMpID0+IGhjLnRva2VuID09PSB0cy5TeW50YXhLaW5kLkV4dGVuZHNLZXl3b3JkLFxuICAgICAgICAgICk/LnR5cGVzWzBdLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGlmICh0eXBlLmluaXRpYWxpemVyPy5wYXJhbWV0ZXJzKSB7XG4gICAgICAgIGZvciAoY29uc3QgcGFyYW0gb2YgdHlwZS5pbml0aWFsaXplci5wYXJhbWV0ZXJzKSB7XG4gICAgICAgICAgX2NvbGxlY3RUeXBlUmVmZXJlbmNlcyhcbiAgICAgICAgICAgIHBhcmFtLnR5cGUsXG4gICAgICAgICAgICBiaW5kaW5ncy5nZXRQYXJhbWV0ZXJSZWxhdGVkTm9kZShwYXJhbSk/LnR5cGUsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodHlwZS5pbnRlcmZhY2VzKSB7XG4gICAgICBjb25zdCBub2RlID0gYmluZGluZ3MuZ2V0Q2xhc3NPckludGVyZmFjZVJlbGF0ZWROb2RlKHR5cGUpO1xuICAgICAgdHlwZS5pbnRlcmZhY2VzLmZvckVhY2goKGlmYWNlKSA9PlxuICAgICAgICB0eXBlUmVmZXJlbmNlcy5wdXNoKHtcbiAgICAgICAgICBmcW46IGlmYWNlLFxuICAgICAgICAgIG5vZGU6IG5vZGU/Lmhlcml0YWdlQ2xhdXNlcz8uZmluZChcbiAgICAgICAgICAgIChoYykgPT5cbiAgICAgICAgICAgICAgaGMudG9rZW4gPT09XG4gICAgICAgICAgICAgIChzcGVjLmlzSW50ZXJmYWNlVHlwZSh0eXBlKVxuICAgICAgICAgICAgICAgID8gdHMuU3ludGF4S2luZC5JbXBsZW1lbnRzS2V5d29yZFxuICAgICAgICAgICAgICAgIDogdHMuU3ludGF4S2luZC5FeHRlbmRzS2V5d29yZCksXG4gICAgICAgICAgKSxcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH1cbiAgfVxuICBmb3IgKGNvbnN0IHsgbWVtYmVyOiBwcm9wIH0gb2YgX2FsbFByb3BlcnRpZXMoYXNzbSkpIHtcbiAgICBfY29sbGVjdFR5cGVSZWZlcmVuY2VzKFxuICAgICAgcHJvcC50eXBlLFxuICAgICAgYmluZGluZ3MuZ2V0UHJvcGVydHlSZWxhdGVkTm9kZShwcm9wKT8udHlwZSxcbiAgICApO1xuICB9XG4gIGZvciAoY29uc3QgeyBtZW1iZXI6IG1ldGggfSBvZiBfYWxsTWV0aG9kcyhhc3NtKSkge1xuICAgIGlmIChtZXRoLnJldHVybnMpIHtcbiAgICAgIF9jb2xsZWN0VHlwZVJlZmVyZW5jZXMoXG4gICAgICAgIG1ldGgucmV0dXJucy50eXBlLFxuICAgICAgICBiaW5kaW5ncy5nZXRNZXRob2RSZWxhdGVkTm9kZShtZXRoKT8udHlwZSxcbiAgICAgICk7XG4gICAgfVxuICAgIGZvciAoY29uc3QgcGFyYW0gb2YgbWV0aC5wYXJhbWV0ZXJzID8/IFtdKSB7XG4gICAgICBfY29sbGVjdFR5cGVSZWZlcmVuY2VzKFxuICAgICAgICBwYXJhbS50eXBlLFxuICAgICAgICBiaW5kaW5ncy5nZXRQYXJhbWV0ZXJSZWxhdGVkTm9kZShwYXJhbSk/LnR5cGUsXG4gICAgICApO1xuICAgIH1cbiAgfVxuICByZXR1cm4gdHlwZVJlZmVyZW5jZXM7XG5cbiAgZnVuY3Rpb24gX2NvbGxlY3RUeXBlUmVmZXJlbmNlcyhcbiAgICB0eXBlOiBzcGVjLlR5cGVSZWZlcmVuY2UsXG4gICAgbm9kZTogdHMuTm9kZSB8IHVuZGVmaW5lZCxcbiAgKTogdm9pZCB7XG4gICAgaWYgKHNwZWMuaXNOYW1lZFR5cGVSZWZlcmVuY2UodHlwZSkpIHtcbiAgICAgIHR5cGVSZWZlcmVuY2VzLnB1c2goeyAuLi50eXBlLCBub2RlIH0pO1xuICAgIH0gZWxzZSBpZiAoc3BlYy5pc0NvbGxlY3Rpb25UeXBlUmVmZXJlbmNlKHR5cGUpKSB7XG4gICAgICBfY29sbGVjdFR5cGVSZWZlcmVuY2VzKHR5cGUuY29sbGVjdGlvbi5lbGVtZW50dHlwZSwgbm9kZSk7XG4gICAgfSBlbHNlIGlmIChzcGVjLmlzVW5pb25UeXBlUmVmZXJlbmNlKHR5cGUpKSB7XG4gICAgICB0eXBlLnVuaW9uLnR5cGVzLmZvckVhY2goKHR5cGUpID0+IF9jb2xsZWN0VHlwZVJlZmVyZW5jZXModHlwZSwgbm9kZSkpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBfZGVyZWZlcmVuY2UoXG4gIHR5cGVSZWY6IHN0cmluZyB8IHNwZWMuTmFtZWRUeXBlUmVmZXJlbmNlLFxuICBhc3NlbWJseTogc3BlYy5Bc3NlbWJseSxcbiAgdmFsaWRhdG9yOiBWYWxpZGF0b3IsXG4pOiBzcGVjLlR5cGUgfCB1bmRlZmluZWQge1xuICBpZiAodHlwZW9mIHR5cGVSZWYgIT09ICdzdHJpbmcnKSB7XG4gICAgdHlwZVJlZiA9IHR5cGVSZWYuZnFuO1xuICB9XG4gIGNvbnN0IFthc3NtXSA9IHR5cGVSZWYuc3BsaXQoJy4nKTtcbiAgaWYgKGFzc2VtYmx5Lm5hbWUgPT09IGFzc20pIHtcbiAgICByZXR1cm4gYXNzZW1ibHkudHlwZXM/Llt0eXBlUmVmXTtcbiAgfVxuICBjb25zdCBmb3JlaWduQXNzbSA9IHZhbGlkYXRvci5wcm9qZWN0SW5mby5kZXBlbmRlbmN5Q2xvc3VyZS5maW5kKFxuICAgIChkZXApID0+IGRlcC5uYW1lID09PSBhc3NtLFxuICApO1xuICByZXR1cm4gZm9yZWlnbkFzc20/LnR5cGVzPy5bdHlwZVJlZl07XG59XG5cbmZ1bmN0aW9uIF9pc0VtcHR5KGFycmF5OiB1bmRlZmluZWQgfCBhbnlbXSk6IGFycmF5IGlzIHVuZGVmaW5lZCB7XG4gIHJldHVybiBhcnJheSA9PSBudWxsIHx8IGFycmF5Lmxlbmd0aCA9PT0gMDtcbn1cblxuLyoqXG4gKiBSZXR1cm4gd2hldGhlciBhbiBpZGVudGlmaWVyIG9ubHkgY29uc2lzdHMgb2YgdXBwZXJjaGFzZSBjaGFyYWN0ZXJzLCBkaWdpdHMgYW5kIHVuZGVyc2NvcmVzXG4gKlxuICogV2UgaGF2ZSBvdXIgb3duIGNoZWNrIGhlcmUgKGlzQ29uc3RhbnRDYXNlKSB3aGljaCBpcyBtb3JlIGxlbmllbnQgdGhhbiB3aGF0XG4gKiBgY2FzZS5jb25zdGFudCgpYCBwcmVzY3JpYmVzLiBXZSBhbHNvIHdhbnQgdG8gYWxsb3cgY29tYmluYXRpb25zIG9mIGxldHRlcnNcbiAqIGFuZCBkaWdpdHMgd2l0aG91dCB1bmRlcnNjb3JlczogYEM1QWAsIHdoaWNoIGBjYXNlYCB3b3VsZCBmb3JjZSB0byBgQzVfQWAuXG4gKiBUaGUgaGludCB3ZSBwcmludCB3aWxsIHN0aWxsIHVzZSBgY2FzZS5jb25zdGFudCgpYCBidXQgdGhhdCBpcyBmaW5lLlxuICovXG5mdW5jdGlvbiBpc0NvbnN0YW50Q2FzZSh4OiBzdHJpbmcpIHtcbiAgcmV0dXJuICEvW15BLVowLTlfXS8uZXhlYyh4KTtcbn1cbiJdfQ==
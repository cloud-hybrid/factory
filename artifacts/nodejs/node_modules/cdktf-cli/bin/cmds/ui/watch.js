"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Watch = void 0;
const react_1 = __importStar(require("react"));
const ink_1 = require("ink");
const ink_spinner_1 = __importDefault(require("ink-spinner"));
const strip_ansi_1 = __importDefault(require("strip-ansi"));
const ink_use_stdout_dimensions_1 = __importDefault(require("ink-use-stdout-dimensions"));
const client_1 = require("@apollo/client");
const format_1 = __importDefault(require("date-fns/format"));
const StatusBox = ({ status, stackName, error, }) => {
    const [didDeployAlready, setDidDeployAlready] = react_1.useState(false);
    react_1.useEffect(() => {
        if (status === "DEPLOYING" && !didDeployAlready)
            setDidDeployAlready(true);
    }, [didDeployAlready, status]);
    let statusText = react_1.default.createElement(ink_1.Text, null, status);
    const stack = stackName ? react_1.default.createElement(ink_1.Text, { color: "blueBright" }, stackName) : null;
    switch (status) {
        case "IDLE":
            statusText = (react_1.default.createElement(ink_1.Text, null,
                didDeployAlready && !error && "Deployment done. ",
                "Watching ",
                stack,
                stack && " ",
                "for changes"));
            break;
        case "DEPLOYING":
            statusText = react_1.default.createElement(ink_1.Text, null,
                "Deploying ",
                stack || "stack");
            break;
        case "SYNTHESIZING":
            statusText = react_1.default.createElement(ink_1.Text, null,
                "Synthesizing ",
                stack || "stack");
            break;
        case "INITIALIZING":
            statusText = react_1.default.createElement(ink_1.Text, null,
                "Initializing Terraform for ",
                stack || "stack");
            break;
        case "CONNECTING":
            statusText = react_1.default.createElement(ink_1.Text, null, "Connecting");
            break;
    }
    if (status === "IDLE") {
        return (react_1.default.createElement(ink_1.Box, null,
            react_1.default.createElement(ink_1.Text, null),
            react_1.default.createElement(ink_1.Box, null, statusText)));
    }
    return (react_1.default.createElement(ink_1.Box, null,
        react_1.default.createElement(ink_1.Text, { color: "green" },
            react_1.default.createElement(ink_spinner_1.default, { type: "dots" })),
        react_1.default.createElement(ink_1.Box, { paddingLeft: 1 }, statusText)));
};
const DeployedResource = ({ resource, columns, }) => {
    let color = undefined;
    let icon = " ";
    switch (resource.deployState) {
        case "CREATING":
            color = "greenBright";
            icon = react_1.default.createElement(ink_spinner_1.default, { type: "dots" });
            break;
        case "CREATED":
            color = "greenBright";
            icon = "+";
            break;
        case "UPDATING":
            icon = react_1.default.createElement(ink_spinner_1.default, { type: "dots" });
            color = "yellowBright";
            break;
        case "UPDATED":
            color = "yellowBright";
            icon = "~";
            break;
        case "DESTROYING":
            icon = react_1.default.createElement(ink_spinner_1.default, { type: "dots" });
            color = "redBright";
            break;
        case "DESTROYED":
            color = "redBright";
            icon = "-";
            break;
        case "WAITING":
            icon = react_1.default.createElement(ink_spinner_1.default, { type: "dots" });
            break;
        case "ERROR":
        case "SUCCESS":
            break;
    }
    return (react_1.default.createElement(ink_1.Box, { width: columns },
        react_1.default.createElement(ink_1.Text, { color: color },
            icon,
            " ",
            resource.id),
        react_1.default.createElement(ink_1.Spacer, null),
        react_1.default.createElement(ink_1.Text, { color: "gray" }, format_1.default(new Date(resource.changedAt), "pp"))));
};
const resourceIsInProgress = (resource) => {
    return ["WAITING", "UPDATING", "CREATING", "DESTROYING"].includes(resource.deployState);
};
const DeployingResources = ({ resources, columns, }) => {
    const inProgressResources = react_1.useMemo(() => (resources === null || resources === void 0 ? void 0 : resources.filter(resourceIsInProgress)) || [], [resources]);
    return (react_1.default.createElement(ink_1.Box, { flexDirection: "column" }, inProgressResources.map((r) => (react_1.default.createElement(DeployedResource, { key: r.id, columns: columns, resource: r })))));
};
const DeployedResources = ({ resources, columns, }) => {
    const [finishedResourcesHistory, setFinishedResourcesHistory] = react_1.useState([]);
    react_1.useEffect(() => {
        const doneResources = (resources === null || resources === void 0 ? void 0 : resources.filter((r) => !resourceIsInProgress(r))) || [];
        setFinishedResourcesHistory((hist) => {
            const newDoneResources = doneResources.filter((newDone) => 
            // skips items that already exist with the same id and timestamp
            !hist.some((existingDone) => existingDone.id === newDone.id &&
                existingDone.changedAt === newDone.changedAt));
            return hist.concat(newDoneResources);
        });
    }, [resources]);
    return (react_1.default.createElement(ink_1.Static, { items: finishedResourcesHistory }, (r) => react_1.default.createElement(DeployedResource, { key: r.id, resource: r, columns: columns })));
};
const ErrorComponent = ({ error, }) => {
    if (!error.recoverable) {
        throw new Error(`${error.origin}: ${error.message}`);
    }
    return (react_1.default.createElement(ink_1.Text, { color: "redBright" },
        error.origin,
        ": ",
        strip_ansi_1.default(error.message)));
};
const WATCH = client_1.gql `
  subscription Watch(
    $dir: String!
    $stack: String
    $cmd: String!
    $aprv: Boolean!
  ) {
    watch(
      inputs: {
        autoApprove: $aprv
        targetDir: $dir
        targetStack: $stack
        synthCommand: $cmd
      }
    ) {
      status
      stacks {
        name
      }
      resources {
        id
        action
        deployState
        changedAt
      }
      error {
        message
        recoverable
        origin
      }
    }
  }
`;
exports.Watch = ({ targetDir, targetStack, synthCommand, autoApprove, }) => {
    var _a;
    const [columns] = ink_use_stdout_dimensions_1.default();
    const { error, data } = client_1.useSubscription(WATCH, {
        variables: {
            dir: targetDir,
            stack: targetStack,
            cmd: synthCommand,
            aprv: autoApprove,
        },
    });
    const watchedStackName = targetStack || ((_a = data === null || data === void 0 ? void 0 : data.watch.stacks.find((_, idx) => idx === 0)) === null || _a === void 0 ? void 0 : _a.name);
    const status = (data === null || data === void 0 ? void 0 : data.watch.status) || "CONNECTING";
    if (error)
        console.error("uncaught error ", error);
    return (react_1.default.createElement(react_1.default.Fragment, null,
        react_1.default.createElement(DeployedResources, { resources: data === null || data === void 0 ? void 0 : data.watch.resources, columns: columns }),
        (data === null || data === void 0 ? void 0 : data.watch.error) && react_1.default.createElement(ErrorComponent, { error: data.watch.error }),
        react_1.default.createElement(ink_1.Box, { flexDirection: "column" },
            status === "DEPLOYING" && (react_1.default.createElement(DeployingResources, { resources: data === null || data === void 0 ? void 0 : data.watch.resources, columns: columns })),
            react_1.default.createElement(StatusBox, { status: status, stackName: watchedStackName, error: data === null || data === void 0 ? void 0 : data.watch.error }))));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2F0Y2guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ3YXRjaC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLCtDQUE0RDtBQUM1RCw2QkFBZ0Q7QUFFaEQsOERBQWtDO0FBQ2xDLDREQUFtQztBQUNuQywwRkFBNEQ7QUFDNUQsMkNBQXNEO0FBRXRELDZEQUFxQztBQUVyQyxNQUFNLFNBQVMsR0FBRyxDQUFDLEVBQ2pCLE1BQU0sRUFDTixTQUFTLEVBQ1QsS0FBSyxHQUtOLEVBQUUsRUFBRTtJQUNILE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxtQkFBbUIsQ0FBQyxHQUFHLGdCQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEUsaUJBQVMsQ0FBQyxHQUFHLEVBQUU7UUFDYixJQUFJLE1BQU0sS0FBSyxXQUFXLElBQUksQ0FBQyxnQkFBZ0I7WUFBRSxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3RSxDQUFDLEVBQUUsQ0FBQyxnQkFBZ0IsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBRS9CLElBQUksVUFBVSxHQUFHLDhCQUFDLFVBQUksUUFBRSxNQUFNLENBQVEsQ0FBQztJQUN2QyxNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLDhCQUFDLFVBQUksSUFBQyxLQUFLLEVBQUMsWUFBWSxJQUFFLFNBQVMsQ0FBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDN0UsUUFBUSxNQUFNLEVBQUU7UUFDZCxLQUFLLE1BQU07WUFDVCxVQUFVLEdBQUcsQ0FDWCw4QkFBQyxVQUFJO2dCQUNGLGdCQUFnQixJQUFJLENBQUMsS0FBSyxJQUFJLG1CQUFtQjs7Z0JBQ3hDLEtBQUs7Z0JBQ2QsS0FBSyxJQUFJLEdBQUc7OEJBQ1IsQ0FDUixDQUFDO1lBQ0YsTUFBTTtRQUNSLEtBQUssV0FBVztZQUNkLFVBQVUsR0FBRyw4QkFBQyxVQUFJOztnQkFBWSxLQUFLLElBQUksT0FBTyxD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SUFDakIsU0FBUyxFQUFFLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxLQUFLLENBQUMsU0FBUyxFQUNoQyxPQUFPLEVBQUUsT0FBTyxHQUNoQixDQUNIO1lBQ0QsOEJBQUMsU0FBUyxJQUNSLE1BQU0sRUFBRSxNQUFNLEVBQ2QsU0FBUyxFQUFFLGdCQUFnQixFQUMzQixLQUFLLEVBQUUsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLEtBQUssQ0FBQyxLQUFLLEdBQ3hCLENBQ0UsQ0FDTCxDQUNKLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgdXNlRWZmZWN0LCB1c2VNZW1vLCB1c2VTdGF0ZSB9IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0IHsgVGV4dCwgQm94LCBTdGF0aWMsIFNwYWNlciB9IGZyb20gXCJpbmtcIjtcbmltcG9ydCB7IFByb3BzIGFzIFRleHRQcm9wcyB9IGZyb20gXCJpbmsvYnVpbGQvY29tcG9uZW50cy9UZXh0XCI7XG5pbXBvcnQgU3Bpbm5lciBmcm9tIFwiaW5rLXNwaW5uZXJcIjtcbmltcG9ydCBzdHJpcEFuc2kgZnJvbSBcInN0cmlwLWFuc2lcIjtcbmltcG9ydCB1c2VTdGRvdXREaW1lbnNpb25zIGZyb20gXCJpbmstdXNlLXN0ZG91dC1kaW1lbnNpb25zXCI7XG5pbXBvcnQgeyBncWwsIHVzZVN1YnNjcmlwdGlvbiB9IGZyb20gXCJAYXBvbGxvL2NsaWVudFwiO1xuaW1wb3J0IHsgR3JhcGhRTFdhdGNoU3RhdGUgfSBmcm9tIFwiLi4vLi4vLi4vbGliL3NlcnZlci91dGlsXCI7XG5pbXBvcnQgZm9ybWF0IGZyb20gXCJkYXRlLWZucy9mb3JtYXRcIjtcblxuY29uc3QgU3RhdHVzQm94ID0gKHtcbiAgc3RhdHVzLFxuICBzdGFja05hbWUsXG4gIGVycm9yLFxufToge1xuICBzdGF0dXM6IHN0cmluZztcbiAgc3RhY2tOYW1lPzogc3RyaW5nO1xuICBlcnJvcj86IEdyYXBoUUxXYXRjaFN0YXRlW1wiZXJyb3JcIl07XG59KSA9PiB7XG4gIGNvbnN0IFtkaWREZXBsb3lBbHJlYWR5LCBzZXREaWREZXBsb3lBbHJlYWR5XSA9IHVzZVN0YXRlKGZhbHNlKTtcbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoc3RhdHVzID09PSBcIkRFUExPWUlOR1wiICYmICFkaWREZXBsb3lBbHJlYWR5KSBzZXREaWREZXBsb3lBbHJlYWR5KHRydWUpO1xuICB9LCBbZGlkRGVwbG95QWxyZWFkeSwgc3RhdHVzXSk7XG5cbiAgbGV0IHN0YXR1c1RleHQgPSA8VGV4dD57c3RhdHVzfTwvVGV4dD47XG4gIGNvbnN0IHN0YWNrID0gc3RhY2tOYW1lID8gPFRleHQgY29sb3I9XCJibHVlQnJpZ2h0XCI+e3N0YWNrTmFtZX08L1RleHQ+IDogbnVsbDtcbiAgc3dpdGNoIChzdGF0dXMpIHtcbiAgICBjYXNlIFwiSURMRVwiOlxuICAgICAgc3RhdHVzVGV4dCA9IChcbiAgICAgICAgPFRleHQ+XG4gICAgICAgICAge2RpZERlcGxveUFscmVhZHkgJiYgIWVycm9yICYmIFwiRGVwbG95bWVudCBkb25lLiBcIn1cbiAgICAgICAgICBXYXRjaGluZyB7c3RhY2t9XG4gICAgICAgICAge3N0YWNrICYmIFwiIFwifWZvciBjaGFuZ2VzXG4gICAgICAgIDwvVGV4dD5cbiAgICAgICk7XG4gICAgICBicmVhaztcbiAgICBjYXNlIFwiREVQTE9ZSU5HXCI6XG4gICAgICBzdGF0dXNUZXh0ID0gPFRleHQ+RGVwbG95aW5nIHtzdGFjayB8fCBcInN0YWNrXCJ9PC9UZXh0PjtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgXCJTWU5USEVTSVpJTkdcIjpcbiAgICAgIHN0YXR1c1RleHQgPSA8VGV4dD5TeW50aGVzaXppbmcge3N0YWNrIHx8IFwic3RhY2tcIn08L1RleHQ+O1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSBcIklOSVRJQUxJWklOR1wiOlxuICAgICAgc3RhdHVzVGV4dCA9IDxUZXh0PkluaXRpYWxpemluZyBUZXJyYWZvcm0gZm9yIHtzdGFjayB8fCBcInN0YWNrXCJ9PC9UZXh0PjtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgXCJDT05ORUNUSU5HXCI6XG4gICAgICBzdGF0dXNUZXh0ID0gPFRleHQ+Q29ubmVjdGluZzwvVGV4dD47XG4gICAgICBicmVhaztcbiAgfVxuXG4gIGlmIChzdGF0dXMgPT09IFwiSURMRVwiKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxCb3g+XG4gICAgICAgIHsvKiBlbXB0eSBUZXh0IGlzIHNvbWVob3cgbmVlZGVkIGZvciBzaG93aW5nL2hpZGluZ1xuICAgICAgICAgU3Bpbm5lciBjb21wb25lbnQgd2hlbiBzdGF0dXMgY2hhbmdlcyAqL31cbiAgICAgICAgPFRleHQ+PC9UZXh0PlxuICAgICAgICA8Qm94PntzdGF0dXNUZXh0fTwvQm94PlxuICAgICAgPC9Cb3g+XG4gICAgKTtcbiAgfVxuICByZXR1cm4gKFxuICAgIDxCb3g+XG4gICAgICA8VGV4dCBjb2xvcj1cImdyZWVuXCI+XG4gICAgICAgIDxTcGlubmVyIHR5cGU9XCJkb3RzXCIgLz5cbiAgICAgIDwvVGV4dD5cbiAgICAgIDxCb3ggcGFkZGluZ0xlZnQ9ezF9PntzdGF0dXNUZXh0fTwvQm94PlxuICAgIDwvQm94PlxuICApO1xufTtcblxuY29uc3QgRGVwbG95ZWRSZXNvdXJjZSA9ICh7XG4gIHJlc291cmNlLFxuICBjb2x1bW5zLFxufToge1xuICByZXNvdXJjZTogR3JhcGhRTFdhdGNoU3RhdGVbXCJyZXNvdXJjZXNcIl1bbnVtYmVyXTtcbiAgY29sdW1uczogbnVtYmVyO1xufSkgPT4ge1xuICBsZXQgY29sb3I6IFRleHRQcm9wc1tcImNvbG9yXCJdIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuICBsZXQgaWNvbjogc3RyaW5nIHwgUmVhY3QuUmVhY3ROb2RlID0gXCIgXCI7XG4gIHN3aXRjaCAocmVzb3VyY2UuZGVwbG95U3RhdGUpIHtcbiAgICBjYXNlIFwiQ1JFQVRJTkdcIjpcbiAgICAgIGNvbG9yID0gXCJncmVlbkJyaWdodFwiO1xuICAgICAgaWNvbiA9IDxTcGlubmVyIHR5cGU9XCJkb3RzXCIgLz47XG4gICAgICBicmVhaztcbiAgICBjYXNlIFwiQ1JFQVRFRFwiOlxuICAgICAgY29sb3IgPSBcImdyZWVuQnJpZ2h0XCI7XG4gICAgICBpY29uID0gXCIrXCI7XG4gICAgICBicmVhaztcbiAgICBjYXNlIFwiVVBEQVRJTkdcIjpcbiAgICAgIGljb24gPSA8U3Bpbm5lciB0eXBlPVwiZG90c1wiIC8+O1xuICAgICAgY29sb3IgPSBcInllbGxvd0JyaWdodFwiO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSBcIlVQREFURURcIjpcbiAgICAgIGNvbG9yID0gXCJ5ZWxsb3dCcmlnaHRcIjtcbiAgICAgIGljb24gPSBcIn5cIjtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgXCJERVNUUk9ZSU5HXCI6XG4gICAgICBpY29uID0gPFNwaW5uZXIgdHlwZT1cImRvdHNcIiAvPjtcbiAgICAgIGNvbG9yID0gXCJyZWRCcmlnaHRcIjtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgXCJERVNUUk9ZRURcIjpcbiAgICAgIGNvbG9yID0gXCJyZWRCcmlnaHRcIjtcbiAgICAgIGljb24gPSBcIi1cIjtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgXCJXQUlUSU5HXCI6XG4gICAgICBpY29uID0gPFNwaW5uZXIgdHlwZT1cImRvdHNcIiAvPjtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgXCJFUlJPUlwiOlxuICAgIGNhc2UgXCJTVUNDRVNTXCI6XG4gICAgICBicmVhaztcbiAgfVxuXG4gIHJldHVybiAoXG4gICAgPEJveCB3aWR0aD17Y29sdW1uc30+XG4gICAgICA8VGV4dCBjb2xvcj17Y29sb3J9PlxuICAgICAgICB7aWNvbn0ge3Jlc291cmNlLmlkfVxuICAgICAgPC9UZXh0PlxuICAgICAgPFNwYWNlciAvPlxuICAgICAgPFRleHQgY29sb3I9XCJncmF5XCI+e2Zvcm1hdChuZXcgRGF0ZShyZXNvdXJjZS5jaGFuZ2VkQXQpLCBcInBwXCIpfTwvVGV4dD5cbiAgICA8L0JveD5cbiAgKTtcbn07XG5cbmNvbnN0IHJlc291cmNlSXNJblByb2dyZXNzID0gKFxuICByZXNvdXJjZTogR3JhcGhRTFdhdGNoU3RhdGVbXCJyZXNvdXJjZXNcIl1bbnVtYmVyXVxuKSA9PiB7XG4gIHJldHVybiBbXCJXQUlUSU5HXCIsIFwiVVBEQVRJTkdcIiwgXCJDUkVBVElOR1wiLCBcIkRFU1RST1lJTkdcIl0uaW5jbHVkZXMoXG4gICAgcmVzb3VyY2UuZGVwbG95U3RhdGVcbiAgKTtcbn07XG5cbmNvbnN0IERlcGxveWluZ1Jlc291cmNlcyA9ICh7XG4gIHJlc291cmNlcyxcbiAgY29sdW1ucyxcbn06IHtcbiAgcmVzb3VyY2VzPzogR3JhcGhRTFdhdGNoU3RhdGVbXCJyZXNvdXJjZXNcIl07XG4gIGNvbHVtbnM6IG51bWJlcjtcbn0pID0+IHtcbiAgY29uc3QgaW5Qcm9ncmVzc1Jlc291cmNlcyA9IHVzZU1lbW8oXG4gICAgKCkgPT4gcmVzb3VyY2VzPy5maWx0ZXIocmVzb3VyY2VJc0luUHJvZ3Jlc3MpIHx8IFtdLFxuICAgIFtyZXNvdXJjZXNdXG4gICk7XG5cbiAgcmV0dXJuIChcbiAgICA8Qm94IGZsZXhEaXJlY3Rpb249XCJjb2x1bW5cIj5cbiAgICAgIHtpblByb2dyZXNzUmVzb3VyY2VzLm1hcCgocikgPT4gKFxuICAgICAgICA8RGVwbG95ZWRSZXNvdXJjZSBrZXk9e3IuaWR9IGNvbHVtbnM9e2NvbHVtbnN9IHJlc291cmNlPXtyfSAvPlxuICAgICAgKSl9XG4gICAgPC9Cb3g+XG4gICk7XG59O1xuXG5jb25zdCBEZXBsb3llZFJlc291cmNlcyA9ICh7XG4gIHJlc291cmNlcyxcbiAgY29sdW1ucyxcbn06IHtcbiAgcmVzb3VyY2VzPzogR3JhcGhRTFdhdGNoU3RhdGVbXCJyZXNvdXJjZXNcIl07XG4gIGNvbHVtbnM6IG51bWJlcjtcbn0pID0+IHtcbiAgY29uc3QgW2ZpbmlzaGVkUmVzb3VyY2VzSGlzdG9yeSwgc2V0RmluaXNoZWRSZXNvdXJjZXNIaXN0b3J5XSA9IHVzZVN0YXRlPFxuICAgIEdyYXBoUUxXYXRjaFN0YXRlW1wicmVzb3VyY2VzXCJdXG4gID4oW10pO1xuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgY29uc3QgZG9uZVJlc291cmNlcyA9XG4gICAgICByZXNvdXJjZXM/LmZpbHRlcigocikgPT4gIXJlc291cmNlSXNJblByb2dyZXNzKHIpKSB8fCBbXTtcbiAgICBzZXRGaW5pc2hlZFJlc291cmNlc0hpc3RvcnkoKGhpc3QpID0+IHtcbiAgICAgIGNvbnN0IG5ld0RvbmVSZXNvdXJjZXMgPSBkb25lUmVzb3VyY2VzLmZpbHRlcihcbiAgICAgICAgKG5ld0RvbmUpID0+XG4gICAgICAgICAgLy8gc2tpcHMgaXRlbXMgdGhhdCBhbHJlYWR5IGV4aXN0IHdpdGggdGhlIHNhbWUgaWQgYW5kIHRpbWVzdGFtcFxuICAgICAgICAgICFoaXN0LnNvbWUoXG4gICAgICAgICAgICAoZXhpc3RpbmdEb25lKSA9PlxuICAgICAgICAgICAgICBleGlzdGluZ0RvbmUuaWQgPT09IG5ld0RvbmUuaWQgJiZcbiAgICAgICAgICAgICAgZXhpc3RpbmdEb25lLmNoYW5nZWRBdCA9PT0gbmV3RG9uZS5jaGFuZ2VkQXRcbiAgICAgICAgICApXG4gICAgICApO1xuICAgICAgcmV0dXJuIGhpc3QuY29uY2F0KG5ld0RvbmVSZXNvdXJjZXMpO1xuICAgIH0pO1xuICB9LCBbcmVzb3VyY2VzXSk7XG5cbiAgcmV0dXJuIChcbiAgICA8U3RhdGljIGl0ZW1zPXtmaW5pc2hlZFJlc291cmNlc0hpc3Rvcnl9PlxuICAgICAgeyhyKSA9PiA8RGVwbG95ZWRSZXNvdXJjZSBrZXk9e3IuaWR9IHJlc291cmNlPXtyfSBjb2x1bW5zPXtjb2x1bW5zfSAvPn1cbiAgICA8L1N0YXRpYz5cbiAgKTtcbn07XG5cbmNvbnN0IEVycm9yQ29tcG9uZW50ID0gKHtcbiAgZXJyb3IsXG59OiB7XG4gIGVycm9yOiBOb25OdWxsYWJsZTxHcmFwaFFMV2F0Y2hTdGF0ZVtcImVycm9yXCJdPjtcbn0pID0+IHtcbiAgaWYgKCFlcnJvci5yZWNvdmVyYWJsZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgJHtlcnJvci5vcmlnaW59OiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gIH1cbiAgcmV0dXJuIChcbiAgICA8VGV4dCBjb2xvcj1cInJlZEJyaWdodFwiPlxuICAgICAge2Vycm9yLm9yaWdpbn06IHtzdHJpcEFuc2koZXJyb3IubWVzc2FnZSl9XG4gICAgPC9UZXh0PlxuICApO1xufTtcblxuaW50ZXJmYWNlIFdhdGNoQ29uZmlnIHtcbiAgdGFyZ2V0RGlyOiBzdHJpbmc7XG4gIHRhcmdldFN0YWNrPzogc3RyaW5nO1xuICBzeW50aENvbW1hbmQ6IHN0cmluZztcbiAgYXV0b0FwcHJvdmU6IGJvb2xlYW47XG59XG5cbmNvbnN0IFdBVENIID0gZ3FsYFxuICBzdWJzY3JpcHRpb24gV2F0Y2goXG4gICAgJGRpcjogU3RyaW5nIVxuICAgICRzdGFjazogU3RyaW5nXG4gICAgJGNtZDogU3RyaW5nIVxuICAgICRhcHJ2OiBCb29sZWFuIVxuICApIHtcbiAgICB3YXRjaChcbiAgICAgIGlucHV0czoge1xuICAgICAgICBhdXRvQXBwcm92ZTogJGFwcnZcbiAgICAgICAgdGFyZ2V0RGlyOiAkZGlyXG4gICAgICAgIHRhcmdldFN0YWNrOiAkc3RhY2tcbiAgICAgICAgc3ludGhDb21tYW5kOiAkY21kXG4gICAgICB9XG4gICAgKSB7XG4gICAgICBzdGF0dXNcbiAgICAgIHN0YWNrcyB7XG4gICAgICAgIG5hbWVcbiAgICAgIH1cbiAgICAgIHJlc291cmNlcyB7XG4gICAgICAgIGlkXG4gICAgICAgIGFjdGlvblxuICAgICAgICBkZXBsb3lTdGF0ZVxuICAgICAgICBjaGFuZ2VkQXRcbiAgICAgIH1cbiAgICAgIGVycm9yIHtcbiAgICAgICAgbWVzc2FnZVxuICAgICAgICByZWNvdmVyYWJsZVxuICAgICAgICBvcmlnaW5cbiAgICAgIH1cbiAgICB9XG4gIH1cbmA7XG5cbmV4cG9ydCBjb25zdCBXYXRjaCA9ICh7XG4gIHRhcmdldERpcixcbiAgdGFyZ2V0U3RhY2ssXG4gIHN5bnRoQ29tbWFuZCxcbiAgYXV0b0FwcHJvdmUsXG59OiBXYXRjaENvbmZpZyk6IFJlYWN0LlJlYWN0RWxlbWVudCA9PiB7XG4gIGNvbnN0IFtjb2x1bW5zXSA9IHVzZVN0ZG91dERpbWVuc2lvbnMoKTtcbiAgY29uc3QgeyBlcnJvciwgZGF0YSB9ID0gdXNlU3Vic2NyaXB0aW9uKFdBVENILCB7XG4gICAgdmFyaWFibGVzOiB7XG4gICAgICBkaXI6IHRhcmdldERpcixcbiAgICAgIHN0YWNrOiB0YXJnZXRTdGFjayxcbiAgICAgIGNtZDogc3ludGhDb21tYW5kLFxuICAgICAgYXBydjogYXV0b0FwcHJvdmUsXG4gICAgfSxcbiAgfSk7XG4gIGNvbnN0IHdhdGNoZWRTdGFja05hbWUgPVxuICAgIHRhcmdldFN0YWNrIHx8XG4gICAgZGF0YT8ud2F0Y2guc3RhY2tzLmZpbmQoKF86IGFueSwgaWR4OiBudW1iZXIpID0+IGlkeCA9PT0gMCk/Lm5hbWU7XG4gIGNvbnN0IHN0YXR1cyA9IGRhdGE/LndhdGNoLnN0YXR1cyB8fCBcIkNPTk5FQ1RJTkdcIjtcblxuICBpZiAoZXJyb3IpIGNvbnNvbGUuZXJyb3IoXCJ1bmNhdWdodCBlcnJvciBcIiwgZXJyb3IpO1xuXG4gIHJldHVybiAoXG4gICAgPD5cbiAgICAgIDxEZXBsb3llZFJlc291cmNlcyByZXNvdXJjZXM9e2RhdGE/LndhdGNoLnJlc291cmNlc30gY29sdW1ucz17Y29sdW1uc30gLz5cbiAgICAgIHtkYXRhPy53YXRjaC5lcnJvciAmJiA8RXJyb3JDb21wb25lbnQgZXJyb3I9e2RhdGEud2F0Y2guZXJyb3J9IC8+fVxuICAgICAgPEJveCBmbGV4RGlyZWN0aW9uPVwiY29sdW1uXCI+XG4gICAgICAgIHtzdGF0dXMgPT09IFwiREVQTE9ZSU5HXCIgJiYgKFxuICAgICAgICAgIDxEZXBsb3lpbmdSZXNvdXJjZXNcbiAgICAgICAgICAgIHJlc291cmNlcz17ZGF0YT8ud2F0Y2gucmVzb3VyY2VzfVxuICAgICAgICAgICAgY29sdW1ucz17Y29sdW1uc31cbiAgICAgICAgICAvPlxuICAgICAgICApfVxuICAgICAgICA8U3RhdHVzQm94XG4gICAgICAgICAgc3RhdHVzPXtzdGF0dXN9XG4gICAgICAgICAgc3RhY2tOYW1lPXt3YXRjaGVkU3RhY2tOYW1lfVxuICAgICAgICAgIGVycm9yPXtkYXRhPy53YXRjaC5lcnJvcn1cbiAgICAgICAgLz5cbiAgICAgIDwvQm94PlxuICAgIDwvPlxuICApO1xufTtcbiJdfQ==
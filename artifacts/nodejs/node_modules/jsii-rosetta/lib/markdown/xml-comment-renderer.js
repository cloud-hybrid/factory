"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CSharpXmlCommentRenderer = void 0;
const escapes_1 = require("./escapes");
const markdown_1 = require("./markdown");
const markdown_renderer_1 = require("./markdown-renderer");
const ESCAPE = escapes_1.makeXmlEscaper();
// The types for 'xmldom' are not complete.
/* eslint-disable-next-line @typescript-eslint/no-var-requires,@typescript-eslint/no-require-imports */
const { DOMParser, XMLSerializer } = require('@xmldom/xmldom');
/**
 * A renderer that will render a CommonMark tree to .NET XML comments
 *
 * Mostly concerns itself with code annotations and escaping; tags that the
 * XML formatter doesn't have equivalents for will be rendered back to MarkDown.
 */
class CSharpXmlCommentRenderer extends markdown_renderer_1.MarkdownRenderer {
    block_quote(_node, context) {
        return markdown_renderer_1.para(markdown_1.prefixLines('    ', markdown_renderer_1.stripPara(context.content())));
    }
    code(node, _context) {
        return `<c>${ESCAPE.text(node.literal)}</c>`;
    }
    code_block(node, _context) {
        return markdown_renderer_1.para(`<code><![CDATA[\n${node.literal}]]></code>`);
    }
    text(node, _context) {
        var _a;
        return (_a = ESCAPE.text(node.literal)) !== null && _a !== void 0 ? _a : '';
    }
    link(node, context) {
        var _a;
        return `<a href="${(_a = ESCAPE.attribute(node.destination)) !== null && _a !== void 0 ? _a : ''}">${context.content()}</a>`;
    }
    image(node, context) {
        var _a;
        return `<img alt="${ESCAPE.text2attr(context.content())}" src="${(_a = ESCAPE.attribute(node.destination)) !== null && _a !== void 0 ? _a : ''}" />`;
    }
    emph(_node, context) {
        return `<em>${context.content()}</em>`;
    }
    strong(_node, context) {
        return `<strong>${context.content()}</strong>`;
    }
    heading(node, context) {
        return markdown_renderer_1.para(`<h${node.level}>${context.content()}</h${node.level}>`);
    }
    list(node, context) {
        const listType = node.listType === 'bullet' ? 'bullet' : 'number';
        return markdown_renderer_1.para(`<list type="${listType}">\n${context.content()}</list>`);
    }
    item(_node, context) {
        return `<description>${markdown_renderer_1.stripPara(context.content())}</description>\n`;
    }
    thematic_break(_node, _context) {
        return markdown_renderer_1.para('<hr />');
    }
    /**
     * HTML needs to be converted to XML
     *
     * If we don't do this, the parser will reject the whole XML block once it seens an unclosed
     * <img> tag.
     */
    html_inline(node, _context) {
        var _a;
        const html = (_a = node.literal) !== null && _a !== void 0 ? _a : '';
        try {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            return new XMLSerializer().serializeToString(doc);
        }
        catch {
            // Could not parse - we'll escape unsafe XML entities here...
            return html.replace(/[<>&]/g, (char) => {
                switch (char) {
                    case '&':
                        return '&amp;';
                    case '<':
                        return '&lt;';
                    case '>':
                        return '&gt;';
                    default:
                        return char;
                }
            });
        }
    }
    /**
     * HTML needs to be converted to XML
     *
     * If we don't do this, the parser will reject the whole XML block once it seens an unclosed
     * <img> tag.
     */
    html_block(node, context) {
        return this.html_inline(node, context);
    }
}
exports.CSharpXmlCommentRenderer = CSharpXmlCommentRenderer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieG1sLWNvbW1lbnQtcmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ4bWwtY29tbWVudC1yZW5kZXJlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSx1Q0FBMkM7QUFDM0MseUNBQTBEO0FBQzFELDJEQUF3RTtBQUV4RSxNQUFNLE1BQU0sR0FBRyx3QkFBYyxFQUFFLENBQUM7QUFFaEMsMkNBQTJDO0FBQzNDLHVHQUF1RztBQUN2RyxNQUFNLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBRS9EOzs7OztHQUtHO0FBQ0gsTUFBYSx3QkFBeUIsU0FBUSxvQ0FBZ0I7SUFDckQsV0FBVyxDQUFDLEtBQWMsRUFBRSxPQUF3QjtRQUN6RCxPQUFPLHdCQUFJLENBQUMsc0JBQVcsQ0FBQyxNQUFNLEVBQUUsNkJBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVNLElBQUksQ0FBQyxJQUFhLEVBQUUsUUFBeUI7UUFDbEQsT0FBTyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7SUFDL0MsQ0FBQztJQUVNLFVBQVUsQ0FBQyxJQUFhLEVBQUUsUUFBeUI7UUFDeEQsT0FBTyx3QkFBSSxDQUFDLG9CQUFvQixJQUFJLENBQUMsT0FBTyxZQUFZLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRU0sSUFBSSxDQUFDLElBQWEsRUFBRSxRQUF5Qjs7UUFDbEQsYUFBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsbUNBQUksRUFBRSxDQUFDO0lBQ3pDLENBQUM7SUFFTSxJQUFJLENBQUMsSUFBYSxFQUFFLE9BQXdCOztRQUNqRCxPQUFPLFlBQVksTUFBQSxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsbUNBQUksRUFBRSxLQUFLLE9BQU8sQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDO0lBQzFGLENBQUM7SUFFTSxLQUFLLENBQUMsSUFBYSxFQUFFLE9BQXdCOztRQUNsRCxPQUFPLGFBQWEsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsVUFBVSxNQUFBLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxtQ0FBSSxFQUFFLE1BQU0sQ0FBQztJQUNsSCxDQUFDO0lBRU0sSUFBSSxDQUFDLEtBQWMsRUFBRSxPQUF3QjtRQUNsRCxPQUFPLE9BQU8sT0FBTyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUM7SUFDekMsQ0FBQztJQUVNLE1BQU0sQ0FBQyxLQUFjLEVBQUUsT0FBd0I7UUFDcEQsT0FBTyxXQUFXLE9BQU8sQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDO0lBQ2pELENBQUM7SUFFTSxPQUFPLENBQUMsSUFBYSxFQUFFLE9BQXdCO1FBQ3BELE9BQU8sd0JBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxLQUFLLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7SUFFTSxJQUFJLENBQUMsSUFBYSxFQUFFLE9BQXdCO1FBQ2pELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQztRQUVsRSxPQUFPLHdCQUFJLENBQUMsZUFBZSxRQUFRLE9BQU8sT0FBTyxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRU0sSUFBSSxDQUFDLEtBQWMsRUFBRSxPQUF3QjtRQUNsRCxPQUFPLGdCQUFnQiw2QkFBUyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQztJQUN4RSxDQUFDO0lBRU0sY0FBYyxDQUFDLEtBQWMsRUFBRSxRQUF5QjtRQUM3RCxPQUFPLHdCQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ksV0FBVyxDQUFDLElBQWEsRUFBRSxRQUF5Qjs7UUFDekQsTUFBTSxJQUFJLFNBQUcsSUFBSSxDQUFDLE9BQU8sbUNBQUksRUFBRSxDQUFDO1FBQ2hDLElBQUk7WUFDRixNQUFNLEdBQUcsR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7WUFDL0QsT0FBTyxJQUFJLGFBQWEsRUFBRSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ25EO1FBQUMsTUFBTTtZQUNOLDZEQUE2RDtZQUM3RCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBWSxFQUFFLEVBQUU7Z0JBQzdDLFFBQVEsSUFBSSxFQUFFO29CQUNaLEtBQUssR0FBRzt3QkFDTixPQUFPLE9BQU8sQ0FBQztvQkFDakIsS0FBSyxHQUFHO3dCQUNOLE9BQU8sTUFBTSxDQUFDO29CQUNoQixLQUFLLEdBQUc7d0JBQ04sT0FBTyxNQUFNLENBQUM7b0JBQ2hCO3dCQUNFLE9BQU8sSUFBSSxDQUFDO2lCQUNmO1lBQ0gsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7SUFFRDs7Ozs7T0FLRztJQUNJLFVBQVUsQ0FBQyxJQUFhLEVBQUUsT0FBd0I7UUFDdkQsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN6QyxDQUFDO0NBQ0Y7QUF4RkQsNERBd0ZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY20gZnJvbSAnY29tbW9ubWFyayc7XG5cbmltcG9ydCB7IG1ha2VYbWxFc2NhcGVyIH0gZnJvbSAnLi9lc2NhcGVzJztcbmltcG9ydCB7IHByZWZpeExpbmVzLCBSZW5kZXJlckNvbnRleHQgfSBmcm9tICcuL21hcmtkb3duJztcbmltcG9ydCB7IE1hcmtkb3duUmVuZGVyZXIsIHBhcmEsIHN0cmlwUGFyYSB9IGZyb20gJy4vbWFya2Rvd24tcmVuZGVyZXInO1xuXG5jb25zdCBFU0NBUEUgPSBtYWtlWG1sRXNjYXBlcigpO1xuXG4vLyBUaGUgdHlwZXMgZm9yICd4bWxkb20nIGFyZSBub3QgY29tcGxldGUuXG4vKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXZhci1yZXF1aXJlcyxAdHlwZXNjcmlwdC1lc2xpbnQvbm8tcmVxdWlyZS1pbXBvcnRzICovXG5jb25zdCB7IERPTVBhcnNlciwgWE1MU2VyaWFsaXplciB9ID0gcmVxdWlyZSgnQHhtbGRvbS94bWxkb20nKTtcblxuLyoqXG4gKiBBIHJlbmRlcmVyIHRoYXQgd2lsbCByZW5kZXIgYSBDb21tb25NYXJrIHRyZWUgdG8gLk5FVCBYTUwgY29tbWVudHNcbiAqXG4gKiBNb3N0bHkgY29uY2VybnMgaXRzZWxmIHdpdGggY29kZSBhbm5vdGF0aW9ucyBhbmQgZXNjYXBpbmc7IHRhZ3MgdGhhdCB0aGVcbiAqIFhNTCBmb3JtYXR0ZXIgZG9lc24ndCBoYXZlIGVxdWl2YWxlbnRzIGZvciB3aWxsIGJlIHJlbmRlcmVkIGJhY2sgdG8gTWFya0Rvd24uXG4gKi9cbmV4cG9ydCBjbGFzcyBDU2hhcnBYbWxDb21tZW50UmVuZGVyZXIgZXh0ZW5kcyBNYXJrZG93blJlbmRlcmVyIHtcbiAgcHVibGljIGJsb2NrX3F1b3RlKF9ub2RlOiBjbS5Ob2RlLCBjb250ZXh0OiBSZW5kZXJlckNvbnRleHQpIHtcbiAgICByZXR1cm4gcGFyYShwcmVmaXhMaW5lcygnICAgICcsIHN0cmlwUGFyYShjb250ZXh0LmNvbnRlbnQoKSkpKTtcbiAgfVxuXG4gIHB1YmxpYyBjb2RlKG5vZGU6IGNtLk5vZGUsIF9jb250ZXh0OiBSZW5kZXJlckNvbnRleHQpIHtcbiAgICByZXR1cm4gYDxjPiR7RVNDQVBFLnRleHQobm9kZS5saXRlcmFsKX08L2M+YDtcbiAgfVxuXG4gIHB1YmxpYyBjb2RlX2Jsb2NrKG5vZGU6IGNtLk5vZGUsIF9jb250ZXh0OiBSZW5kZXJlckNvbnRleHQpIHtcbiAgICByZXR1cm4gcGFyYShgPGNvZGU+PCFbQ0RBVEFbXFxuJHtub2RlLmxpdGVyYWx9XV0+PC9jb2RlPmApO1xuICB9XG5cbiAgcHVibGljIHRleHQobm9kZTogY20uTm9kZSwgX2NvbnRleHQ6IFJlbmRlcmVyQ29udGV4dCkge1xuICAgIHJldHVybiBFU0NBUEUudGV4dChub2RlLmxpdGVyYWwpID8/ICcnO1xuICB9XG5cbiAgcHVibGljIGxpbmsobm9kZTogY20uTm9kZSwgY29udGV4dDogUmVuZGVyZXJDb250ZXh0KSB7XG4gICAgcmV0dXJuIGA8YSBocmVmPVwiJHtFU0NBUEUuYXR0cmlidXRlKG5vZGUuZGVzdGluYXRpb24pID8/ICcnfVwiPiR7Y29udGV4dC5jb250ZW50KCl9PC9hPmA7XG4gIH1cblxuICBwdWJsaWMgaW1hZ2Uobm9kZTogY20uTm9kZSwgY29udGV4dDogUmVuZGVyZXJDb250ZXh0KSB7XG4gICAgcmV0dXJuIGA8aW1nIGFsdD1cIiR7RVNDQVBFLnRleHQyYXR0cihjb250ZXh0LmNvbnRlbnQoKSl9XCIgc3JjPVwiJHtFU0NBUEUuYXR0cmlidXRlKG5vZGUuZGVzdGluYXRpb24pID8/ICcnfVwiIC8+YDtcbiAgfVxuXG4gIHB1YmxpYyBlbXBoKF9ub2RlOiBjbS5Ob2RlLCBjb250ZXh0OiBSZW5kZXJlckNvbnRleHQpIHtcbiAgICByZXR1cm4gYDxlbT4ke2NvbnRleHQuY29udGVudCgpfTwvZW0+YDtcbiAgfVxuXG4gIHB1YmxpYyBzdHJvbmcoX25vZGU6IGNtLk5vZGUsIGNvbnRleHQ6IFJlbmRlcmVyQ29udGV4dCkge1xuICAgIHJldHVybiBgPHN0cm9uZz4ke2NvbnRleHQuY29udGVudCgpfTwvc3Ryb25nPmA7XG4gIH1cblxuICBwdWJsaWMgaGVhZGluZyhub2RlOiBjbS5Ob2RlLCBjb250ZXh0OiBSZW5kZXJlckNvbnRleHQpIHtcbiAgICByZXR1cm4gcGFyYShgPGgke25vZGUubGV2ZWx9PiR7Y29udGV4dC5jb250ZW50KCl9PC9oJHtub2RlLmxldmVsfT5gKTtcbiAgfVxuXG4gIHB1YmxpYyBsaXN0KG5vZGU6IGNtLk5vZGUsIGNvbnRleHQ6IFJlbmRlcmVyQ29udGV4dCkge1xuICAgIGNvbnN0IGxpc3RUeXBlID0gbm9kZS5saXN0VHlwZSA9PT0gJ2J1bGxldCcgPyAnYnVsbGV0JyA6ICdudW1iZXInO1xuXG4gICAgcmV0dXJuIHBhcmEoYDxsaXN0IHR5cGU9XCIke2xpc3RUeXBlfVwiPlxcbiR7Y29udGV4dC5jb250ZW50KCl9PC9saXN0PmApO1xuICB9XG5cbiAgcHVibGljIGl0ZW0oX25vZGU6IGNtLk5vZGUsIGNvbnRleHQ6IFJlbmRlcmVyQ29udGV4dCkge1xuICAgIHJldHVybiBgPGRlc2NyaXB0aW9uPiR7c3RyaXBQYXJhKGNvbnRleHQuY29udGVudCgpKX08L2Rlc2NyaXB0aW9uPlxcbmA7XG4gIH1cblxuICBwdWJsaWMgdGhlbWF0aWNfYnJlYWsoX25vZGU6IGNtLk5vZGUsIF9jb250ZXh0OiBSZW5kZXJlckNvbnRleHQpIHtcbiAgICByZXR1cm4gcGFyYSgnPGhyIC8+Jyk7XG4gIH1cblxuICAvKipcbiAgICogSFRNTCBuZWVkcyB0byBiZSBjb252ZXJ0ZWQgdG8gWE1MXG4gICAqXG4gICAqIElmIHdlIGRvbid0IGRvIHRoaXMsIHRoZSBwYXJzZXIgd2lsbCByZWplY3QgdGhlIHdob2xlIFhNTCBibG9jayBvbmNlIGl0IHNlZW5zIGFuIHVuY2xvc2VkXG4gICAqIDxpbWc+IHRhZy5cbiAgICovXG4gIHB1YmxpYyBodG1sX2lubGluZShub2RlOiBjbS5Ob2RlLCBfY29udGV4dDogUmVuZGVyZXJDb250ZXh0KSB7XG4gICAgY29uc3QgaHRtbCA9IG5vZGUubGl0ZXJhbCA/PyAnJztcbiAgICB0cnkge1xuICAgICAgY29uc3QgZG9jID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhodG1sLCAndGV4dC9odG1sJyk7XG4gICAgICByZXR1cm4gbmV3IFhNTFNlcmlhbGl6ZXIoKS5zZXJpYWxpemVUb1N0cmluZyhkb2MpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgLy8gQ291bGQgbm90IHBhcnNlIC0gd2UnbGwgZXNjYXBlIHVuc2FmZSBYTUwgZW50aXRpZXMgaGVyZS4uLlxuICAgICAgcmV0dXJuIGh0bWwucmVwbGFjZSgvWzw+Jl0vZywgKGNoYXI6IHN0cmluZykgPT4ge1xuICAgICAgICBzd2l0Y2ggKGNoYXIpIHtcbiAgICAgICAgICBjYXNlICcmJzpcbiAgICAgICAgICAgIHJldHVybiAnJmFtcDsnO1xuICAgICAgICAgIGNhc2UgJzwnOlxuICAgICAgICAgICAgcmV0dXJuICcmbHQ7JztcbiAgICAgICAgICBjYXNlICc+JzpcbiAgICAgICAgICAgIHJldHVybiAnJmd0Oyc7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHJldHVybiBjaGFyO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSFRNTCBuZWVkcyB0byBiZSBjb252ZXJ0ZWQgdG8gWE1MXG4gICAqXG4gICAqIElmIHdlIGRvbid0IGRvIHRoaXMsIHRoZSBwYXJzZXIgd2lsbCByZWplY3QgdGhlIHdob2xlIFhNTCBibG9jayBvbmNlIGl0IHNlZW5zIGFuIHVuY2xvc2VkXG4gICAqIDxpbWc+IHRhZy5cbiAgICovXG4gIHB1YmxpYyBodG1sX2Jsb2NrKG5vZGU6IGNtLk5vZGUsIGNvbnRleHQ6IFJlbmRlcmVyQ29udGV4dCkge1xuICAgIHJldHVybiB0aGlzLmh0bWxfaW5saW5lKG5vZGUsIGNvbnRleHQpO1xuICB9XG59XG4iXX0=
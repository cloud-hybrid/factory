"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.extractSnippets = exports.extractAndInfuse = void 0;
const path = require("path");
const assemblies_1 = require("../jsii/assemblies");
const logging = require("../logging");
const rosetta_translator_1 = require("../rosetta-translator");
const snippet_1 = require("../snippet");
const key_1 = require("../tablets/key");
const tablets_1 = require("../tablets/tablets");
const util_1 = require("../util");
const infuse_1 = require("./infuse");
async function extractAndInfuse(assemblyLocations, options) {
    const result = await extractSnippets(assemblyLocations, options);
    await infuse_1.infuse(assemblyLocations, {
        cacheFromFile: options.cacheFromFile,
        cacheToFile: options.cacheToFile,
    });
    return result;
}
exports.extractAndInfuse = extractAndInfuse;
/**
 * Extract all samples from the given assemblies into a tablet
 */
async function extractSnippets(assemblyLocations, options = {}) {
    var _a, _b, _c, _d;
    const only = (_a = options.only) !== null && _a !== void 0 ? _a : [];
    logging.info(`Loading ${assemblyLocations.length} assemblies`);
    const assemblies = await assemblies_1.loadAssemblies(assemblyLocations, (_b = options.validateAssemblies) !== null && _b !== void 0 ? _b : false);
    let snippets = Array.from(assemblies_1.allTypeScriptSnippets(assemblies, options.loose));
    if (only.length > 0) {
        snippets = filterSnippets(snippets, only);
    }
    // Map every assembly to a list of snippets, so that we know what implicit
    // tablet to write the translations to later on.
    const snippetsPerAssembly = util_1.groupBy(snippets.map((s) => ({ key: key_1.snippetKey(s), location: projectDirectory(s) })), (x) => x.location);
    const translatorOptions = {
        includeCompilerDiagnostics: (_c = options.includeCompilerDiagnostics) !== null && _c !== void 0 ? _c : false,
        assemblies: assemblies.map((a) => a.assembly),
    };
    const translator = options.translatorFactory
        ? options.translatorFactory(translatorOptions)
        : new rosetta_translator_1.RosettaTranslator(translatorOptions);
    // Prime the snippet cache with:
    // - Cache source file
    // - Default tablets found next to each assembly
    if (options.cacheFromFile) {
        await translator.addToCache(options.cacheFromFile);
    }
    translator.addTabletsToCache(...Object.values(await assemblies_1.loadAllDefaultTablets(assemblies)));
    if (translator.hasCache()) {
        const { translations, remaining } = translator.readFromCache(snippets, true, options.includeCompilerDiagnostics);
        logging.info(`Reused ${translations.length} translations from cache`);
        snippets = remaining;
    }
    const diagnostics = [];
    if (snippets.length > 0) {
        logging.info('Translating');
        const startTime = Date.now();
        const result = await translator.translateAll(snippets);
        const delta = (Date.now() - startTime) / 1000;
        logging.info(`Translated ${snippets.length} snippets in ${delta} seconds (${(delta / snippets.length).toPrecision(3)}s/snippet)`);
        diagnostics.push(...result.diagnostics);
    }
    else {
        logging.info('Nothing left to translate');
    }
    // Save to individual tablet files, and optionally append to the output file
    if ((_d = options.writeToImplicitTablets) !== null && _d !== void 0 ? _d : true) {
        await Promise.all(Object.entries(snippetsPerAssembly).map(async ([location, snips]) => {
            const asmTabletFile = path.join(location, tablets_1.DEFAULT_TABLET_NAME);
            logging.debug(`Writing ${snips.length} translations to ${asmTabletFile}`);
            const translations = snips.map(({ key }) => translator.tablet.tryGetSnippet(key)).filter(util_1.isDefined);
            const asmTablet = new tablets_1.LanguageTablet();
            asmTablet.addSnippets(...translations);
            await asmTablet.save(asmTabletFile);
        }));
    }
    if (options.cacheToFile) {
        logging.info(`Adding translations to ${options.cacheToFile}`);
        const output = options.trimCache
            ? new tablets_1.LanguageTablet()
            : await tablets_1.LanguageTablet.fromOptionalFile(options.cacheToFile);
        output.addTablet(translator.tablet);
        await output.save(options.cacheToFile);
    }
    return { diagnostics, tablet: translator.tablet };
}
exports.extractSnippets = extractSnippets;
/**
 * Only yield the snippets whose id exists in a whitelist
 */
function filterSnippets(ts, includeIds) {
    return ts.filter((t) => includeIds.includes(key_1.snippetKey(t)));
}
function projectDirectory(ts) {
    var _a;
    const dir = (_a = ts.parameters) === null || _a === void 0 ? void 0 : _a[snippet_1.SnippetParameters.$PROJECT_DIRECTORY];
    if (!dir) {
        throw new Error(`Snippet does not have associated project directory: ${JSON.stringify(ts.location)}`);
    }
    return dir;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0cmFjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImV4dHJhY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkJBQTZCO0FBRTdCLG1EQUFrRztBQUNsRyxzQ0FBc0M7QUFDdEMsOERBQW9GO0FBQ3BGLHdDQUFrRTtBQUNsRSx3Q0FBNEM7QUFDNUMsZ0RBQXlFO0FBRXpFLGtDQUE2QztBQUM3QyxxQ0FBa0M7QUFvRDNCLEtBQUssVUFBVSxnQkFBZ0IsQ0FBQyxpQkFBMkIsRUFBRSxPQUF1QjtJQUN6RixNQUFNLE1BQU0sR0FBRyxNQUFNLGVBQWUsQ0FBQyxpQkFBaUIsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNqRSxNQUFNLGVBQU0sQ0FBQyxpQkFBaUIsRUFBRTtRQUM5QixhQUFhLEVBQUUsT0FBTyxDQUFDLGFBQWE7UUFDcEMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxXQUFXO0tBQ2pDLENBQUMsQ0FBQztJQUNILE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFQRCw0Q0FPQztBQUVEOztHQUVHO0FBQ0ksS0FBSyxVQUFVLGVBQWUsQ0FDbkMsaUJBQW9DLEVBQ3BDLFVBQTBCLEVBQUU7O0lBRTVCLE1BQU0sSUFBSSxTQUFHLE9BQU8sQ0FBQyxJQUFJLG1DQUFJLEVBQUUsQ0FBQztJQUVoQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsaUJBQWlCLENBQUMsTUFBTSxhQUFhLENBQUMsQ0FBQztJQUMvRCxNQUFNLFVBQVUsR0FBRyxNQUFNLDJCQUFjLENBQUMsaUJBQWlCLFFBQUUsT0FBTyxDQUFDLGtCQUFrQixtQ0FBSSxLQUFLLENBQUMsQ0FBQztJQUVoRyxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLGtDQUFxQixDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUM1RSxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1FBQ25CLFFBQVEsR0FBRyxjQUFjLENB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RUFBRSxVQUFvQjtJQUNuRSxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsZ0JBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDOUQsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsRUFBcUI7O0lBQzdDLE1BQU0sR0FBRyxTQUFHLEVBQUUsQ0FBQyxVQUFVLDBDQUFHLDJCQUFpQixDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDbEUsSUFBSSxDQUFDLEdBQUcsRUFBRTtRQUNSLE1BQU0sSUFBSSxLQUFLLENBQUMsdURBQXVELElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUN2RztJQUNELE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCB7IGxvYWRBc3NlbWJsaWVzLCBhbGxUeXBlU2NyaXB0U25pcHBldHMsIGxvYWRBbGxEZWZhdWx0VGFibGV0cyB9IGZyb20gJy4uL2pzaWkvYXNzZW1ibGllcyc7XG5pbXBvcnQgKiBhcyBsb2dnaW5nIGZyb20gJy4uL2xvZ2dpbmcnO1xuaW1wb3J0IHsgUm9zZXR0YVRyYW5zbGF0b3IsIFJvc2V0dGFUcmFuc2xhdG9yT3B0aW9ucyB9IGZyb20gJy4uL3Jvc2V0dGEtdHJhbnNsYXRvcic7XG5pbXBvcnQgeyBUeXBlU2NyaXB0U25pcHBldCwgU25pcHBldFBhcmFtZXRlcnMgfSBmcm9tICcuLi9zbmlwcGV0JztcbmltcG9ydCB7IHNuaXBwZXRLZXkgfSBmcm9tICcuLi90YWJsZXRzL2tleSc7XG5pbXBvcnQgeyBMYW5ndWFnZVRhYmxldCwgREVGQVVMVF9UQUJMRVRfTkFNRSB9IGZyb20gJy4uL3RhYmxldHMvdGFibGV0cyc7XG5pbXBvcnQgeyBSb3NldHRhRGlhZ25vc3RpYyB9IGZyb20gJy4uL3RyYW5zbGF0ZSc7XG5pbXBvcnQgeyBncm91cEJ5LCBpc0RlZmluZWQgfSBmcm9tICcuLi91dGlsJztcbmltcG9ydCB7IGluZnVzZSB9IGZyb20gJy4vaW5mdXNlJztcblxuZXhwb3J0IGludGVyZmFjZSBFeHRyYWN0UmVzdWx0IHtcbiAgZGlhZ25vc3RpY3M6IFJvc2V0dGFEaWFnbm9zdGljW107XG4gIHRhYmxldDogTGFuZ3VhZ2VUYWJsZXQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXh0cmFjdE9wdGlvbnMge1xuICByZWFkb25seSBpbmNsdWRlQ29tcGlsZXJEaWFnbm9zdGljcz86IGJvb2xlYW47XG4gIHJlYWRvbmx5IHZhbGlkYXRlQXNzZW1ibGllcz86IGJvb2xlYW47XG4gIHJlYWRvbmx5IG9ubHk/OiBzdHJpbmdbXTtcblxuICAvKipcbiAgICogQSB0YWJsZXQgZmlsZSB0byBiZSBsb2FkZWQgYW5kIHVzZWQgYXMgYSBzb3VyY2UgZm9yIGNhY2hpbmdcbiAgICovXG4gIHJlYWRvbmx5IGNhY2hlRnJvbUZpbGU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEEgdGFibGV0IGZpbGUgdG8gYXBwZW5kIHRyYW5zbGF0ZWQgc25pcHBldHMgdG9cbiAgICovXG4gIHJlYWRvbmx5IGNhY2hlVG9GaWxlPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUcmltIGNhY2hlIHRvIG9ubHkgY29udGFpbiB0cmFuc2xhdGlvbnMgZm91bmQgaW4gdGhlIGN1cnJlbnQgYXNzZW1ibGllc1xuICAgKlxuICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgKi9cbiAgcmVhZG9ubHkgdHJpbUNhY2hlPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogV3JpdGUgdHJhbnNsYXRpb25zIHRvIGltcGxpY2l0IHRhYmxldHMgKGAuanNpaS50YWJsLmpzb25gKVxuICAgKlxuICAgKiBAZGVmYXVsdCB0cnVlXG4gICAqL1xuICByZWFkb25seSB3cml0ZVRvSW1wbGljaXRUYWJsZXRzPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogTWFrZSBhIHRyYW5zbGF0b3IgKGp1c3QgZm9yIHRlc3RpbmcpXG4gICAqL1xuICByZWFkb25seSB0cmFuc2xhdG9yRmFjdG9yeT86IChvcHRzOiBSb3NldHRhVHJhbnNsYXRvck9wdGlvbnMpID0+IFJvc2V0dGFUcmFuc2xhdG9yO1xuXG4gIC8qKlxuICAgKiBUdXJuIG9uICdsb29zZSBtb2RlJyBvciBub3RcbiAgICpcbiAgICogTG9vc2UgbW9kZSBpZ25vcmVzIGZhaWx1cmVzIGR1cmluZyBmaXh0dXJpemluZywgYW5kIHVuZG9lcyAnc3RyaWN0IG1vZGUnIGZvclxuICAgKiBkaWFnbm9zdGljcy5cbiAgICpcbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHJlYWRvbmx5IGxvb3NlPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGV4dHJhY3RBbmRJbmZ1c2UoYXNzZW1ibHlMb2NhdGlvbnM6IHN0cmluZ1tdLCBvcHRpb25zOiBFeHRyYWN0T3B0aW9ucyk6IFByb21pc2U8RXh0cmFjdFJlc3VsdD4ge1xuICBjb25zdCByZXN1bHQgPSBhd2FpdCBleHRyYWN0U25pcHBldHMoYXNzZW1ibHlMb2NhdGlvbnMsIG9wdGlvbnMpO1xuICBhd2FpdCBpbmZ1c2UoYXNzZW1ibHlMb2NhdGlvbnMsIHtcbiAgICBjYWNoZUZyb21GaWxlOiBvcHRpb25zLmNhY2hlRnJvbUZpbGUsXG4gICAgY2FjaGVUb0ZpbGU6IG9wdGlvbnMuY2FjaGVUb0ZpbGUsXG4gIH0pO1xuICByZXR1cm4gcmVzdWx0O1xufVxuXG4vKipcbiAqIEV4dHJhY3QgYWxsIHNhbXBsZXMgZnJvbSB0aGUgZ2l2ZW4gYXNzZW1ibGllcyBpbnRvIGEgdGFibGV0XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleHRyYWN0U25pcHBldHMoXG4gIGFzc2VtYmx5TG9jYXRpb25zOiByZWFkb25seSBzdHJpbmdbXSxcbiAgb3B0aW9uczogRXh0cmFjdE9wdGlvbnMgPSB7fSxcbik6IFByb21pc2U8RXh0cmFjdFJlc3VsdD4ge1xuICBjb25zdCBvbmx5ID0gb3B0aW9ucy5vbmx5ID8/IFtdO1xuXG4gIGxvZ2dpbmcuaW5mbyhgTG9hZGluZyAke2Fzc2VtYmx5TG9jYXRpb25zLmxlbmd0aH0gYXNzZW1ibGllc2ApO1xuICBjb25zdCBhc3NlbWJsaWVzID0gYXdhaXQgbG9hZEFzc2VtYmxpZXMoYXNzZW1ibHlMb2NhdGlvbnMsIG9wdGlvbnMudmFsaWRhdGVBc3NlbWJsaWVzID8/IGZhbHNlKTtcblxuICBsZXQgc25pcHBldHMgPSBBcnJheS5mcm9tKGFsbFR5cGVTY3JpcHRTbmlwcGV0cyhhc3NlbWJsaWVzLCBvcHRpb25zLmxvb3NlKSk7XG4gIGlmIChvbmx5Lmxlbmd0aCA+IDApIHtcbiAgICBzbmlwcGV0cyA9IGZpbHRlclNuaXBwZXRzKHNuaXBwZXRzLCBvbmx5KTtcbiAgfVxuXG4gIC8vIE1hcCBldmVyeSBhc3NlbWJseSB0byBhIGxpc3Qgb2Ygc25pcHBldHMsIHNvIHRoYXQgd2Uga25vdyB3aGF0IGltcGxpY2l0XG4gIC8vIHRhYmxldCB0byB3cml0ZSB0aGUgdHJhbnNsYXRpb25zIHRvIGxhdGVyIG9uLlxuICBjb25zdCBzbmlwcGV0c1BlckFzc2VtYmx5ID0gZ3JvdXBCeShcbiAgICBzbmlwcGV0cy5tYXAoKHMpID0+ICh7IGtleTogc25pcHBldEtleShzKSwgbG9jYXRpb246IHByb2plY3REaXJlY3RvcnkocykgfSkpLFxuICAgICh4KSA9PiB4LmxvY2F0aW9uLFxuICApO1xuXG4gIGNvbnN0IHRyYW5zbGF0b3JPcHRpb25zOiBSb3NldHRhVHJhbnNsYXRvck9wdGlvbnMgPSB7XG4gICAgaW5jbHVkZUNvbXBpbGVyRGlhZ25vc3RpY3M6IG9wdGlvbnMuaW5jbHVkZUNvbXBpbGVyRGlhZ25vc3RpY3MgPz8gZmFsc2UsXG4gICAgYXNzZW1ibGllczogYXNzZW1ibGllcy5tYXAoKGEpID0+IGEuYXNzZW1ibHkpLFxuICB9O1xuXG4gIGNvbnN0IHRyYW5zbGF0b3IgPSBvcHRpb25zLnRyYW5zbGF0b3JGYWN0b3J5XG4gICAgPyBvcHRpb25zLnRyYW5zbGF0b3JGYWN0b3J5KHRyYW5zbGF0b3JPcHRpb25zKVxuICAgIDogbmV3IFJvc2V0dGFUcmFuc2xhdG9yKHRyYW5zbGF0b3JPcHRpb25zKTtcblxuICAvLyBQcmltZSB0aGUgc25pcHBldCBjYWNoZSB3aXRoOlxuICAvLyAtIENhY2hlIHNvdXJjZSBmaWxlXG4gIC8vIC0gRGVmYXVsdCB0YWJsZXRzIGZvdW5kIG5leHQgdG8gZWFjaCBhc3NlbWJseVxuICBpZiAob3B0aW9ucy5jYWNoZUZyb21GaWxlKSB7XG4gICAgYXdhaXQgdHJhbnNsYXRvci5hZGRUb0NhY2hlKG9wdGlvbnMuY2FjaGVGcm9tRmlsZSk7XG4gIH1cbiAgdHJhbnNsYXRvci5hZGRUYWJsZXRzVG9DYWNoZSguLi5PYmplY3QudmFsdWVzKGF3YWl0IGxvYWRBbGxEZWZhdWx0VGFibGV0cyhhc3NlbWJsaWVzKSkpO1xuXG4gIGlmICh0cmFuc2xhdG9yLmhhc0NhY2hlKCkpIHtcbiAgICBjb25zdCB7IHRyYW5zbGF0aW9ucywgcmVtYWluaW5nIH0gPSB0cmFuc2xhdG9yLnJlYWRGcm9tQ2FjaGUoc25pcHBldHMsIHRydWUsIG9wdGlvbnMuaW5jbHVkZUNvbXBpbGVyRGlhZ25vc3RpY3MpO1xuICAgIGxvZ2dpbmcuaW5mbyhgUmV1c2VkICR7dHJhbnNsYXRpb25zLmxlbmd0aH0gdHJhbnNsYXRpb25zIGZyb20gY2FjaGVgKTtcbiAgICBzbmlwcGV0cyA9IHJlbWFpbmluZztcbiAgfVxuXG4gIGNvbnN0IGRpYWdub3N0aWNzID0gW107XG4gIGlmIChzbmlwcGV0cy5sZW5ndGggPiAwKSB7XG4gICAgbG9nZ2luZy5pbmZvKCdUcmFuc2xhdGluZycpO1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0cmFuc2xhdG9yLnRyYW5zbGF0ZUFsbChzbmlwcGV0cyk7XG5cbiAgICBjb25zdCBkZWx0YSA9IChEYXRlLm5vdygpIC0gc3RhcnRUaW1lKSAvIDEwMDA7XG4gICAgbG9nZ2luZy5pbmZvKFxuICAgICAgYFRyYW5zbGF0ZWQgJHtzbmlwcGV0cy5sZW5ndGh9IHNuaXBwZXRzIGluICR7ZGVsdGF9IHNlY29uZHMgKCR7KGRlbHRhIC8gc25pcHBldHMubGVuZ3RoKS50b1ByZWNpc2lvbihcbiAgICAgICAgMyxcbiAgICAgICl9cy9zbmlwcGV0KWAsXG4gICAgKTtcbiAgICBkaWFnbm9zdGljcy5wdXNoKC4uLnJlc3VsdC5kaWFnbm9zdGljcyk7XG4gIH0gZWxzZSB7XG4gICAgbG9nZ2luZy5pbmZvKCdOb3RoaW5nIGxlZnQgdG8gdHJhbnNsYXRlJyk7XG4gIH1cblxuICAvLyBTYXZlIHRvIGluZGl2aWR1YWwgdGFibGV0IGZpbGVzLCBhbmQgb3B0aW9uYWxseSBhcHBlbmQgdG8gdGhlIG91dHB1dCBmaWxlXG4gIGlmIChvcHRpb25zLndyaXRlVG9JbXBsaWNpdFRhYmxldHMgPz8gdHJ1ZSkge1xuICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgT2JqZWN0LmVudHJpZXMoc25pcHBldHNQZXJBc3NlbWJseSkubWFwKGFzeW5jIChbbG9jYXRpb24sIHNuaXBzXSkgPT4ge1xuICAgICAgICBjb25zdCBhc21UYWJsZXRGaWxlID0gcGF0aC5qb2luKGxvY2F0aW9uLCBERUZBVUxUX1RBQkxFVF9OQU1FKTtcbiAgICAgICAgbG9nZ2luZy5kZWJ1ZyhgV3JpdGluZyAke3NuaXBzLmxlbmd0aH0gdHJhbnNsYXRpb25zIHRvICR7YXNtVGFibGV0RmlsZX1gKTtcbiAgICAgICAgY29uc3QgdHJhbnNsYXRpb25zID0gc25pcHMubWFwKCh7IGtleSB9KSA9PiB0cmFuc2xhdG9yLnRhYmxldC50cnlHZXRTbmlwcGV0KGtleSkpLmZpbHRlcihpc0RlZmluZWQpO1xuXG4gICAgICAgIGNvbnN0IGFzbVRhYmxldCA9IG5ldyBMYW5ndWFnZVRhYmxldCgpO1xuICAgICAgICBhc21UYWJsZXQuYWRkU25pcHBldHMoLi4udHJhbnNsYXRpb25zKTtcbiAgICAgICAgYXdhaXQgYXNtVGFibGV0LnNhdmUoYXNtVGFibGV0RmlsZSk7XG4gICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgaWYgKG9wdGlvbnMuY2FjaGVUb0ZpbGUpIHtcbiAgICBsb2dnaW5nLmluZm8oYEFkZGluZyB0cmFuc2xhdGlvbnMgdG8gJHtvcHRpb25zLmNhY2hlVG9GaWxlfWApO1xuICAgIGNvbnN0IG91dHB1dCA9IG9wdGlvbnMudHJpbUNhY2hlXG4gICAgICA/IG5ldyBMYW5ndWFnZVRhYmxldCgpXG4gICAgICA6IGF3YWl0IExhbmd1YWdlVGFibGV0LmZyb21PcHRpb25hbEZpbGUob3B0aW9ucy5jYWNoZVRvRmlsZSk7XG4gICAgb3V0cHV0LmFkZFRhYmxldCh0cmFuc2xhdG9yLnRhYmxldCk7XG4gICAgYXdhaXQgb3V0cHV0LnNhdmUob3B0aW9ucy5jYWNoZVRvRmlsZSk7XG4gIH1cblxuICByZXR1cm4geyBkaWFnbm9zdGljcywgdGFibGV0OiB0cmFuc2xhdG9yLnRhYmxldCB9O1xufVxuXG4vKipcbiAqIE9ubHkgeWllbGQgdGhlIHNuaXBwZXRzIHdob3NlIGlkIGV4aXN0cyBpbiBhIHdoaXRlbGlzdFxuICovXG5mdW5jdGlvbiBmaWx0ZXJTbmlwcGV0cyh0czogVHlwZVNjcmlwdFNuaXBwZXRbXSwgaW5jbHVkZUlkczogc3RyaW5nW10pIHtcbiAgcmV0dXJuIHRzLmZpbHRlcigodCkgPT4gaW5jbHVkZUlkcy5pbmNsdWRlcyhzbmlwcGV0S2V5KHQpKSk7XG59XG5cbmZ1bmN0aW9uIHByb2plY3REaXJlY3RvcnkodHM6IFR5cGVTY3JpcHRTbmlwcGV0KSB7XG4gIGNvbnN0IGRpciA9IHRzLnBhcmFtZXRlcnM/LltTbmlwcGV0UGFyYW1ldGVycy4kUFJPSkVDVF9ESVJFQ1RPUlldO1xuICBpZiAoIWRpcikge1xuICAgIHRocm93IG5ldyBFcnJvcihgU25pcHBldCBkb2VzIG5vdCBoYXZlIGFzc29jaWF0ZWQgcHJvamVjdCBkaXJlY3Rvcnk6ICR7SlNPTi5zdHJpbmdpZnkodHMubG9jYXRpb24pfWApO1xuICB9XG4gIHJldHVybiBkaXI7XG59XG4iXX0=
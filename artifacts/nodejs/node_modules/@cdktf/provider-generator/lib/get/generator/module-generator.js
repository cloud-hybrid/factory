"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ModuleGenerator = void 0;
const codemaker_1 = require("codemaker");
class ModuleGenerator {
    constructor(code, targets) {
        this.code = code;
        this.targets = targets;
        this.code.indentation = 2;
        for (const target of this.targets) {
            this.emitSubmodule(target);
        }
    }
    emitSubmodule(target) {
        const spec = target.spec;
        if (!spec) {
            throw new Error(`missing spec for ${target.fqn}`);
        }
        this.code.openFile(target.fileName);
        this.code.line(`// generated by cdktf get`);
        this.code.line(`// ${target.source}`);
        this.code.line(`import { TerraformModule } from 'cdktf';`);
        this.code.line(`import { Construct } from 'constructs';`);
        const baseName = this.code.toPascalCase(target.name.replace(/[-/.]/g, "_"));
        const optionsType = `${baseName}Options`;
        this.code.openBlock(`export interface ${optionsType}`);
        for (const input of spec.inputs) {
            const optional = input.required && input.default === undefined ? "" : "?";
            this.code.line(`/**`);
            this.code.line(` * ${input.description}`);
            if (input.default) {
                this.code.line(` * @default ${input.default}`);
            }
            this.code.line(` */`);
            this.code.line(`readonly ${codemaker_1.toCamelCase(input.name)}${optional}: ${parseType(input.type)};`);
        }
        this.code.closeBlock();
        this.code.openBlock(`export class ${baseName} extends TerraformModule`);
        this.code.line(`private readonly inputs: { [name: string]: any } = { }`);
        const allOptional = spec.inputs.find((x) => x.required) ? "" : " = {}";
        this.code.open(`public constructor(scope: Construct, id: string, options: ${optionsType}${allOptional}) {`);
        this.code.open(`super(scope, id, {`);
        this.code.line(`source: '${target.source}',`);
        if (target.version) {
            this.code.line(`version: '${target.version}',`);
        }
        this.code.close(`});`);
        for (const input of spec.inputs) {
            const inputName = codemaker_1.toCamelCase(input.name);
            this.code.line(`this.${inputName} = options.${inputName};`);
        }
        this.code.close(`}`); // ctor
        for (const input of spec.inputs) {
            const inputName = codemaker_1.toCamelCase(input.name);
            const inputType = parseType(input.type) +
                (input.required && input.default === undefined ? "" : " | undefined");
            this.code.openBlock(`public get ${inputName}(): ${inputType}`);
            this.code.line(`return this.inputs['${input.name}'] as ${inputType};`);
            this.code.closeBlock();
            this.code.openBlock(`public set ${inputName}(value: ${inputType})`);
            this.code.line(`this.inputs['${input.name}'] = value;`);
            this.code.closeBlock();
        }
        for (const output of spec.outputs) {
            const outputName = codemaker_1.toCamelCase(output.name);
            this.code.openBlock(`public get ${outputName}Output()`);
            this.code.line(`return this.interpolationForOutput('${output.name}')`);
            this.code.closeBlock();
        }
        this.code.openBlock(`protected synthesizeAttributes()`);
        this.code.line(`return this.inputs;`);
        this.code.closeBlock();
        this.code.closeBlock(); // class
        this.code.closeFile(target.fileName);
    }
}
exports.ModuleGenerator = ModuleGenerator;
function parseType(type) {
    if (type === "string") {
        return "string";
    }
    if (type === "number") {
        return "number";
    }
    if (type === "bool") {
        return "boolean";
    }
    if (type === "list") {
        return "string[]";
    }
    if (type === "map") {
        return "{ [key: string]: string }";
    }
    if (type === "any") {
        return "any";
    }
    const complexType = parseComplexType(type);
    if (complexType) {
        return complexType;
    }
    throw new Error(`unknown type ${type}`);
}
function parseComplexType(type) {
    const complex = /^(object|list|map)\(([\s\S]+)\)/;
    const match = complex.exec(type);
    if (!match) {
        return undefined;
    }
    const [, kind, innerType] = match;
    if (kind === "object") {
        return `any`;
    }
    if (kind === "list") {
        return `${parseType(innerType)}[]`;
    }
    if (kind === "map") {
        return `{ [key: string]: ${parseType(innerType)} }`;
    }
    throw new Error(`unexpected kind ${kind}`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kdWxlLWdlbmVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1vZHVsZS1nZW5lcmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEseUNBQW1EO0FBR25ELE1BQWEsZUFBZTtJQUMxQixZQUNtQixJQUFlLEVBQ2YsT0FBc0M7UUFEdEMsU0FBSSxHQUFKLElBQUksQ0FBVztRQUNmLFlBQU8sR0FBUCxPQUFPLENBQStCO1FBRXZELElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztRQUUxQixLQUFLLE1BQU0sTUFBTSxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDakMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUM1QjtJQUNILENBQUM7SUFFTyxhQUFhLENBQUMsTUFBbUM7UUFDdkQsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztRQUV6QixJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1QsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQkFBb0IsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7U0FDbkQ7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFcEMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsMkJBQTJCLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBRXRDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLDBDQUEwQyxDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMseUNBQXlDLENBQUMsQ0FBQztRQUUxRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FB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QUU7UUFDckIsT0FBTyxLQUFLLENBQUM7S0FDZDtJQUVELElBQUksSUFBSSxLQUFLLE1BQU0sRUFBRTtRQUNuQixPQUFPLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7S0FDcEM7SUFFRCxJQUFJLElBQUksS0FBSyxLQUFLLEVBQUU7UUFDbEIsT0FBTyxvQkFBb0IsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7S0FDckQ7SUFFRCxNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBQzdDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb2RlTWFrZXIsIHRvQ2FtZWxDYXNlIH0gZnJvbSBcImNvZGVtYWtlclwiO1xuaW1wb3J0IHsgQ29uc3RydWN0c01ha2VyTW9kdWxlVGFyZ2V0IH0gZnJvbSBcIi4uL2NvbnN0cnVjdHMtbWFrZXJcIjtcblxuZXhwb3J0IGNsYXNzIE1vZHVsZUdlbmVyYXRvciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29kZTogQ29kZU1ha2VyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdGFyZ2V0czogQ29uc3RydWN0c01ha2VyTW9kdWxlVGFyZ2V0W11cbiAgKSB7XG4gICAgdGhpcy5jb2RlLmluZGVudGF0aW9uID0gMjtcblxuICAgIGZvciAoY29uc3QgdGFyZ2V0IG9mIHRoaXMudGFyZ2V0cykge1xuICAgICAgdGhpcy5lbWl0U3VibW9kdWxlKHRhcmdldCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBlbWl0U3VibW9kdWxlKHRhcmdldDogQ29uc3RydWN0c01ha2VyTW9kdWxlVGFyZ2V0KSB7XG4gICAgY29uc3Qgc3BlYyA9IHRhcmdldC5zcGVjO1xuXG4gICAgaWYgKCFzcGVjKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYG1pc3Npbmcgc3BlYyBmb3IgJHt0YXJnZXQuZnFufWApO1xuICAgIH1cblxuICAgIHRoaXMuY29kZS5vcGVuRmlsZSh0YXJnZXQuZmlsZU5hbWUpO1xuXG4gICAgdGhpcy5jb2RlLmxpbmUoYC8vIGdlbmVyYXRlZCBieSBjZGt0ZiBnZXRgKTtcbiAgICB0aGlzLmNvZGUubGluZShgLy8gJHt0YXJnZXQuc291cmNlfWApO1xuXG4gICAgdGhpcy5jb2RlLmxpbmUoYGltcG9ydCB7IFRlcnJhZm9ybU1vZHVsZSB9IGZyb20gJ2Nka3RmJztgKTtcbiAgICB0aGlzLmNvZGUubGluZShgaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7YCk7XG5cbiAgICBjb25zdCBiYXNlTmFtZSA9IHRoaXMuY29kZS50b1Bhc2NhbENhc2UodGFyZ2V0Lm5hbWUucmVwbGFjZSgvWy0vLl0vZywgXCJfXCIpKTtcbiAgICBjb25zdCBvcHRpb25zVHlwZSA9IGAke2Jhc2VOYW1lfU9wdGlvbnNgO1xuXG4gICAgdGhpcy5jb2RlLm9wZW5CbG9jayhgZXhwb3J0IGludGVyZmFjZSAke29wdGlvbnNUeXBlfWApO1xuICAgIGZvciAoY29uc3QgaW5wdXQgb2Ygc3BlYy5pbnB1dHMpIHtcbiAgICAgIGNvbnN0IG9wdGlvbmFsID0gaW5wdXQucmVxdWlyZWQgJiYgaW5wdXQuZGVmYXVsdCA9PT0gdW5kZWZpbmVkID8gXCJcIiA6IFwiP1wiO1xuICAgICAgdGhpcy5jb2RlLmxpbmUoYC8qKmApO1xuICAgICAgdGhpcy5jb2RlLmxpbmUoYCAqICR7aW5wdXQuZGVzY3JpcHRpb259YCk7XG4gICAgICBpZiAoaW5wdXQuZGVmYXVsdCkge1xuICAgICAgICB0aGlzLmNvZGUubGluZShgICogQGRlZmF1bHQgJHtpbnB1dC5kZWZhdWx0fWApO1xuICAgICAgfVxuICAgICAgdGhpcy5jb2RlLmxpbmUoYCAqL2ApO1xuICAgICAgdGhpcy5jb2RlLmxpbmUoXG4gICAgICAgIGByZWFkb25seSAke3RvQ2FtZWxDYXNlKGlucHV0Lm5hbWUpfSR7b3B0aW9uYWx9OiAke3BhcnNlVHlwZShcbiAgICAgICAgICBpbnB1dC50eXBlXG4gICAgICAgICl9O2BcbiAgICAgICk7XG4gICAgfVxuICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG5cbiAgICB0aGlzLmNvZGUub3BlbkJsb2NrKGBleHBvcnQgY2xhc3MgJHtiYXNlTmFtZX0gZXh0ZW5kcyBUZXJyYWZvcm1Nb2R1bGVgKTtcblxuICAgIHRoaXMuY29kZS5saW5lKGBwcml2YXRlIHJlYWRvbmx5IGlucHV0czogeyBbbmFtZTogc3RyaW5nXTogYW55IH0gPSB7IH1gKTtcblxuICAgIGNvbnN0IGFsbE9wdGlvbmFsID0gc3BlYy5pbnB1dHMuZmluZCgoeCkgPT4geC5yZXF1aXJlZCkgPyBcIlwiIDogXCIgPSB7fVwiO1xuXG4gICAgdGhpcy5jb2RlLm9wZW4oXG4gICAgICBgcHVibGljIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIG9wdGlvbnM6ICR7b3B0aW9uc1R5cGV9JHthbGxPcHRpb25hbH0pIHtgXG4gICAgKTtcbiAgICB0aGlzLmNvZGUub3Blbihgc3VwZXIoc2NvcGUsIGlkLCB7YCk7XG4gICAgdGhpcy5jb2RlLmxpbmUoYHNvdXJjZTogJyR7dGFyZ2V0LnNvdXJjZX0nLGApO1xuICAgIGlmICh0YXJnZXQudmVyc2lvbikge1xuICAgICAgdGhpcy5jb2RlLmxpbmUoYHZlcnNpb246ICcke3RhcmdldC52ZXJzaW9ufScsYCk7XG4gICAgfVxuICAgIHRoaXMuY29kZS5jbG9zZShgfSk7YCk7XG5cbiAgICBmb3IgKGNvbnN0IGlucHV0IG9mIHNwZWMuaW5wdXRzKSB7XG4gICAgICBjb25zdCBpbnB1dE5hbWUgPSB0b0NhbWVsQ2FzZShpbnB1dC5uYW1lKTtcbiAgICAgIHRoaXMuY29kZS5saW5lKGB0aGlzLiR7aW5wdXROYW1lfSA9IG9wdGlvbnMuJHtpbnB1dE5hbWV9O2ApO1xuICAgIH1cblxuICAgIHRoaXMuY29kZS5jbG9zZShgfWApOyAvLyBjdG9yXG5cbiAgICBmb3IgKGNvbnN0IGlucHV0IG9mIHNwZWMuaW5wdXRzKSB7XG4gICAgICBjb25zdCBpbnB1dE5hbWUgPSB0b0NhbWVsQ2FzZShpbnB1dC5uYW1lKTtcbiAgICAgIGNvbnN0IGlucHV0VHlwZSA9XG4gICAgICAgIHBhcnNlVHlwZShpbnB1dC50eXBlKSArXG4gICAgICAgIChpbnB1dC5yZXF1aXJlZCAmJiBpbnB1dC5kZWZhdWx0ID09PSB1bmRlZmluZWQgPyBcIlwiIDogXCIgfCB1bmRlZmluZWRcIik7XG4gICAgICB0aGlzLmNvZGUub3BlbkJsb2NrKGBwdWJsaWMgZ2V0ICR7aW5wdXROYW1lfSgpOiAke2lucHV0VHlwZX1gKTtcbiAgICAgIHRoaXMuY29kZS5saW5lKGByZXR1cm4gdGhpcy5pbnB1dHNbJyR7aW5wdXQubmFtZX0nXSBhcyAke2lucHV0VHlwZX07YCk7XG4gICAgICB0aGlzLmNvZGUuY2xvc2VCbG9jaygpO1xuXG4gICAgICB0aGlzLmNvZGUub3BlbkJsb2NrKGBwdWJsaWMgc2V0ICR7aW5wdXROYW1lfSh2YWx1ZTogJHtpbnB1dFR5cGV9KWApO1xuICAgICAgdGhpcy5jb2RlLmxpbmUoYHRoaXMuaW5wdXRzWycke2lucHV0Lm5hbWV9J10gPSB2YWx1ZTtgKTtcbiAgICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBvdXRwdXQgb2Ygc3BlYy5vdXRwdXRzKSB7XG4gICAgICBjb25zdCBvdXRwdXROYW1lID0gdG9DYW1lbENhc2Uob3V0cHV0Lm5hbWUpO1xuICAgICAgdGhpcy5jb2RlLm9wZW5CbG9jayhgcHVibGljIGdldCAke291dHB1dE5hbWV9T3V0cHV0KClgKTtcbiAgICAgIHRoaXMuY29kZS5saW5lKGByZXR1cm4gdGhpcy5pbnRlcnBvbGF0aW9uRm9yT3V0cHV0KCcke291dHB1dC5uYW1lfScpYCk7XG4gICAgICB0aGlzLmNvZGUuY2xvc2VCbG9jaygpO1xuICAgIH1cblxuICAgIHRoaXMuY29kZS5vcGVuQmxvY2soYHByb3RlY3RlZCBzeW50aGVzaXplQXR0cmlidXRlcygpYCk7XG4gICAgdGhpcy5jb2RlLmxpbmUoYHJldHVybiB0aGlzLmlucHV0cztgKTtcbiAgICB0aGlzLmNvZGUuY2xvc2VCbG9jaygpO1xuXG4gICAgdGhpcy5jb2RlLmNsb3NlQmxvY2soKTsgLy8gY2xhc3NcbiAgICB0aGlzLmNvZGUuY2xvc2VGaWxlKHRhcmdldC5maWxlTmFtZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VUeXBlKHR5cGU6IHN0cmluZykge1xuICBpZiAodHlwZSA9PT0gXCJzdHJpbmdcIikge1xuICAgIHJldHVybiBcInN0cmluZ1wiO1xuICB9XG4gIGlmICh0eXBlID09PSBcIm51bWJlclwiKSB7XG4gICAgcmV0dXJuIFwibnVtYmVyXCI7XG4gIH1cbiAgaWYgKHR5cGUgPT09IFwiYm9vbFwiKSB7XG4gICAgcmV0dXJuIFwiYm9vbGVhblwiO1xuICB9XG4gIGlmICh0eXBlID09PSBcImxpc3RcIikge1xuICAgIHJldHVybiBcInN0cmluZ1tdXCI7XG4gIH1cbiAgaWYgKHR5cGUgPT09IFwibWFwXCIpIHtcbiAgICByZXR1cm4gXCJ7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9XCI7XG4gIH1cbiAgaWYgKHR5cGUgPT09IFwiYW55XCIpIHtcbiAgICByZXR1cm4gXCJhbnlcIjtcbiAgfVxuXG4gIGNvbnN0IGNvbXBsZXhUeXBlID0gcGFyc2VDb21wbGV4VHlwZSh0eXBlKTtcbiAgaWYgKGNvbXBsZXhUeXBlKSB7XG4gICAgcmV0dXJuIGNvbXBsZXhUeXBlO1xuICB9XG5cbiAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIHR5cGUgJHt0eXBlfWApO1xufVxuXG5mdW5jdGlvbiBwYXJzZUNvbXBsZXhUeXBlKHR5cGU6IHN0cmluZyk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gIGNvbnN0IGNvbXBsZXggPSAvXihvYmplY3R8bGlzdHxtYXApXFwoKFtcXHNcXFNdKylcXCkvO1xuICBjb25zdCBtYXRjaCA9IGNvbXBsZXguZXhlYyh0eXBlKTtcbiAgaWYgKCFtYXRjaCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCBbLCBraW5kLCBpbm5lclR5cGVdID0gbWF0Y2g7XG5cbiAgaWYgKGtpbmQgPT09IFwib2JqZWN0XCIpIHtcbiAgICByZXR1cm4gYGFueWA7XG4gIH1cblxuICBpZiAoa2luZCA9PT0gXCJsaXN0XCIpIHtcbiAgICByZXR1cm4gYCR7cGFyc2VUeXBlKGlubmVyVHlwZSl9W11gO1xuICB9XG5cbiAgaWYgKGtpbmQgPT09IFwibWFwXCIpIHtcbiAgICByZXR1cm4gYHsgW2tleTogc3RyaW5nXTogJHtwYXJzZVR5cGUoaW5uZXJUeXBlKX0gfWA7XG4gIH1cblxuICB0aHJvdyBuZXcgRXJyb3IoYHVuZXhwZWN0ZWQga2luZCAke2tpbmR9YCk7XG59XG4iXX0=
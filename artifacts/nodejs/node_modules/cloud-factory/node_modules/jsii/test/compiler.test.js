"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs_extra_1 = require("fs-extra");
const os_1 = require("os");
const path_1 = require("path");
const compiler_1 = require("../lib/compiler");
describe(compiler_1.Compiler, () => {
    describe('generated tsconfig', () => {
        test('default is tsconfig.json', async () => {
            const sourceDir = await fs_extra_1.mkdtemp(path_1.join(os_1.tmpdir(), 'jsii-compiler-watch-mode-'));
            const compiler = new compiler_1.Compiler({
                projectInfo: _makeProjectInfo(sourceDir, 'index.d.ts'),
            });
            await compiler.emit();
            expect(await fs_extra_1.readJson(path_1.join(sourceDir, 'tsconfig.json'), 'utf-8')).toEqual(expectedTypeScriptConfig());
        });
        test('file name can be customized', async () => {
            const sourceDir = await fs_extra_1.mkdtemp(path_1.join(os_1.tmpdir(), 'jsii-compiler-watch-mode-'));
            const compiler = new compiler_1.Compiler({
                projectInfo: _makeProjectInfo(sourceDir, 'index.d.ts'),
                generateTypeScriptConfig: 'tsconfig.jsii.json',
            });
            await compiler.emit();
            expect(await fs_extra_1.readJson(path_1.join(sourceDir, 'tsconfig.jsii.json'), 'utf-8')).toEqual(expectedTypeScriptConfig());
        });
    });
    test('"watch" mode', async () => {
        // This can be a little slow, allowing 15 seconds maximum here (default is 5 seconds)
        jest.setTimeout(15000);
        const sourceDir = await fs_extra_1.mkdtemp(path_1.join(os_1.tmpdir(), 'jsii-compiler-watch-mode-'));
        try {
            await fs_extra_1.writeFile(path_1.join(sourceDir, 'index.ts'), 'export class MarkerA {}');
            // Intentionally using lower case name - it should be case-insensitive
            await fs_extra_1.writeFile(path_1.join(sourceDir, 'readme.md'), '# Test Package');
            const compiler = new compiler_1.Compiler({
                projectInfo: _makeProjectInfo(sourceDir, 'index.d.ts'),
                failOnWarnings: true,
                projectReferences: false,
            });
            let firstCompilation = true;
            let onWatchClosed;
            let onWatchFailed;
            const watchClosed = new Promise((ok, ko) => {
                onWatchClosed = ok;
                onWatchFailed = ko;
            });
            const watch = await compiler.watch({
                nonBlocking: true,
                // Ignore diagnostics reporting (not to pollute test console output)
                reportDiagnostics: () => null,
                // Ignore watch status reporting (not to pollute test console output)
                reportWatchStatus: () => null,
                // Verify everything goes according to plan
                compilationComplete: async (emitResult) => {
                    try {
                        expect(emitResult.emitSkipped).toBeFalsy();
                        const output = await fs_extra_1.readFile(path_1.join(sourceDir, '.jsii'), {
                            encoding: 'utf-8',
                        });
                        if (firstCompilation) {
                            firstCompilation = false;
                            expect(output).toContain('"MarkerA"');
                            await fs_extra_1.writeFile(path_1.join(sourceDir, 'index.ts'), 'export class MarkerB {}');
                            return;
                        }
                        expect(output).toContain('"MarkerB"');
                        watch.close();
                        // Tell the test suite we're done here!
                        onWatchClosed();
                    }
                    catch (e) {
                        watch.close();
                        onWatchFailed(e);
                    }
                },
            });
            await watchClosed;
        }
        finally {
            await fs_extra_1.remove(sourceDir);
        }
    });
    test('rootDir is added to assembly', async () => {
        const outDir = 'jsii-outdir';
        const rootDir = 'jsii-rootdir';
        const sourceDir = await fs_extra_1.mkdtemp(path_1.join(os_1.tmpdir(), 'jsii-tmpdir'));
        await fs_extra_1.ensureDir(path_1.join(sourceDir, rootDir));
        try {
            await fs_extra_1.writeFile(path_1.join(sourceDir, rootDir, 'index.ts'), 'export class MarkerA {}');
            // Intentionally using lower case name - it should be case-insensitive
            await fs_extra_1.writeFile(path_1.join(sourceDir, rootDir, 'readme.md'), '# Test Package');
            const compiler = new compiler_1.Compiler({
                projectInfo: {
                    ..._makeProjectInfo(sourceDir, path_1.join(outDir, 'index.d.ts')),
                    tsc: {
                        outDir,
                        rootDir,
                    },
                },
                failOnWarnings: true,
                projectReferences: false,
            });
            await compiler.emit();
            const assembly = await fs_extra_1.readJson(path_1.join(sourceDir, '.jsii'), 'utf-8');
            expect(assembly.metadata).toEqual(expect.objectContaining({
                tscRootDir: rootDir,
            }));
        }
        finally {
            await fs_extra_1.remove(sourceDir);
        }
    });
});
function _makeProjectInfo(sourceDir, types) {
    return {
        projectRoot: sourceDir,
        packageJson: undefined,
        types,
        main: types.replace(/(?:\.d)?\.ts(x?)/, '.js$1'),
        name: 'jsii',
        version: '0.0.1',
        jsiiVersionFormat: 'short',
        license: 'Apache-2.0',
        author: { name: 'John Doe', roles: ['author'] },
        repository: { type: 'git', url: 'https://github.com/aws/jsii.git' },
        dependencies: {},
        peerDependencies: {},
        dependencyClosure: [],
        bundleDependencies: {},
        targets: {},
        excludeTypescript: [],
    };
}
function expectedTypeScriptConfig() {
    return {
        _generated_by_jsii_: 'Generated by jsii - safe to delete, and ideally should be in .gitignore',
        compilerOptions: {
            alwaysStrict: true,
            charset: 'utf8',
            composite: false,
            declaration: true,
            experimentalDecorators: true,
            incremental: true,
            inlineSourceMap: true,
            inlineSources: true,
            lib: ['es2019'],
            module: 'CommonJS',
            newLine: 'lf',
            noEmitOnError: true,
            noFallthroughCasesInSwitch: true,
            noImplicitAny: true,
            noImplicitReturns: true,
            noImplicitThis: true,
            noUnusedLocals: true,
            noUnusedParameters: true,
            resolveJsonModule: true,
            strict: true,
            strictNullChecks: true,
            strictPropertyInitialization: true,
            stripInternal: false,
            target: 'ES2019',
            tsBuildInfoFile: 'tsconfig.tsbuildinfo',
        },
        exclude: ['node_modules'],
        include: [path_1.join('**', '*.ts')],
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZXIudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbXBpbGVyLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx1Q0FPa0I7QUFDbEIsMkJBQTRCO0FBQzVCLCtCQUE0QjtBQUU1Qiw4Q0FBMkM7QUFHM0MsUUFBUSxDQUFDLG1CQUFRLEVBQUUsR0FBRyxFQUFFO0lBQ3RCLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLEVBQUU7UUFDbEMsSUFBSSxDQUFDLDBCQUEwQixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzFDLE1BQU0sU0FBUyxHQUFHLE1BQU0sa0JBQU8sQ0FDN0IsV0FBSSxDQUFDLFdBQU0sRUFBRSxFQUFFLDJCQUEyQixDQUFDLENBQzVDLENBQUM7WUFFRixNQUFNLFFBQVEsR0FBRyxJQUFJLG1CQUFRLENBQUM7Z0JBQzVCLFdBQVcsRUFBRSxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDO2FBQ3ZELENBQUMsQ0FBQztZQUVILE1BQU0sUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1lBRXRCLE1BQU0sQ0FBQyxNQUFNLG1CQUFRLENBQUMsV0FBSSxDQUFDLFNBQVMsRUFBRSxlQUFlLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FDdkUsd0JBQXdCLEVBQUUsQ0FDM0IsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLDZCQUE2QixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzdDLE1BQU0sU0FBUyxHQUFHLE1BQU0sa0JBQU8sQ0FDN0IsV0FBSSxDQUFDLFdBQU0sRUFBRSxFQUFFLDJCQUEyQixDQUFDLENBQzVDLENBQUM7WUFFRixNQUFNLFFBQVEsR0FBRyxJQUFJLG1CQUFRLENBQUM7Z0JBQzVCLFdBQVcsRUFBRSxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDO2dCQUN0RCx3QkFBd0IsRUFBRSxvQkFBb0I7YUFDL0MsQ0FBQyxDQUFDO1lBRUgsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFdEIsTUFBTSxDQUNKLE1BQU0sbUJBQVEsQ0FBQyxXQUFJLENBQUMsU0FBUyxFQUFFLG9CQUFvQixDQUFDLEVBQUUsT0FBTyxDQUFDLENBQy9ELENBQUMsT0FBTyxDQUFDLHdCQUF3QixFQUFFLENBQUMsQ0FBQztRQUN4QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLGNBQWMsRUFBRSxLQUFLLElBQUksRUFBRTtRQUM5QixxRkFBcUY7UUFDckYsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFNLENBQUMsQ0FBQztRQUV4QixNQUFNLFNBQVMsR0FBRyxNQUFNLGtCQUFPLENBQzdCLFdBQUksQ0FBQyxXQUFNLEVBQUUsRUFBRSwyQkFBMkIsQ0FBQyxDQUM1QyxDQUFDO1FBRUYsSUFBSTtZQUNGLE1BQU0sb0JBQVMsQ0FBQyxXQUFJLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxFQUFFLHlCQUF5QixDQUFDLENBQUM7WUFDeEUsc0VBQXNFO1lBQ3RFLE1BQU0sb0JBQVMsQ0FBQyxXQUFJLENBQUMsU0FBUyxFQUFFLFdBQVcsQ0FBQyxFQUFFLGdCQUFnQixDQUFDLENBQUM7WUFFaEUsTUFBTSxRQUFRLEdBQUcsSUFBSSxtQkFBUSxDQUFDO2dCQUM1QixXQUFXLEVBQUUsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQztnQkFDdEQsY0FBYyxFQUFFLElBQUk7Z0JBQ3BCLGlCQUFpQixFQUFFLEtBQUs7YUFDekIsQ0FBQyxDQUFDO1lBRUgsSUFBSSxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7WUFDNUIsSUFBSSxhQUF5QixDQUFDO1lBQzlCLElBQUksYUFBbUMsQ0FBQztZQUN4QyxNQUFNLFdBQVcsR0FBRyxJQUFJLE9BQU8sQ0FBTyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRTtnQkFDL0MsYUFBYSxHQUFHLEVBQUUsQ0FBQztnQkFDbkIsYUFBYSxHQUFHLEVBQUUsQ0FBQztZQUNyQixDQUFDLENBQUMsQ0FBQztZQUNILE1BQU0sS0FBSyxHQUFHLE1BQU0sUUFBUSxDQUFDLEtBQUssQ0FBQztnQkFDakMsV0FBVyxFQUFFLElBQUk7Z0JBQ2pCLG9FQUFvRTtnQkFDcEUsaUJBQWlCLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSTtnQkFDN0IscUVBQXFFO2dCQUNyRSxpQkFBaUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJO2dCQUM3QiwyQ0FBMkM7Z0JBQzNDLG1CQUFtQixFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsRUFBRTtvQkFDeEMsSUFBSTt3QkFDRixNQUFNLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDO3dCQUMzQyxNQUFNLE1BQU0sR0FBRyxNQUFNLG1CQUFRLENBQUMsV0FBSSxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsRUFBRTs0QkFDdEQsUUFBUSxFQUFFLE9BQU87eUJBQ2xCLENBQUMsQ0FBQzt3QkFDSCxJQUFJLGdCQUFnQixFQUFFOzRCQUNwQixnQkFBZ0IsR0FBRyxLQUFLLENBQUM7NEJBQ3pCLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7NEJBQ3RDLE1BQU0sb0JBQVMsQ0FDYixXQUFJLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxFQUMzQix5QkFBeUIsQ0FDMUIsQ0FBQzs0QkFDRixPQUFPO3lCQUNSO3dCQUNELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7d0JBQ3RDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQzt3QkFDZCx1Q0FBdUM7d0JBQ3ZDLGFBQWEsRUFBRSxDQUFDO3FCQUNqQjtvQkFBQyxPQUFPLENBQUMsRUFBRTt3QkFDVixLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7d0JBQ2QsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO3FCQUNsQjtnQkFDSCxDQUFDO2FBQ0YsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxXQUFXLENBQUM7U0FDbkI7Z0JBQVM7WUFDUixNQUFNLGlCQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDekI7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyw4QkFBOEIsRUFBRSxLQUFLLElBQUksRUFBRTtRQUM5QyxNQUFNLE1BQU0sR0FBRyxhQUFhLENBQUM7UUFDN0IsTUFBTSxPQUFPLEdBQUcsY0FBYyxDQUFDO1FBQy9CLE1BQU0sU0FBUyxHQUFHLE1BQU0sa0JBQU8sQ0FBQyxXQUFJLENBQUMsV0FBTSxFQUFFLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUMvRCxNQUFNLG9CQUFTLENBQUMsV0FBSSxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBRTFDLElBQUk7WUFDRixNQUFNLG9CQUFTLENBQ2IsV0FBSSxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsVUFBVSxDQUFDLEVBQ3BDLHlCQUF5QixDQUMxQixDQUFDO1lBQ0Ysc0VBQXNFO1lBQ3RFLE1BQU0sb0JBQVMsQ0FBQyxXQUFJLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxXQUFXLENBQUMsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBRXpFLE1BQU0sUUFBUSxHQUFHLElBQUksbUJBQVEsQ0FBQztnQkFDNUIsV0FBVyxFQUFFO29CQUNYLEdBQUcsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLFdBQUksQ0FBQyxNQUFNLEVBQUUsWUFBWSxDQUFDLENBQUM7b0JBQzFELEdBQUcsRUFBRTt3QkFDSCxNQUFNO3dCQUNOLE9BQU87cUJBQ1I7aUJBQ0Y7Z0JBQ0QsY0FBYyxFQUFFLElBQUk7Z0JBQ3BCLGlCQUFpQixFQUFFLEtBQUs7YUFDekIsQ0FBQyxDQUFDO1lBRUgsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFdEIsTUFBTSxRQUFRLEdBQUcsTUFBTSxtQkFBUSxDQUFDLFdBQUksQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDbkUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQy9CLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsVUFBVSxFQUFFLE9BQU87YUFDcEIsQ0FBQyxDQUNILENBQUM7U0FDSDtnQkFBUztZQUNSLE1BQU0saUJBQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUN6QjtJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxTQUFTLGdCQUFnQixDQUFDLFNBQWlCLEVBQUUsS0FBYTtJQUN4RCxPQUFPO1FBQ0wsV0FBVyxFQUFFLFNBQVM7UUFDdEIsV0FBVyxFQUFFLFNBQVM7UUFDdEIsS0FBSztRQUNMLElBQUksRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLGtCQUFrQixFQUFFLE9BQU8sQ0FBQztRQUNoRCxJQUFJLEVBQUUsTUFBTTtRQUNaLE9BQU8sRUFBRSxPQUFPO1FBQ2hCLGlCQUFpQixFQUFFLE9BQU87UUFDMUIsT0FBTyxFQUFFLFlBQVk7UUFDckIsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRTtRQUMvQyxVQUFVLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxpQ0FBaUMsRUFBRTtRQUNuRSxZQUFZLEVBQUUsRUFBRTtRQUNoQixnQkFBZ0IsRUFBRSxFQUFFO1FBQ3BCLGlCQUFpQixFQUFFLEVBQUU7UUFDckIsa0JBQWtCLEVBQUUsRUFBRTtRQUN0QixPQUFPLEVBQUUsRUFBRTtRQUNYLGlCQUFpQixFQUFFLEVBQUU7S0FDdEIsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLHdCQUF3QjtJQUMvQixPQUFPO1FBQ0wsbUJBQW1CLEVBQ2pCLHlFQUF5RTtRQUMzRSxlQUFlLEVBQUU7WUFDZixZQUFZLEVBQUUsSUFBSTtZQUNsQixPQUFPLEVBQUUsTUFBTTtZQUNmLFNBQVMsRUFBRSxLQUFLO1lBQ2hCLFdBQVcsRUFBRSxJQUFJO1lBQ2pCLHNCQUFzQixFQUFFLElBQUk7WUFDNUIsV0FBVyxFQUFFLElBQUk7WUFDakIsZUFBZSxFQUFFLElBQUk7WUFDckIsYUFBYSxFQUFFLElBQUk7WUFDbkIsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDO1lBQ2YsTUFBTSxFQUFFLFVBQVU7WUFDbEIsT0FBTyxFQUFFLElBQUk7WUFDYixhQUFhLEVBQUUsSUFBSTtZQUNuQiwwQkFBMEIsRUFBRSxJQUFJO1lBQ2hDLGFBQWEsRUFBRSxJQUFJO1lBQ25CLGlCQUFpQixFQUFFLElBQUk7WUFDdkIsY0FBYyxFQUFFLElBQUk7WUFDcEIsY0FBYyxFQUFFLElBQUk7WUFDcEIsa0JBQWtCLEVBQUUsSUFBSTtZQUN4QixpQkFBaUIsRUFBRSxJQUFJO1lBQ3ZCLE1BQU0sRUFBRSxJQUFJO1lBQ1osZ0JBQWdCLEVBQUUsSUFBSTtZQUN0Qiw0QkFBNEIsRUFBRSxJQUFJO1lBQ2xDLGFBQWEsRUFBRSxLQUFLO1lBQ3BCLE1BQU0sRUFBRSxRQUFRO1lBQ2hCLGVBQWUsRUFBRSxzQkFBc0I7U0FDeEM7UUFDRCxPQUFPLEVBQUUsQ0FBQyxjQUFjLENBQUM7UUFDekIsT0FBTyxFQUFFLENBQUMsV0FBSSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztLQUM5QixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIGVuc3VyZURpcixcbiAgbWtkdGVtcCxcbiAgcmVtb3ZlLFxuICB3cml0ZUZpbGUsXG4gIHJlYWRGaWxlLFxuICByZWFkSnNvbixcbn0gZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgdG1wZGlyIH0gZnJvbSAnb3MnO1xuaW1wb3J0IHsgam9pbiB9IGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgeyBDb21waWxlciB9IGZyb20gJy4uL2xpYi9jb21waWxlcic7XG5pbXBvcnQgeyBQcm9qZWN0SW5mbyB9IGZyb20gJy4uL2xpYi9wcm9qZWN0LWluZm8nO1xuXG5kZXNjcmliZShDb21waWxlciwgKCkgPT4ge1xuICBkZXNjcmliZSgnZ2VuZXJhdGVkIHRzY29uZmlnJywgKCkgPT4ge1xuICAgIHRlc3QoJ2RlZmF1bHQgaXMgdHNjb25maWcuanNvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHNvdXJjZURpciA9IGF3YWl0IG1rZHRlbXAoXG4gICAgICAgIGpvaW4odG1wZGlyKCksICdqc2lpLWNvbXBpbGVyLXdhdGNoLW1vZGUtJyksXG4gICAgICApO1xuXG4gICAgICBjb25zdCBjb21waWxlciA9IG5ldyBDb21waWxlcih7XG4gICAgICAgIHByb2plY3RJbmZvOiBfbWFrZVByb2plY3RJbmZvKHNvdXJjZURpciwgJ2luZGV4LmQudHMnKSxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBjb21waWxlci5lbWl0KCk7XG5cbiAgICAgIGV4cGVjdChhd2FpdCByZWFkSnNvbihqb2luKHNvdXJjZURpciwgJ3RzY29uZmlnLmpzb24nKSwgJ3V0Zi04JykpLnRvRXF1YWwoXG4gICAgICAgIGV4cGVjdGVkVHlwZVNjcmlwdENvbmZpZygpLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2ZpbGUgbmFtZSBjYW4gYmUgY3VzdG9taXplZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHNvdXJjZURpciA9IGF3YWl0IG1rZHRlbXAoXG4gICAgICAgIGpvaW4odG1wZGlyKCksICdqc2lpLWNvbXBpbGVyLXdhdGNoLW1vZGUtJyksXG4gICAgICApO1xuXG4gICAgICBjb25zdCBjb21waWxlciA9IG5ldyBDb21waWxlcih7XG4gICAgICAgIHByb2plY3RJbmZvOiBfbWFrZVByb2plY3RJbmZvKHNvdXJjZURpciwgJ2luZGV4LmQudHMnKSxcbiAgICAgICAgZ2VuZXJhdGVUeXBlU2NyaXB0Q29uZmlnOiAndHNjb25maWcuanNpaS5qc29uJyxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBjb21waWxlci5lbWl0KCk7XG5cbiAgICAgIGV4cGVjdChcbiAgICAgICAgYXdhaXQgcmVhZEpzb24oam9pbihzb3VyY2VEaXIsICd0c2NvbmZpZy5qc2lpLmpzb24nKSwgJ3V0Zi04JyksXG4gICAgICApLnRvRXF1YWwoZXhwZWN0ZWRUeXBlU2NyaXB0Q29uZmlnKCkpO1xuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdcIndhdGNoXCIgbW9kZScsIGFzeW5jICgpID0+IHtcbiAgICAvLyBUaGlzIGNhbiBiZSBhIGxpdHRsZSBzbG93LCBhbGxvd2luZyAxNSBzZWNvbmRzIG1heGltdW0gaGVyZSAoZGVmYXVsdCBpcyA1IHNlY29uZHMpXG4gICAgamVzdC5zZXRUaW1lb3V0KDE1XzAwMCk7XG5cbiAgICBjb25zdCBzb3VyY2VEaXIgPSBhd2FpdCBta2R0ZW1wKFxuICAgICAgam9pbih0bXBkaXIoKSwgJ2pzaWktY29tcGlsZXItd2F0Y2gtbW9kZS0nKSxcbiAgICApO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHdyaXRlRmlsZShqb2luKHNvdXJjZURpciwgJ2luZGV4LnRzJyksICdleHBvcnQgY2xhc3MgTWFya2VyQSB7fScpO1xuICAgICAgLy8gSW50ZW50aW9uYWxseSB1c2luZyBsb3dlciBjYXNlIG5hbWUgLSBpdCBzaG91bGQgYmUgY2FzZS1pbnNlbnNpdGl2ZVxuICAgICAgYXdhaXQgd3JpdGVGaWxlKGpvaW4oc291cmNlRGlyLCAncmVhZG1lLm1kJyksICcjIFRlc3QgUGFja2FnZScpO1xuXG4gICAgICBjb25zdCBjb21waWxlciA9IG5ldyBDb21waWxlcih7XG4gICAgICAgIHByb2plY3RJbmZvOiBfbWFrZVByb2plY3RJbmZvKHNvdXJjZURpciwgJ2luZGV4LmQudHMnKSxcbiAgICAgICAgZmFpbE9uV2FybmluZ3M6IHRydWUsXG4gICAgICAgIHByb2plY3RSZWZlcmVuY2VzOiBmYWxzZSxcbiAgICAgIH0pO1xuXG4gICAgICBsZXQgZmlyc3RDb21waWxhdGlvbiA9IHRydWU7XG4gICAgICBsZXQgb25XYXRjaENsb3NlZDogKCkgPT4gdm9pZDtcbiAgICAgIGxldCBvbldhdGNoRmFpbGVkOiAoZXJyOiBFcnJvcikgPT4gdm9pZDtcbiAgICAgIGNvbnN0IHdhdGNoQ2xvc2VkID0gbmV3IFByb21pc2U8dm9pZD4oKG9rLCBrbykgPT4ge1xuICAgICAgICBvbldhdGNoQ2xvc2VkID0gb2s7XG4gICAgICAgIG9uV2F0Y2hGYWlsZWQgPSBrbztcbiAgICAgIH0pO1xuICAgICAgY29uc3Qgd2F0Y2ggPSBhd2FpdCBjb21waWxlci53YXRjaCh7XG4gICAgICAgIG5vbkJsb2NraW5nOiB0cnVlLFxuICAgICAgICAvLyBJZ25vcmUgZGlhZ25vc3RpY3MgcmVwb3J0aW5nIChub3QgdG8gcG9sbHV0ZSB0ZXN0IGNvbnNvbGUgb3V0cHV0KVxuICAgICAgICByZXBvcnREaWFnbm9zdGljczogKCkgPT4gbnVsbCxcbiAgICAgICAgLy8gSWdub3JlIHdhdGNoIHN0YXR1cyByZXBvcnRpbmcgKG5vdCB0byBwb2xsdXRlIHRlc3QgY29uc29sZSBvdXRwdXQpXG4gICAgICAgIHJlcG9ydFdhdGNoU3RhdHVzOiAoKSA9PiBudWxsLFxuICAgICAgICAvLyBWZXJpZnkgZXZlcnl0aGluZyBnb2VzIGFjY29yZGluZyB0byBwbGFuXG4gICAgICAgIGNvbXBpbGF0aW9uQ29tcGxldGU6IGFzeW5jIChlbWl0UmVzdWx0KSA9PiB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGV4cGVjdChlbWl0UmVzdWx0LmVtaXRTa2lwcGVkKS50b0JlRmFsc3koKTtcbiAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHJlYWRGaWxlKGpvaW4oc291cmNlRGlyLCAnLmpzaWknKSwge1xuICAgICAgICAgICAgICBlbmNvZGluZzogJ3V0Zi04JyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaWYgKGZpcnN0Q29tcGlsYXRpb24pIHtcbiAgICAgICAgICAgICAgZmlyc3RDb21waWxhdGlvbiA9IGZhbHNlO1xuICAgICAgICAgICAgICBleHBlY3Qob3V0cHV0KS50b0NvbnRhaW4oJ1wiTWFya2VyQVwiJyk7XG4gICAgICAgICAgICAgIGF3YWl0IHdyaXRlRmlsZShcbiAgICAgICAgICAgICAgICBqb2luKHNvdXJjZURpciwgJ2luZGV4LnRzJyksXG4gICAgICAgICAgICAgICAgJ2V4cG9ydCBjbGFzcyBNYXJrZXJCIHt9JyxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZXhwZWN0KG91dHB1dCkudG9Db250YWluKCdcIk1hcmtlckJcIicpO1xuICAgICAgICAgICAgd2F0Y2guY2xvc2UoKTtcbiAgICAgICAgICAgIC8vIFRlbGwgdGhlIHRlc3Qgc3VpdGUgd2UncmUgZG9uZSBoZXJlIVxuICAgICAgICAgICAgb25XYXRjaENsb3NlZCgpO1xuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHdhdGNoLmNsb3NlKCk7XG4gICAgICAgICAgICBvbldhdGNoRmFpbGVkKGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgd2F0Y2hDbG9zZWQ7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGF3YWl0IHJlbW92ZShzb3VyY2VEaXIpO1xuICAgIH1cbiAgfSk7XG5cbiAgdGVzdCgncm9vdERpciBpcyBhZGRlZCB0byBhc3NlbWJseScsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBvdXREaXIgPSAnanNpaS1vdXRkaXInO1xuICAgIGNvbnN0IHJvb3REaXIgPSAnanNpaS1yb290ZGlyJztcbiAgICBjb25zdCBzb3VyY2VEaXIgPSBhd2FpdCBta2R0ZW1wKGpvaW4odG1wZGlyKCksICdqc2lpLXRtcGRpcicpKTtcbiAgICBhd2FpdCBlbnN1cmVEaXIoam9pbihzb3VyY2VEaXIsIHJvb3REaXIpKTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3cml0ZUZpbGUoXG4gICAgICAgIGpvaW4oc291cmNlRGlyLCByb290RGlyLCAnaW5kZXgudHMnKSxcbiAgICAgICAgJ2V4cG9ydCBjbGFzcyBNYXJrZXJBIHt9JyxcbiAgICAgICk7XG4gICAgICAvLyBJbnRlbnRpb25hbGx5IHVzaW5nIGxvd2VyIGNhc2UgbmFtZSAtIGl0IHNob3VsZCBiZSBjYXNlLWluc2Vuc2l0aXZlXG4gICAgICBhd2FpdCB3cml0ZUZpbGUoam9pbihzb3VyY2VEaXIsIHJvb3REaXIsICdyZWFkbWUubWQnKSwgJyMgVGVzdCBQYWNrYWdlJyk7XG5cbiAgICAgIGNvbnN0IGNvbXBpbGVyID0gbmV3IENvbXBpbGVyKHtcbiAgICAgICAgcHJvamVjdEluZm86IHtcbiAgICAgICAgICAuLi5fbWFrZVByb2plY3RJbmZvKHNvdXJjZURpciwgam9pbihvdXREaXIsICdpbmRleC5kLnRzJykpLFxuICAgICAgICAgIHRzYzoge1xuICAgICAgICAgICAgb3V0RGlyLFxuICAgICAgICAgICAgcm9vdERpcixcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBmYWlsT25XYXJuaW5nczogdHJ1ZSxcbiAgICAgICAgcHJvamVjdFJlZmVyZW5jZXM6IGZhbHNlLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IGNvbXBpbGVyLmVtaXQoKTtcblxuICAgICAgY29uc3QgYXNzZW1ibHkgPSBhd2FpdCByZWFkSnNvbihqb2luKHNvdXJjZURpciwgJy5qc2lpJyksICd1dGYtOCcpO1xuICAgICAgZXhwZWN0KGFzc2VtYmx5Lm1ldGFkYXRhKS50b0VxdWFsKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdHNjUm9vdERpcjogcm9vdERpcixcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhd2FpdCByZW1vdmUoc291cmNlRGlyKTtcbiAgICB9XG4gIH0pO1xufSk7XG5cbmZ1bmN0aW9uIF9tYWtlUHJvamVjdEluZm8oc291cmNlRGlyOiBzdHJpbmcsIHR5cGVzOiBzdHJpbmcpOiBQcm9qZWN0SW5mbyB7XG4gIHJldHVybiB7XG4gICAgcHJvamVjdFJvb3Q6IHNvdXJjZURpcixcbiAgICBwYWNrYWdlSnNvbjogdW5kZWZpbmVkLFxuICAgIHR5cGVzLFxuICAgIG1haW46IHR5cGVzLnJlcGxhY2UoLyg/OlxcLmQpP1xcLnRzKHg/KS8sICcuanMkMScpLFxuICAgIG5hbWU6ICdqc2lpJywgLy8gVGhhdCdzIHdoYXQgcGFja2FnZS5qc29uIHdvdWxkIHRlbGwgaWYgd2UgbG9vayB1cC4uLlxuICAgIHZlcnNpb246ICcwLjAuMScsXG4gICAganNpaVZlcnNpb25Gb3JtYXQ6ICdzaG9ydCcsXG4gICAgbGljZW5zZTogJ0FwYWNoZS0yLjAnLFxuICAgIGF1dGhvcjogeyBuYW1lOiAnSm9obiBEb2UnLCByb2xlczogWydhdXRob3InXSB9LFxuICAgIHJlcG9zaXRvcnk6IHsgdHlwZTogJ2dpdCcsIHVybDogJ2h0dHBzOi8vZ2l0aHViLmNvbS9hd3MvanNpaS5naXQnIH0sXG4gICAgZGVwZW5kZW5jaWVzOiB7fSxcbiAgICBwZWVyRGVwZW5kZW5jaWVzOiB7fSxcbiAgICBkZXBlbmRlbmN5Q2xvc3VyZTogW10sXG4gICAgYnVuZGxlRGVwZW5kZW5jaWVzOiB7fSxcbiAgICB0YXJnZXRzOiB7fSxcbiAgICBleGNsdWRlVHlwZXNjcmlwdDogW10sXG4gIH07XG59XG5cbmZ1bmN0aW9uIGV4cGVjdGVkVHlwZVNjcmlwdENvbmZpZygpIHtcbiAgcmV0dXJuIHtcbiAgICBfZ2VuZXJhdGVkX2J5X2pzaWlfOlxuICAgICAgJ0dlbmVyYXRlZCBieSBqc2lpIC0gc2FmZSB0byBkZWxldGUsIGFuZCBpZGVhbGx5IHNob3VsZCBiZSBpbiAuZ2l0aWdub3JlJyxcbiAgICBjb21waWxlck9wdGlvbnM6IHtcbiAgICAgIGFsd2F5c1N0cmljdDogdHJ1ZSxcbiAgICAgIGNoYXJzZXQ6ICd1dGY4JyxcbiAgICAgIGNvbXBvc2l0ZTogZmFsc2UsXG4gICAgICBkZWNsYXJhdGlvbjogdHJ1ZSxcbiAgICAgIGV4cGVyaW1lbnRhbERlY29yYXRvcnM6IHRydWUsXG4gICAgICBpbmNyZW1lbnRhbDogdHJ1ZSxcbiAgICAgIGlubGluZVNvdXJjZU1hcDogdHJ1ZSxcbiAgICAgIGlubGluZVNvdXJjZXM6IHRydWUsXG4gICAgICBsaWI6IFsnZXMyMDE5J10sXG4gICAgICBtb2R1bGU6ICdDb21tb25KUycsXG4gICAgICBuZXdMaW5lOiAnbGYnLFxuICAgICAgbm9FbWl0T25FcnJvcjogdHJ1ZSxcbiAgICAgIG5vRmFsbHRocm91Z2hDYXNlc0luU3dpdGNoOiB0cnVlLFxuICAgICAgbm9JbXBsaWNpdEFueTogdHJ1ZSxcbiAgICAgIG5vSW1wbGljaXRSZXR1cm5zOiB0cnVlLFxuICAgICAgbm9JbXBsaWNpdFRoaXM6IHRydWUsXG4gICAgICBub1VudXNlZExvY2FsczogdHJ1ZSxcbiAgICAgIG5vVW51c2VkUGFyYW1ldGVyczogdHJ1ZSxcbiAgICAgIHJlc29sdmVKc29uTW9kdWxlOiB0cnVlLFxuICAgICAgc3RyaWN0OiB0cnVlLFxuICAgICAgc3RyaWN0TnVsbENoZWNrczogdHJ1ZSxcbiAgICAgIHN0cmljdFByb3BlcnR5SW5pdGlhbGl6YXRpb246IHRydWUsXG4gICAgICBzdHJpcEludGVybmFsOiBmYWxzZSxcbiAgICAgIHRhcmdldDogJ0VTMjAxOScsXG4gICAgICB0c0J1aWxkSW5mb0ZpbGU6ICd0c2NvbmZpZy50c2J1aWxkaW5mbycsXG4gICAgfSxcbiAgICBleGNsdWRlOiBbJ25vZGVfbW9kdWxlcyddLFxuICAgIGluY2x1ZGU6IFtqb2luKCcqKicsICcqLnRzJyldLFxuICB9O1xufVxuIl19
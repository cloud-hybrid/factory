"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getOrganizationNames = exports.createWorkspace = exports.getAccountDetails = void 0;
const https = require("https");
const url_1 = require("url");
const BASE_URL = `https://app.terraform.io/api/v2/`;
const SUCCESS_STATUS_CODES = [200, 201];
async function get(url, token) {
    return new Promise((ok, ko) => {
        const req = https.request(url_1.format(url), { headers: { Authorization: `Bearer ${token}` } }, (res) => {
            if (res.statusCode !== 200) {
                console.log("\nERROR: couldn't validate token.");
                return ko(new Error(res.statusMessage));
            }
            const data = new Array();
            res.on("data", (chunk) => data.push(chunk));
            res.once("error", (err) => ko(err));
            res.once("end", () => {
                const response = JSON.parse(Buffer.concat(data).toString("utf-8"));
                return ok(response);
            });
        });
        req.end();
    });
}
async function post(url, token, data) {
    return new Promise((ok, ko) => {
        const req = https.request(url_1.format(url), {
            headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/vnd.api+json",
                "Content-Length": data.length,
            },
            method: "POST",
        }, (res) => {
            const data = new Array();
            res.on("data", (chunk) => data.push(chunk));
            res.once("error", (err) => ko(err));
            res.once("end", () => {
                const response = JSON.parse(Buffer.concat(data).toString("utf-8"));
                if (res.statusCode) {
                    const statusCode = res.statusCode;
                    if (!SUCCESS_STATUS_CODES.includes(statusCode)) {
                        const { errors } = response;
                        const message = errors
                            .map((error) => error.detail)
                            .join(", ");
                        return ko(new Error(message));
                    }
                }
                return ok(response);
            });
        });
        req.write(data);
        req.end();
    });
}
async function getAccountDetails(token) {
    return (await get(`${BASE_URL}/account/details`, token));
}
exports.getAccountDetails = getAccountDetails;
async function createWorkspace(organizationName, workspaceName, token) {
    await post(`${BASE_URL}/organizations/${organizationName}/workspaces`, token, JSON.stringify({
        data: {
            attributes: {
                name: workspaceName,
                operations: false,
            },
            type: "workspaces",
        },
    }));
}
exports.createWorkspace = createWorkspace;
async function getOrganizationNames(token) {
    return (await get(`${BASE_URL}/organizations`, token));
}
exports.getOrganizationNames = getOrganizationNames;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVycmFmb3JtLWNsb3VkLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRlcnJhZm9ybS1jbG91ZC1jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQWdDO0FBQ2hDLDZCQUE2QjtBQUU3QixNQUFNLFFBQVEsR0FBRyxrQ0FBa0MsQ0FBQztBQUVwRCxNQUFNLG9CQUFvQixHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBMkJ4QyxLQUFLLFVBQVUsR0FBRyxDQUFDLEdBQVcsRUFBRSxLQUFhO0lBQzNDLE9BQU8sSUFBSSxPQUFPLENBQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUU7UUFDakMsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FDdkIsWUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUNYLEVBQUUsT0FBTyxFQUFFLEVBQUUsYUFBYSxFQUFFLFVBQVUsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUNqRCxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ04sSUFBSSxHQUFHLENBQUMsVUFBVSxLQUFLLEdBQUcsRUFBRTtnQkFDMUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO2dCQUNqRCxPQUFPLEVBQUUsQ0FBQyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQzthQUN6QztZQUNELE1BQU0sSUFBSSxHQUFHLElBQUksS0FBSyxFQUFVLENBQUM7WUFDakMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUU1QyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDcEMsR0FBRyxDQUFDLElBQUksQ0FB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SSxFQUFFO1lBQ0osVUFBVSxFQUFFO2dCQUNWLElBQUksRUFBRSxhQUFhO2dCQUNuQixVQUFVLEVBQUUsS0FBSzthQUNsQjtZQUNELElBQUksRUFBRSxZQUFZO1NBQ25CO0tBQ0YsQ0FBQyxDQUNILENBQUM7QUFDSixDQUFDO0FBbEJELDBDQWtCQztBQUVNLEtBQUssVUFBVSxvQkFBb0IsQ0FBQyxLQUFhO0lBQ3RELE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxHQUFHLFFBQVEsZ0JBQWdCLEVBQUUsS0FBSyxDQUFDLENBQWlCLENBQUM7QUFDekUsQ0FBQztBQUZELG9EQUVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGh0dHBzID0gcmVxdWlyZShcImh0dHBzXCIpO1xuaW1wb3J0IHsgZm9ybWF0IH0gZnJvbSBcInVybFwiO1xuXG5jb25zdCBCQVNFX1VSTCA9IGBodHRwczovL2FwcC50ZXJyYWZvcm0uaW8vYXBpL3YyL2A7XG5cbmNvbnN0IFNVQ0NFU1NfU1RBVFVTX0NPREVTID0gWzIwMCwgMjAxXTtcblxuZXhwb3J0IGludGVyZmFjZSBBdHRyaWJ1dGVzIHtcbiAgdXNlcm5hbWU6IHN0cmluZztcbiAgXCJhdmF0YXItdXJsXCI6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEYXRhIHtcbiAgaWQ6IHN0cmluZztcbiAgdHlwZTogc3RyaW5nO1xuICBhdHRyaWJ1dGVzOiBBdHRyaWJ1dGVzO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFjY291bnQge1xuICBkYXRhOiBEYXRhO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE9yZ2FuaXphdGlvbkRhdGEge1xuICBpZDogc3RyaW5nO1xuICB0eXBlOiBzdHJpbmc7XG4gIGF0dHJpYnV0ZXM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE9yZ2FuaXphdGlvbiB7XG4gIGRhdGE6IE9yZ2FuaXphdGlvbkRhdGFbXTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0KHVybDogc3RyaW5nLCB0b2tlbjogc3RyaW5nKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChvaywga28pID0+IHtcbiAgICBjb25zdCByZXEgPSBodHRwcy5yZXF1ZXN0KFxuICAgICAgZm9ybWF0KHVybCksXG4gICAgICB7IGhlYWRlcnM6IHsgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Rva2VufWAgfSB9LFxuICAgICAgKHJlcykgPT4ge1xuICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgIT09IDIwMCkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKFwiXFxuRVJST1I6IGNvdWxkbid0IHZhbGlkYXRlIHRva2VuLlwiKTtcbiAgICAgICAgICByZXR1cm4ga28obmV3IEVycm9yKHJlcy5zdGF0dXNNZXNzYWdlKSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZGF0YSA9IG5ldyBBcnJheTxCdWZmZXI+KCk7XG4gICAgICAgIHJlcy5vbihcImRhdGFcIiwgKGNodW5rKSA9PiBkYXRhLnB1c2goY2h1bmspKTtcblxuICAgICAgICByZXMub25jZShcImVycm9yXCIsIChlcnIpID0+IGtvKGVycikpO1xuICAgICAgICByZXMub25jZShcImVuZFwiLCAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBKU09OLnBhcnNlKEJ1ZmZlci5jb25jYXQoZGF0YSkudG9TdHJpbmcoXCJ1dGYtOFwiKSk7XG4gICAgICAgICAgcmV0dXJuIG9rKHJlc3BvbnNlKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgKTtcblxuICAgIHJlcS5lbmQoKTtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBvc3QodXJsOiBzdHJpbmcsIHRva2VuOiBzdHJpbmcsIGRhdGE6IHN0cmluZykge1xuICByZXR1cm4gbmV3IFByb21pc2U8YW55Pigob2ssIGtvKSA9PiB7XG4gICAgY29uc3QgcmVxID0gaHR0cHMucmVxdWVzdChcbiAgICAgIGZvcm1hdCh1cmwpLFxuICAgICAge1xuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Rva2VufWAsXG4gICAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi92bmQuYXBpK2pzb25cIixcbiAgICAgICAgICBcIkNvbnRlbnQtTGVuZ3RoXCI6IGRhdGEubGVuZ3RoLFxuICAgICAgICB9LFxuICAgICAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgfSxcbiAgICAgIChyZXMpID0+IHtcbiAgICAgICAgY29uc3QgZGF0YSA9IG5ldyBBcnJheTxCdWZmZXI+KCk7XG4gICAgICAgIHJlcy5vbihcImRhdGFcIiwgKGNodW5rKSA9PiBkYXRhLnB1c2goY2h1bmspKTtcbiAgICAgICAgcmVzLm9uY2UoXCJlcnJvclwiLCAoZXJyKSA9PiBrbyhlcnIpKTtcbiAgICAgICAgcmVzLm9uY2UoXCJlbmRcIiwgKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gSlNPTi5wYXJzZShCdWZmZXIuY29uY2F0KGRhdGEpLnRvU3RyaW5nKFwidXRmLThcIikpO1xuXG4gICAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlKSB7XG4gICAgICAgICAgICBjb25zdCBzdGF0dXNDb2RlID0gcmVzLnN0YXR1c0NvZGU7XG4gICAgICAgICAgICBpZiAoIVNVQ0NFU1NfU1RBVFVTX0NPREVTLmluY2x1ZGVzKHN0YXR1c0NvZGUpKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHsgZXJyb3JzIH0gPSByZXNwb25zZTtcbiAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGVycm9yc1xuICAgICAgICAgICAgICAgIC5tYXAoKGVycm9yOiB7IGRldGFpbDogc3RyaW5nIH0pID0+IGVycm9yLmRldGFpbClcbiAgICAgICAgICAgICAgICAuam9pbihcIiwgXCIpO1xuXG4gICAgICAgICAgICAgIHJldHVybiBrbyhuZXcgRXJyb3IobWVzc2FnZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gb2socmVzcG9uc2UpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICApO1xuXG4gICAgcmVxLndyaXRlKGRhdGEpO1xuXG4gICAgcmVxLmVuZCgpO1xuICB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEFjY291bnREZXRhaWxzKHRva2VuOiBzdHJpbmcpIHtcbiAgcmV0dXJuIChhd2FpdCBnZXQoYCR7QkFTRV9VUkx9L2FjY291bnQvZGV0YWlsc2AsIHRva2VuKSkgYXMgQWNjb3VudDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVdvcmtzcGFjZShcbiAgb3JnYW5pemF0aW9uTmFtZTogc3RyaW5nLFxuICB3b3Jrc3BhY2VOYW1lOiBzdHJpbmcsXG4gIHRva2VuOiBzdHJpbmdcbikge1xuICBhd2FpdCBwb3N0KFxuICAgIGAke0JBU0VfVVJMfS9vcmdhbml6YXRpb25zLyR7b3JnYW5pemF0aW9uTmFtZX0vd29ya3NwYWNlc2AsXG4gICAgdG9rZW4sXG4gICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgZGF0YToge1xuICAgICAgICBhdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgbmFtZTogd29ya3NwYWNlTmFtZSxcbiAgICAgICAgICBvcGVyYXRpb25zOiBmYWxzZSxcbiAgICAgICAgfSxcbiAgICAgICAgdHlwZTogXCJ3b3Jrc3BhY2VzXCIsXG4gICAgICB9LFxuICAgIH0pXG4gICk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRPcmdhbml6YXRpb25OYW1lcyh0b2tlbjogc3RyaW5nKSB7XG4gIHJldHVybiAoYXdhaXQgZ2V0KGAke0JBU0VfVVJMfS9vcmdhbml6YXRpb25zYCwgdG9rZW4pKSBhcyBPcmdhbml6YXRpb247XG59XG4iXX0=
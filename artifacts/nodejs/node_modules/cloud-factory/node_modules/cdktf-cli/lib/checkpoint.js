"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ReportRequest = exports.sendTelemetry = void 0;
const https = require("https");
const url_1 = require("url");
const uuid_1 = require("uuid");
const os = __importStar(require("os"));
const ci_detect_1 = __importDefault(require("@npmcli/ci-detect"));
const logging_1 = require("./logging");
const version_check_1 = require("../bin/cmds/helper/version-check");
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const BASE_URL = `https://checkpoint-api.hashicorp.com/v1/`;
const VALID_STATUS_CODES = [200, 201];
async function post(url, data) {
    return new Promise((ok, ko) => {
        const req = https.request(url_1.format(url), {
            headers: {
                Accept: "application/json",
                "Content-Length": data.length,
                "User-Agent": "HashiCorp/cdktf-cli",
            },
            method: "POST",
        }, (res) => {
            if (res.statusCode) {
                const statusCode = res.statusCode;
                if (!VALID_STATUS_CODES.includes(statusCode)) {
                    return ko(new Error(res.statusMessage));
                }
            }
            const data = new Array();
            res.on("data", (chunk) => data.push(chunk));
            res.on("error", (err) => ko(err));
            res.on("end", () => {
                return ok();
            });
        });
        req.setTimeout(1000, () => ko(new Error("request timeout")));
        req.write(data);
        req.end();
        req.on("error", (err) => ko(err));
    });
}
async function sendTelemetry(command, payload) {
    const reportParams = {
        command,
        product: "cdktf",
        version: version_check_1.versionNumber(),
        dateTime: new Date(),
        language: payload.language,
        payload,
    };
    try {
        await ReportRequest(reportParams);
    }
    catch (err) {
        logging_1.logger.error(`Could not send telemetry data: ${err}`);
    }
}
exports.sendTelemetry = sendTelemetry;
function getId(filePath, key, forceCreation = false, explanatoryComment) {
    const _uuid = uuid_1.v4(); // create a new UUID in case we don't find one
    let jsonFile;
    try {
        jsonFile = require(filePath); // we found the file
    }
    catch (_a) {
        // we found no file, create one if we're forcing a creation
        if (forceCreation) {
            const _idFile = {}; // compose JSON id file in case we don't find one
            if (explanatoryComment) {
                _idFile["//"] = explanatoryComment.replace(/\n/g, " ");
            }
            _idFile[key] = _uuid;
            fs.ensureDirSync(path.dirname(filePath));
            fs.writeFileSync(filePath, JSON.stringify(_idFile, null, 2));
        }
        return _uuid;
    }
    if (jsonFile[key]) {
        return jsonFile[key]; // we found an id
    }
    else {
        // we found no id, we add it to the file for future use
        fs.writeFileSync(filePath, JSON.stringify({ ...jsonFile, [key]: _uuid }, null, 2));
        return _uuid;
    }
}
function getProjectId(projectPath = process.cwd()) {
    return getId(path.resolve(projectPath, "cdktf.json"), "projectId");
}
function getUserId() {
    return getId(path.resolve(os.homedir(), ".cdktf", "config.json"), "userId", true, `This signature is a randomly generated UUID used to anonymously differentiate users in telemetry data order to inform product direction.
This signature is random, it is not based on any personally identifiable information.
To create a new signature, you can simply delete this file at any time.
See https://cdk.tf/telemetry for more
information on how to disable it.`);
}
async function ReportRequest(reportParams) {
    // we won't report when checkpoint is disabled.
    if (process.env.CHECKPOINT_DISABLE) {
        return;
    }
    if (!reportParams.runID) {
        reportParams.runID = uuid_1.v4();
    }
    if (!reportParams.dateTime) {
        reportParams.dateTime = new Date();
    }
    if (!reportParams.arch) {
        reportParams.arch = os.arch();
    }
    if (!reportParams.os) {
        reportParams.os = os.platform();
    }
    const ci = ci_detect_1.default();
    if (!reportParams.userId && !ci) {
        reportParams.userId = getUserId();
    }
    if (ci) {
        reportParams.ci = ci;
    }
    reportParams.projectId = reportParams.projectId || getProjectId();
    const postData = JSON.stringify(reportParams);
    try {
        await post(`${BASE_URL}telemetry/${reportParams.product}`, postData);
    }
    catch (e) {
        // Log errors writing to checkpoint
        logging_1.processLoggerError(e.message);
    }
}
exports.ReportRequest = ReportRequest;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2twb2ludC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNoZWNrcG9pbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLCtCQUFnQztBQUNoQyw2QkFBNkI7QUFDN0IsK0JBQW9DO0FBQ3BDLHVDQUF5QjtBQUN6QixrRUFBeUM7QUFDekMsdUNBQXVEO0FBQ3ZELG9FQUFpRTtBQUNqRSwyQ0FBNkI7QUFDN0IsNkNBQStCO0FBRS9CLE1BQU0sUUFBUSxHQUFHLDBDQUEwQyxDQUFDO0FBRTVELE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFpQnRDLEtBQUssVUFBVSxJQUFJLENBQUMsR0FBVyxFQUFFLElBQVk7SUFDM0MsT0FBTyxJQUFJLE9BQU8sQ0FBTyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRTtRQUNsQyxNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUN2QixZQUFNLENBQUMsR0FBRyxDQUFDLEVBQ1g7WUFDRSxPQUFPLEVBQUU7Z0JBQ1AsTUFBTSxFQUFFLGtCQUFrQjtnQkFDMUIsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLE1BQU07Z0JBQzdCLFlBQVksRUFBRSxxQkFBcUI7YUFDcEM7WUFDRCxNQUFNLEVBQUUsTUFBTTtTQUNmLEVBQ0QsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNOLElBQUksR0FBRyxDQUFDLFVBQVUsRUFBRTtnQkFDbEIsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQztnQkFDbEMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsRUFBRTtvQkFDNUMsT0FBTyxFQUFFLENBQUMsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7aUJBQ3pDO2FBQ0Y7WUFDRCxNQUFNLElBQUksR0FBRyxJQUFJLEtBQUssRUFBVSxDQUFDO1lBQ2pDLEdB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QyxFQUFFLEVBQUU7UUFDL0IsWUFBWSxDQUFDLE1BQU0sR0FBRyxTQUFTLEVBQUUsQ0FBQztLQUNuQztJQUVELElBQUksRUFBRSxFQUFFO1FBQ04sWUFBWSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7S0FDdEI7SUFFRCxZQUFZLENBQUMsU0FBUyxHQUFHLFlBQVksQ0FBQyxTQUFTLElBQUksWUFBWSxFQUFFLENBQUM7SUFFbEUsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUU5QyxJQUFJO1FBQ0YsTUFBTSxJQUFJLENBQUMsR0FBRyxRQUFRLGFBQWEsWUFBWSxDQUFDLE9BQU8sRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0tBQ3RFO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixtQ0FBbUM7UUFDbkMsNEJBQWtCLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQy9CO0FBQ0gsQ0FBQztBQXpDRCxzQ0F5Q0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgaHR0cHMgPSByZXF1aXJlKFwiaHR0cHNcIik7XG5pbXBvcnQgeyBmb3JtYXQgfSBmcm9tIFwidXJsXCI7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tIFwidXVpZFwiO1xuaW1wb3J0ICogYXMgb3MgZnJvbSBcIm9zXCI7XG5pbXBvcnQgY2lEZXRlY3QgZnJvbSBcIkBucG1jbGkvY2ktZGV0ZWN0XCI7XG5pbXBvcnQgeyBsb2dnZXIsIHByb2Nlc3NMb2dnZXJFcnJvciB9IGZyb20gXCIuL2xvZ2dpbmdcIjtcbmltcG9ydCB7IHZlcnNpb25OdW1iZXIgfSBmcm9tIFwiLi4vYmluL2NtZHMvaGVscGVyL3ZlcnNpb24tY2hlY2tcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmcy1leHRyYVwiO1xuXG5jb25zdCBCQVNFX1VSTCA9IGBodHRwczovL2NoZWNrcG9pbnQtYXBpLmhhc2hpY29ycC5jb20vdjEvYDtcblxuY29uc3QgVkFMSURfU1RBVFVTX0NPREVTID0gWzIwMCwgMjAxXTtcblxuZXhwb3J0IGludGVyZmFjZSBSZXBvcnRQYXJhbXMge1xuICBkYXRlVGltZT86IERhdGU7XG4gIGFyY2g/OiBzdHJpbmc7XG4gIG9zPzogc3RyaW5nO1xuICBwYXlsb2FkOiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICBwcm9kdWN0OiBzdHJpbmc7XG4gIHJ1bklEPzogc3RyaW5nO1xuICB2ZXJzaW9uPzogc3RyaW5nO1xuICBjb21tYW5kPzogc3RyaW5nO1xuICBsYW5ndWFnZT86IHN0cmluZztcbiAgdXNlcklkPzogc3RyaW5nO1xuICBjaT86IHN0cmluZztcbiAgcHJvamVjdElkPzogc3RyaW5nO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwb3N0KHVybDogc3RyaW5nLCBkYXRhOiBzdHJpbmcpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChvaywga28pID0+IHtcbiAgICBjb25zdCByZXEgPSBodHRwcy5yZXF1ZXN0KFxuICAgICAgZm9ybWF0KHVybCksXG4gICAgICB7XG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICBBY2NlcHQ6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICAgIFwiQ29udGVudC1MZW5ndGhcIjogZGF0YS5sZW5ndGgsXG4gICAgICAgICAgXCJVc2VyLUFnZW50XCI6IFwiSGFzaGlDb3JwL2Nka3RmLWNsaVwiLFxuICAgICAgICB9LFxuICAgICAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgfSxcbiAgICAgIChyZXMpID0+IHtcbiAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlKSB7XG4gICAgICAgICAgY29uc3Qgc3RhdHVzQ29kZSA9IHJlcy5zdGF0dXNDb2RlO1xuICAgICAgICAgIGlmICghVkFMSURfU1RBVFVTX0NPREVTLmluY2x1ZGVzKHN0YXR1c0NvZGUpKSB7XG4gICAgICAgICAgICByZXR1cm4ga28obmV3IEVycm9yKHJlcy5zdGF0dXNNZXNzYWdlKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGRhdGEgPSBuZXcgQXJyYXk8QnVmZmVyPigpO1xuICAgICAgICByZXMub24oXCJkYXRhXCIsIChjaHVuaykgPT4gZGF0YS5wdXNoKGNodW5rKSk7XG4gICAgICAgIHJlcy5vbihcImVycm9yXCIsIChlcnIpID0+IGtvKGVycikpO1xuICAgICAgICByZXMub24oXCJlbmRcIiwgKCkgPT4ge1xuICAgICAgICAgIHJldHVybiBvaygpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICApO1xuXG4gICAgcmVxLnNldFRpbWVvdXQoMTAwMCwgKCkgPT4ga28obmV3IEVycm9yKFwicmVxdWVzdCB0aW1lb3V0XCIpKSk7XG4gICAgcmVxLndyaXRlKGRhdGEpO1xuICAgIHJlcS5lbmQoKTtcbiAgICByZXEub24oXCJlcnJvclwiLCAoZXJyKSA9PiBrbyhlcnIpKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZW5kVGVsZW1ldHJ5KFxuICBjb21tYW5kOiBzdHJpbmcsXG4gIHBheWxvYWQ6IFJlY29yZDxzdHJpbmcsIGFueT5cbikge1xuICBjb25zdCByZXBvcnRQYXJhbXM6IFJlcG9ydFBhcmFtcyA9IHtcbiAgICBjb21tYW5kLFxuICAgIHByb2R1Y3Q6IFwiY2RrdGZcIixcbiAgICB2ZXJzaW9uOiB2ZXJzaW9uTnVtYmVyKCksXG4gICAgZGF0ZVRpbWU6IG5ldyBEYXRlKCksXG4gICAgbGFuZ3VhZ2U6IHBheWxvYWQubGFuZ3VhZ2UsXG4gICAgcGF5bG9hZCxcbiAgfTtcblxuICB0cnkge1xuICAgIGF3YWl0IFJlcG9ydFJlcXVlc3QocmVwb3J0UGFyYW1zKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLmVycm9yKGBDb3VsZCBub3Qgc2VuZCB0ZWxlbWV0cnkgZGF0YTogJHtlcnJ9YCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0SWQoXG4gIGZpbGVQYXRoOiBzdHJpbmcsXG4gIGtleTogc3RyaW5nLFxuICBmb3JjZUNyZWF0aW9uID0gZmFsc2UsXG4gIGV4cGxhbmF0b3J5Q29tbWVudD86IHN0cmluZ1xuKTogc3RyaW5nIHtcbiAgY29uc3QgX3V1aWQgPSB1dWlkdjQoKTsgLy8gY3JlYXRlIGEgbmV3IFVVSUQgaW4gY2FzZSB3ZSBkb24ndCBmaW5kIG9uZVxuXG4gIGxldCBqc29uRmlsZTtcbiAgdHJ5IHtcbiAgICBqc29uRmlsZSA9IHJlcXVpcmUoZmlsZVBhdGgpOyAvLyB3ZSBmb3VuZCB0aGUgZmlsZVxuICB9IGNhdGNoIHtcbiAgICAvLyB3ZSBmb3VuZCBubyBmaWxlLCBjcmVhdGUgb25lIGlmIHdlJ3JlIGZvcmNpbmcgYSBjcmVhdGlvblxuICAgIGlmIChmb3JjZUNyZWF0aW9uKSB7XG4gICAgICBjb25zdCBfaWRGaWxlID0ge30gYXMgUmVjb3JkPHN0cmluZywgc3RyaW5nPjsgLy8gY29tcG9zZSBKU09OIGlkIGZpbGUgaW4gY2FzZSB3ZSBkb24ndCBmaW5kIG9uZVxuICAgICAgaWYgKGV4cGxhbmF0b3J5Q29tbWVudCkge1xuICAgICAgICBfaWRGaWxlW1wiLy9cIl0gPSBleHBsYW5hdG9yeUNvbW1lbnQucmVwbGFjZSgvXFxuL2csIFwiIFwiKTtcbiAgICAgIH1cbiAgICAgIF9pZEZpbGVba2V5XSA9IF91dWlkO1xuICAgICAgZnMuZW5zdXJlRGlyU3luYyhwYXRoLmRpcm5hbWUoZmlsZVBhdGgpKTtcbiAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIEpTT04uc3RyaW5naWZ5KF9pZEZpbGUsIG51bGwsIDIpKTtcbiAgICB9XG4gICAgcmV0dXJuIF91dWlkO1xuICB9XG5cbiAgaWYgKGpzb25GaWxlW2tleV0pIHtcbiAgICByZXR1cm4ganNvbkZpbGVba2V5XTsgLy8gd2UgZm91bmQgYW4gaWRcbiAgfSBlbHNlIHtcbiAgICAvLyB3ZSBmb3VuZCBubyBpZCwgd2UgYWRkIGl0IHRvIHRoZSBmaWxlIGZvciBmdXR1cmUgdXNlXG4gICAgZnMud3JpdGVGaWxlU3luYyhcbiAgICAgIGZpbGVQYXRoLFxuICAgICAgSlNPTi5zdHJpbmdpZnkoeyAuLi5qc29uRmlsZSwgW2tleV06IF91dWlkIH0sIG51bGwsIDIpXG4gICAgKTtcbiAgICByZXR1cm4gX3V1aWQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0UHJvamVjdElkKHByb2plY3RQYXRoID0gcHJvY2Vzcy5jd2QoKSk6IHN0cmluZyB7XG4gIHJldHVybiBnZXRJZChwYXRoLnJlc29sdmUocHJvamVjdFBhdGgsIFwiY2RrdGYuanNvblwiKSwgXCJwcm9qZWN0SWRcIik7XG59XG5cbmZ1bmN0aW9uIGdldFVzZXJJZCgpOiBzdHJpbmcge1xuICByZXR1cm4gZ2V0SWQoXG4gICAgcGF0aC5yZXNvbHZlKG9zLmhvbWVkaXIoKSwgXCIuY2RrdGZcIiwgXCJjb25maWcuanNvblwiKSxcbiAgICBcInVzZXJJZFwiLFxuICAgIHRydWUsXG4gICAgYFRoaXMgc2lnbmF0dXJlIGlzIGEgcmFuZG9tbHkgZ2VuZXJhdGVkIFVVSUQgdXNlZCB0byBhbm9ueW1vdXNseSBkaWZmZXJlbnRpYXRlIHVzZXJzIGluIHRlbGVtZXRyeSBkYXRhIG9yZGVyIHRvIGluZm9ybSBwcm9kdWN0IGRpcmVjdGlvbi5cblRoaXMgc2lnbmF0dXJlIGlzIHJhbmRvbSwgaXQgaXMgbm90IGJhc2VkIG9uIGFueSBwZXJzb25hbGx5IGlkZW50aWZpYWJsZSBpbmZvcm1hdGlvbi5cblRvIGNyZWF0ZSBhIG5ldyBzaWduYXR1cmUsIHlvdSBjYW4gc2ltcGx5IGRlbGV0ZSB0aGlzIGZpbGUgYXQgYW55IHRpbWUuXG5TZWUgaHR0cHM6Ly9jZGsudGYvdGVsZW1ldHJ5IGZvciBtb3JlXG5pbmZvcm1hdGlvbiBvbiBob3cgdG8gZGlzYWJsZSBpdC5gXG4gICk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBSZXBvcnRSZXF1ZXN0KHJlcG9ydFBhcmFtczogUmVwb3J0UGFyYW1zKTogUHJvbWlzZTx2b2lkPiB7XG4gIC8vIHdlIHdvbid0IHJlcG9ydCB3aGVuIGNoZWNrcG9pbnQgaXMgZGlzYWJsZWQuXG4gIGlmIChwcm9jZXNzLmVudi5DSEVDS1BPSU5UX0RJU0FCTEUpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoIXJlcG9ydFBhcmFtcy5ydW5JRCkge1xuICAgIHJlcG9ydFBhcmFtcy5ydW5JRCA9IHV1aWR2NCgpO1xuICB9XG5cbiAgaWYgKCFyZXBvcnRQYXJhbXMuZGF0ZVRpbWUpIHtcbiAgICByZXBvcnRQYXJhbXMuZGF0ZVRpbWUgPSBuZXcgRGF0ZSgpO1xuICB9XG5cbiAgaWYgKCFyZXBvcnRQYXJhbXMuYXJjaCkge1xuICAgIHJlcG9ydFBhcmFtcy5hcmNoID0gb3MuYXJjaCgpO1xuICB9XG5cbiAgaWYgKCFyZXBvcnRQYXJhbXMub3MpIHtcbiAgICByZXBvcnRQYXJhbXMub3MgPSBvcy5wbGF0Zm9ybSgpO1xuICB9XG5cbiAgY29uc3QgY2k6IHN0cmluZyB8IGZhbHNlID0gY2lEZXRlY3QoKTtcbiAgaWYgKCFyZXBvcnRQYXJhbXMudXNlcklkICYmICFjaSkge1xuICAgIHJlcG9ydFBhcmFtcy51c2VySWQgPSBnZXRVc2VySWQoKTtcbiAgfVxuXG4gIGlmIChjaSkge1xuICAgIHJlcG9ydFBhcmFtcy5jaSA9IGNpO1xuICB9XG5cbiAgcmVwb3J0UGFyYW1zLnByb2plY3RJZCA9IHJlcG9ydFBhcmFtcy5wcm9qZWN0SWQgfHwgZ2V0UHJvamVjdElkKCk7XG5cbiAgY29uc3QgcG9zdERhdGEgPSBKU09OLnN0cmluZ2lmeShyZXBvcnRQYXJhbXMpO1xuXG4gIHRyeSB7XG4gICAgYXdhaXQgcG9zdChgJHtCQVNFX1VSTH10ZWxlbWV0cnkvJHtyZXBvcnRQYXJhbXMucHJvZHVjdH1gLCBwb3N0RGF0YSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyBMb2cgZXJyb3JzIHdyaXRpbmcgdG8gY2hlY2twb2ludFxuICAgIHByb2Nlc3NMb2dnZXJFcnJvcihlLm1lc3NhZ2UpO1xuICB9XG59XG4iXX0=
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WatchClient = void 0;
const chokidar = __importStar(require("chokidar"));
const lodash_isequal_1 = __importDefault(require("lodash.isequal"));
const synth_stack_1 = require("../../bin/cmds/helper/synth-stack");
const terraform_cli_1 = require("../../bin/cmds/ui/models/terraform-cli");
const terraform_cloud_1 = require("../../bin/cmds/ui/models/terraform-cloud");
const terraform_context_1 = require("../../bin/cmds/ui/terraform-context");
const util_1 = require("./util");
const fs_1 = require("cdktf/lib/private/fs");
const logging_1 = require("../logging");
const checkpoint_1 = require("../checkpoint");
class RecoverableError extends Error {
    constructor(message, origin) {
        super(message);
        this.origin = origin;
        // Set the prototype explicitly. See https://github.com/Microsoft/TypeScript-wiki/blob/master/Breaking-Changes.md#extending-built-ins-like-error-array-and-map-may-no-longer-work
        Object.setPrototypeOf(this, RecoverableError.prototype);
    }
}
class WatchClient {
    constructor(options) {
        this.subscribers = new Set();
        this.running = false;
        this.needsInit = true;
        this.actionQueue = [];
        this.state = {
            status: "IDLE",
            stacks: [],
            resources: new Map(),
        };
        this.targetDir = options.targetDir;
        this.synthCommand = options.synthCommand;
        if (!options.autoApprove)
            throw new Error("WatchClient does not yet support running without autoApprove");
        this.autoApprove = options.autoApprove;
        this.targetStack = options.targetStack;
    }
    isRunning() {
        return this.running;
    }
    subscribe(handler) {
        this.subscribers.add(handler);
        return () => this.subscribers.delete(handler);
    }
    updateState(state) {
        const previousState = this.state;
        // ignore state being readonly - it is readonly for safety in other places
        this.state = Object.assign({}, this.state, state);
        if (!lodash_isequal_1.default(previousState, this.state)) {
            this.subscribers.forEach((sub) => sub(this.state));
        }
    }
    async runSynth() {
        this.updateState({ status: "SYNTHESIZING", error: undefined });
        try {
            const stacks = (await synth_stack_1.SynthStack.synth(this.synthCommand, this.targetDir, true, "watch")).map((stack) => {
                return {
                    ...stack,
                    json: JSON.parse(stack.content),
                };
            });
            this.updateState({
                stacks,
            });
            if (this.needsInit)
                await this.queueAction("INIT", true);
        }
        catch (e) {
            throw new RecoverableError(e.errorOutput || e.message, "SYNTHESIZING");
        }
    }
    async runInit() {
        this.updateState({ status: "INITIALIZING" });
        const terraform = await this.getTerraform();
        await terraform.init();
        this.needsInit = false;
    }
    async runDeploy() {
        const { workingDirectory, name } = await this.getTargetStack();
        console.log(`Running deploy in workingDirectory ${workingDirectory}`);
        const newTargetStackHash = fs_1.hashPath(workingDirectory);
        if (this.lastTargetStackHash === newTargetStackHash) {
            console.log(`skipping deploy because hash ("${this.lastTargetStackHash}") of target stack "${name}" did not change for working directory ${workingDirectory}`);
            return;
        }
        else {
            console.log(`continuing deploy because new hash ("${newTargetStackHash}") of working directory "${workingDirectory}" differs from previous hash "${this.lastTargetStackHash}"`);
        }
        this.updateState({ status: "DEPLOYING" });
        const terraform = await this.getTerraform();
        // remove previous errors
        // we do this here as deploy will update the state already while
        // in progress and we don't want to see the error while successful
        // things already start to happen
        this.updateState({
            error: undefined,
        });
        try {
            if (terraform instanceof terraform_cloud_1.TerraformCloud) {
                // plan for Terraform Cloud remote execution also uploads the Terraform code
                const { planFile } = await terraform.plan(false); // false = deploy
                await terraform.deploy(planFile, this.handleTerraformOutput.bind(this));
            }
            else if (terraform instanceof terraform_cli_1.TerraformCli) {
                // skip the plan and refreshing to save time ⏱
                const NO_PLAN_FILE = "";
                await terraform.deploy(NO_PLAN_FILE, this.handleTerraformOutput.bind(this), ["-refresh=false"]);
            }
            // deployment was successful -> update hash
            this.lastTargetStackHash = newTargetStackHash;
        }
        catch (e) {
            // When new providers where added or the stack name might've
            // been changed (when using just a single stack) we need to
            // re-init Terraform. We'll do this proactively on any error.
            this.needsInit = true;
            throw new RecoverableError(`${e.message}${e.stderr ? `\n${e.stderr}` : ""}`, "DEPLOYING");
        }
    }
    handleTerraformOutput(chunk) {
        const resources = terraform_context_1.parseOutput(chunk.toString());
        if (resources.length > 0) {
            const newResources = new Map(this.state.resources);
            resources.forEach((r) => newResources.set(r.id, { ...r, changedAt: Date.now() }));
            this.updateState({ resources: newResources });
        }
    }
    async getTargetStack() {
        const { stacks } = this.state;
        if (stacks.length === 0) {
            throw new RecoverableError("Cannot determine target stack when there are no stacks", this.state.status);
        }
        if (this.targetStack) {
            const stack = stacks.find((s) => s.name === this.targetStack);
            if (!stack) {
                throw new RecoverableError(`Could not find stack ${this.targetStack}. Found ${stacks
                    .map((s) => s.name)
                    .join(", ")}`, this.state.status);
            }
            return stack;
        }
        else if (stacks.length > 1) {
            throw new RecoverableError("Found more than one stack, please specify which stack to watch using --stack", this.state.status);
        }
        return stacks[0];
    }
    // todo: optimization: cache instance as long as backend does not change
    async getTerraform() {
        var _a, _b, _c, _d;
        const stack = await this.getTargetStack();
        if ((_b = (_a = stack.json.terraform) === null || _a === void 0 ? void 0 : _a.backend) === null || _b === void 0 ? void 0 : _b.remote) {
            const terraformCloud = new terraform_cloud_1.TerraformCloud(stack, (_d = (_c = stack.json.terraform) === null || _c === void 0 ? void 0 : _c.backend) === null || _d === void 0 ? void 0 : _d.remote);
            if (await terraformCloud.isRemoteWorkspace()) {
                throw new RecoverableError("Using Terraform Cloud in Remote Execution Mode is not yet supported for cdktf watch", this.state.status);
                // return terraformCloud;
            }
        }
        return new terraform_cli_1.TerraformCli(stack);
    }
    async start() {
        this.running = true;
        let gitignored = [];
        try {
            gitignored = await util_1.readGitignore(process.cwd());
        }
        catch (e) {
            logging_1.logger.error(e);
            this.updateState({
                error: {
                    message: `Could not read .gitignore file in ${process.cwd()}. Watch requires it for knowing which files to watch. Error while reading file: ${e.message}`,
                    recoverable: false,
                    origin: "IDLE",
                    timestamp: Date.now(),
                },
            });
            return;
        }
        console.log(`Read .gitignore file: ${gitignored}`);
        // If input files change we queue a synth to be run
        this.sourceFileWatcher = chokidar.watch(".", {
            ignored: gitignored,
            cwd: process.cwd(),
            ignoreInitial: true,
        });
        this.sourceFileWatcher.on("ready", () => console.log("srcdir watcher ready"));
        ["change", "add"].forEach((event) => {
            if (this.sourceFileWatcher)
                this.sourceFileWatcher.on(event, (path) => {
                    console.log(`synth - path changed: ${event} ${path}`);
                    this.queueAction("SYNTH");
                });
        });
        // If out dir files change we queue a deploy to be run
        // The runDeploy() method will check if files of the
        // currently watched stack changed
        this.outDirWatcher = chokidar.watch(this.targetDir, {
            ignored: ["**/.terraform/**", "**/.terraform.lock.hcl", "*/*/*/plan"],
            cwd: process.cwd(),
            ignoreInitial: true,
        });
        this.outDirWatcher.on("ready", () => console.log("outdir watcher ready"));
        ["change", "add"].forEach((event) => {
            if (this.outDirWatcher)
                this.outDirWatcher.on(event, (path) => {
                    console.log(`outdir - path changed: ${event} ${path}`);
                    this.queueAction("DEPLOY");
                });
        });
        // Queue initial synth to get things started
        await this.queueAction("SYNTH");
        await checkpoint_1.sendTelemetry("watch", { event: "start" });
        this.startHandlingActions();
    }
    async queueAction(action, priority = false) {
        // only enqueue if not already enqueued anyway
        if (!this.actionQueue.includes(action)) {
            // priority = run next
            if (priority)
                this.actionQueue.unshift(action);
            else
                this.actionQueue.push(action);
        }
        console.log(`currently queued actions: ${this.actionQueue.join(", ")}`);
    }
    async startHandlingActions() {
        while (this.isRunning()) {
            const nextAction = this.actionQueue.shift();
            if (nextAction)
                console.log(`Handling next action: ${nextAction}`);
            try {
                switch (nextAction) {
                    case "SYNTH": {
                        await this.runSynth();
                        break;
                    }
                    case "INIT": {
                        await this.runInit();
                        break;
                    }
                    case "DEPLOY": {
                        await this.runDeploy();
                        break;
                    }
                    case undefined: {
                        // this is hacky but makes it very easy to keep this alive in
                        // a loop even if no events are currently enqueued. This whole
                        // queue implemenation will probably be replaced by a state
                        // machine in the future.
                        this.updateState({ status: "IDLE" });
                        await new Promise((resolve) => setTimeout(resolve, 100));
                        break;
                    }
                    default: {
                        console.warn(`warning: received unknown action ${nextAction} - ignoring it`);
                        break;
                    }
                }
            }
            catch (e) {
                if (e instanceof RecoverableError) {
                    this.updateState({
                        error: {
                            message: e.message,
                            recoverable: true,
                            origin: e.origin,
                            timestamp: Date.now(),
                        },
                    });
                }
                else {
                    throw e;
                }
            }
        }
    }
    async stop() {
        if (this.sourceFileWatcher)
            await this.sourceFileWatcher.close();
        if (this.outDirWatcher)
            await this.outDirWatcher.close();
        this.actionQueue = [];
        this.running = false;
    }
}
exports.WatchClient = WatchClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2F0Y2hDbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJXYXRjaENsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsbURBQXFDO0FBRXJDLG9FQUF5QztBQUN6QyxtRUFHMkM7QUFLM0MsMEVBQXNFO0FBQ3RFLDhFQUEwRTtBQUMxRSwyRUFBa0U7QUFFbEUsaUNBQXVDO0FBQ3ZDLDZDQUFnRDtBQUNoRCx3Q0FBb0M7QUFDcEMsOENBQThDO0FBNEI5QyxNQUFNLGdCQUFpQixTQUFRLEtBQUs7SUFDbEMsWUFBWSxPQUFlLEVBQVMsTUFBd0I7UUFDMUQsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRG1CLFdBQU0sR0FBTixNQUFNLENBQWtCO1FBRTFELGlMQUFpTDtRQUNqTCxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUMxRCxDQUFDO0NBQ0Y7QUFvQkQsTUFBYSxXQUFXO0lBcUJ0QixZQUFZLE9BQTJCO1FBZC9CLGdCQUFXLEdBQUcsSUFBSSxHQUFHLEVBQXVCLENBQUM7UUFDN0MsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUNoQixjQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLGdCQUFXLEdBQWEsRUFBRSxDQUFDO1FBRWxCLFVBQUssR0FBNkI7WUFDakQsTUFBTSxFQUFFLE1BQU07WUFDZCxNQUFNLEVBQUUsRUFBRTtZQUNWLFNBQVMsRUFBRSxJQUFJLEdBQUcsRUFBRTtTQUNyQixDQUFDO1FBTUEsSUFBSSxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDO1FBQ25DLElBQUksQ0FBQyxZQUFZLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQztRQUV6QyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDdEIsTUFBTSxJQUFJLEtBQUssQ0FDYiw4REFBOEQsQ0FDL0QsQ0FBQztRQUNKLElBQUksQ0FBQyxXQUFXLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQztRQUN2QyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUM7SUFDekMsQ0FBQztJQUVNLFNBQVM7UUFDZCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdEIsQ0FBQztJQUVNLFNBQVMsQ0FBQyxPQUE0QjtRQUMzQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM5QixPQUFPLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFTyxXQUFXLENBQUMsS0FBMEI7UUFDNUMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNqQywwRUFBMEU7UUFDekUsSUFBSSxDQUFDLEtBQW9CLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNsRSxJQUFJLENBQUMsd0JBQVcsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQzNDLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQW1CLENBQUMsQ0FBQyxDQUFDO1NBQ2xFO0lBQ0gsQ0FBQztJQUVPLEtBQUssQ0FBQyxRQUFRO1FBQ3BCLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBQy9ELElBQUk7WUFDRixNQUFNLE1BQU0sR0FBRyxDQUNiLE1BQU0sd0JBQVUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FDekUsQ0FBQyxHQUFHLENBQVEsQ0FBQyxLQUFLLEVBQUUsRUFBRTtnQkFDckIsT0FBTztvQkFDTCxHQUFHLEtBQUs7b0JBQ1IsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBa0I7aUJBQ2pELENBQUM7WUFDSixDQUFDLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxXQUFXLENBQUM7Z0JBQ2YsTUFBTTthQUNQLENBQUMsQ0FBQztZQUNILElBQUksSUFBSSxDQUFDLFNBQVM7Z0JBQUUsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztTQUMxRDtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsTUFBTSxJQUFJLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxXQUFXLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxjQUFjLENBQUMsQ0FBQztTQUN4RTtJQUNILENBQUM7SUFFTyxLQUFLLENBQUMsT0FBTztRQUNuQixJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQUM7UUFDN0MsTUFBTSxTQUFTLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDNUMsTUFBTSxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7SUFDekIsQ0FBQztJQUVPLEtBQUssQ0FBQyxTQUFTO1FBQ3JCLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUMvRCxPQUFPLENBQUMsR0FBRyxDQUFDLHNDQUFzQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7UUFDdEUsTUFBTSxrQkFBa0IsR0FBRyxhQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN0RCxJQUFJLElBQUksQ0FBQyxtQkFBbUIsS0FBSyxrQkFBa0IsRUFBRTtZQUNuRCxPQUFPLENBQUMsR0FBRyxDQUNULGtDQUFrQyxJQUFJLENBQUMsbUJBQW1CLHVCQUF1QixJQUFJLDBDQUEwQyxnQkFBZ0IsRUFBRSxDQUNsSixDQUFDO1lBQ0YsT0FBTztTQUNSO2FBQU07WUFDTCxPQUFPLENBQUMsR0FBRyxDQUNULHdDQUF3QyxrQkFBa0IsNEJBQTRCLGdCQUFnQixpQ0FBaUMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLENBQ25LLENBQUM7U0FDSDtRQUVELElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUMxQyxNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUU1Qyx5QkFBeUI7UUFDekIsZ0VBQWdFO1FBQ2hFLGtFQUFrRTtRQUNsRSxpQ0FBaUM7UUFDakMsSUFBSSxDQUFDLFdBQVcsQ0FBQztZQUNmLEtBQUssRUFBRSxTQUFTO1NBQ2pCLENBQUMsQ0FBQztRQUNILElBQUk7WUFDRixJQUFJLFNBQVMsWUFBWSxnQ0FBYyxFQUFFO2dCQUN2Qyw0RUFBNEU7Z0JBQzVFLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxpQkFBaUI7Z0JBQ25FLE1BQU0sU0FBUyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2FBQ3pFO2lCQUFNLElBQUksU0FBUyxZQUFZLDRCQUFZLEVBQUU7Z0JBQzVDLDhDQUE4QztnQkFDOUMsTUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFDO2dCQUN4QixNQUFNLFNBQVMsQ0FBQyxNQUFNLENBQ3BCLFlBQVksRUFDWixJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUNyQyxDQUFDLGdCQUFnQixDQUFDLENBQ25CLENBQUM7YUFDSDtZQUNELDJDQUEyQztZQUMzQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsa0JBQWtCLENBQUM7U0FDL0M7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLDREQUE0RDtZQUM1RCwyREFBMkQ7WUFDM0QsNkRBQTZEO1lBQzdELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1lBQ3RCLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsR0FBRyxDQUFDLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFDaEQsV0FBVyxDQUNaLENBQUM7U0FDSDtJQUNILENBQUM7SUFFTyxxQkFBcUIsQ0FBQyxLQUFhO1FBQ3pDLE1BQU0sU0FBUyxHQUFHLCtCQUFXLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDaEQsSUFBSSxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN4QixNQUFNLFlBQVksR0FBRyxJQUFJLEdBQUcsQ0FDMUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFvQyxDQUNoRCxDQUFDO1lBQ0YsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQ3RCLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLEdBQUcsQ0FBQyxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUN4RCxDQUFDO1lBQ0YsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLFNBQVMsRUFBRSxZQUF1QyxFQUFFLENBQUMsQ0FBQztTQUMxRTtJQUNILENBQUM7SUFFTyxLQUFLLENBQUMsY0FBYztRQUMxQixNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUM5QixJQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ3ZCLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsd0RBQXdELEVBQ3hELElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUNsQixDQUFDO1NBQ0g7UUFDRCxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDcEIsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDOUQsSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDVixNQUFNLElBQUksZ0JBQWdCLENBQ3hCLHdCQUF3QixJQUFJLENBQUMsV0FBVyxXQUFXLE1BQU07cUJBQ3RELEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztxQkFDbEIsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQ2YsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQ2xCLENBQUM7YUFDSDtZQUNELE9BQU8sS0FBSyxDQUFDO1NBQ2Q7YUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzVCLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsOEVBQThFLEVBQzlFLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUNsQixDQUFDO1NBQ0g7UUFDRCxPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuQixDQUFDO0lBRUQsd0VBQXdFO0lBQ2hFLEtBQUssQ0FBQyxZQUFZOztRQUN4QixNQUFNLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUMxQyxnQkFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsMENBQUUsT0FBTywwQ0FBRSxNQUFNLEVBQUU7WUFDekMsTUFBTSxjQUFjLEdBQUcsSUFBSSxnQ0FBYyxDQUN2QyxLQUFjLGNBQ2QsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLDBDQUFFLE9BQU8sMENBQUUsTUFBTSxDQUN0QyxDQUFDO1lBQ0YsSUFBSSxNQUFNLGNBQWMsQ0FBQyxpQkFBaUIsRUFBRSxFQUFFO2dCQUM1QyxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLHFGQUFxRixFQUNyRixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FDbEIsQ0FBQztnQkFDRix5QkFBeUI7YUFDMUI7U0FDRjtRQUNELE9BQU8sSUFBSSw0QkFBWSxDQUFDLEtBQWMsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFTSxLQUFLLENBQUMsS0FBSztRQUNoQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUVwQixJQUFJLFVBQVUsR0FBYSxFQUFFLENBQUM7UUFDOUIsSUFBSTtZQUNGLFVBQVUsR0FBRyxNQUFNLG9CQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7U0FDakQ7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLGdCQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2hCLElBQUksQ0FBQyxXQUFXLENBQUM7Z0JBQ2YsS0FBSyxFQUFFO29CQUNMLE9BQU8sRUFBRSxxQ0FBcUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxtRkFDekQsQ0FBQyxDQUFDLE9BQ0osRUFBRTtvQkFDRixXQUFXLEVBQUUsS0FBSztvQkFDbEIsTUFBTSxFQUFFLE1BQU07b0JBQ2QsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7aUJBQ3RCO2FBQ0YsQ0FBQyxDQUFDO1lBQ0gsT0FBTztTQUNSO1FBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUVuRCxtREFBbUQ7UUFDbkQsSUFBSSxDQUFDLGlCQUFpQixHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFO1lBQzNDLE9BQU8sRUFBRSxVQUFVO1lBQ25CLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRyxFQUFFO1lBQ2xCLGFBQWEsRUFBRSxJQUFJO1NBQ3BCLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLENBQ3BDLENBQUM7UUFDRixDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUNsQyxJQUFJLElBQUksQ0FBQyxpQkFBaUI7Z0JBQ3hCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUU7b0JBQ3hDLE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCLEtBQUssSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO29CQUN0RCxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUM1QixDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO1FBRUgsc0RBQXNEO1FBQ3RELG9EQUFvRDtRQUNwRCxrQ0FBa0M7UUFDbEMsSUFBSSxDQUFDLGFBQWEsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbEQsT0FBTyxFQUFFLENBQUMsa0JBQWtCLEVBQUUsd0JBQXdCLEVBQUUsWUFBWSxDQUFDO1lBQ3JFLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRyxFQUFFO1lBQ2xCLGFBQWEsRUFBRSxJQUFJO1NBQ3BCLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQztRQUMxRSxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUNsQyxJQUFJLElBQUksQ0FBQyxhQUFhO2dCQUNwQixJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtvQkFDcEMsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsS0FBSyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUM7b0JBQ3ZELElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzdCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7UUFFSCw0Q0FBNEM7UUFDNUMsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2hDLE1BQU0sMEJBQWEsQ0FBQyxPQUFPLEVBQUUsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUVqRCxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBRU0sS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFjLEVBQUUsUUFBUSxHQUFHLEtBQUs7UUFDdkQsOENBQThDO1FBQzlDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN0QyxzQkFBc0I7WUFDdEIsSUFBSSxRQUFRO2dCQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDOztnQkFDMUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDcEM7UUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDMUUsQ0FBQztJQUVPLEtBQUssQ0FBQyxvQkFBb0I7UUFDaEMsT0FBTyxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUU7WUFDdkIsTUFBTSxVQUFVLEdBQXVCLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDaEUsSUFBSSxVQUFVO2dCQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCLFVBQVUsRUFBRSxDQUFDLENBQUM7WUFDbkUsSUFBSTtnQkFDRixRQUFRLFVBQVUsRUFBRTtvQkFDbEIsS0FBSyxPQUFPLENBQUMsQ0FBQzt3QkFDWixNQUFNLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQzt3QkFDdEIsTUFBTTtxQkFDUDtvQkFDRCxLQUFLLE1BQU0sQ0FBQyxDQUFDO3dCQUNYLE1BQU0sSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO3dCQUNyQixNQUFNO3FCQUNQO29CQUNELEtBQUssUUFBUSxDQUFDLENBQUM7d0JBQ2IsTUFBTSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7d0JBQ3ZCLE1BQU07cUJBQ1A7b0JBQ0QsS0FBSyxTQUFTLENBQUMsQ0FBQzt3QkFDZCw2REFBNkQ7d0JBQzdELDhEQUE4RDt3QkFDOUQsMkRBQTJEO3dCQUMzRCx5QkFBeUI7d0JBQ3pCLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQzt3QkFDckMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO3dCQUN6RCxNQUFNO3FCQUNQO29CQUNELE9BQU8sQ0FBQyxDQUFDO3dCQUNQLE9BQU8sQ0FBQyxJQUFJLENBQ1Ysb0NBQW9DLFVBQVUsZ0JBQWdCLENBQy9ELENBQUM7d0JBQ0YsTUFBTTtxQkFDUDtpQkFDRjthQUNGO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1YsSUFBSSxDQUFDLFlBQVksZ0JBQWdCLEVBQUU7b0JBQ2pDLElBQUksQ0FBQyxXQUFXLENBQUM7d0JBQ2YsS0FBSyxFQUFFOzRCQUNMLE9BQU8sRUFBRSxDQUFDLENBQUMsT0FBTzs0QkFDbEIsV0FBVyxFQUFFLElBQUk7NEJBQ2pCLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTTs0QkFDaEIsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7eUJBQ3RCO3FCQUNGLENBQUMsQ0FBQztpQkFDSjtxQkFBTTtvQkFDTCxNQUFNLENBQUMsQ0FBQztpQkFDVDthQUNGO1NBQ0Y7SUFDSCxDQUFDO0lBRU0sS0FBSyxDQUFDLElBQUk7UUFDZixJQUFJLElBQUksQ0FBQyxpQkFBaUI7WUFBRSxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNqRSxJQUFJLElBQUksQ0FBQyxhQUFhO1lBQUUsTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3pELElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO0lBQ3ZCLENBQUM7Q0FDRjtBQWxVRCxrQ0FrVUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjaG9raWRhciBmcm9tIFwiY2hva2lkYXJcIjtcbmltcG9ydCB7IERlZXBSZWFkb25seSB9IGZyb20gXCJ1dGlsaXR5LXR5cGVzXCI7XG5pbXBvcnQgaXNEZWVwRXF1YWwgZnJvbSBcImxvZGFzaC5pc2VxdWFsXCI7XG5pbXBvcnQge1xuICBTeW50aGVzaXplZFN0YWNrLFxuICBTeW50aFN0YWNrLFxufSBmcm9tIFwiLi4vLi4vYmluL2NtZHMvaGVscGVyL3N5bnRoLXN0YWNrXCI7XG5pbXBvcnQge1xuICBEZXBsb3lpbmdSZXNvdXJjZSxcbiAgVGVycmFmb3JtLFxufSBmcm9tIFwiLi4vLi4vYmluL2NtZHMvdWkvbW9kZWxzL3RlcnJhZm9ybVwiO1xuaW1wb3J0IHsgVGVycmFmb3JtQ2xpIH0gZnJvbSBcIi4uLy4uL2Jpbi9jbWRzL3VpL21vZGVscy90ZXJyYWZvcm0tY2xpXCI7XG5pbXBvcnQgeyBUZXJyYWZvcm1DbG91ZCB9IGZyb20gXCIuLi8uLi9iaW4vY21kcy91aS9tb2RlbHMvdGVycmFmb3JtLWNsb3VkXCI7XG5pbXBvcnQgeyBwYXJzZU91dHB1dCB9IGZyb20gXCIuLi8uLi9iaW4vY21kcy91aS90ZXJyYWZvcm0tY29udGV4dFwiO1xuaW1wb3J0IHsgVGVycmFmb3JtSnNvbiB9IGZyb20gXCIuLi8uLi9iaW4vY21kcy91aS90ZXJyYWZvcm0tanNvblwiO1xuaW1wb3J0IHsgcmVhZEdpdGlnbm9yZSB9IGZyb20gXCIuL3V0aWxcIjtcbmltcG9ydCB7IGhhc2hQYXRoIH0gZnJvbSBcImNka3RmL2xpYi9wcml2YXRlL2ZzXCI7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwiLi4vbG9nZ2luZ1wiO1xuaW1wb3J0IHsgc2VuZFRlbGVtZXRyeSB9IGZyb20gXCIuLi9jaGVja3BvaW50XCI7XG5cbmludGVyZmFjZSBXYXRjaENsaWVudE9wdGlvbnMge1xuICB0YXJnZXREaXI6IHN0cmluZztcbiAgc3ludGhDb21tYW5kOiBzdHJpbmc7XG4gIGF1dG9BcHByb3ZlOiBib29sZWFuO1xuICB0YXJnZXRTdGFjaz86IHN0cmluZztcbn1cblxudHlwZSBBY3Rpb24gPSBcIklOSVRcIiB8IFwiU1lOVEhcIiB8IFwiREVQTE9ZXCI7XG5cbnR5cGUgU3RhY2sgPSBTeW50aGVzaXplZFN0YWNrICYge1xuICBqc29uOiBUZXJyYWZvcm1Kc29uO1xufTtcblxuZXhwb3J0IHR5cGUgVGltZXN0YW1wZWREZXBsb3lpbmdSZXNvdXJjZSA9IERlcGxveWluZ1Jlc291cmNlICYge1xuICBjaGFuZ2VkQXQ6IG51bWJlcjtcbn07XG5cbnR5cGUgV2F0Y2hTdGF0ZVN0YXR1cyA9XG4gIHwgXCJJRExFXCJcbiAgfCBcIlNZTlRIRVNJWklOR1wiXG4gIHwgXCJJTklUSUFMSVpJTkdcIlxuICB8IFwiUExBTk5JTkdcIlxuICB8IFwiREVQTE9ZSU5HXCI7XG5cbmV4cG9ydCB0eXBlIFdhdGNoRXJyb3JPcmlnaW4gPSBXYXRjaFN0YXRlU3RhdHVzO1xuXG5jbGFzcyBSZWNvdmVyYWJsZUVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICBjb25zdHJ1Y3RvcihtZXNzYWdlOiBzdHJpbmcsIHB1YmxpYyBvcmlnaW46IFdhdGNoRXJyb3JPcmlnaW4pIHtcbiAgICBzdXBlcihtZXNzYWdlKTtcbiAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBleHBsaWNpdGx5LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL01pY3Jvc29mdC9UeXBlU2NyaXB0LXdpa2kvYmxvYi9tYXN0ZXIvQnJlYWtpbmctQ2hhbmdlcy5tZCNleHRlbmRpbmctYnVpbHQtaW5zLWxpa2UtZXJyb3ItYXJyYXktYW5kLW1hcC1tYXktbm8tbG9uZ2VyLXdvcmtcbiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YodGhpcywgUmVjb3ZlcmFibGVFcnJvci5wcm90b3R5cGUpO1xuICB9XG59XG5cbnR5cGUgV2F0Y2hFcnJvciA9IHtcbiAgbWVzc2FnZTogc3RyaW5nO1xuICBvcmlnaW46IFdhdGNoRXJyb3JPcmlnaW47XG4gIHJlY292ZXJhYmxlOiBib29sZWFuO1xuICB0aW1lc3RhbXA6IG51bWJlcjtcbn07XG5leHBvcnQgaW50ZXJmYWNlIFdhdGNoU3RhdGUge1xuICBzdGF0dXM6IFdhdGNoU3RhdGVTdGF0dXM7XG4gIHN0YWNrczogU3RhY2tbXTtcbiAgcmVzb3VyY2VzOiBNYXA8XG4gICAgVGltZXN0YW1wZWREZXBsb3lpbmdSZXNvdXJjZVtcImlkXCJdLFxuICAgIFRpbWVzdGFtcGVkRGVwbG95aW5nUmVzb3VyY2VcbiAgPjtcbiAgZXJyb3I/OiBXYXRjaEVycm9yO1xufVxuXG5leHBvcnQgdHlwZSBTdWJzY3JpcHRpb25IYW5kbGVyID0gKHN0YXRlOiBXYXRjaFN0YXRlKSA9PiB2b2lkIHwgUHJvbWlzZTx2b2lkPjtcblxuZXhwb3J0IGNsYXNzIFdhdGNoQ2xpZW50IHtcbiAgcHVibGljIHJlYWRvbmx5IHRhcmdldERpcjogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgc3ludGhDb21tYW5kOiBzdHJpbmc7XG4gIC8vIHB1YmxpYyByZWFkb25seSB3YXRjaENvbW1hbmQ6IHN0cmluZyBsYXRlclxuICBwdWJsaWMgcmVhZG9ubHkgYXV0b0FwcHJvdmU6IGJvb2xlYW47XG4gIHB1YmxpYyByZWFkb25seSB0YXJnZXRTdGFjaz86IHN0cmluZztcblxuICBwcml2YXRlIHN1YnNjcmliZXJzID0gbmV3IFNldDxTdWJzY3JpcHRpb25IYW5kbGVyPigpO1xuICBwcml2YXRlIHJ1bm5pbmcgPSBmYWxzZTtcbiAgcHJpdmF0ZSBuZWVkc0luaXQgPSB0cnVlO1xuICBwcml2YXRlIGFjdGlvblF1ZXVlOiBBY3Rpb25bXSA9IFtdO1xuICBwcml2YXRlIGxhc3RUYXJnZXRTdGFja0hhc2g/OiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3RhdGU6IERlZXBSZWFkb25seTxXYXRjaFN0YXRlPiA9IHtcbiAgICBzdGF0dXM6IFwiSURMRVwiLFxuICAgIHN0YWNrczogW10sXG4gICAgcmVzb3VyY2VzOiBuZXcgTWFwKCksXG4gIH07XG5cbiAgcHJpdmF0ZSBzb3VyY2VGaWxlV2F0Y2hlcj86IGNob2tpZGFyLkZTV2F0Y2hlcjtcbiAgcHJpdmF0ZSBvdXREaXJXYXRjaGVyPzogY2hva2lkYXIuRlNXYXRjaGVyO1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFdhdGNoQ2xpZW50T3B0aW9ucykge1xuICAgIHRoaXMudGFyZ2V0RGlyID0gb3B0aW9ucy50YXJnZXREaXI7XG4gICAgdGhpcy5zeW50aENvbW1hbmQgPSBvcHRpb25zLnN5bnRoQ29tbWFuZDtcblxuICAgIGlmICghb3B0aW9ucy5hdXRvQXBwcm92ZSlcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJXYXRjaENsaWVudCBkb2VzIG5vdCB5ZXQgc3VwcG9ydCBydW5uaW5nIHdpdGhvdXQgYXV0b0FwcHJvdmVcIlxuICAgICAgKTtcbiAgICB0aGlzLmF1dG9BcHByb3ZlID0gb3B0aW9ucy5hdXRvQXBwcm92ZTtcbiAgICB0aGlzLnRhcmdldFN0YWNrID0gb3B0aW9ucy50YXJnZXRTdGFjaztcbiAgfVxuXG4gIHB1YmxpYyBpc1J1bm5pbmcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMucnVubmluZztcbiAgfVxuXG4gIHB1YmxpYyBzdWJzY3JpYmUoaGFuZGxlcjogU3Vic2NyaXB0aW9uSGFuZGxlcik6ICgpID0+IHZvaWQge1xuICAgIHRoaXMuc3Vic2NyaWJlcnMuYWRkKGhhbmRsZXIpO1xuICAgIHJldHVybiAoKSA9PiB0aGlzLnN1YnNjcmliZXJzLmRlbGV0ZShoYW5kbGVyKTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlU3RhdGUoc3RhdGU6IFBhcnRpYWw8V2F0Y2hTdGF0ZT4pOiB2b2lkIHtcbiAgICBjb25zdCBwcmV2aW91c1N0YXRlID0gdGhpcy5zdGF0ZTtcbiAgICAvLyBpZ25vcmUgc3RhdGUgYmVpbmcgcmVhZG9ubHkgLSBpdCBpcyByZWFkb25seSBmb3Igc2FmZXR5IGluIG90aGVyIHBsYWNlc1xuICAgICh0aGlzLnN0YXRlIGFzIFdhdGNoU3RhdGUpID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5zdGF0ZSwgc3RhdGUpO1xuICAgIGlmICghaXNEZWVwRXF1YWwocHJldmlvdXNTdGF0ZSwgdGhpcy5zdGF0ZSkpIHtcbiAgICAgIHRoaXMuc3Vic2NyaWJlcnMuZm9yRWFjaCgoc3ViKSA9PiBzdWIodGhpcy5zdGF0ZSBhcyBXYXRjaFN0YXRlKSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBydW5TeW50aCgpIHtcbiAgICB0aGlzLnVwZGF0ZVN0YXRlKHsgc3RhdHVzOiBcIlNZTlRIRVNJWklOR1wiLCBlcnJvcjogdW5kZWZpbmVkIH0pO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzdGFja3MgPSAoXG4gICAgICAgIGF3YWl0IFN5bnRoU3RhY2suc3ludGgodGhpcy5zeW50aENvbW1hbmQsIHRoaXMudGFyZ2V0RGlyLCB0cnVlLCBcIndhdGNoXCIpXG4gICAgICApLm1hcDxTdGFjaz4oKHN0YWNrKSA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgLi4uc3RhY2ssXG4gICAgICAgICAganNvbjogSlNPTi5wYXJzZShzdGFjay5jb250ZW50KSBhcyBUZXJyYWZvcm1Kc29uLFxuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtcbiAgICAgICAgc3RhY2tzLFxuICAgICAgfSk7XG4gICAgICBpZiAodGhpcy5uZWVkc0luaXQpIGF3YWl0IHRoaXMucXVldWVBY3Rpb24oXCJJTklUXCIsIHRydWUpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBSZWNvdmVyYWJsZUVycm9yKGUuZXJyb3JPdXRwdXQgfHwgZS5tZXNzYWdlLCBcIlNZTlRIRVNJWklOR1wiKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHJ1bkluaXQoKSB7XG4gICAgdGhpcy51cGRhdGVTdGF0ZSh7IHN0YXR1czogXCJJTklUSUFMSVpJTkdcIiB9KTtcbiAgICBjb25zdCB0ZXJyYWZvcm0gPSBhd2FpdCB0aGlzLmdldFRlcnJhZm9ybSgpO1xuICAgIGF3YWl0IHRlcnJhZm9ybS5pbml0KCk7XG4gICAgdGhpcy5uZWVkc0luaXQgPSBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcnVuRGVwbG95KCkge1xuICAgIGNvbnN0IHsgd29ya2luZ0RpcmVjdG9yeSwgbmFtZSB9ID0gYXdhaXQgdGhpcy5nZXRUYXJnZXRTdGFjaygpO1xuICAgIGNvbnNvbGUubG9nKGBSdW5uaW5nIGRlcGxveSBpbiB3b3JraW5nRGlyZWN0b3J5ICR7d29ya2luZ0RpcmVjdG9yeX1gKTtcbiAgICBjb25zdCBuZXdUYXJnZXRTdGFja0hhc2ggPSBoYXNoUGF0aCh3b3JraW5nRGlyZWN0b3J5KTtcbiAgICBpZiAodGhpcy5sYXN0VGFyZ2V0U3RhY2tIYXNoID09PSBuZXdUYXJnZXRTdGFja0hhc2gpIHtcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBgc2tpcHBpbmcgZGVwbG95IGJlY2F1c2UgaGFzaCAoXCIke3RoaXMubGFzdFRhcmdldFN0YWNrSGFzaH1cIikgb2YgdGFyZ2V0IHN0YWNrIFwiJHtuYW1lfVwiIGRpZCBub3QgY2hhbmdlIGZvciB3b3JraW5nIGRpcmVjdG9yeSAke3dvcmtpbmdEaXJlY3Rvcnl9YFxuICAgICAgKTtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgIGBjb250aW51aW5nIGRlcGxveSBiZWNhdXNlIG5ldyBoYXNoIChcIiR7bmV3VGFyZ2V0U3RhY2tIYXNofVwiKSBvZiB3b3JraW5nIGRpcmVjdG9yeSBcIiR7d29ya2luZ0RpcmVjdG9yeX1cIiBkaWZmZXJzIGZyb20gcHJldmlvdXMgaGFzaCBcIiR7dGhpcy5sYXN0VGFyZ2V0U3RhY2tIYXNofVwiYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLnVwZGF0ZVN0YXRlKHsgc3RhdHVzOiBcIkRFUExPWUlOR1wiIH0pO1xuICAgIGNvbnN0IHRlcnJhZm9ybSA9IGF3YWl0IHRoaXMuZ2V0VGVycmFmb3JtKCk7XG5cbiAgICAvLyByZW1vdmUgcHJldmlvdXMgZXJyb3JzXG4gICAgLy8gd2UgZG8gdGhpcyBoZXJlIGFzIGRlcGxveSB3aWxsIHVwZGF0ZSB0aGUgc3RhdGUgYWxyZWFkeSB3aGlsZVxuICAgIC8vIGluIHByb2dyZXNzIGFuZCB3ZSBkb24ndCB3YW50IHRvIHNlZSB0aGUgZXJyb3Igd2hpbGUgc3VjY2Vzc2Z1bFxuICAgIC8vIHRoaW5ncyBhbHJlYWR5IHN0YXJ0IHRvIGhhcHBlblxuICAgIHRoaXMudXBkYXRlU3RhdGUoe1xuICAgICAgZXJyb3I6IHVuZGVmaW5lZCxcbiAgICB9KTtcbiAgICB0cnkge1xuICAgICAgaWYgKHRlcnJhZm9ybSBpbnN0YW5jZW9mIFRlcnJhZm9ybUNsb3VkKSB7XG4gICAgICAgIC8vIHBsYW4gZm9yIFRlcnJhZm9ybSBDbG91ZCByZW1vdGUgZXhlY3V0aW9uIGFsc28gdXBsb2FkcyB0aGUgVGVycmFmb3JtIGNvZGVcbiAgICAgICAgY29uc3QgeyBwbGFuRmlsZSB9ID0gYXdhaXQgdGVycmFmb3JtLnBsYW4oZmFsc2UpOyAvLyBmYWxzZSA9IGRlcGxveVxuICAgICAgICBhd2FpdCB0ZXJyYWZvcm0uZGVwbG95KHBsYW5GaWxlLCB0aGlzLmhhbmRsZVRlcnJhZm9ybU91dHB1dC5iaW5kKHRoaXMpKTtcbiAgICAgIH0gZWxzZSBpZiAodGVycmFmb3JtIGluc3RhbmNlb2YgVGVycmFmb3JtQ2xpKSB7XG4gICAgICAgIC8vIHNraXAgdGhlIHBsYW4gYW5kIHJlZnJlc2hpbmcgdG8gc2F2ZSB0aW1lIOKPsVxuICAgICAgICBjb25zdCBOT19QTEFOX0ZJTEUgPSBcIlwiO1xuICAgICAgICBhd2FpdCB0ZXJyYWZvcm0uZGVwbG95KFxuICAgICAgICAgIE5PX1BMQU5fRklMRSxcbiAgICAgICAgICB0aGlzLmhhbmRsZVRlcnJhZm9ybU91dHB1dC5iaW5kKHRoaXMpLFxuICAgICAgICAgIFtcIi1yZWZyZXNoPWZhbHNlXCJdXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICAvLyBkZXBsb3ltZW50IHdhcyBzdWNjZXNzZnVsIC0+IHVwZGF0ZSBoYXNoXG4gICAgICB0aGlzLmxhc3RUYXJnZXRTdGFja0hhc2ggPSBuZXdUYXJnZXRTdGFja0hhc2g7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gV2hlbiBuZXcgcHJvdmlkZXJzIHdoZXJlIGFkZGVkIG9yIHRoZSBzdGFjayBuYW1lIG1pZ2h0J3ZlXG4gICAgICAvLyBiZWVuIGNoYW5nZWQgKHdoZW4gdXNpbmcganVzdCBhIHNpbmdsZSBzdGFjaykgd2UgbmVlZCB0b1xuICAgICAgLy8gcmUtaW5pdCBUZXJyYWZvcm0uIFdlJ2xsIGRvIHRoaXMgcHJvYWN0aXZlbHkgb24gYW55IGVycm9yLlxuICAgICAgdGhpcy5uZWVkc0luaXQgPSB0cnVlO1xuICAgICAgdGhyb3cgbmV3IFJlY292ZXJhYmxlRXJyb3IoXG4gICAgICAgIGAke2UubWVzc2FnZX0ke2Uuc3RkZXJyID8gYFxcbiR7ZS5zdGRlcnJ9YCA6IFwiXCJ9YCxcbiAgICAgICAgXCJERVBMT1lJTkdcIlxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZVRlcnJhZm9ybU91dHB1dChjaHVuazogQnVmZmVyKSB7XG4gICAgY29uc3QgcmVzb3VyY2VzID0gcGFyc2VPdXRwdXQoY2h1bmsudG9TdHJpbmcoKSk7XG4gICAgaWYgKHJlc291cmNlcy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBuZXdSZXNvdXJjZXMgPSBuZXcgTWFwKFxuICAgICAgICB0aGlzLnN0YXRlLnJlc291cmNlcyBhcyBXYXRjaFN0YXRlW1wicmVzb3VyY2VzXCJdXG4gICAgICApO1xuICAgICAgcmVzb3VyY2VzLmZvckVhY2goKHIpID0+XG4gICAgICAgIG5ld1Jlc291cmNlcy5zZXQoci5pZCwgeyAuLi5yLCBjaGFuZ2VkQXQ6IERhdGUubm93KCkgfSlcbiAgICAgICk7XG4gICAgICB0aGlzLnVwZGF0ZVN0YXRlKHsgcmVzb3VyY2VzOiBuZXdSZXNvdXJjZXMgYXMgV2F0Y2hTdGF0ZVtcInJlc291cmNlc1wiXSB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFRhcmdldFN0YWNrKCk6IFByb21pc2U8RGVlcFJlYWRvbmx5PFN0YWNrPj4ge1xuICAgIGNvbnN0IHsgc3RhY2tzIH0gPSB0aGlzLnN0YXRlO1xuICAgIGlmIChzdGFja3MubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgUmVjb3ZlcmFibGVFcnJvcihcbiAgICAgICAgXCJDYW5ub3QgZGV0ZXJtaW5lIHRhcmdldCBzdGFjayB3aGVuIHRoZXJlIGFyZSBubyBzdGFja3NcIixcbiAgICAgICAgdGhpcy5zdGF0ZS5zdGF0dXNcbiAgICAgICk7XG4gICAgfVxuICAgIGlmICh0aGlzLnRhcmdldFN0YWNrKSB7XG4gICAgICBjb25zdCBzdGFjayA9IHN0YWNrcy5maW5kKChzKSA9PiBzLm5hbWUgPT09IHRoaXMudGFyZ2V0U3RhY2spO1xuICAgICAgaWYgKCFzdGFjaykge1xuICAgICAgICB0aHJvdyBuZXcgUmVjb3ZlcmFibGVFcnJvcihcbiAgICAgICAgICBgQ291bGQgbm90IGZpbmQgc3RhY2sgJHt0aGlzLnRhcmdldFN0YWNrfS4gRm91bmQgJHtzdGFja3NcbiAgICAgICAgICAgIC5tYXAoKHMpID0+IHMubmFtZSlcbiAgICAgICAgICAgIC5qb2luKFwiLCBcIil9YCxcbiAgICAgICAgICB0aGlzLnN0YXRlLnN0YXR1c1xuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHN0YWNrO1xuICAgIH0gZWxzZSBpZiAoc3RhY2tzLmxlbmd0aCA+IDEpIHtcbiAgICAgIHRocm93IG5ldyBSZWNvdmVyYWJsZUVycm9yKFxuICAgICAgICBcIkZvdW5kIG1vcmUgdGhhbiBvbmUgc3RhY2ssIHBsZWFzZSBzcGVjaWZ5IHdoaWNoIHN0YWNrIHRvIHdhdGNoIHVzaW5nIC0tc3RhY2tcIixcbiAgICAgICAgdGhpcy5zdGF0ZS5zdGF0dXNcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBzdGFja3NbMF07XG4gIH1cblxuICAvLyB0b2RvOiBvcHRpbWl6YXRpb246IGNhY2hlIGluc3RhbmNlIGFzIGxvbmcgYXMgYmFja2VuZCBkb2VzIG5vdCBjaGFuZ2VcbiAgcHJpdmF0ZSBhc3luYyBnZXRUZXJyYWZvcm0oKTogUHJvbWlzZTxUZXJyYWZvcm0+IHtcbiAgICBjb25zdCBzdGFjayA9IGF3YWl0IHRoaXMuZ2V0VGFyZ2V0U3RhY2soKTtcbiAgICBpZiAoc3RhY2suanNvbi50ZXJyYWZvcm0/LmJhY2tlbmQ/LnJlbW90ZSkge1xuICAgICAgY29uc3QgdGVycmFmb3JtQ2xvdWQgPSBuZXcgVGVycmFmb3JtQ2xvdWQoXG4gICAgICAgIHN0YWNrIGFzIFN0YWNrLFxuICAgICAgICBzdGFjay5qc29uLnRlcnJhZm9ybT8uYmFja2VuZD8ucmVtb3RlXG4gICAgICApO1xuICAgICAgaWYgKGF3YWl0IHRlcnJhZm9ybUNsb3VkLmlzUmVtb3RlV29ya3NwYWNlKCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IFJlY292ZXJhYmxlRXJyb3IoXG4gICAgICAgICAgXCJVc2luZyBUZXJyYWZvcm0gQ2xvdWQgaW4gUmVtb3RlIEV4ZWN1dGlvbiBNb2RlIGlzIG5vdCB5ZXQgc3VwcG9ydGVkIGZvciBjZGt0ZiB3YXRjaFwiLFxuICAgICAgICAgIHRoaXMuc3RhdGUuc3RhdHVzXG4gICAgICAgICk7XG4gICAgICAgIC8vIHJldHVybiB0ZXJyYWZvcm1DbG91ZDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG5ldyBUZXJyYWZvcm1DbGkoc3RhY2sgYXMgU3RhY2spO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHN0YXJ0KCkge1xuICAgIHRoaXMucnVubmluZyA9IHRydWU7XG5cbiAgICBsZXQgZ2l0aWdub3JlZDogc3RyaW5nW10gPSBbXTtcbiAgICB0cnkge1xuICAgICAgZ2l0aWdub3JlZCA9IGF3YWl0IHJlYWRHaXRpZ25vcmUocHJvY2Vzcy5jd2QoKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgbWVzc2FnZTogYENvdWxkIG5vdCByZWFkIC5naXRpZ25vcmUgZmlsZSBpbiAke3Byb2Nlc3MuY3dkKCl9LiBXYXRjaCByZXF1aXJlcyBpdCBmb3Iga25vd2luZyB3aGljaCBmaWxlcyB0byB3YXRjaC4gRXJyb3Igd2hpbGUgcmVhZGluZyBmaWxlOiAke1xuICAgICAgICAgICAgZS5tZXNzYWdlXG4gICAgICAgICAgfWAsXG4gICAgICAgICAgcmVjb3ZlcmFibGU6IGZhbHNlLFxuICAgICAgICAgIG9yaWdpbjogXCJJRExFXCIsXG4gICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnNvbGUubG9nKGBSZWFkIC5naXRpZ25vcmUgZmlsZTogJHtnaXRpZ25vcmVkfWApO1xuXG4gICAgLy8gSWYgaW5wdXQgZmlsZXMgY2hhbmdlIHdlIHF1ZXVlIGEgc3ludGggdG8gYmUgcnVuXG4gICAgdGhpcy5zb3VyY2VGaWxlV2F0Y2hlciA9IGNob2tpZGFyLndhdGNoKFwiLlwiLCB7XG4gICAgICBpZ25vcmVkOiBnaXRpZ25vcmVkLFxuICAgICAgY3dkOiBwcm9jZXNzLmN3ZCgpLFxuICAgICAgaWdub3JlSW5pdGlhbDogdHJ1ZSxcbiAgICB9KTtcbiAgICB0aGlzLnNvdXJjZUZpbGVXYXRjaGVyLm9uKFwicmVhZHlcIiwgKCkgPT5cbiAgICAgIGNvbnNvbGUubG9nKFwic3JjZGlyIHdhdGNoZXIgcmVhZHlcIilcbiAgICApO1xuICAgIFtcImNoYW5nZVwiLCBcImFkZFwiXS5mb3JFYWNoKChldmVudCkgPT4ge1xuICAgICAgaWYgKHRoaXMuc291cmNlRmlsZVdhdGNoZXIpXG4gICAgICAgIHRoaXMuc291cmNlRmlsZVdhdGNoZXIub24oZXZlbnQsIChwYXRoKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coYHN5bnRoIC0gcGF0aCBjaGFuZ2VkOiAke2V2ZW50fSAke3BhdGh9YCk7XG4gICAgICAgICAgdGhpcy5xdWV1ZUFjdGlvbihcIlNZTlRIXCIpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIC8vIElmIG91dCBkaXIgZmlsZXMgY2hhbmdlIHdlIHF1ZXVlIGEgZGVwbG95IHRvIGJlIHJ1blxuICAgIC8vIFRoZSBydW5EZXBsb3koKSBtZXRob2Qgd2lsbCBjaGVjayBpZiBmaWxlcyBvZiB0aGVcbiAgICAvLyBjdXJyZW50bHkgd2F0Y2hlZCBzdGFjayBjaGFuZ2VkXG4gICAgdGhpcy5vdXREaXJXYXRjaGVyID0gY2hva2lkYXIud2F0Y2godGhpcy50YXJnZXREaXIsIHtcbiAgICAgIGlnbm9yZWQ6IFtcIioqLy50ZXJyYWZvcm0vKipcIiwgXCIqKi8udGVycmFmb3JtLmxvY2suaGNsXCIsIFwiKi8qLyovcGxhblwiXSxcbiAgICAgIGN3ZDogcHJvY2Vzcy5jd2QoKSxcbiAgICAgIGlnbm9yZUluaXRpYWw6IHRydWUsXG4gICAgfSk7XG4gICAgdGhpcy5vdXREaXJXYXRjaGVyLm9uKFwicmVhZHlcIiwgKCkgPT4gY29uc29sZS5sb2coXCJvdXRkaXIgd2F0Y2hlciByZWFkeVwiKSk7XG4gICAgW1wiY2hhbmdlXCIsIFwiYWRkXCJdLmZvckVhY2goKGV2ZW50KSA9PiB7XG4gICAgICBpZiAodGhpcy5vdXREaXJXYXRjaGVyKVxuICAgICAgICB0aGlzLm91dERpcldhdGNoZXIub24oZXZlbnQsIChwYXRoKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coYG91dGRpciAtIHBhdGggY2hhbmdlZDogJHtldmVudH0gJHtwYXRofWApO1xuICAgICAgICAgIHRoaXMucXVldWVBY3Rpb24oXCJERVBMT1lcIik7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgLy8gUXVldWUgaW5pdGlhbCBzeW50aCB0byBnZXQgdGhpbmdzIHN0YXJ0ZWRcbiAgICBhd2FpdCB0aGlzLnF1ZXVlQWN0aW9uKFwiU1lOVEhcIik7XG4gICAgYXdhaXQgc2VuZFRlbGVtZXRyeShcIndhdGNoXCIsIHsgZXZlbnQ6IFwic3RhcnRcIiB9KTtcblxuICAgIHRoaXMuc3RhcnRIYW5kbGluZ0FjdGlvbnMoKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBxdWV1ZUFjdGlvbihhY3Rpb246IEFjdGlvbiwgcHJpb3JpdHkgPSBmYWxzZSkge1xuICAgIC8vIG9ubHkgZW5xdWV1ZSBpZiBub3QgYWxyZWFkeSBlbnF1ZXVlZCBhbnl3YXlcbiAgICBpZiAoIXRoaXMuYWN0aW9uUXVldWUuaW5jbHVkZXMoYWN0aW9uKSkge1xuICAgICAgLy8gcHJpb3JpdHkgPSBydW4gbmV4dFxuICAgICAgaWYgKHByaW9yaXR5KSB0aGlzLmFjdGlvblF1ZXVlLnVuc2hpZnQoYWN0aW9uKTtcbiAgICAgIGVsc2UgdGhpcy5hY3Rpb25RdWV1ZS5wdXNoKGFjdGlvbik7XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coYGN1cnJlbnRseSBxdWV1ZWQgYWN0aW9uczogJHt0aGlzLmFjdGlvblF1ZXVlLmpvaW4oXCIsIFwiKX1gKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc3RhcnRIYW5kbGluZ0FjdGlvbnMoKSB7XG4gICAgd2hpbGUgKHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgIGNvbnN0IG5leHRBY3Rpb246IEFjdGlvbiB8IHVuZGVmaW5lZCA9IHRoaXMuYWN0aW9uUXVldWUuc2hpZnQoKTtcbiAgICAgIGlmIChuZXh0QWN0aW9uKSBjb25zb2xlLmxvZyhgSGFuZGxpbmcgbmV4dCBhY3Rpb246ICR7bmV4dEFjdGlvbn1gKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIHN3aXRjaCAobmV4dEFjdGlvbikge1xuICAgICAgICAgIGNhc2UgXCJTWU5USFwiOiB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnJ1blN5bnRoKCk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgY2FzZSBcIklOSVRcIjoge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5ydW5Jbml0KCk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgY2FzZSBcIkRFUExPWVwiOiB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnJ1bkRlcGxveSgpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNhc2UgdW5kZWZpbmVkOiB7XG4gICAgICAgICAgICAvLyB0aGlzIGlzIGhhY2t5IGJ1dCBtYWtlcyBpdCB2ZXJ5IGVhc3kgdG8ga2VlcCB0aGlzIGFsaXZlIGluXG4gICAgICAgICAgICAvLyBhIGxvb3AgZXZlbiBpZiBubyBldmVudHMgYXJlIGN1cnJlbnRseSBlbnF1ZXVlZC4gVGhpcyB3aG9sZVxuICAgICAgICAgICAgLy8gcXVldWUgaW1wbGVtZW5hdGlvbiB3aWxsIHByb2JhYmx5IGJlIHJlcGxhY2VkIGJ5IGEgc3RhdGVcbiAgICAgICAgICAgIC8vIG1hY2hpbmUgaW4gdGhlIGZ1dHVyZS5cbiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoeyBzdGF0dXM6IFwiSURMRVwiIH0pO1xuICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwKSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgICAgICBgd2FybmluZzogcmVjZWl2ZWQgdW5rbm93biBhY3Rpb24gJHtuZXh0QWN0aW9ufSAtIGlnbm9yaW5nIGl0YFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIFJlY292ZXJhYmxlRXJyb3IpIHtcbiAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtcbiAgICAgICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGUubWVzc2FnZSxcbiAgICAgICAgICAgICAgcmVjb3ZlcmFibGU6IHRydWUsXG4gICAgICAgICAgICAgIG9yaWdpbjogZS5vcmlnaW4sXG4gICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzdG9wKCkge1xuICAgIGlmICh0aGlzLnNvdXJjZUZpbGVXYXRjaGVyKSBhd2FpdCB0aGlzLnNvdXJjZUZpbGVXYXRjaGVyLmNsb3NlKCk7XG4gICAgaWYgKHRoaXMub3V0RGlyV2F0Y2hlcikgYXdhaXQgdGhpcy5vdXREaXJXYXRjaGVyLmNsb3NlKCk7XG4gICAgdGhpcy5hY3Rpb25RdWV1ZSA9IFtdO1xuICAgIHRoaXMucnVubmluZyA9IGZhbHNlO1xuICB9XG59XG4iXX0=
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const os = __importStar(require("os"));
const child_process_1 = require("child_process");
const lib_1 = require("../lib");
const provider_generator_1 = require("@cdktf/provider-generator");
const providerRequirements = ["kreuzwerker/docker@ ~>2.15.0"];
const createFiles = (cwd, files) => {
    files.forEach(([p, content]) => {
        fs.writeFileSync(path.resolve(cwd, p), content, "utf8");
    });
};
const createTSCdkProject = (cwd) => createFiles(cwd, [
    [
        "cdktf.json",
        `{
"language": "typescript",
"app": "npm run --silent compile && node main.js",
"terraformProviders": [],
"terraformModules": [],
"context": {}}`,
    ],
    [
        "main.ts",
        `import { Construct } from "constructs";
import { App, TerraformStack } from "cdktf";


class MyStack extends TerraformStack {
    constructor(scope: Construct, name: string) {
    super(scope, name);

    // define resources here
    }
}

const app = new App();
new MyStack(app, "converted");
app.synth();`,
    ],
    [
        "package.json",
        `{
        "name": "converted",
        "version": "1.0.0",
        "main": "main.js",
        "types": "main.ts",
        "license": "MPL-2.0",
        "private": true,
        "scripts": {
          "get": "cdktf get",
          "build": "tsc",
          "synth": "cdktf synth",
          "compile": "tsc --pretty",
          "watch": "tsc -w",
          "test": "echo ok",
          "upgrade": "npm i cdktf@latest cdktf-cli@latest",
          "upgrade:next": "npm i cdktf@next cdktf-cli@next"
        },
        "engines": {
          "node": ">=10.12"
        },
        "dependencies": {
          "cdktf": "next",
          "constructs": "^10.0.5"
        },
        "devDependencies": {
          "@types/node": "^14.0.26",
          "typescript": "^3.9.7",
          "cdktf-cli": "next"
        }
      }`,
    ],
    [
        "tsconfig.json",
        `{
        "compilerOptions": {
          "alwaysStrict": true,
          "charset": "utf8",
          "declaration": true,
          "experimentalDecorators": true,
          "inlineSourceMap": true,
          "inlineSources": true,
          "lib": [
            "es2018"
          ],
          "module": "CommonJS",
          "noEmitOnError": true,
          "noFallthroughCasesInSwitch": true,
          "noImplicitAny": true,
          "noImplicitReturns": true,
          "noImplicitThis": true,
          "noUnusedLocals": true,
          "noUnusedParameters": true,
          "resolveJsonModule": true,
          "strict": true,
          "strictNullChecks": true,
          "strictPropertyInitialization": true,
          "stripInternal": true,
          "target": "ES2018"
        },
        "include": [
          "**/*.ts"
        ],
        "exclude": [
          "node_modules"
        ]
      }`,
    ],
]);
const terraformProject = (files) => {
    const dir = fs.mkdtempSync(path.join(os.tmpdir(), "cdktf-convert."));
    createFiles(dir, files);
    return {
        importPath: dir,
        targetPath: fs.mkdtempSync(path.join(os.tmpdir(), "cdktf-converted.")),
    };
};
const exec = (command, cwd) => child_process_1.execSync(command, {
    cwd,
    ...(process.env.VERBOSE === "true" ? { stdio: "inherit" } : {}),
});
const getTerraformPlan = (cwd) => {
    exec(`terraform init`, cwd);
    exec(`terraform plan -out planfile`, cwd);
    exec(`terraform show -json planfile > plan.json`, cwd);
    return JSON.parse(fs.readFileSync(path.resolve(cwd, "plan.json"), "utf8"));
};
const getCdkPlan = (cwd) => {
    exec(`npm install`, cwd);
    exec(`npm run get`, cwd);
    exec(`npm run synth`, cwd);
    return getTerraformPlan(path.resolve(cwd, "cdktf.out/stacks/converted/"));
};
function resources(plan) {
    return plan.planned_values.root_module.resources.map((item) => ({
        type: item.type,
        provider_name: item.provider_name,
        values: item.values,
    }));
}
let cachedProviderSchema;
describe("convertProject", () => {
    beforeAll(async () => {
        // Get all the provider schemas
        const { providerSchema } = await provider_generator_1.readSchema(providerRequirements.map((spec) => provider_generator_1.ConstructsMakerProviderTarget.from(new provider_generator_1.config.TerraformProviderConstraint(spec), provider_generator_1.LANGUAGES[0])));
        cachedProviderSchema = providerSchema;
    });
    it("has a similar plan", async () => {
        const { importPath, targetPath } = terraformProject([
            [
                "main.tf",
                `terraform {
        required_providers {
          docker = {
            source  = "kreuzwerker/docker"
            version = "2.14.0"
          }
        }
      }
      
      provider "docker" {
        host = "unix:///var/run/docker.sock"
      }`,
            ],
            [
                "container.tf",
                `resource "docker_image" "ubuntu" {
            name = "ubuntu:latest"
          }
          
          resource "docker_container" "foo" {
            image = docker_image.ubuntu.latest
            name  = "foo"
          }`,
            ],
            [
                "cluster.tf",
                `module "k3s" {
        source  = "camptocamp/k3s/docker"
        version = "0.11.0"
        
        cluster_endpoint = ""
        cluster_name = "cdktf"
        network_name = ""
      }`,
            ],
        ]);
        const previousPlan = getTerraformPlan(importPath);
        createTSCdkProject(targetPath);
        const mainTs = fs.readFileSync(path.resolve(targetPath, "main.ts"), "utf8");
        const { code, cdktfJson } = await lib_1.convertProject(lib_1.getTerraformConfigFromDir(importPath), mainTs, require(path.resolve(targetPath, "cdktf.json")), {
            language: "typescript",
            providerSchema: cachedProviderSchema,
        });
        fs.writeFileSync(path.resolve(targetPath, "main.ts"), code, "utf8");
        fs.writeFileSync(path.resolve(targetPath, "cdktf.json"), JSON.stringify(cdktfJson), "utf8");
        const currentPlan = getCdkPlan(targetPath);
        expect(resources(currentPlan)).toEqual(resources(previousPlan));
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydFByb2plY3QudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbnZlcnRQcm9qZWN0LnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsdUNBQXlCO0FBQ3pCLDJDQUE2QjtBQUM3Qix1Q0FBeUI7QUFDekIsaURBQXlDO0FBQ3pDLGdDQUFtRTtBQUNuRSxrRUFLbUM7QUFFbkMsTUFBTSxvQkFBb0IsR0FBRyxDQUFDLDhCQUE4QixDQUFDLENBQUM7QUFDOUQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxHQUFXLEVBQUUsS0FBeUIsRUFBRSxFQUFFO0lBQzdELEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsRUFBRSxFQUFFO1FBQzdCLEVBQUUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQzFELENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBRUYsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLEdBQVcsRUFBRSxFQUFFLENBQ3pDLFdBQVcsQ0FBQyxHQUFHLEVBQUU7SUFDZjtRQUNFLFlBQVk7UUFDWjs7Ozs7ZUFLUztLQUNWO0lBQ0Q7UUFDRSxTQUFTO1FBQ1Q7Ozs7Ozs7Ozs7Ozs7O2FBY087S0FDUjtJQUNEO1FBQ0UsY0FBYztRQUNkOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztRQTZCRTtLQUNIO0lBQ0Q7UUFDRSxlQUFlO1FBQ2Y7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O1FBZ0NFO0tBQ0g7Q0FDRixDQUFDLENBQUM7QUFFTCxNQUFNLGdCQUFnQixHQUFHLENBQUMsS0FBeUIsRUFBRSxFQUFFO0lBQ3JELE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxF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QUFZO2dCQUNaOzs7Ozs7O1FBT0E7YUFDRDtTQUNGLENBQUMsQ0FBQztRQUVILE1BQU0sWUFBWSxHQUFHLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2xELGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQy9CLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFNUUsTUFBTSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsR0FBRyxNQUFNLG9CQUFjLENBQzlDLCtCQUF5QixDQUFDLFVBQVUsQ0FBQyxFQUNyQyxNQUFNLEVBQ04sT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLFlBQVksQ0FBQyxDQUFDLEVBQy9DO1lBQ0UsUUFBUSxFQUFFLFlBQVk7WUFDdEIsY0FBYyxFQUFFLG9CQUFvQjtTQUNyQyxDQUNGLENBQUM7UUFFRixFQUFFLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNwRSxFQUFFLENBQUMsYUFBYSxDQUNkLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLFlBQVksQ0FBQyxFQUN0QyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxFQUN6QixNQUFNLENBQ1AsQ0FBQztRQUVGLE1BQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUUzQyxNQUFNLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0lBQ2xFLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIG9zIGZyb20gXCJvc1wiO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuaW1wb3J0IHsgY29udmVydFByb2plY3QsIGdldFRlcnJhZm9ybUNvbmZpZ0Zyb21EaXIgfSBmcm9tIFwiLi4vbGliXCI7XG5pbXBvcnQge1xuICByZWFkU2NoZW1hLFxuICBDb25zdHJ1Y3RzTWFrZXJQcm92aWRlclRhcmdldCxcbiAgTEFOR1VBR0VTLFxuICBjb25maWcsXG59IGZyb20gXCJAY2RrdGYvcHJvdmlkZXItZ2VuZXJhdG9yXCI7XG5cbmNvbnN0IHByb3ZpZGVyUmVxdWlyZW1lbnRzID0gW1wia3JldXp3ZXJrZXIvZG9ja2VyQCB+PjIuMTUuMFwiXTtcbmNvbnN0IGNyZWF0ZUZpbGVzID0gKGN3ZDogc3RyaW5nLCBmaWxlczogW3N0cmluZywgc3RyaW5nXVtdKSA9PiB7XG4gIGZpbGVzLmZvckVhY2goKFtwLCBjb250ZW50XSkgPT4ge1xuICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aC5yZXNvbHZlKGN3ZCwgcCksIGNvbnRlbnQsIFwidXRmOFwiKTtcbiAgfSk7XG59O1xuXG5jb25zdCBjcmVhdGVUU0Nka1Byb2plY3QgPSAoY3dkOiBzdHJpbmcpID0+XG4gIGNyZWF0ZUZpbGVzKGN3ZCwgW1xuICAgIFtcbiAgICAgIFwiY2RrdGYuanNvblwiLFxuICAgICAgYHtcblwibGFuZ3VhZ2VcIjogXCJ0eXBlc2NyaXB0XCIsXG5cImFwcFwiOiBcIm5wbSBydW4gLS1zaWxlbnQgY29tcGlsZSAmJiBub2RlIG1haW4uanNcIixcblwidGVycmFmb3JtUHJvdmlkZXJzXCI6IFtdLFxuXCJ0ZXJyYWZvcm1Nb2R1bGVzXCI6IFtdLFxuXCJjb250ZXh0XCI6IHt9fWAsXG4gICAgXSxcbiAgICBbXG4gICAgICBcIm1haW4udHNcIixcbiAgICAgIGBpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgQXBwLCBUZXJyYWZvcm1TdGFjayB9IGZyb20gXCJjZGt0ZlwiO1xuXG5cbmNsYXNzIE15U3RhY2sgZXh0ZW5kcyBUZXJyYWZvcm1TdGFjayB7XG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgbmFtZTogc3RyaW5nKSB7XG4gICAgc3VwZXIoc2NvcGUsIG5hbWUpO1xuXG4gICAgLy8gZGVmaW5lIHJlc291cmNlcyBoZXJlXG4gICAgfVxufVxuXG5jb25zdCBhcHAgPSBuZXcgQXBwKCk7XG5uZXcgTXlTdGFjayhhcHAsIFwiY29udmVydGVkXCIpO1xuYXBwLnN5bnRoKCk7YCxcbiAgICBdLFxuICAgIFtcbiAgICAgIFwicGFja2FnZS5qc29uXCIsXG4gICAgICBge1xuICAgICAgICBcIm5hbWVcIjogXCJjb252ZXJ0ZWRcIixcbiAgICAgICAgXCJ2ZXJzaW9uXCI6IFwiMS4wLjBcIixcbiAgICAgICAgXCJtYWluXCI6IFwibWFpbi5qc1wiLFxuICAgICAgICBcInR5cGVzXCI6IFwibWFpbi50c1wiLFxuICAgICAgICBcImxpY2Vuc2VcIjogXCJNUEwtMi4wXCIsXG4gICAgICAgIFwicHJpdmF0ZVwiOiB0cnVlLFxuICAgICAgICBcInNjcmlwdHNcIjoge1xuICAgICAgICAgIFwiZ2V0XCI6IFwiY2RrdGYgZ2V0XCIsXG4gICAgICAgICAgXCJidWlsZFwiOiBcInRzY1wiLFxuICAgICAgICAgIFwic3ludGhcIjogXCJjZGt0ZiBzeW50aFwiLFxuICAgICAgICAgIFwiY29tcGlsZVwiOiBcInRzYyAtLXByZXR0eVwiLFxuICAgICAgICAgIFwid2F0Y2hcIjogXCJ0c2MgLXdcIixcbiAgICAgICAgICBcInRlc3RcIjogXCJlY2hvIG9rXCIsXG4gICAgICAgICAgXCJ1cGdyYWRlXCI6IFwibnBtIGkgY2RrdGZAbGF0ZXN0IGNka3RmLWNsaUBsYXRlc3RcIixcbiAgICAgICAgICBcInVwZ3JhZGU6bmV4dFwiOiBcIm5wbSBpIGNka3RmQG5leHQgY2RrdGYtY2xpQG5leHRcIlxuICAgICAgICB9LFxuICAgICAgICBcImVuZ2luZXNcIjoge1xuICAgICAgICAgIFwibm9kZVwiOiBcIj49MTAuMTJcIlxuICAgICAgICB9LFxuICAgICAgICBcImRlcGVuZGVuY2llc1wiOiB7XG4gICAgICAgICAgXCJjZGt0ZlwiOiBcIm5leHRcIixcbiAgICAgICAgICBcImNvbnN0cnVjdHNcIjogXCJeMTAuMC41XCJcbiAgICAgICAgfSxcbiAgICAgICAgXCJkZXZEZXBlbmRlbmNpZXNcIjoge1xuICAgICAgICAgIFwiQHR5cGVzL25vZGVcIjogXCJeMTQuMC4yNlwiLFxuICAgICAgICAgIFwidHlwZXNjcmlwdFwiOiBcIl4zLjkuN1wiLFxuICAgICAgICAgIFwiY2RrdGYtY2xpXCI6IFwibmV4dFwiXG4gICAgICAgIH1cbiAgICAgIH1gLFxuICAgIF0sXG4gICAgW1xuICAgICAgXCJ0c2NvbmZpZy5qc29uXCIsXG4gICAgICBge1xuICAgICAgICBcImNvbXBpbGVyT3B0aW9uc1wiOiB7XG4gICAgICAgICAgXCJhbHdheXNTdHJpY3RcIjogdHJ1ZSxcbiAgICAgICAgICBcImNoYXJzZXRcIjogXCJ1dGY4XCIsXG4gICAgICAgICAgXCJkZWNsYXJhdGlvblwiOiB0cnVlLFxuICAgICAgICAgIFwiZXhwZXJpbWVudGFsRGVjb3JhdG9yc1wiOiB0cnVlLFxuICAgICAgICAgIFwiaW5saW5lU291cmNlTWFwXCI6IHRydWUsXG4gICAgICAgICAgXCJpbmxpbmVTb3VyY2VzXCI6IHRydWUsXG4gICAgICAgICAgXCJsaWJcIjogW1xuICAgICAgICAgICAgXCJlczIwMThcIlxuICAgICAgICAgIF0sXG4gICAgICAgICAgXCJtb2R1bGVcIjogXCJDb21tb25KU1wiLFxuICAgICAgICAgIFwibm9FbWl0T25FcnJvclwiOiB0cnVlLFxuICAgICAgICAgIFwibm9GYWxsdGhyb3VnaENhc2VzSW5Td2l0Y2hcIjogdHJ1ZSxcbiAgICAgICAgICBcIm5vSW1wbGljaXRBbnlcIjogdHJ1ZSxcbiAgICAgICAgICBcIm5vSW1wbGljaXRSZXR1cm5zXCI6IHRydWUsXG4gICAgICAgICAgXCJub0ltcGxpY2l0VGhpc1wiOiB0cnVlLFxuICAgICAgICAgIFwibm9VbnVzZWRMb2NhbHNcIjogdHJ1ZSxcbiAgICAgICAgICBcIm5vVW51c2VkUGFyYW1ldGVyc1wiOiB0cnVlLFxuICAgICAgICAgIFwicmVzb2x2ZUpzb25Nb2R1bGVcIjogdHJ1ZSxcbiAgICAgICAgICBcInN0cmljdFwiOiB0cnVlLFxuICAgICAgICAgIFwic3RyaWN0TnVsbENoZWNrc1wiOiB0cnVlLFxuICAgICAgICAgIFwic3RyaWN0UHJvcGVydHlJbml0aWFsaXphdGlvblwiOiB0cnVlLFxuICAgICAgICAgIFwic3RyaXBJbnRlcm5hbFwiOiB0cnVlLFxuICAgICAgICAgIFwidGFyZ2V0XCI6IFwiRVMyMDE4XCJcbiAgICAgICAgfSxcbiAgICAgICAgXCJpbmNsdWRlXCI6IFtcbiAgICAgICAgICBcIioqLyoudHNcIlxuICAgICAgICBdLFxuICAgICAgICBcImV4Y2x1ZGVcIjogW1xuICAgICAgICAgIFwibm9kZV9tb2R1bGVzXCJcbiAgICAgICAgXVxuICAgICAgfWAsXG4gICAgXSxcbiAgXSk7XG5cbmNvbnN0IHRlcnJhZm9ybVByb2plY3QgPSAoZmlsZXM6IFtzdHJpbmcsIHN0cmluZ11bXSkgPT4ge1xuICBjb25zdCBkaXIgPSBmcy5ta2R0ZW1wU3luYyhwYXRoLmpvaW4ob3MudG1wZGlyKCksIFwiY2RrdGYtY29udmVydC5cIikpO1xuICBjcmVhdGVGaWxlcyhkaXIsIGZpbGVzKTtcblxuICByZXR1cm4ge1xuICAgIGltcG9ydFBhdGg6IGRpcixcbiAgICB0YXJnZXRQYXRoOiBmcy5ta2R0ZW1wU3luYyhwYXRoLmpvaW4ob3MudG1wZGlyKCksIFwiY2RrdGYtY29udmVydGVkLlwiKSksXG4gIH07XG59O1xuXG5jb25zdCBleGVjID0gKGNvbW1hbmQ6IHN0cmluZywgY3dkOiBzdHJpbmcpID0+XG4gIGV4ZWNTeW5jKGNvbW1hbmQsIHtcbiAgICBjd2QsXG4gICAgLi4uKHByb2Nlc3MuZW52LlZFUkJPU0UgPT09IFwidHJ1ZVwiID8geyBzdGRpbzogXCJpbmhlcml0XCIgfSA6IHt9KSxcbiAgfSk7XG5cbmNvbnN0IGdldFRlcnJhZm9ybVBsYW4gPSAoY3dkOiBzdHJpbmcpID0+IHtcbiAgZXhlYyhgdGVycmFmb3JtIGluaXRgLCBjd2QpO1xuICBleGVjKGB0ZXJyYWZvcm0gcGxhbiAtb3V0IHBsYW5maWxlYCwgY3dkKTtcbiAgZXhlYyhgdGVycmFmb3JtIHNob3cgLWpzb24gcGxhbmZpbGUgPiBwbGFuLmpzb25gLCBjd2QpO1xuXG4gIHJldHVybiBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUoY3dkLCBcInBsYW4uanNvblwiKSwgXCJ1dGY4XCIpKTtcbn07XG5cbmNvbnN0IGdldENka1BsYW4gPSAoY3dkOiBzdHJpbmcpID0+IHtcbiAgZXhlYyhgbnBtIGluc3RhbGxgLCBjd2QpO1xuICBleGVjKGBucG0gcnVuIGdldGAsIGN3ZCk7XG4gIGV4ZWMoYG5wbSBydW4gc3ludGhgLCBjd2QpO1xuXG4gIHJldHVybiBnZXRUZXJyYWZvcm1QbGFuKHBhdGgucmVzb2x2ZShjd2QsIFwiY2RrdGYub3V0L3N0YWNrcy9jb252ZXJ0ZWQvXCIpKTtcbn07XG5cbmZ1bmN0aW9uIHJlc291cmNlcyhwbGFuOiBhbnkpIHtcbiAgcmV0dXJuIHBsYW4ucGxhbm5lZF92YWx1ZXMucm9vdF9tb2R1bGUucmVzb3VyY2VzLm1hcCgoaXRlbTogYW55KSA9PiAoe1xuICAgIHR5cGU6IGl0ZW0udHlwZSxcbiAgICBwcm92aWRlcl9uYW1lOiBpdGVtLnByb3ZpZGVyX25hbWUsXG4gICAgdmFsdWVzOiBpdGVtLnZhbHVlcyxcbiAgfSkpO1xufVxuXG5sZXQgY2FjaGVkUHJvdmlkZXJTY2hlbWE6IGFueTtcbmRlc2NyaWJlKFwiY29udmVydFByb2plY3RcIiwgKCkgPT4ge1xuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgIC8vIEdldCBhbGwgdGhlIHByb3ZpZGVyIHNjaGVtYXNcbiAgICBjb25zdCB7IHByb3ZpZGVyU2NoZW1hIH0gPSBhd2FpdCByZWFkU2NoZW1hKFxuICAgICAgcHJvdmlkZXJSZXF1aXJlbWVudHMubWFwKChzcGVjKSA9PlxuICAgICAgICBDb25zdHJ1Y3RzTWFrZXJQcm92aWRlclRhcmdldC5mcm9tKFxuICAgICAgICAgIG5ldyBjb25maWcuVGVycmFmb3JtUHJvdmlkZXJDb25zdHJhaW50KHNwZWMpLFxuICAgICAgICAgIExBTkdVQUdFU1swXVxuICAgICAgICApXG4gICAgICApXG4gICAgKTtcbiAgICBjYWNoZWRQcm92aWRlclNjaGVtYSA9IHByb3ZpZGVyU2NoZW1hO1xuICB9KTtcbiAgaXQoXCJoYXMgYSBzaW1pbGFyIHBsYW5cIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHsgaW1wb3J0UGF0aCwgdGFyZ2V0UGF0aCB9ID0gdGVycmFmb3JtUHJvamVjdChbXG4gICAgICBbXG4gICAgICAgIFwibWFpbi50ZlwiLFxuICAgICAgICBgdGVycmFmb3JtIHtcbiAgICAgICAgcmVxdWlyZWRfcHJvdmlkZXJzIHtcbiAgICAgICAgICBkb2NrZXIgPSB7XG4gICAgICAgICAgICBzb3VyY2UgID0gXCJrcmV1endlcmtlci9kb2NrZXJcIlxuICAgICAgICAgICAgdmVyc2lvbiA9IFwiMi4xNC4wXCJcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIFxuICAgICAgcHJvdmlkZXIgXCJkb2NrZXJcIiB7XG4gICAgICAgIGhvc3QgPSBcInVuaXg6Ly8vdmFyL3J1bi9kb2NrZXIuc29ja1wiXG4gICAgICB9YCxcbiAgICAgIF0sXG4gICAgICBbXG4gICAgICAgIFwiY29udGFpbmVyLnRmXCIsXG4gICAgICAgIGByZXNvdXJjZSBcImRvY2tlcl9pbWFnZVwiIFwidWJ1bnR1XCIge1xuICAgICAgICAgICAgbmFtZSA9IFwidWJ1bnR1OmxhdGVzdFwiXG4gICAgICAgICAgfVxuICAgICAgICAgIFxuICAgICAgICAgIHJlc291cmNlIFwiZG9ja2VyX2NvbnRhaW5lclwiIFwiZm9vXCIge1xuICAgICAgICAgICAgaW1hZ2UgPSBkb2NrZXJfaW1hZ2UudWJ1bnR1LmxhdGVzdFxuICAgICAgICAgICAgbmFtZSAgPSBcImZvb1wiXG4gICAgICAgICAgfWAsXG4gICAgICBdLFxuICAgICAgW1xuICAgICAgICBcImNsdXN0ZXIudGZcIixcbiAgICAgICAgYG1vZHVsZSBcImszc1wiIHtcbiAgICAgICAgc291cmNlICA9IFwiY2FtcHRvY2FtcC9rM3MvZG9ja2VyXCJcbiAgICAgICAgdmVyc2lvbiA9IFwiMC4xMS4wXCJcbiAgICAgICAgXG4gICAgICAgIGNsdXN0ZXJfZW5kcG9pbnQgPSBcIlwiXG4gICAgICAgIGNsdXN0ZXJfbmFtZSA9IFwiY2RrdGZcIlxuICAgICAgICBuZXR3b3JrX25hbWUgPSBcIlwiXG4gICAgICB9YCxcbiAgICAgIF0sXG4gICAgXSk7XG5cbiAgICBjb25zdCBwcmV2aW91c1BsYW4gPSBnZXRUZXJyYWZvcm1QbGFuKGltcG9ydFBhdGgpO1xuICAgIGNyZWF0ZVRTQ2RrUHJvamVjdCh0YXJnZXRQYXRoKTtcbiAgICBjb25zdCBtYWluVHMgPSBmcy5yZWFkRmlsZVN5bmMocGF0aC5yZXNvbHZlKHRhcmdldFBhdGgsIFwibWFpbi50c1wiKSwgXCJ1dGY4XCIpO1xuXG4gICAgY29uc3QgeyBjb2RlLCBjZGt0Zkpzb24gfSA9IGF3YWl0IGNvbnZlcnRQcm9qZWN0KFxuICAgICAgZ2V0VGVycmFmb3JtQ29uZmlnRnJvbURpcihpbXBvcnRQYXRoKSxcbiAgICAgIG1haW5UcyxcbiAgICAgIHJlcXVpcmUocGF0aC5yZXNvbHZlKHRhcmdldFBhdGgsIFwiY2RrdGYuanNvblwiKSksXG4gICAgICB7XG4gICAgICAgIGxhbmd1YWdlOiBcInR5cGVzY3JpcHRcIixcbiAgICAgICAgcHJvdmlkZXJTY2hlbWE6IGNhY2hlZFByb3ZpZGVyU2NoZW1hLFxuICAgICAgfVxuICAgICk7XG5cbiAgICBmcy53cml0ZUZpbGVTeW5jKHBhdGgucmVzb2x2ZSh0YXJnZXRQYXRoLCBcIm1haW4udHNcIiksIGNvZGUsIFwidXRmOFwiKTtcbiAgICBmcy53cml0ZUZpbGVTeW5jKFxuICAgICAgcGF0aC5yZXNvbHZlKHRhcmdldFBhdGgsIFwiY2RrdGYuanNvblwiKSxcbiAgICAgIEpTT04uc3RyaW5naWZ5KGNka3RmSnNvbiksXG4gICAgICBcInV0ZjhcIlxuICAgICk7XG5cbiAgICBjb25zdCBjdXJyZW50UGxhbiA9IGdldENka1BsYW4odGFyZ2V0UGF0aCk7XG5cbiAgICBleHBlY3QocmVzb3VyY2VzKGN1cnJlbnRQbGFuKSkudG9FcXVhbChyZXNvdXJjZXMocHJldmlvdXNQbGFuKSk7XG4gIH0pO1xufSk7XG4iXX0=
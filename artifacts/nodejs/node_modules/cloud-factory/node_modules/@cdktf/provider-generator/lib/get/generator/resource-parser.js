"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ResourceParser = void 0;
const codemaker_1 = require("codemaker");
const models_1 = require("./models");
const classNames = [];
const uniqueClassName = (className) => {
    if (classNames.includes(className)) {
        className = `${className}A`;
    }
    classNames.push(className);
    return className;
};
class Parser {
    constructor() {
        this.structs = new Array();
    }
    resourceFrom(provider, type, schema, terraformSchemaType) {
        let baseName = type;
        if (baseName.startsWith(`${provider}_`)) {
            baseName = baseName.substr(provider.length + 1);
        }
        const isProvider = terraformSchemaType === "provider";
        if (isProvider) {
            baseName = `${provider}_${baseName}`;
            if (!("attributes" in schema.block)) {
                schema.block = { attributes: {}, block_types: {} };
            }
            // somehow missing from provider schema
            schema.block.attributes["alias"] = {
                type: "string",
                description: "Alias name",
                optional: true,
                computed: false,
            };
        }
        const className = uniqueClassName(codemaker_1.toPascalCase(baseName));
        // avoid naming collision - see https://github.com/hashicorp/terraform-cdk/issues/299
        const configStructName = uniqueClassName(`${className}Config`);
        const fileName = baseName === "index"
            ? "index-resource.ts"
            : `${codemaker_1.toSnakeCase(baseName).replace(/_/g, "-")}.ts`;
        const filePath = `providers/${codemaker_1.toSnakeCase(provider)}/${fileName}`;
        const attributes = this.renderAttributesForBlock(new models_1.Scope({
            name: baseName,
            isProvider,
            parent: isProvider
                ? undefined
                : new models_1.Scope({ name: provider, isProvider: true }),
        }), schema.block);
        const resourceModel = new models_1.ResourceModel({
            terraformType: type,
            baseName,
            fileName,
            filePath,
            className,
            schema,
            provider,
            attributes,
            terraformSchemaType,
            structs: this.structs,
            configStructName,
        });
        return resourceModel;
    }
    renderAttributeType(scope, attributeType) {
        const parent = scope[scope.length - 1];
        const level = scope.length;
        const isComputed = !!scope.find((e) => e.isComputed === true);
        const isOptional = parent.isOptional;
        const isRequired = parent.isRequired;
        if (typeof attributeType === "string") {
            switch (attributeType) {
                case "bool":
                    return new models_1.AttributeTypeModel("boolean", {
                        isComputed,
                        isOptional,
                        isRequired,
                        level,
                    });
                case "string":
                    return new models_1.AttributeTypeModel("string", {
                        isComputed,
                        isOptional,
                        isRequired,
                        level,
                    });
                case "number":
                    return new models_1.AttributeTypeModel("number", {
                        isComputed,
                        isOptional,
                        isRequired,
                        level,
                    });
                case "dynamic":
                    return new models_1.AttributeTypeModel("any", {
                        isComputed,
                        isOptional,
                        isRequired,
                        level,
                        isMap: true,
                    });
                default:
                    throw new Error(`invalid primitive type ${attributeType}`);
            }
        }
        if (Array.isArray(attributeType)) {
            if (attributeType.length !== 2) {
                throw new Error(`unexpected array`);
            }
            const [kind, type] = attributeType;
            if (kind === "set" || kind === "list") {
                const attrType = this.renderAttributeType(scope, type);
                attrType.isList = true;
                attrType.isComputed = isComputed;
                attrType.isOptional = isOptional;
                attrType.isRequired = isRequired;
                attrType.level = level;
                return attrType;
            }
            if (kind === "map") {
                const valueType = this.renderAttributeType(scope, type);
                valueType.isMap = true;
                valueType.isComputed = isComputed;
                valueType.isOptional = isOptional;
                valueType.isRequired = isRequired;
                valueType.level = level;
                return valueType;
            }
            if (kind === "object") {
                const objAttributes = type;
                const attributes = {};
                for (const [name, type] of Object.entries(objAttributes)) {
                    attributes[name] = { type };
                }
                const struct = this.addAnonymousStruct(scope, attributes);
                const model = new models_1.AttributeTypeModel(struct.name, {
                    struct,
                    isComputed,
                    isOptional,
                    isRequired,
                    level,
                });
                return model;
            }
        }
        throw new Error(`unknown type ${attributeType}`);
    }
    renderAttributesForBlock(parentType, block) {
        const attributes = new Array();
        for (const [terraformAttributeName, att] of Object.entries(block.attributes || {})) {
            if (parentType.inBlockType && att.computed && !!att.optional === false)
                continue;
            const type = this.renderAttributeType([
                parentType,
                new models_1.Scope({
                    name: terraformAttributeName,
                    parent: parentType,
                    isProvider: parentType.isProvider,
                    isComputed: !!att.computed,
                    isOptional: !!att.optional,
                    isRequired: !!att.required,
                }),
            ], att.type);
            const name = codemaker_1.toCamelCase(terraformAttributeName);
            attributes.push(new models_1.AttributeModel({
                terraformFullName: parentType.fullName(terraformAttributeName),
                description: att.description,
                name,
                storageName: `_${name}`,
                computed: !!att.computed,
                optional: !!att.optional,
                terraformName: terraformAttributeName,
                type,
                provider: parentType.isProvider,
                required: !!att.required,
            }));
        }
        for (const [blockTypeName, blockType] of Object.entries(block.block_types || {})) {
            // create a struct for this block
            const blockAttributes = this.renderAttributesForBlock(new models_1.Scope({
                name: `${parentType.name}_${blockTypeName}`,
                parent: parentType,
                isProvider: parentType.isProvider,
                inBlockType: true,
            }), blockType.block);
            const blockStruct = this.addStruct([
                parentType,
                new models_1.Scope({
                    name: blockTypeName,
                    parent: parentType,
                    isProvider: parentType.isProvider,
                }),
            ], blockAttributes, blockType.nesting_mode === "list" && blockType.max_items === 1);
            // define the attribute
            attributes.push(attributeForBlockType(blockTypeName, blockType, blockStruct, parentType.isProvider, parentType));
        }
        return attributes;
        function attributeForBlockType(terraformName, blockType, struct, isProvider, parent) {
            const name = codemaker_1.toCamelCase(terraformName);
            let optional;
            let required;
            switch (blockType.nesting_mode) {
                case "single":
                    optional = !struct.attributes.some((x) => !x.optional);
                    required = !struct.attributes.some((x) => !x.required);
                    return new models_1.AttributeModel({
                        name,
                        terraformName,
                        terraformFullName: parent.fullName(terraformName),
                        type: new models_1.AttributeTypeModel(struct.name, {
                            struct,
                            isOptional: optional,
                            isRequired: required,
                            isSingleItem: true,
                        }),
                        description: `${terraformName} block`,
                        storageName: `_${name}`,
                        optional,
                        computed: false,
                        provider: isProvider,
                        required,
                    });
                case "map":
                    return new models_1.AttributeModel({
                        name,
                        terraformName,
                        terraformFullName: parent.fullName(terraformName),
                        type: new models_1.AttributeTypeModel(struct.name, { struct, isMap: true }),
                        description: `${terraformName} block`,
                        storageName: `_${name}`,
                        optional: false,
                        computed: false,
                        provider: isProvider,
                        required: false,
                    });
                case "list":
                case "set":
                    optional =
                        blockType.min_items === undefined ? true : blockType.min_items < 1;
                    required =
                        blockType.min_items === undefined ? false : blockType.min_items > 0;
                    return new models_1.AttributeModel({
                        name,
                        terraformName: terraformName,
                        terraformFullName: parent.fullName(terraformName),
                        type: new models_1.AttributeTypeModel(struct.name, {
                            struct,
                            isList: true,
                            isOptional: optional,
                            isRequired: required,
                            isSingleItem: blockType.max_items === 1,
                        }),
                        description: `${terraformName} block`,
                        storageName: `_${name}`,
                        optional,
                        computed: false,
                        provider: isProvider,
                        required,
                    });
            }
        }
    }
    addAnonymousStruct(scope, attrs) {
        const attributes = new Array();
        const parent = scope[scope.length - 1];
        const computed = !!parent.isComputed;
        const optional = !!parent.isOptional;
        const required = !!parent.isRequired;
        for (const [terraformName, att] of Object.entries(attrs)) {
            const name = codemaker_1.toCamelCase(terraformName);
            attributes.push(new models_1.AttributeModel({
                name,
                storageName: `_${name}`,
                computed: computed,
                description: att.description,
                optional: optional,
                terraformName,
                terraformFullName: parent.fullName(terraformName),
                type: this.renderAttributeType([
                    ...scope,
                    new models_1.Scope({
                        name: terraformName,
                        parent,
                        isProvider: parent.isProvider,
                        isComputed: computed,
                        isOptional: optional,
                        isRequired: required,
                    }),
                ], att.type),
                provider: parent.isProvider,
                required: required,
            }));
        }
        return this.addStruct(scope, attributes);
    }
    addStruct(scope, attributes, isSingleItem = false) {
        const name = uniqueClassName(codemaker_1.toPascalCase(scope.map((x) => codemaker_1.toSnakeCase(x.name)).join("_")));
        const parent = scope[scope.length - 1];
        // blockType.nesting_mode => list/set & blockType.max_items === 1,
        const isClass = (parent.isComputed && !parent.isOptional) || isSingleItem;
        const isAnonymous = true;
        const s = new models_1.Struct(name, attributes, isClass, isAnonymous, isSingleItem);
        this.structs.push(s);
        return s;
    }
}
class ResourceParser {
    parse(provider, type, schema, terraformType) {
        const parser = new Parser();
        const resource = parser.resourceFrom(provider, type, schema, terraformType);
        return resource;
    }
}
exports.ResourceParser = ResourceParser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2UtcGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmVzb3VyY2UtcGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHlDQUFtRTtBQVFuRSxxQ0FNa0I7QUFFbEIsTUFBTSxVQUFVLEdBQWEsRUFBRSxDQUFDO0FBRWhDLE1BQU0sZUFBZSxHQUFHLENBQUMsU0FBaUIsRUFBVSxFQUFFO0lBQ3BELElBQUksVUFBVSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsRUFBRTtRQUNsQyxTQUFTLEdBQUcsR0FBRyxTQUFTLEdBQUcsQ0FBQztLQUM3QjtJQUNELFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDM0IsT0FBTyxTQUFTLENBQUM7QUFDbkIsQ0FBQyxDQUFDO0FBRUYsTUFBTSxNQUFNO0lBQVo7UUFDVSxZQUFPLEdBQUcsSUFBSSxLQUFLLEVBQVUsQ0FBQztJQXFYeEMsQ0FBQztJQW5YUSxZQUFZLENBQ2pCLFFBQWdCLEVBQ2hCLElBQVksRUFDWixNQUFjLEVBQ2QsbUJBQTJCO1FBRTNCLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQztRQUNwQixJQUFJLFFBQVEsQ0FBQyxVQUFVLENBQUMsR0FBRyxRQUFRLEdBQUcsQ0FBQyxFQUFFO1lBQ3ZDLFFBQVEsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDakQ7UUFFRCxNQUFNLFVBQVUsR0FBRyxtQkFBbUIsS0FBSyxVQUFVLENBQUM7UUFDdEQsSUFBSSxVQUFVLEVBQUU7WUFDZCxRQUFRLEdBQUcsR0FBRyxRQUFRLElBQUksUUFBUSxFQUFFLENBQUM7WUFDckMsSUFBSSxDQUFDLENBQUMsWUFBWSxJQUFJLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDbkMsTUFBTSxDQUFDLEtBQUssR0FBRyxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFB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RyxlQUFlLENBQzFCLHdCQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsdUJBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDOUQsQ0FBQztRQUNGLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3ZDLGtFQUFrRTtRQUNsRSxNQUFNLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxVQUFVLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksWUFBWSxDQUFDO1FBQzFFLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQztRQUN6QixNQUFNLENBQUMsR0FBRyxJQUFJLGVBQU0sQ0FBQyxJQUFJLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDM0UsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDckIsT0FBTyxDQUFDLENBQUM7SUFDWCxDQUFDO0NBQ0Y7QUFFRCxNQUFhLGNBQWM7SUFDbEIsS0FBSyxDQUNWLFFBQWdCLEVBQ2hCLElBQVksRUFDWixNQUFjLEVBQ2QsYUFBcUI7UUFFckIsTUFBTSxNQUFNLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUM1QixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQzVFLE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7Q0FDRjtBQVhELHdDQVdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdG9DYW1lbENhc2UsIHRvUGFzY2FsQ2FzZSwgdG9TbmFrZUNhc2UgfSBmcm9tIFwiY29kZW1ha2VyXCI7XG5pbXBvcnQge1xuICBBdHRyaWJ1dGUsXG4gIEF0dHJpYnV0ZVR5cGUsXG4gIEJsb2NrLFxuICBCbG9ja1R5cGUsXG4gIFNjaGVtYSxcbn0gZnJvbSBcIi4vcHJvdmlkZXItc2NoZW1hXCI7XG5pbXBvcnQge1xuICBSZXNvdXJjZU1vZGVsLFxuICBBdHRyaWJ1dGVUeXBlTW9kZWwsXG4gIFN0cnVjdCxcbiAgU2NvcGUsXG4gIEF0dHJpYnV0ZU1vZGVsLFxufSBmcm9tIFwiLi9tb2RlbHNcIjtcblxuY29uc3QgY2xhc3NOYW1lczogc3RyaW5nW10gPSBbXTtcblxuY29uc3QgdW5pcXVlQ2xhc3NOYW1lID0gKGNsYXNzTmFtZTogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgaWYgKGNsYXNzTmFtZXMuaW5jbHVkZXMoY2xhc3NOYW1lKSkge1xuICAgIGNsYXNzTmFtZSA9IGAke2NsYXNzTmFtZX1BYDtcbiAgfVxuICBjbGFzc05hbWVzLnB1c2goY2xhc3NOYW1lKTtcbiAgcmV0dXJuIGNsYXNzTmFtZTtcbn07XG5cbmNsYXNzIFBhcnNlciB7XG4gIHByaXZhdGUgc3RydWN0cyA9IG5ldyBBcnJheTxTdHJ1Y3Q+KCk7XG5cbiAgcHVibGljIHJlc291cmNlRnJvbShcbiAgICBwcm92aWRlcjogc3RyaW5nLFxuICAgIHR5cGU6IHN0cmluZyxcbiAgICBzY2hlbWE6IFNjaGVtYSxcbiAgICB0ZXJyYWZvcm1TY2hlbWFUeXBlOiBzdHJpbmdcbiAgKTogUmVzb3VyY2VNb2RlbCB7XG4gICAgbGV0IGJhc2VOYW1lID0gdHlwZTtcbiAgICBpZiAoYmFzZU5hbWUuc3RhcnRzV2l0aChgJHtwcm92aWRlcn1fYCkpIHtcbiAgICAgIGJhc2VOYW1lID0gYmFzZU5hbWUuc3Vic3RyKHByb3ZpZGVyLmxlbmd0aCArIDEpO1xuICAgIH1cblxuICAgIGNvbnN0IGlzUHJvdmlkZXIgPSB0ZXJyYWZvcm1TY2hlbWFUeXBlID09PSBcInByb3ZpZGVyXCI7XG4gICAgaWYgKGlzUHJvdmlkZXIpIHtcbiAgICAgIGJhc2VOYW1lID0gYCR7cHJvdmlkZXJ9XyR7YmFzZU5hbWV9YDtcbiAgICAgIGlmICghKFwiYXR0cmlidXRlc1wiIGluIHNjaGVtYS5ibG9jaykpIHtcbiAgICAgICAgc2NoZW1hLmJsb2NrID0geyBhdHRyaWJ1dGVzOiB7fSwgYmxvY2tfdHlwZXM6IHt9IH07XG4gICAgICB9XG4gICAgICAvLyBzb21laG93IG1pc3NpbmcgZnJvbSBwcm92aWRlciBzY2hlbWFcbiAgICAgIHNjaGVtYS5ibG9jay5hdHRyaWJ1dGVzW1wiYWxpYXNcIl0gPSB7XG4gICAgICAgIHR5cGU6IFwic3RyaW5nXCIsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBcIkFsaWFzIG5hbWVcIixcbiAgICAgICAgb3B0aW9uYWw6IHRydWUsXG4gICAgICAgIGNvbXB1dGVkOiBmYWxzZSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgY2xhc3NOYW1lID0gdW5pcXVlQ2xhc3NOYW1lKHRvUGFzY2FsQ2FzZShiYXNlTmFtZSkpO1xuICAgIC8vIGF2b2lkIG5hbWluZyBjb2xsaXNpb24gLSBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2hhc2hpY29ycC90ZXJyYWZvcm0tY2RrL2lzc3Vlcy8yOTlcbiAgICBjb25zdCBjb25maWdTdHJ1Y3ROYW1lID0gdW5pcXVlQ2xhc3NOYW1lKGAke2NsYXNzTmFtZX1Db25maWdgKTtcbiAgICBjb25zdCBmaWxlTmFtZSA9XG4gICAgICBiYXNlTmFtZSA9PT0gXCJpbmRleFwiXG4gICAgICAgID8gXCJpbmRleC1yZXNvdXJjZS50c1wiXG4gICAgICAgIDogYCR7dG9TbmFrZUNhc2UoYmFzZU5hbWUpLnJlcGxhY2UoL18vZywgXCItXCIpfS50c2A7XG4gICAgY29uc3QgZmlsZVBhdGggPSBgcHJvdmlkZXJzLyR7dG9TbmFrZUNhc2UocHJvdmlkZXIpfS8ke2ZpbGVOYW1lfWA7XG4gICAgY29uc3QgYXR0cmlidXRlcyA9IHRoaXMucmVuZGVyQXR0cmlidXRlc0ZvckJsb2NrKFxuICAgICAgbmV3IFNjb3BlKHtcbiAgICAgICAgbmFtZTogYmFzZU5hbWUsXG4gICAgICAgIGlzUHJvdmlkZXIsXG4gICAgICAgIHBhcmVudDogaXNQcm92aWRlclxuICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgOiBuZXcgU2NvcGUoeyBuYW1lOiBwcm92aWRlciwgaXNQcm92aWRlcjogdHJ1ZSB9KSxcbiAgICAgIH0pLFxuICAgICAgc2NoZW1hLmJsb2NrXG4gICAgKTtcblxuICAgIGNvbnN0IHJlc291cmNlTW9kZWwgPSBuZXcgUmVzb3VyY2VNb2RlbCh7XG4gICAgICB0ZXJyYWZvcm1UeXBlOiB0eXBlLFxuICAgICAgYmFzZU5hbWUsXG4gICAgICBmaWxlTmFtZSxcbiAgICAgIGZpbGVQYXRoLFxuICAgICAgY2xhc3NOYW1lLFxuICAgICAgc2NoZW1hLFxuICAgICAgcHJvdmlkZXIsXG4gICAgICBhdHRyaWJ1dGVzLFxuICAgICAgdGVycmFmb3JtU2NoZW1hVHlwZSxcbiAgICAgIHN0cnVjdHM6IHRoaXMuc3RydWN0cyxcbiAgICAgIGNvbmZpZ1N0cnVjdE5hbWUsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gcmVzb3VyY2VNb2RlbDtcbiAgfVxuXG4gIHByaXZhdGUgcmVuZGVyQXR0cmlidXRlVHlwZShcbiAgICBzY29wZTogU2NvcGVbXSxcbiAgICBhdHRyaWJ1dGVUeXBlOiBBdHRyaWJ1dGVUeXBlXG4gICk6IEF0dHJpYnV0ZVR5cGVNb2RlbCB7XG4gICAgY29uc3QgcGFyZW50ID0gc2NvcGVbc2NvcGUubGVuZ3RoIC0gMV07XG4gICAgY29uc3QgbGV2ZWwgPSBzY29wZS5sZW5ndGg7XG4gICAgY29uc3QgaXNDb21wdXRlZCA9ICEhc2NvcGUuZmluZCgoZSkgPT4gZS5pc0NvbXB1dGVkID09PSB0cnVlKTtcbiAgICBjb25zdCBpc09wdGlvbmFsID0gcGFyZW50LmlzT3B0aW9uYWw7XG4gICAgY29uc3QgaXNSZXF1aXJlZCA9IHBhcmVudC5pc1JlcXVpcmVkO1xuXG4gICAgaWYgKHR5cGVvZiBhdHRyaWJ1dGVUeXBlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBzd2l0Y2ggKGF0dHJpYnV0ZVR5cGUpIHtcbiAgICAgICAgY2FzZSBcImJvb2xcIjpcbiAgICAgICAgICByZXR1cm4gbmV3IEF0dHJpYnV0ZVR5cGVNb2RlbChcImJvb2xlYW5cIiwge1xuICAgICAgICAgICAgaXNDb21wdXRlZCxcbiAgICAgICAgICAgIGlzT3B0aW9uYWwsXG4gICAgICAgICAgICBpc1JlcXVpcmVkLFxuICAgICAgICAgICAgbGV2ZWwsXG4gICAgICAgICAgfSk7XG4gICAgICAgIGNhc2UgXCJzdHJpbmdcIjpcbiAgICAgICAgICByZXR1cm4gbmV3IEF0dHJpYnV0ZVR5cGVNb2RlbChcInN0cmluZ1wiLCB7XG4gICAgICAgICAgICBpc0NvbXB1dGVkLFxuICAgICAgICAgICAgaXNPcHRpb25hbCxcbiAgICAgICAgICAgIGlzUmVxdWlyZWQsXG4gICAgICAgICAgICBsZXZlbCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgY2FzZSBcIm51bWJlclwiOlxuICAgICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlVHlwZU1vZGVsKFwibnVtYmVyXCIsIHtcbiAgICAgICAgICAgIGlzQ29tcHV0ZWQsXG4gICAgICAgICAgICBpc09wdGlvbmFsLFxuICAgICAgICAgICAgaXNSZXF1aXJlZCxcbiAgICAgICAgICAgIGxldmVsLFxuICAgICAgICAgIH0pO1xuICAgICAgICBjYXNlIFwiZHluYW1pY1wiOlxuICAgICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlVHlwZU1vZGVsKFwiYW55XCIsIHtcbiAgICAgICAgICAgIGlzQ29tcHV0ZWQsXG4gICAgICAgICAgICBpc09wdGlvbmFsLFxuICAgICAgICAgICAgaXNSZXF1aXJlZCxcbiAgICAgICAgICAgIGxldmVsLFxuICAgICAgICAgICAgaXNNYXA6IHRydWUsXG4gICAgICAgICAgfSk7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBpbnZhbGlkIHByaW1pdGl2ZSB0eXBlICR7YXR0cmlidXRlVHlwZX1gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoQXJyYXkuaXNBcnJheShhdHRyaWJ1dGVUeXBlKSkge1xuICAgICAgaWYgKGF0dHJpYnV0ZVR5cGUubGVuZ3RoICE9PSAyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgdW5leHBlY3RlZCBhcnJheWApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBba2luZCwgdHlwZV0gPSBhdHRyaWJ1dGVUeXBlO1xuXG4gICAgICBpZiAoa2luZCA9PT0gXCJzZXRcIiB8fCBraW5kID09PSBcImxpc3RcIikge1xuICAgICAgICBjb25zdCBhdHRyVHlwZSA9IHRoaXMucmVuZGVyQXR0cmlidXRlVHlwZShzY29wZSwgdHlwZSBhcyBBdHRyaWJ1dGVUeXBlKTtcbiAgICAgICAgYXR0clR5cGUuaXNMaXN0ID0gdHJ1ZTtcbiAgICAgICAgYXR0clR5cGUuaXNDb21wdXRlZCA9IGlzQ29tcHV0ZWQ7XG4gICAgICAgIGF0dHJUeXBlLmlzT3B0aW9uYWwgPSBpc09wdGlvbmFsO1xuICAgICAgICBhdHRyVHlwZS5pc1JlcXVpcmVkID0gaXNSZXF1aXJlZDtcbiAgICAgICAgYXR0clR5cGUubGV2ZWwgPSBsZXZlbDtcbiAgICAgICAgcmV0dXJuIGF0dHJUeXBlO1xuICAgICAgfVxuXG4gICAgICBpZiAoa2luZCA9PT0gXCJtYXBcIikge1xuICAgICAgICBjb25zdCB2YWx1ZVR5cGUgPSB0aGlzLnJlbmRlckF0dHJpYnV0ZVR5cGUoXG4gICAgICAgICAgc2NvcGUsXG4gICAgICAgICAgdHlwZSBhcyBBdHRyaWJ1dGVUeXBlXG4gICAgICAgICk7XG4gICAgICAgIHZhbHVlVHlwZS5pc01hcCA9IHRydWU7XG4gICAgICAgIHZhbHVlVHlwZS5pc0NvbXB1dGVkID0gaXNDb21wdXRlZDtcbiAgICAgICAgdmFsdWVUeXBlLmlzT3B0aW9uYWwgPSBpc09wdGlvbmFsO1xuICAgICAgICB2YWx1ZVR5cGUuaXNSZXF1aXJlZCA9IGlzUmVxdWlyZWQ7XG4gICAgICAgIHZhbHVlVHlwZS5sZXZlbCA9IGxldmVsO1xuICAgICAgICByZXR1cm4gdmFsdWVUeXBlO1xuICAgICAgfVxuXG4gICAgICBpZiAoa2luZCA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICBjb25zdCBvYmpBdHRyaWJ1dGVzID0gdHlwZSBhcyB7IFtuYW1lOiBzdHJpbmddOiBBdHRyaWJ1dGVUeXBlIH07XG4gICAgICAgIGNvbnN0IGF0dHJpYnV0ZXM6IHsgW25hbWU6IHN0cmluZ106IEF0dHJpYnV0ZSB9ID0ge307XG4gICAgICAgIGZvciAoY29uc3QgW25hbWUsIHR5cGVdIG9mIE9iamVjdC5lbnRyaWVzKG9iakF0dHJpYnV0ZXMpKSB7XG4gICAgICAgICAgYXR0cmlidXRlc1tuYW1lXSA9IHsgdHlwZSB9O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHN0cnVjdCA9IHRoaXMuYWRkQW5vbnltb3VzU3RydWN0KHNjb3BlLCBhdHRyaWJ1dGVzKTtcbiAgICAgICAgY29uc3QgbW9kZWwgPSBuZXcgQXR0cmlidXRlVHlwZU1vZGVsKHN0cnVjdC5uYW1lLCB7XG4gICAgICAgICAgc3RydWN0LFxuICAgICAgICAgIGlzQ29tcHV0ZWQsXG4gICAgICAgICAgaXNPcHRpb25hbCxcbiAgICAgICAgICBpc1JlcXVpcmVkLFxuICAgICAgICAgIGxldmVsLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG1vZGVsO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRocm93IG5ldyBFcnJvcihgdW5rbm93biB0eXBlICR7YXR0cmlidXRlVHlwZX1gKTtcbiAgfVxuXG4gIHB1YmxpYyByZW5kZXJBdHRyaWJ1dGVzRm9yQmxvY2socGFyZW50VHlwZTogU2NvcGUsIGJsb2NrOiBCbG9jaykge1xuICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgQXJyYXk8QXR0cmlidXRlTW9kZWw+KCk7XG5cbiAgICBmb3IgKGNvbnN0IFt0ZXJyYWZvcm1BdHRyaWJ1dGVOYW1lLCBhdHRdIG9mIE9iamVjdC5lbnRyaWVzKFxuICAgICAgYmxvY2suYXR0cmlidXRlcyB8fCB7fVxuICAgICkpIHtcbiAgICAgIGlmIChwYXJlbnRUeXBlLmluQmxvY2tUeXBlICYmIGF0dC5jb21wdXRlZCAmJiAhIWF0dC5vcHRpb25hbCA9PT0gZmFsc2UpXG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgY29uc3QgdHlwZSA9IHRoaXMucmVuZGVyQXR0cmlidXRlVHlwZShcbiAgICAgICAgW1xuICAgICAgICAgIHBhcmVudFR5cGUsXG4gICAgICAgICAgbmV3IFNjb3BlKHtcbiAgICAgICAgICAgIG5hbWU6IHRlcnJhZm9ybUF0dHJpYnV0ZU5hbWUsXG4gICAgICAgICAgICBwYXJlbnQ6IHBhcmVudFR5cGUsXG4gICAgICAgICAgICBpc1Byb3ZpZGVyOiBwYXJlbnRUeXBlLmlzUHJvdmlkZXIsXG4gICAgICAgICAgICBpc0NvbXB1dGVkOiAhIWF0dC5jb21wdXRlZCxcbiAgICAgICAgICAgIGlzT3B0aW9uYWw6ICEhYXR0Lm9wdGlvbmFsLFxuICAgICAgICAgICAgaXNSZXF1aXJlZDogISFhdHQucmVxdWlyZWQsXG4gICAgICAgICAgfSksXG4gICAgICAgIF0sXG4gICAgICAgIGF0dC50eXBlXG4gICAgICApO1xuICAgICAgY29uc3QgbmFtZSA9IHRvQ2FtZWxDYXNlKHRlcnJhZm9ybUF0dHJpYnV0ZU5hbWUpO1xuXG4gICAgICBhdHRyaWJ1dGVzLnB1c2goXG4gICAgICAgIG5ldyBBdHRyaWJ1dGVNb2RlbCh7XG4gICAgICAgICAgdGVycmFmb3JtRnVsbE5hbWU6IHBhcmVudFR5cGUuZnVsbE5hbWUodGVycmFmb3JtQXR0cmlidXRlTmFtZSksXG4gICAgICAgICAgZGVzY3JpcHRpb246IGF0dC5kZXNjcmlwdGlvbixcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIHN0b3JhZ2VOYW1lOiBgXyR7bmFtZX1gLFxuICAgICAgICAgIGNvbXB1dGVkOiAhIWF0dC5jb21wdXRlZCxcbiAgICAgICAgICBvcHRpb25hbDogISFhdHQub3B0aW9uYWwsXG4gICAgICAgICAgdGVycmFmb3JtTmFtZTogdGVycmFmb3JtQXR0cmlidXRlTmFtZSxcbiAgICAgICAgICB0eXBlLFxuICAgICAgICAgIHByb3ZpZGVyOiBwYXJlbnRUeXBlLmlzUHJvdmlkZXIsXG4gICAgICAgICAgcmVxdWlyZWQ6ICEhYXR0LnJlcXVpcmVkLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IFtibG9ja1R5cGVOYW1lLCBibG9ja1R5cGVdIG9mIE9iamVjdC5lbnRyaWVzKFxuICAgICAgYmxvY2suYmxvY2tfdHlwZXMgfHwge31cbiAgICApKSB7XG4gICAgICAvLyBjcmVhdGUgYSBzdHJ1Y3QgZm9yIHRoaXMgYmxvY2tcbiAgICAgIGNvbnN0IGJsb2NrQXR0cmlidXRlcyA9IHRoaXMucmVuZGVyQXR0cmlidXRlc0ZvckJsb2NrKFxuICAgICAgICBuZXcgU2NvcGUoe1xuICAgICAgICAgIG5hbWU6IGAke3BhcmVudFR5cGUubmFtZX1fJHtibG9ja1R5cGVOYW1lfWAsXG4gICAgICAgICAgcGFyZW50OiBwYXJlbnRUeXBlLFxuICAgICAgICAgIGlzUHJvdmlkZXI6IHBhcmVudFR5cGUuaXNQcm92aWRlcixcbiAgICAgICAgICBpbkJsb2NrVHlwZTogdHJ1ZSxcbiAgICAgICAgfSksXG4gICAgICAgIGJsb2NrVHlwZS5ibG9ja1xuICAgICAgKTtcbiAgICAgIGNvbnN0IGJsb2NrU3RydWN0ID0gdGhpcy5hZGRTdHJ1Y3QoXG4gICAgICAgIFtcbiAgICAgICAgICBwYXJlbnRUeXBlLFxuICAgICAgICAgIG5ldyBTY29wZSh7XG4gICAgICAgICAgICBuYW1lOiBibG9ja1R5cGVOYW1lLFxuICAgICAgICAgICAgcGFyZW50OiBwYXJlbnRUeXBlLFxuICAgICAgICAgICAgaXNQcm92aWRlcjogcGFyZW50VHlwZS5pc1Byb3ZpZGVyLFxuICAgICAgICAgIH0pLFxuICAgICAgICBdLFxuICAgICAgICBibG9ja0F0dHJpYnV0ZXMsXG4gICAgICAgIGJsb2NrVHlwZS5uZXN0aW5nX21vZGUgPT09IFwibGlzdFwiICYmIGJsb2NrVHlwZS5tYXhfaXRlbXMgPT09IDFcbiAgICAgICk7XG5cbiAgICAgIC8vIGRlZmluZSB0aGUgYXR0cmlidXRlXG4gICAgICBhdHRyaWJ1dGVzLnB1c2goXG4gICAgICAgIGF0dHJpYnV0ZUZvckJsb2NrVHlwZShcbiAgICAgICAgICBibG9ja1R5cGVOYW1lLFxuICAgICAgICAgIGJsb2NrVHlwZSxcbiAgICAgICAgICBibG9ja1N0cnVjdCxcbiAgICAgICAgICBwYXJlbnRUeXBlLmlzUHJvdmlkZXIsXG4gICAgICAgICAgcGFyZW50VHlwZVxuICAgICAgICApXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBhdHRyaWJ1dGVzO1xuXG4gICAgZnVuY3Rpb24gYXR0cmlidXRlRm9yQmxvY2tUeXBlKFxuICAgICAgdGVycmFmb3JtTmFtZTogc3RyaW5nLFxuICAgICAgYmxvY2tUeXBlOiBCbG9ja1R5cGUsXG4gICAgICBzdHJ1Y3Q6IFN0cnVjdCxcbiAgICAgIGlzUHJvdmlkZXI6IGJvb2xlYW4sXG4gICAgICBwYXJlbnQ6IFNjb3BlXG4gICAgKTogQXR0cmlidXRlTW9kZWwge1xuICAgICAgY29uc3QgbmFtZSA9IHRvQ2FtZWxDYXNlKHRlcnJhZm9ybU5hbWUpO1xuICAgICAgbGV0IG9wdGlvbmFsOiBib29sZWFuO1xuICAgICAgbGV0IHJlcXVpcmVkOiBib29sZWFuO1xuICAgICAgc3dpdGNoIChibG9ja1R5cGUubmVzdGluZ19tb2RlKSB7XG4gICAgICAgIGNhc2UgXCJzaW5nbGVcIjpcbiAgICAgICAgICBvcHRpb25hbCA9ICFzdHJ1Y3QuYXR0cmlidXRlcy5zb21lKCh4KSA9PiAheC5vcHRpb25hbCk7XG4gICAgICAgICAgcmVxdWlyZWQgPSAhc3RydWN0LmF0dHJpYnV0ZXMuc29tZSgoeCkgPT4gIXgucmVxdWlyZWQpO1xuICAgICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlTW9kZWwoe1xuICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgIHRlcnJhZm9ybU5hbWUsXG4gICAgICAgICAgICB0ZXJyYWZvcm1GdWxsTmFtZTogcGFyZW50LmZ1bGxOYW1lKHRlcnJhZm9ybU5hbWUpLFxuICAgICAgICAgICAgdHlwZTogbmV3IEF0dHJpYnV0ZVR5cGVNb2RlbChzdHJ1Y3QubmFtZSwge1xuICAgICAgICAgICAgICBzdHJ1Y3QsXG4gICAgICAgICAgICAgIGlzT3B0aW9uYWw6IG9wdGlvbmFsLFxuICAgICAgICAgICAgICBpc1JlcXVpcmVkOiByZXF1aXJlZCxcbiAgICAgICAgICAgICAgaXNTaW5nbGVJdGVtOiB0cnVlLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogYCR7dGVycmFmb3JtTmFtZX0gYmxvY2tgLFxuICAgICAgICAgICAgc3RvcmFnZU5hbWU6IGBfJHtuYW1lfWAsXG4gICAgICAgICAgICBvcHRpb25hbCxcbiAgICAgICAgICAgIGNvbXB1dGVkOiBmYWxzZSxcbiAgICAgICAgICAgIHByb3ZpZGVyOiBpc1Byb3ZpZGVyLFxuICAgICAgICAgICAgcmVxdWlyZWQsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgY2FzZSBcIm1hcFwiOlxuICAgICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlTW9kZWwoe1xuICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgIHRlcnJhZm9ybU5hbWUsXG4gICAgICAgICAgICB0ZXJyYWZvcm1GdWxsTmFtZTogcGFyZW50LmZ1bGxOYW1lKHRlcnJhZm9ybU5hbWUpLFxuICAgICAgICAgICAgdHlwZTogbmV3IEF0dHJpYnV0ZVR5cGVNb2RlbChzdHJ1Y3QubmFtZSwgeyBzdHJ1Y3QsIGlzTWFwOiB0cnVlIH0pLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGAke3RlcnJhZm9ybU5hbWV9IGJsb2NrYCxcbiAgICAgICAgICAgIHN0b3JhZ2VOYW1lOiBgXyR7bmFtZX1gLFxuICAgICAgICAgICAgb3B0aW9uYWw6IGZhbHNlLFxuICAgICAgICAgICAgY29tcHV0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgcHJvdmlkZXI6IGlzUHJvdmlkZXIsXG4gICAgICAgICAgICByZXF1aXJlZDogZmFsc2UsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgY2FzZSBcImxpc3RcIjpcbiAgICAgICAgY2FzZSBcInNldFwiOlxuICAgICAgICAgIG9wdGlvbmFsID1cbiAgICAgICAgICAgIGJsb2NrVHlwZS5taW5faXRlbXMgPT09IHVuZGVmaW5lZCA/IHRydWUgOiBibG9ja1R5cGUubWluX2l0ZW1zIDwgMTtcbiAgICAgICAgICByZXF1aXJlZCA9XG4gICAgICAgICAgICBibG9ja1R5cGUubWluX2l0ZW1zID09PSB1bmRlZmluZWQgPyBmYWxzZSA6IGJsb2NrVHlwZS5taW5faXRlbXMgPiAwO1xuICAgICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlTW9kZWwoe1xuICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgIHRlcnJhZm9ybU5hbWU6IHRlcnJhZm9ybU5hbWUsXG4gICAgICAgICAgICB0ZXJyYWZvcm1GdWxsTmFtZTogcGFyZW50LmZ1bGxOYW1lKHRlcnJhZm9ybU5hbWUpLFxuICAgICAgICAgICAgdHlwZTogbmV3IEF0dHJpYnV0ZVR5cGVNb2RlbChzdHJ1Y3QubmFtZSwge1xuICAgICAgICAgICAgICBzdHJ1Y3QsXG4gICAgICAgICAgICAgIGlzTGlzdDogdHJ1ZSxcbiAgICAgICAgICAgICAgaXNPcHRpb25hbDogb3B0aW9uYWwsXG4gICAgICAgICAgICAgIGlzUmVxdWlyZWQ6IHJlcXVpcmVkLFxuICAgICAgICAgICAgICBpc1NpbmdsZUl0ZW06IGJsb2NrVHlwZS5tYXhfaXRlbXMgPT09IDEsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBgJHt0ZXJyYWZvcm1OYW1lfSBibG9ja2AsXG4gICAgICAgICAgICBzdG9yYWdlTmFtZTogYF8ke25hbWV9YCxcbiAgICAgICAgICAgIG9wdGlvbmFsLFxuICAgICAgICAgICAgY29tcHV0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgcHJvdmlkZXI6IGlzUHJvdmlkZXIsXG4gICAgICAgICAgICByZXF1aXJlZCxcbiAgICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSBhZGRBbm9ueW1vdXNTdHJ1Y3QoXG4gICAgc2NvcGU6IFNjb3BlW10sXG4gICAgYXR0cnM6IHsgW25hbWU6IHN0cmluZ106IEF0dHJpYnV0ZSB9XG4gICkge1xuICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgQXJyYXk8QXR0cmlidXRlTW9kZWw+KCk7XG4gICAgY29uc3QgcGFyZW50ID0gc2NvcGVbc2NvcGUubGVuZ3RoIC0gMV07XG4gICAgY29uc3QgY29tcHV0ZWQgPSAhIXBhcmVudC5pc0NvbXB1dGVkO1xuICAgIGNvbnN0IG9wdGlvbmFsID0gISFwYXJlbnQuaXNPcHRpb25hbDtcbiAgICBjb25zdCByZXF1aXJlZCA9ICEhcGFyZW50LmlzUmVxdWlyZWQ7XG4gICAgZm9yIChjb25zdCBbdGVycmFmb3JtTmFtZSwgYXR0XSBvZiBPYmplY3QuZW50cmllcyhhdHRycykpIHtcbiAgICAgIGNvbnN0IG5hbWUgPSB0b0NhbWVsQ2FzZSh0ZXJyYWZvcm1OYW1lKTtcbiAgICAgIGF0dHJpYnV0ZXMucHVzaChcbiAgICAgICAgbmV3IEF0dHJpYnV0ZU1vZGVsKHtcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIHN0b3JhZ2VOYW1lOiBgXyR7bmFtZX1gLFxuICAgICAgICAgIGNvbXB1dGVkOiBjb21wdXRlZCxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogYXR0LmRlc2NyaXB0aW9uLFxuICAgICAgICAgIG9wdGlvbmFsOiBvcHRpb25hbCxcbiAgICAgICAgICB0ZXJyYWZvcm1OYW1lLFxuICAgICAgICAgIHRlcnJhZm9ybUZ1bGxOYW1lOiBwYXJlbnQuZnVsbE5hbWUodGVycmFmb3JtTmFtZSksXG4gICAgICAgICAgdHlwZTogdGhpcy5yZW5kZXJBdHRyaWJ1dGVUeXBlKFxuICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAuLi5zY29wZSxcbiAgICAgICAgICAgICAgbmV3IFNjb3BlKHtcbiAgICAgICAgICAgICAgICBuYW1lOiB0ZXJyYWZvcm1OYW1lLFxuICAgICAgICAgICAgICAgIHBhcmVudCxcbiAgICAgICAgICAgICAgICBpc1Byb3ZpZGVyOiBwYXJlbnQuaXNQcm92aWRlcixcbiAgICAgICAgICAgICAgICBpc0NvbXB1dGVkOiBjb21wdXRlZCxcbiAgICAgICAgICAgICAgICBpc09wdGlvbmFsOiBvcHRpb25hbCxcbiAgICAgICAgICAgICAgICBpc1JlcXVpcmVkOiByZXF1aXJlZCxcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgYXR0LnR5cGVcbiAgICAgICAgICApLFxuICAgICAgICAgIHByb3ZpZGVyOiBwYXJlbnQuaXNQcm92aWRlcixcbiAgICAgICAgICByZXF1aXJlZDogcmVxdWlyZWQsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmFkZFN0cnVjdChzY29wZSwgYXR0cmlidXRlcyk7XG4gIH1cblxuICBwcml2YXRlIGFkZFN0cnVjdChcbiAgICBzY29wZTogU2NvcGVbXSxcbiAgICBhdHRyaWJ1dGVzOiBBdHRyaWJ1dGVNb2RlbFtdLFxuICAgIGlzU2luZ2xlSXRlbSA9IGZhbHNlXG4gICkge1xuICAgIGNvbnN0IG5hbWUgPSB1bmlxdWVDbGFzc05hbWUoXG4gICAgICB0b1Bhc2NhbENhc2Uoc2NvcGUubWFwKCh4KSA9PiB0b1NuYWtlQ2FzZSh4Lm5hbWUpKS5qb2luKFwiX1wiKSlcbiAgICApO1xuICAgIGNvbnN0IHBhcmVudCA9IHNjb3BlW3Njb3BlLmxlbmd0aCAtIDFdO1xuICAgIC8vIGJsb2NrVHlwZS5uZXN0aW5nX21vZGUgPT4gbGlzdC9zZXQgJiBibG9ja1R5cGUubWF4X2l0ZW1zID09PSAxLFxuICAgIGNvbnN0IGlzQ2xhc3MgPSAocGFyZW50LmlzQ29tcHV0ZWQgJiYgIXBhcmVudC5pc09wdGlvbmFsKSB8fCBpc1NpbmdsZUl0ZW07XG4gICAgY29uc3QgaXNBbm9ueW1vdXMgPSB0cnVlO1xuICAgIGNvbnN0IHMgPSBuZXcgU3RydWN0KG5hbWUsIGF0dHJpYnV0ZXMsIGlzQ2xhc3MsIGlzQW5vbnltb3VzLCBpc1NpbmdsZUl0ZW0pO1xuICAgIHRoaXMuc3RydWN0cy5wdXNoKHMpO1xuICAgIHJldHVybiBzO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSZXNvdXJjZVBhcnNlciB7XG4gIHB1YmxpYyBwYXJzZShcbiAgICBwcm92aWRlcjogc3RyaW5nLFxuICAgIHR5cGU6IHN0cmluZyxcbiAgICBzY2hlbWE6IFNjaGVtYSxcbiAgICB0ZXJyYWZvcm1UeXBlOiBzdHJpbmdcbiAgKTogUmVzb3VyY2VNb2RlbCB7XG4gICAgY29uc3QgcGFyc2VyID0gbmV3IFBhcnNlcigpO1xuICAgIGNvbnN0IHJlc291cmNlID0gcGFyc2VyLnJlc291cmNlRnJvbShwcm92aWRlciwgdHlwZSwgc2NoZW1hLCB0ZXJyYWZvcm1UeXBlKTtcbiAgICByZXR1cm4gcmVzb3VyY2U7XG4gIH1cbn1cbiJdfQ==
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.StructEmitter = void 0;
const models_1 = require("../models");
const attributes_emitter_1 = require("./attributes-emitter");
const util_1 = require("../../../util");
const path = __importStar(require("path"));
const resource_model_1 = require("../models/resource-model");
class StructEmitter {
    constructor(code) {
        this.code = code;
        this.attributesEmitter = new attributes_emitter_1.AttributesEmitter(this.code);
    }
    emit(resource) {
        if (resource.structsRequireSharding) {
            this.emitNamespacedStructs(resource);
        }
        else {
            this.emitStructs(resource);
        }
    }
    emitInterface(resource, struct, name = struct.name) {
        if (resource.isProvider) {
            this.code.openBlock(`export interface ${name}`);
        }
        else {
            this.code.openBlock(`export interface ${name}${struct.extends}`);
        }
        for (const att of struct.assignableAttributes) {
            if (att.description) {
                this.code.line(`/**`);
                this.code.line(`* ${att.description}`);
                this.code.line(`* `);
                this.code.line(`* Docs at Terraform Registry: {@link ${resource.linkToDocs}#${att.terraformName} ${resource.className}#${att.terraformName}}`);
                this.code.line(`*/`);
            }
            else {
                this.code.line(`/**`);
                this.code.line(`* Docs at Terraform Registry: {@link ${resource.linkToDocs}#${att.terraformName} ${resource.className}#${att.terraformName}}`);
                this.code.line(`*/`);
            }
            this.code.line(`readonly ${att.typeDefinition};`);
        }
        this.code.closeBlock();
        if (!(struct instanceof models_1.ConfigStruct)) {
            this.emitToTerraformFunction(struct);
        }
    }
    emitStructs(resource) {
        resource.structs.forEach((struct) => {
            if (struct.isSingleItem) {
                // We use the interface here for the configuration / inputs of a resource / nested block
                this.emitInterface(resource, struct);
                // And we use the class for the attributes / outputs of a resource / nested block
                if (!struct.isProvider) {
                    this.emitClass(struct, struct.outputReferenceName);
                }
            }
            else if (struct.isClass) {
                this.emitClass(struct);
            }
            else {
                this.emitInterface(resource, struct);
            }
        });
    }
    emitNamespacedStructs(resource) {
        // iterate over all structs in batches of 400 to avoid too many exports (> 1200)
        const structImports = {};
        // drop configStruct from resource.structs to avoid double import
        const structsWithoutConfigStruct = resource.structs.slice(1);
        const structPaths = [];
        for (let i = 0; i < structsWithoutConfigStruct.length; i += resource_model_1.STRUCT_SHARDING_THRESHOLD) {
            const structsToImport = {};
            const structs = structsWithoutConfigStruct.slice(i, i + resource_model_1.STRUCT_SHARDING_THRESHOLD);
            const structFilename = `structs${i}.ts`;
            structPaths.push(structFilename);
            // find all structs that need to be imported in this file
            structs.forEach((struct) => {
                struct.attributes.forEach((att) => {
                    var _a, _b;
                    const structTypeName = att.type.typeName;
                    const fileToImport = structImports[structTypeName];
                    if (fileToImport) {
                        const attTypeStruct = att.type.struct;
                        if (!attTypeStruct)
                            throw new Error(`${structTypeName} is not a struct`);
                        (_a = structsToImport[fileToImport]) !== null && _a !== void 0 ? _a : (structsToImport[fileToImport] = []);
                        structsToImport[fileToImport].push(...[structTypeName, attTypeStruct.mapperName]);
                        // OutputReferences are only used in the current file
                        // if both the imported type and the referencing type
                        // within this file are class based accessors (complex objects)
                        if (((_b = att.type.struct) === null || _b === void 0 ? void 0 : _b.isClass) && struct.isClass) {
                            structsToImport[fileToImport].push(attTypeStruct.outputReferenceName);
                        }
                    }
                });
            });
            // associate current structs batch with the file it will be written to
            // to find it in subsequent files for importing
            structs.map((struct) => (structImports[struct.name] = structFilename));
            const namespacedFilePath = path.join(resource.structsFolderPath, structFilename);
            this.code.openFile(namespacedFilePath);
            // the structs only makes use of cdktf not constructs
            this.code.line(`import * as cdktf from 'cdktf';`);
            Object.entries(structsToImport).forEach(([fileToImport, structs]) => {
                this.code.line(`import { ${structs.join(",\n")} } from './${path.basename(fileToImport, ".ts")}'`);
            });
            structs.forEach((struct) => {
                if (struct.isSingleItem) {
                    // We use the interface here for the configuration / inputs of a resource / nested block
                    this.emitInterface(resource, struct);
                    // And we use the class for the attributes / outputs of a resource / nested block
                    if (!struct.isProvider) {
                        this.emitClass(struct, struct.outputReferenceName);
                    }
                }
                else if (struct.isClass) {
                    this.emitClass(struct);
                }
                else {
                    this.emitInterface(resource, struct);
                }
            });
            this.code.closeFile(namespacedFilePath);
        }
        // emit the index file that exports all the struct files we've just generated
        const indexFilePath = path.join(resource.structsFolderPath, "index.ts");
        this.code.openFile(indexFilePath);
        structPaths.forEach((structPath) => {
            this.code.line(`export * from './${path.basename(structPath, ".ts")}'`);
        });
        this.code.closeFile(indexFilePath);
    }
    emitClass(struct, name = struct.name) {
        this.code.openBlock(`export class ${name} extends ${struct.isSingleItem
            ? "cdktf.ComplexObject"
            : "cdktf.ComplexComputedList"}`);
        if (struct.isSingleItem) {
            this.code.line("private isEmptyObject = false;");
            this.code.line();
            this.code.line(`/**`);
            this.code.line(`* @param terraformResource The parent resource`);
            this.code.line(`* @param terraformAttribute The attribute on the parent resource this class is referencing`);
            this.code.line(`* @param isSingleItem True if this is a block, false if it's a list`);
            this.code.line(`*/`);
            this.code.openBlock(`public constructor(terraformResource: cdktf.ITerraformResource, terraformAttribute: string, isSingleItem: boolean)`);
            this.code.line(`super(terraformResource, terraformAttribute, isSingleItem);`);
            this.code.closeBlock();
            this.code.line();
            this.emitInternalValueGetter(struct);
            this.code.line();
            this.emitInternalValueSetter(struct);
        }
        for (const att of struct.attributes) {
            this.attributesEmitter.emit(att, this.attributesEmitter.needsResetEscape(att, struct.attributes), this.attributesEmitter.needsInputEscape(att, struct.attributes));
        }
        this.code.closeBlock();
    }
    emitInternalValueGetter(struct) {
        this.code.openBlock(`public get internalValue(): ${struct.name} | undefined`);
        this.code.line("let hasAnyValues = this.isEmptyObject;");
        this.code.line("const internalValueResult: any = {};");
        for (const att of struct.attributes) {
            if (att.isStored) {
                if (att.getterType._type === "stored_class") {
                    this.code.openBlock(`if (this.${att.storageName}?.internalValue !== undefined)`);
                }
                else {
                    this.code.openBlock(`if (this.${att.storageName} !== undefined)`);
                }
                this.code.line("hasAnyValues = true;");
                if (att.getterType._type === "stored_class") {
                    this.code.line(`internalValueResult.${att.name} = this.${att.storageName}?.internalValue;`);
                }
                else {
                    this.code.line(`internalValueResult.${att.name} = this.${att.storageName};`);
                }
                this.code.closeBlock();
            }
        }
        this.code.line("return hasAnyValues ? internalValueResult : undefined;");
        this.code.closeBlock();
    }
    emitInternalValueSetter(struct) {
        this.code.openBlock(`public set internalValue(value: ${struct.name} | undefined)`);
        this.code.openBlock("if (value === undefined)");
        this.code.line("this.isEmptyObject = false;");
        for (const att of struct.attributes) {
            if (att.isStored) {
                if (att.setterType._type === "stored_class") {
                    this.code.line(`this.${att.storageName}.internalValue = undefined;`);
                }
                else {
                    this.code.line(`this.${att.storageName} = undefined;`);
                }
            }
        }
        this.code.closeBlock();
        this.code.openBlock("else");
        this.code.line("this.isEmptyObject = Object.keys(value).length === 0;");
        for (const att of struct.attributes) {
            if (att.isStored) {
                if (att.setterType._type === "stored_class") {
                    this.code.line(`this.${att.storageName}.internalValue = value.${att.name};`);
                }
                else {
                    this.code.line(`this.${att.storageName} = value.${att.name};`);
                }
            }
        }
        this.code.closeBlock();
        this.code.closeBlock();
    }
    emitToTerraformFunction(struct) {
        this.code.line();
        this.code.openBlock(`export function ${util_1.downcaseFirst(struct.name)}ToTerraform(struct?: ${struct.isSingleItem && !struct.isProvider
            ? `${struct.name}OutputReference | `
            : ""}${struct.name}): any`);
        this.code.line(`if (!cdktf.canInspect(struct)) { return struct; }`);
        this.code.openBlock(`if (cdktf.isComplexElement(struct))`);
        this.code.line(`throw new Error("A complex element was used as configuration, this is not supported: https://cdk.tf/complex-object-as-configuration");`);
        this.code.closeBlock();
        this.code.openBlock("return");
        for (const att of struct.isClass
            ? struct.attributes
            : struct.assignableAttributes) {
            if (!att.isConfigIgnored) {
                this.attributesEmitter.emitToTerraform(att, true);
            }
        }
        this.code.closeBlock(";");
        this.code.closeBlock();
        this.code.line();
    }
}
exports.StructEmitter = StructEmitter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RydWN0LWVtaXR0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdHJ1Y3QtZW1pdHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0Esc0NBQWdFO0FBQ2hFLDZEQUF5RDtBQUN6RCx3Q0FBOEM7QUFDOUMsMkNBQTZCO0FBQzdCLDZEQUFxRTtBQUNyRSxNQUFhLGFBQWE7SUFHeEIsWUFBNkIsSUFBZTtRQUFmLFNBQUksR0FBSixJQUFJLENBQVc7UUFDMUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksc0NBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFFTSxJQUFJLENBQUMsUUFBdUI7UUFDakMsSUFBSSxRQUFRLENBQUMsc0JBQXNCLEVBQUU7WUFDbkMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3RDO2FBQU07WUFDTCxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQzVCO0lBQ0gsQ0FBQztJQUVNLGFBQWEsQ0FDbEIsUUFBdUIsRUFDdkIsTUFBYyxFQUNkLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSTtRQUVsQixJQUFJLFFBQVEsQ0FBQyxVQUFVLEVBQUU7WUFDdkIsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsb0JBQW9CLElBQUksRUFBRSxDQUFDLENBQUM7U0FDakQ7YUFBTTtZQUNMLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLG9CQUFvQixJQUFJLEdBQUcsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7U0FDbEU7UUFFRCxLQUFLLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxvQkFBb0IsRUFBRTtZQUM3QyxJQUFJLEdBQUcsQ0FBQyxXQUFXLEVBQUU7Z0JBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUN0QixJQUFJLENB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ZXNDb250ZW50IjpbImltcG9ydCB7IENvZGVNYWtlciB9IGZyb20gXCJjb2RlbWFrZXJcIjtcbmltcG9ydCB7IFJlc291cmNlTW9kZWwsIFN0cnVjdCwgQ29uZmlnU3RydWN0IH0gZnJvbSBcIi4uL21vZGVsc1wiO1xuaW1wb3J0IHsgQXR0cmlidXRlc0VtaXR0ZXIgfSBmcm9tIFwiLi9hdHRyaWJ1dGVzLWVtaXR0ZXJcIjtcbmltcG9ydCB7IGRvd25jYXNlRmlyc3QgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbFwiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgU1RSVUNUX1NIQVJESU5HX1RIUkVTSE9MRCB9IGZyb20gXCIuLi9tb2RlbHMvcmVzb3VyY2UtbW9kZWxcIjtcbmV4cG9ydCBjbGFzcyBTdHJ1Y3RFbWl0dGVyIHtcbiAgYXR0cmlidXRlc0VtaXR0ZXI6IEF0dHJpYnV0ZXNFbWl0dGVyO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgY29kZTogQ29kZU1ha2VyKSB7XG4gICAgdGhpcy5hdHRyaWJ1dGVzRW1pdHRlciA9IG5ldyBBdHRyaWJ1dGVzRW1pdHRlcih0aGlzLmNvZGUpO1xuICB9XG5cbiAgcHVibGljIGVtaXQocmVzb3VyY2U6IFJlc291cmNlTW9kZWwpIHtcbiAgICBpZiAocmVzb3VyY2Uuc3RydWN0c1JlcXVpcmVTaGFyZGluZykge1xuICAgICAgdGhpcy5lbWl0TmFtZXNwYWNlZFN0cnVjdHMocmVzb3VyY2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmVtaXRTdHJ1Y3RzKHJlc291cmNlKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZW1pdEludGVyZmFjZShcbiAgICByZXNvdXJjZTogUmVzb3VyY2VNb2RlbCxcbiAgICBzdHJ1Y3Q6IFN0cnVjdCxcbiAgICBuYW1lID0gc3RydWN0Lm5hbWVcbiAgKSB7XG4gICAgaWYgKHJlc291cmNlLmlzUHJvdmlkZXIpIHtcbiAgICAgIHRoaXMuY29kZS5vcGVuQmxvY2soYGV4cG9ydCBpbnRlcmZhY2UgJHtuYW1lfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNvZGUub3BlbkJsb2NrKGBleHBvcnQgaW50ZXJmYWNlICR7bmFtZX0ke3N0cnVjdC5leHRlbmRzfWApO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgYXR0IG9mIHN0cnVjdC5hc3NpZ25hYmxlQXR0cmlidXRlcykge1xuICAgICAgaWYgKGF0dC5kZXNjcmlwdGlvbikge1xuICAgICAgICB0aGlzLmNvZGUubGluZShgLyoqYCk7XG4gICAgICAgIHRoaXMuY29kZS5saW5lKGAqICR7YXR0LmRlc2NyaXB0aW9ufWApO1xuICAgICAgICB0aGlzLmNvZGUubGluZShgKiBgKTtcbiAgICAgICAgdGhpcy5jb2RlLmxpbmUoXG4gICAgICAgICAgYCogRG9jcyBhdCBUZXJyYWZvcm0gUmVnaXN0cnk6IHtAbGluayAke3Jlc291cmNlLmxpbmtUb0RvY3N9IyR7YXR0LnRlcnJhZm9ybU5hbWV9ICR7cmVzb3VyY2UuY2xhc3NOYW1lfSMke2F0dC50ZXJyYWZvcm1OYW1lfX1gXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuY29kZS5saW5lKGAqL2ApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5jb2RlLmxpbmUoYC8qKmApO1xuICAgICAgICB0aGlzLmNvZGUubGluZShcbiAgICAgICAgICBgKiBEb2NzIGF0IFRlcnJhZm9ybSBSZWdpc3RyeToge0BsaW5rICR7cmVzb3VyY2UubGlua1RvRG9jc30jJHthdHQudGVycmFmb3JtTmFtZX0gJHtyZXNvdXJjZS5jbGFzc05hbWV9IyR7YXR0LnRlcnJhZm9ybU5hbWV9fWBcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5jb2RlLmxpbmUoYCovYCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuY29kZS5saW5lKGByZWFkb25seSAke2F0dC50eXBlRGVmaW5pdGlvbn07YCk7XG4gICAgfVxuICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG5cbiAgICBpZiAoIShzdHJ1Y3QgaW5zdGFuY2VvZiBDb25maWdTdHJ1Y3QpKSB7XG4gICAgICB0aGlzLmVtaXRUb1RlcnJhZm9ybUZ1bmN0aW9uKHN0cnVjdCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBlbWl0U3RydWN0cyhyZXNvdXJjZTogUmVzb3VyY2VNb2RlbCkge1xuICAgIHJlc291cmNlLnN0cnVjdHMuZm9yRWFjaCgoc3RydWN0KSA9PiB7XG4gICAgICBpZiAoc3RydWN0LmlzU2luZ2xlSXRlbSkge1xuICAgICAgICAvLyBXZSB1c2UgdGhlIGludGVyZmFjZSBoZXJlIGZvciB0aGUgY29uZmlndXJhdGlvbiAvIGlucHV0cyBvZiBhIHJlc291cmNlIC8gbmVzdGVkIGJsb2NrXG4gICAgICAgIHRoaXMuZW1pdEludGVyZmFjZShyZXNvdXJjZSwgc3RydWN0KTtcbiAgICAgICAgLy8gQW5kIHdlIHVzZSB0aGUgY2xhc3MgZm9yIHRoZSBhdHRyaWJ1dGVzIC8gb3V0cHV0cyBvZiBhIHJlc291cmNlIC8gbmVzdGVkIGJsb2NrXG4gICAgICAgIGlmICghc3RydWN0LmlzUHJvdmlkZXIpIHtcbiAgICAgICAgICB0aGlzLmVtaXRDbGFzcyhzdHJ1Y3QsIHN0cnVjdC5vdXRwdXRSZWZlcmVuY2VOYW1lKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChzdHJ1Y3QuaXNDbGFzcykge1xuICAgICAgICB0aGlzLmVtaXRDbGFzcyhzdHJ1Y3QpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5lbWl0SW50ZXJmYWNlKHJlc291cmNlLCBzdHJ1Y3QpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBlbWl0TmFtZXNwYWNlZFN0cnVjdHMocmVzb3VyY2U6IFJlc291cmNlTW9kZWwpIHtcbiAgICAvLyBpdGVyYXRlIG92ZXIgYWxsIHN0cnVjdHMgaW4gYmF0Y2hlcyBvZiA0MDAgdG8gYXZvaWQgdG9vIG1hbnkgZXhwb3J0cyAoPiAxMjAwKVxuICAgIGNvbnN0IHN0cnVjdEltcG9ydHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcblxuICAgIC8vIGRyb3AgY29uZmlnU3RydWN0IGZyb20gcmVzb3VyY2Uuc3RydWN0cyB0byBhdm9pZCBkb3VibGUgaW1wb3J0XG4gICAgY29uc3Qgc3RydWN0c1dpdGhvdXRDb25maWdTdHJ1Y3QgPSByZXNvdXJjZS5zdHJ1Y3RzLnNsaWNlKDEpO1xuXG4gICAgY29uc3Qgc3RydWN0UGF0aHMgPSBbXTtcbiAgICBmb3IgKFxuICAgICAgbGV0IGkgPSAwO1xuICAgICAgaSA8IHN0cnVjdHNXaXRob3V0Q29uZmlnU3RydWN0Lmxlbmd0aDtcbiAgICAgIGkgKz0gU1RSVUNUX1NIQVJESU5HX1RIUkVTSE9MRFxuICAgICkge1xuICAgICAgY29uc3Qgc3RydWN0c1RvSW1wb3J0OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmdbXT4gPSB7fTtcbiAgICAgIGNvbnN0IHN0cnVjdHMgPSBzdHJ1Y3RzV2l0aG91dENvbmZpZ1N0cnVjdC5zbGljZShcbiAgICAgICAgaSxcbiAgICAgICAgaSArIFNUUlVDVF9TSEFSRElOR19USFJFU0hPTERcbiAgICAgICk7XG4gICAgICBjb25zdCBzdHJ1Y3RGaWxlbmFtZSA9IGBzdHJ1Y3RzJHtpfS50c2A7XG4gICAgICBzdHJ1Y3RQYXRocy5wdXNoKHN0cnVjdEZpbGVuYW1lKTtcblxuICAgICAgLy8gZmluZCBhbGwgc3RydWN0cyB0aGF0IG5lZWQgdG8gYmUgaW1wb3J0ZWQgaW4gdGhpcyBmaWxlXG4gICAgICBzdHJ1Y3RzLmZvckVhY2goKHN0cnVjdCkgPT4ge1xuICAgICAgICBzdHJ1Y3QuYXR0cmlidXRlcy5mb3JFYWNoKChhdHQpID0+IHtcbiAgICAgICAgICBjb25zdCBzdHJ1Y3RUeXBlTmFtZSA9IGF0dC50eXBlLnR5cGVOYW1lO1xuICAgICAgICAgIGNvbnN0IGZpbGVUb0ltcG9ydCA9IHN0cnVjdEltcG9ydHNbc3RydWN0VHlwZU5hbWVdO1xuXG4gICAgICAgICAgaWYgKGZpbGVUb0ltcG9ydCkge1xuICAgICAgICAgICAgY29uc3QgYXR0VHlwZVN0cnVjdCA9IGF0dC50eXBlLnN0cnVjdDtcbiAgICAgICAgICAgIGlmICghYXR0VHlwZVN0cnVjdClcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3N0cnVjdFR5cGVOYW1lfSBpcyBub3QgYSBzdHJ1Y3RgKTtcblxuICAgICAgICAgICAgc3RydWN0c1RvSW1wb3J0W2ZpbGVUb0ltcG9ydF0gPz9cbiAgICAgICAgICAgICAgKHN0cnVjdHNUb0ltcG9ydFtmaWxlVG9JbXBvcnRdID0gW10pO1xuICAgICAgICAgICAgc3RydWN0c1RvSW1wb3J0W2ZpbGVUb0ltcG9ydF0ucHVzaChcbiAgICAgICAgICAgICAgLi4uW3N0cnVjdFR5cGVOYW1lLCBhdHRUeXBlU3RydWN0Lm1hcHBlck5hbWVdXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAvLyBPdXRwdXRSZWZlcmVuY2VzIGFyZSBvbmx5IHVzZWQgaW4gdGhlIGN1cnJlbnQgZmlsZVxuICAgICAgICAgICAgLy8gaWYgYm90aCB0aGUgaW1wb3J0ZWQgdHlwZSBhbmQgdGhlIHJlZmVyZW5jaW5nIHR5cGVcbiAgICAgICAgICAgIC8vIHdpdGhpbiB0aGlzIGZpbGUgYXJlIGNsYXNzIGJhc2VkIGFjY2Vzc29ycyAoY29tcGxleCBvYmplY3RzKVxuICAgICAgICAgICAgaWYgKGF0dC50eXBlLnN0cnVjdD8uaXNDbGFzcyAmJiBzdHJ1Y3QuaXNDbGFzcykge1xuICAgICAgICAgICAgICBzdHJ1Y3RzVG9JbXBvcnRbZmlsZVRvSW1wb3J0XS5wdXNoKFxuICAgICAgICAgICAgICAgIGF0dFR5cGVTdHJ1Y3Qub3V0cHV0UmVmZXJlbmNlTmFtZVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgLy8gYXNzb2NpYXRlIGN1cnJlbnQgc3RydWN0cyBiYXRjaCB3aXRoIHRoZSBmaWxlIGl0IHdpbGwgYmUgd3JpdHRlbiB0b1xuICAgICAgLy8gdG8gZmluZCBpdCBpbiBzdWJzZXF1ZW50IGZpbGVzIGZvciBpbXBvcnRpbmdcbiAgICAgIHN0cnVjdHMubWFwKChzdHJ1Y3QpID0+IChzdHJ1Y3RJbXBvcnRzW3N0cnVjdC5uYW1lXSA9IHN0cnVjdEZpbGVuYW1lKSk7XG5cbiAgICAgIGNvbnN0IG5hbWVzcGFjZWRGaWxlUGF0aCA9IHBhdGguam9pbihcbiAgICAgICAgcmVzb3VyY2Uuc3RydWN0c0ZvbGRlclBhdGgsXG4gICAgICAgIHN0cnVjdEZpbGVuYW1lXG4gICAgICApO1xuXG4gICAgICB0aGlzLmNvZGUub3BlbkZpbGUobmFtZXNwYWNlZEZpbGVQYXRoKTtcbiAgICAgIC8vIHRoZSBzdHJ1Y3RzIG9ubHkgbWFrZXMgdXNlIG9mIGNka3RmIG5vdCBjb25zdHJ1Y3RzXG4gICAgICB0aGlzLmNvZGUubGluZShgaW1wb3J0ICogYXMgY2RrdGYgZnJvbSAnY2RrdGYnO2ApO1xuICAgICAgT2JqZWN0LmVudHJpZXMoc3RydWN0c1RvSW1wb3J0KS5mb3JFYWNoKChbZmlsZVRvSW1wb3J0LCBzdHJ1Y3RzXSkgPT4ge1xuICAgICAgICB0aGlzLmNvZGUubGluZShcbiAgICAgICAgICBgaW1wb3J0IHsgJHtzdHJ1Y3RzLmpvaW4oXCIsXFxuXCIpfSB9IGZyb20gJy4vJHtwYXRoLmJhc2VuYW1lKFxuICAgICAgICAgICAgZmlsZVRvSW1wb3J0LFxuICAgICAgICAgICAgXCIudHNcIlxuICAgICAgICAgICl9J2BcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuXG4gICAgICBzdHJ1Y3RzLmZvckVhY2goKHN0cnVjdCkgPT4ge1xuICAgICAgICBpZiAoc3RydWN0LmlzU2luZ2xlSXRlbSkge1xuICAgICAgICAgIC8vIFdlIHVzZSB0aGUgaW50ZXJmYWNlIGhlcmUgZm9yIHRoZSBjb25maWd1cmF0aW9uIC8gaW5wdXRzIG9mIGEgcmVzb3VyY2UgLyBuZXN0ZWQgYmxvY2tcbiAgICAgICAgICB0aGlzLmVtaXRJbnRlcmZhY2UocmVzb3VyY2UsIHN0cnVjdCk7XG4gICAgICAgICAgLy8gQW5kIHdlIHVzZSB0aGUgY2xhc3MgZm9yIHRoZSBhdHRyaWJ1dGVzIC8gb3V0cHV0cyBvZiBhIHJlc291cmNlIC8gbmVzdGVkIGJsb2NrXG4gICAgICAgICAgaWYgKCFzdHJ1Y3QuaXNQcm92aWRlcikge1xuICAgICAgICAgICAgdGhpcy5lbWl0Q2xhc3Moc3RydWN0LCBzdHJ1Y3Qub3V0cHV0UmVmZXJlbmNlTmFtZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHN0cnVjdC5pc0NsYXNzKSB7XG4gICAgICAgICAgdGhpcy5lbWl0Q2xhc3Moc3RydWN0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmVtaXRJbnRlcmZhY2UocmVzb3VyY2UsIHN0cnVjdCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgdGhpcy5jb2RlLmNsb3NlRmlsZShuYW1lc3BhY2VkRmlsZVBhdGgpO1xuICAgIH1cblxuICAgIC8vIGVtaXQgdGhlIGluZGV4IGZpbGUgdGhhdCBleHBvcnRzIGFsbCB0aGUgc3RydWN0IGZpbGVzIHdlJ3ZlIGp1c3QgZ2VuZXJhdGVkXG4gICAgY29uc3QgaW5kZXhGaWxlUGF0aCA9IHBhdGguam9pbihyZXNvdXJjZS5zdHJ1Y3RzRm9sZGVyUGF0aCwgXCJpbmRleC50c1wiKTtcblxuICAgIHRoaXMuY29kZS5vcGVuRmlsZShpbmRleEZpbGVQYXRoKTtcbiAgICBzdHJ1Y3RQYXRocy5mb3JFYWNoKChzdHJ1Y3RQYXRoKSA9PiB7XG4gICAgICB0aGlzLmNvZGUubGluZShgZXhwb3J0ICogZnJvbSAnLi8ke3BhdGguYmFzZW5hbWUoc3RydWN0UGF0aCwgXCIudHNcIil9J2ApO1xuICAgIH0pO1xuICAgIHRoaXMuY29kZS5jbG9zZUZpbGUoaW5kZXhGaWxlUGF0aCk7XG4gIH1cblxuICBwcml2YXRlIGVtaXRDbGFzcyhzdHJ1Y3Q6IFN0cnVjdCwgbmFtZSA9IHN0cnVjdC5uYW1lKSB7XG4gICAgdGhpcy5jb2RlLm9wZW5CbG9jayhcbiAgICAgIGBleHBvcnQgY2xhc3MgJHtuYW1lfSBleHRlbmRzICR7XG4gICAgICAgIHN0cnVjdC5pc1NpbmdsZUl0ZW1cbiAgICAgICAgICA/IFwiY2RrdGYuQ29tcGxleE9iamVjdFwiXG4gICAgICAgICAgOiBcImNka3RmLkNvbXBsZXhDb21wdXRlZExpc3RcIlxuICAgICAgfWBcbiAgICApO1xuXG4gICAgaWYgKHN0cnVjdC5pc1NpbmdsZUl0ZW0pIHtcbiAgICAgIHRoaXMuY29kZS5saW5lKFwicHJpdmF0ZSBpc0VtcHR5T2JqZWN0ID0gZmFsc2U7XCIpO1xuICAgICAgdGhpcy5jb2RlLmxpbmUoKTtcblxuICAgICAgdGhpcy5jb2RlLmxpbmUoYC8qKmApO1xuICAgICAgdGhpcy5jb2RlLmxpbmUoYCogQHBhcmFtIHRlcnJhZm9ybVJlc291cmNlIFRoZSBwYXJlbnQgcmVzb3VyY2VgKTtcbiAgICAgIHRoaXMuY29kZS5saW5lKFxuICAgICAgICBgKiBAcGFyYW0gdGVycmFmb3JtQXR0cmlidXRlIFRoZSBhdHRyaWJ1dGUgb24gdGhlIHBhcmVudCByZXNvdXJjZSB0aGlzIGNsYXNzIGlzIHJlZmVyZW5jaW5nYFxuICAgICAgKTtcbiAgICAgIHRoaXMuY29kZS5saW5lKFxuICAgICAgICBgKiBAcGFyYW0gaXNTaW5nbGVJdGVtIFRydWUgaWYgdGhpcyBpcyBhIGJsb2NrLCBmYWxzZSBpZiBpdCdzIGEgbGlzdGBcbiAgICAgICk7XG4gICAgICB0aGlzLmNvZGUubGluZShgKi9gKTtcbiAgICAgIHRoaXMuY29kZS5vcGVuQmxvY2soXG4gICAgICAgIGBwdWJsaWMgY29uc3RydWN0b3IodGVycmFmb3JtUmVzb3VyY2U6IGNka3RmLklUZXJyYWZvcm1SZXNvdXJjZSwgdGVycmFmb3JtQXR0cmlidXRlOiBzdHJpbmcsIGlzU2luZ2xlSXRlbTogYm9vbGVhbilgXG4gICAgICApO1xuICAgICAgdGhpcy5jb2RlLmxpbmUoXG4gICAgICAgIGBzdXBlcih0ZXJyYWZvcm1SZXNvdXJjZSwgdGVycmFmb3JtQXR0cmlidXRlLCBpc1NpbmdsZUl0ZW0pO2BcbiAgICAgICk7XG4gICAgICB0aGlzLmNvZGUuY2xvc2VCbG9jaygpO1xuXG4gICAgICB0aGlzLmNvZGUubGluZSgpO1xuICAgICAgdGhpcy5lbWl0SW50ZXJuYWxWYWx1ZUdldHRlcihzdHJ1Y3QpO1xuICAgICAgdGhpcy5jb2RlLmxpbmUoKTtcbiAgICAgIHRoaXMuZW1pdEludGVybmFsVmFsdWVTZXR0ZXIoc3RydWN0KTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGF0dCBvZiBzdHJ1Y3QuYXR0cmlidXRlcykge1xuICAgICAgdGhpcy5hdHRyaWJ1dGVzRW1pdHRlci5lbWl0KFxuICAgICAgICBhdHQsXG4gICAgICAgIHRoaXMuYXR0cmlidXRlc0VtaXR0ZXIubmVlZHNSZXNldEVzY2FwZShhdHQsIHN0cnVjdC5hdHRyaWJ1dGVzKSxcbiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzRW1pdHRlci5uZWVkc0lucHV0RXNjYXBlKGF0dCwgc3RydWN0LmF0dHJpYnV0ZXMpXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG4gIH1cblxuICBwcml2YXRlIGVtaXRJbnRlcm5hbFZhbHVlR2V0dGVyKHN0cnVjdDogU3RydWN0KSB7XG4gICAgdGhpcy5jb2RlLm9wZW5CbG9jayhcbiAgICAgIGBwdWJsaWMgZ2V0IGludGVybmFsVmFsdWUoKTogJHtzdHJ1Y3QubmFtZX0gfCB1bmRlZmluZWRgXG4gICAgKTtcblxuICAgIHRoaXMuY29kZS5saW5lKFwibGV0IGhhc0FueVZhbHVlcyA9IHRoaXMuaXNFbXB0eU9iamVjdDtcIik7XG4gICAgdGhpcy5jb2RlLmxpbmUoXCJjb25zdCBpbnRlcm5hbFZhbHVlUmVzdWx0OiBhbnkgPSB7fTtcIik7XG4gICAgZm9yIChjb25zdCBhdHQgb2Ygc3RydWN0LmF0dHJpYnV0ZXMpIHtcbiAgICAgIGlmIChhdHQuaXNTdG9yZWQpIHtcbiAgICAgICAgaWYgKGF0dC5nZXR0ZXJUeXBlLl90eXBlID09PSBcInN0b3JlZF9jbGFzc1wiKSB7XG4gICAgICAgICAgdGhpcy5jb2RlLm9wZW5CbG9jayhcbiAgICAgICAgICAgIGBpZiAodGhpcy4ke2F0dC5zdG9yYWdlTmFtZX0/LmludGVybmFsVmFsdWUgIT09IHVuZGVmaW5lZClgXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmNvZGUub3BlbkJsb2NrKGBpZiAodGhpcy4ke2F0dC5zdG9yYWdlTmFtZX0gIT09IHVuZGVmaW5lZClgKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNvZGUubGluZShcImhhc0FueVZhbHVlcyA9IHRydWU7XCIpO1xuICAgICAgICBpZiAoYXR0LmdldHRlclR5cGUuX3R5cGUgPT09IFwic3RvcmVkX2NsYXNzXCIpIHtcbiAgICAgICAgICB0aGlzLmNvZGUubGluZShcbiAgICAgICAgICAgIGBpbnRlcm5hbFZhbHVlUmVzdWx0LiR7YXR0Lm5hbWV9ID0gdGhpcy4ke2F0dC5zdG9yYWdlTmFtZX0/LmludGVybmFsVmFsdWU7YFxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5jb2RlLmxpbmUoXG4gICAgICAgICAgICBgaW50ZXJuYWxWYWx1ZVJlc3VsdC4ke2F0dC5uYW1lfSA9IHRoaXMuJHthdHQuc3RvcmFnZU5hbWV9O2BcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuY29kZS5saW5lKFwicmV0dXJuIGhhc0FueVZhbHVlcyA/IGludGVybmFsVmFsdWVSZXN1bHQgOiB1bmRlZmluZWQ7XCIpO1xuICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG4gIH1cblxuICBwcml2YXRlIGVtaXRJbnRlcm5hbFZhbHVlU2V0dGVyKHN0cnVjdDogU3RydWN0KSB7XG4gICAgdGhpcy5jb2RlLm9wZW5CbG9jayhcbiAgICAgIGBwdWJsaWMgc2V0IGludGVybmFsVmFsdWUodmFsdWU6ICR7c3RydWN0Lm5hbWV9IHwgdW5kZWZpbmVkKWBcbiAgICApO1xuXG4gICAgdGhpcy5jb2RlLm9wZW5CbG9jayhcImlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKVwiKTtcbiAgICB0aGlzLmNvZGUubGluZShcInRoaXMuaXNFbXB0eU9iamVjdCA9IGZhbHNlO1wiKTtcbiAgICBmb3IgKGNvbnN0IGF0dCBvZiBzdHJ1Y3QuYXR0cmlidXRlcykge1xuICAgICAgaWYgKGF0dC5pc1N0b3JlZCkge1xuICAgICAgICBpZiAoYXR0LnNldHRlclR5cGUuX3R5cGUgPT09IFwic3RvcmVkX2NsYXNzXCIpIHtcbiAgICAgICAgICB0aGlzLmNvZGUubGluZShgdGhpcy4ke2F0dC5zdG9yYWdlTmFtZX0uaW50ZXJuYWxWYWx1ZSA9IHVuZGVmaW5lZDtgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmNvZGUubGluZShgdGhpcy4ke2F0dC5zdG9yYWdlTmFtZX0gPSB1bmRlZmluZWQ7YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5jb2RlLmNsb3NlQmxvY2soKTtcbiAgICB0aGlzLmNvZGUub3BlbkJsb2NrKFwiZWxzZVwiKTtcbiAgICB0aGlzLmNvZGUubGluZShcInRoaXMuaXNFbXB0eU9iamVjdCA9IE9iamVjdC5rZXlzKHZhbHVlKS5sZW5ndGggPT09IDA7XCIpO1xuICAgIGZvciAoY29uc3QgYXR0IG9mIHN0cnVjdC5hdHRyaWJ1dGVzKSB7XG4gICAgICBpZiAoYXR0LmlzU3RvcmVkKSB7XG4gICAgICAgIGlmIChhdHQuc2V0dGVyVHlwZS5fdHlwZSA9PT0gXCJzdG9yZWRfY2xhc3NcIikge1xuICAgICAgICAgIHRoaXMuY29kZS5saW5lKFxuICAgICAgICAgICAgYHRoaXMuJHthdHQuc3RvcmFnZU5hbWV9LmludGVybmFsVmFsdWUgPSB2YWx1ZS4ke2F0dC5uYW1lfTtgXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmNvZGUubGluZShgdGhpcy4ke2F0dC5zdG9yYWdlTmFtZX0gPSB2YWx1ZS4ke2F0dC5uYW1lfTtgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmNvZGUuY2xvc2VCbG9jaygpO1xuICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG4gIH1cblxuICBwcml2YXRlIGVtaXRUb1RlcnJhZm9ybUZ1bmN0aW9uKHN0cnVjdDogU3RydWN0KSB7XG4gICAgdGhpcy5jb2RlLmxpbmUoKTtcbiAgICB0aGlzLmNvZGUub3BlbkJsb2NrKFxuICAgICAgYGV4cG9ydCBmdW5jdGlvbiAke2Rvd25jYXNlRmlyc3Qoc3RydWN0Lm5hbWUpfVRvVGVycmFmb3JtKHN0cnVjdD86ICR7XG4gICAgICAgIHN0cnVjdC5pc1NpbmdsZUl0ZW0gJiYgIXN0cnVjdC5pc1Byb3ZpZGVyXG4gICAgICAgICAgPyBgJHtzdHJ1Y3QubmFtZX1PdXRwdXRSZWZlcmVuY2UgfCBgXG4gICAgICAgICAgOiBcIlwiXG4gICAgICB9JHtzdHJ1Y3QubmFtZX0pOiBhbnlgXG4gICAgKTtcbiAgICB0aGlzLmNvZGUubGluZShgaWYgKCFjZGt0Zi5jYW5JbnNwZWN0KHN0cnVjdCkpIHsgcmV0dXJuIHN0cnVjdDsgfWApO1xuICAgIHRoaXMuY29kZS5vcGVuQmxvY2soYGlmIChjZGt0Zi5pc0NvbXBsZXhFbGVtZW50KHN0cnVjdCkpYCk7XG4gICAgdGhpcy5jb2RlLmxpbmUoXG4gICAgICBgdGhyb3cgbmV3IEVycm9yKFwiQSBjb21wbGV4IGVsZW1lbnQgd2FzIHVzZWQgYXMgY29uZmlndXJhdGlvbiwgdGhpcyBpcyBub3Qgc3VwcG9ydGVkOiBodHRwczovL2Nkay50Zi9jb21wbGV4LW9iamVjdC1hcy1jb25maWd1cmF0aW9uXCIpO2BcbiAgICApO1xuICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG5cbiAgICB0aGlzLmNvZGUub3BlbkJsb2NrKFwicmV0dXJuXCIpO1xuICAgIGZvciAoY29uc3QgYXR0IG9mIHN0cnVjdC5pc0NsYXNzXG4gICAgICA/IHN0cnVjdC5hdHRyaWJ1dGVzXG4gICAgICA6IHN0cnVjdC5hc3NpZ25hYmxlQXR0cmlidXRlcykge1xuICAgICAgaWYgKCFhdHQuaXNDb25maWdJZ25vcmVkKSB7XG4gICAgICAgIHRoaXMuYXR0cmlidXRlc0VtaXR0ZXIuZW1pdFRvVGVycmFmb3JtKGF0dCwgdHJ1ZSk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKFwiO1wiKTtcbiAgICB0aGlzLmNvZGUuY2xvc2VCbG9jaygpO1xuICAgIHRoaXMuY29kZS5saW5lKCk7XG4gIH1cbn1cbiJdfQ==
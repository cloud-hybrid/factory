"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const spec = require("@jsii/spec");
const fs = require("fs-extra");
const mockfs = require("mock-fs");
const path = require("path");
const assemblies_1 = require("../../lib/jsii/assemblies");
const snippet_1 = require("../../lib/snippet");
const testutil_1 = require("../testutil");
const fake_assembly_1 = require("./fake-assembly");
test('Extract snippet from README', () => {
    const snippets = Array.from(assemblies_1.allTypeScriptSnippets([
        {
            assembly: fake_assembly_1.fakeAssembly({
                readme: {
                    markdown: ['Before the example.', '```ts', 'someExample();', '```', 'After the example.'].join('\n'),
                },
            }),
            directory: path.join(__dirname, 'fixtures'),
        },
    ]));
    expect(snippets[0].visibleSource).toEqual('someExample();');
});
test('Extract snippet from submodule READMEs', () => {
    const snippets = Array.from(assemblies_1.allTypeScriptSnippets([
        {
            assembly: fake_assembly_1.fakeAssembly({
                submodules: {
                    'my.submodule': {
                        readme: {
                            markdown: ['Before the example.', '```ts', 'someExample();', '```', 'After the example.'].join('\n'),
                        },
                    },
                },
            }),
            directory: path.join(__dirname, 'fixtures'),
        },
    ]));
    expect(snippets[0].visibleSource).toEqual('someExample();');
});
test('Extract snippet from type docstring', () => {
    const snippets = Array.from(assemblies_1.allTypeScriptSnippets([
        {
            assembly: fake_assembly_1.fakeAssembly({
                types: {
                    'asm.MyType': {
                        kind: spec.TypeKind.Class,
                        assembly: 'asm',
                        fqn: 'asm.MyType',
                        name: 'MyType',
                        docs: {
                            summary: 'My Type',
                            remarks: ['Before the example.', '```ts', 'someExample();', '```', 'After the example.'].join('\n'),
                        },
                    },
                },
            }),
            directory: path.join(__dirname, 'fixtures'),
        },
    ]));
    expect(snippets[0].visibleSource).toEqual('someExample();');
});
test('Snippet can include fixture', () => {
    const snippets = Array.from(assemblies_1.allTypeScriptSnippets([
        {
            assembly: fake_assembly_1.fakeAssembly({
                readme: {
                    markdown: [
                        'Before the example.',
                        '```ts fixture=explicit',
                        'someExample();',
                        '```',
                        'After the example.',
                    ].join('\n'),
                },
            }),
            directory: path.join(__dirname, 'fixtures'),
        },
    ]));
    expect(snippets[0].visibleSource).toEqual('someExample();');
    expect(snippets[0].completeSource).toMatchInlineSnapshot(`
    "// This is a fixture

    // This is a wrapper so that \`import\` statements are invalid if included in
    // the code example that'll be inlined at the \`here\` marker.
    (function () {
      // Code snippet begins after !show marker below
    /// !show
    someExample();
    /// !hide
    // Code snippet ended before !hide marker above
    })()
    "
  `);
});
test('Use fixture from example', () => {
    const snippets = Array.from(assemblies_1.allTypeScriptSnippets([
        {
            assembly: fake_assembly_1.fakeAssembly({
                types: {
                    'asm.MyType': {
                        kind: spec.TypeKind.Class,
                        assembly: 'asm',
                        fqn: 'asm.MyType',
                        name: 'MyType',
                        docs: {
                            example: ['/// fixture=explicit', 'someExample();'].join('\n'),
                        },
                    },
                },
            }),
            directory: path.join(__dirname, 'fixtures'),
        },
    ]));
    expect(snippets[0].completeSource).toMatchInlineSnapshot(`
    "// This is a fixture

    // This is a wrapper so that \`import\` statements are invalid if included in
    // the code example that'll be inlined at the \`here\` marker.
    (function () {
      // Code snippet begins after !show marker below
    /// !show
    someExample();
    /// !hide
    // Code snippet ended before !hide marker above
    })()
    "
  `);
    expect(snippets[0].visibleSource).toEqual('someExample();');
});
test('Fixture allows use of import statements', () => {
    const snippets = Array.from(assemblies_1.allTypeScriptSnippets([
        {
            assembly: fake_assembly_1.fakeAssembly({
                types: {
                    'asm.MyType': {
                        kind: spec.TypeKind.Class,
                        assembly: 'asm',
                        fqn: 'asm.MyType',
                        name: 'MyType',
                        docs: {
                            example: ['/// fixture=explicit', 'import { exit } from "process";', 'someExample();', 'exit(0);'].join('\n'),
                        },
                    },
                },
            }),
            directory: path.join(__dirname, 'fixtures'),
        },
    ]));
    expect(snippets[0].completeSource).toMatchInlineSnapshot(`
    "// Hoisted imports begin after !show marker below
    /// !show
    import { exit } from \\"process\\";
    /// !hide
    // Hoisted imports ended before !hide marker above
    // This is a fixture

    // This is a wrapper so that \`import\` statements are invalid if included in
    // the code example that'll be inlined at the \`here\` marker.
    (function () {
      // Code snippet begins after !show marker below
    /// !show

    someExample();
    exit(0);
    /// !hide
    // Code snippet ended before !hide marker above
    })()
    "
  `);
    expect(snippets[0].visibleSource).toEqual(['import { exit } from "process";', 'someExample();', 'exit(0);'].join('\n'));
});
test('Backwards compatibility with literate integ tests', () => {
    var _a, _b;
    mockfs({
        '/package/test/integ.example.lit.ts': '# Some literate source file',
    });
    try {
        const snippets = Array.from(assemblies_1.allTypeScriptSnippets([
            {
                assembly: fake_assembly_1.fakeAssembly({
                    readme: {
                        markdown: [
                            'Before the example.',
                            '```ts lit=test/integ.example.lit.ts',
                            'someExample();',
                            '```',
                            'After the example.',
                        ].join('\n'),
                    },
                }),
                directory: '/package',
            },
        ]));
        expect(snippets[0].visibleSource).toEqual('someExample();');
        expect(snippets[0].completeSource).toEqual('# Some literate source file');
        expect((_b = (_a = snippets[0]) === null || _a === void 0 ? void 0 : _a.parameters) === null || _b === void 0 ? void 0 : _b[snippet_1.SnippetParameters.$COMPILATION_DIRECTORY]).toEqual(path.normalize('/package/test'));
    }
    finally {
        mockfs.restore();
    }
});
test('rosetta fixture from submodule is preferred if it exists', async () => {
    const jsiiModule = await testutil_1.TestJsiiModule.fromSource({
        'index.ts': 'export * as submodule from "./submodule"',
        'submodule.ts': `
        /**
         * @example new ClassA();
         */
        export class ClassA {
          public someMethod() {
          }
        }`,
    }, {
        name: 'my_assembly',
        jsii: testutil_1.DUMMY_JSII_CONFIG,
    });
    try {
        await fs.mkdirp(path.join(jsiiModule.moduleDirectory, 'rosetta', 'submodule'));
        await fs.writeFile(path.join(jsiiModule.moduleDirectory, 'rosetta', 'submodule', 'default.ts-fixture'), 'pick me\n/// here');
        await fs.writeFile(path.join(jsiiModule.moduleDirectory, 'rosetta', 'default.ts-fixture'), 'dont pick me\n/// here');
        const snippets = assemblies_1.allTypeScriptSnippets([{ assembly: jsiiModule.assembly, directory: jsiiModule.moduleDirectory }]);
        expect(snippets[0].completeSource).toMatch(/^pick me/);
    }
    finally {
        await jsiiModule.cleanup();
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZW1ibGllcy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXNzZW1ibGllcy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQW1DO0FBQ25DLCtCQUErQjtBQUMvQixrQ0FBa0M7QUFDbEMsNkJBQTZCO0FBRTdCLDBEQUFrRTtBQUNsRSwrQ0FBc0Q7QUFDdEQsMENBQWdFO0FBQ2hFLG1EQUErQztBQUUvQyxJQUFJLENBQUMsNkJBQTZCLEVBQUUsR0FBRyxFQUFFO0lBQ3ZDLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQ3pCLGtDQUFxQixDQUFDO1FBQ3BCO1lBQ0UsUUFBUSxFQUFFLDRCQUFZLENBQUM7Z0JBQ3JCLE1BQU0sRUFBRTtvQkFDTixRQUFRLEVBQUUsQ0FBQyxxQkFBcUIsRUFBRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLG9CQUFvQixDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztpQkFDckc7YUFDRixDQUFDO1lBQ0YsU0FBUyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQztTQUM1QztLQUNGLENBQUMsQ0FDSCxDQUFDO0lBRUYsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUM5RCxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyx3Q0FBd0MsRUFBRSxHQUFHLEVBQUU7SUFDbEQsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FDekIsa0NBQXFCLENBQUM7UUFDcEI7WUFDRSxRQUFRLEVBQUUsNEJBQVksQ0FBQztnQkFDckIsVUFBVSxFQUFFO29CQUNWLGNBQWMsRUFBRTt3QkFDZCxNQUFNLEVBQUU7NEJBQ04sUUFBUSxFQUFFLENBQUMscUJBQXFCLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLEtBQUssRUFBRSxv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RUFBRTtJQUMxRSxNQUFNLFVBQVUsR0FBRyxNQUFNLHlCQUFjLENBQUMsVUFBVSxDQUNoRDtRQUNFLFVBQVUsRUFBRSwwQ0FBMEM7UUFDdEQsY0FBYyxFQUFFOzs7Ozs7O1VBT1o7S0FDTCxFQUNEO1FBQ0UsSUFBSSxFQUFFLGFBQWE7UUFDbkIsSUFBSSxFQUFFLDRCQUFpQjtLQUN4QixDQUNGLENBQUM7SUFDRixJQUFJO1FBQ0YsTUFBTSxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsRUFBRSxTQUFTLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQztRQUMvRSxNQUFNLEVBQUUsQ0FBQyxTQUFTLENBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLG9CQUFvQixDQUFDLEVBQ25GLG1CQUFtQixDQUNwQixDQUFDO1FBQ0YsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxlQUFlLEVBQUUsU0FBUyxFQUFFLG9CQUFvQixDQUFDLEVBQ3RFLHdCQUF3QixDQUN6QixDQUFDO1FBRUYsTUFBTSxRQUFRLEdBQUcsa0NBQXFCLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxVQUFVLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxVQUFVLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRW5ILE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0tBQ3hEO1lBQVM7UUFDUixNQUFNLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztLQUM1QjtBQUNILENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgc3BlYyBmcm9tICdAanNpaS9zcGVjJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCAqIGFzIG1vY2tmcyBmcm9tICdtb2NrLWZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCB7IGFsbFR5cGVTY3JpcHRTbmlwcGV0cyB9IGZyb20gJy4uLy4uL2xpYi9qc2lpL2Fzc2VtYmxpZXMnO1xuaW1wb3J0IHsgU25pcHBldFBhcmFtZXRlcnMgfSBmcm9tICcuLi8uLi9saWIvc25pcHBldCc7XG5pbXBvcnQgeyBUZXN0SnNpaU1vZHVsZSwgRFVNTVlfSlNJSV9DT05GSUcgfSBmcm9tICcuLi90ZXN0dXRpbCc7XG5pbXBvcnQgeyBmYWtlQXNzZW1ibHkgfSBmcm9tICcuL2Zha2UtYXNzZW1ibHknO1xuXG50ZXN0KCdFeHRyYWN0IHNuaXBwZXQgZnJvbSBSRUFETUUnLCAoKSA9PiB7XG4gIGNvbnN0IHNuaXBwZXRzID0gQXJyYXkuZnJvbShcbiAgICBhbGxUeXBlU2NyaXB0U25pcHBldHMoW1xuICAgICAge1xuICAgICAgICBhc3NlbWJseTogZmFrZUFzc2VtYmx5KHtcbiAgICAgICAgICByZWFkbWU6IHtcbiAgICAgICAgICAgIG1hcmtkb3duOiBbJ0JlZm9yZSB0aGUgZXhhbXBsZS4nLCAnYGBgdHMnLCAnc29tZUV4YW1wbGUoKTsnLCAnYGBgJywgJ0FmdGVyIHRoZSBleGFtcGxlLiddLmpvaW4oJ1xcbicpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pLFxuICAgICAgICBkaXJlY3Rvcnk6IHBhdGguam9pbihfX2Rpcm5hbWUsICdmaXh0dXJlcycpLFxuICAgICAgfSxcbiAgICBdKSxcbiAgKTtcblxuICBleHBlY3Qoc25pcHBldHNbMF0udmlzaWJsZVNvdXJjZSkudG9FcXVhbCgnc29tZUV4YW1wbGUoKTsnKTtcbn0pO1xuXG50ZXN0KCdFeHRyYWN0IHNuaXBwZXQgZnJvbSBzdWJtb2R1bGUgUkVBRE1FcycsICgpID0+IHtcbiAgY29uc3Qgc25pcHBldHMgPSBBcnJheS5mcm9tKFxuICAgIGFsbFR5cGVTY3JpcHRTbmlwcGV0cyhbXG4gICAgICB7XG4gICAgICAgIGFzc2VtYmx5OiBmYWtlQXNzZW1ibHkoe1xuICAgICAgICAgIHN1Ym1vZHVsZXM6IHtcbiAgICAgICAgICAgICdteS5zdWJtb2R1bGUnOiB7XG4gICAgICAgICAgICAgIHJlYWRtZToge1xuICAgICAgICAgICAgICAgIG1hcmtkb3duOiBbJ0JlZm9yZSB0aGUgZXhhbXBsZS4nLCAnYGBgdHMnLCAnc29tZUV4YW1wbGUoKTsnLCAnYGBgJywgJ0FmdGVyIHRoZSBleGFtcGxlLiddLmpvaW4oJ1xcbicpLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgICAgZGlyZWN0b3J5OiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnZml4dHVyZXMnKSxcbiAgICAgIH0sXG4gICAgXSksXG4gICk7XG5cbiAgZXhwZWN0KHNuaXBwZXRzWzBdLnZpc2libGVTb3VyY2UpLnRvRXF1YWwoJ3NvbWVFeGFtcGxlKCk7Jyk7XG59KTtcblxudGVzdCgnRXh0cmFjdCBzbmlwcGV0IGZyb20gdHlwZSBkb2NzdHJpbmcnLCAoKSA9PiB7XG4gIGNvbnN0IHNuaXBwZXRzID0gQXJyYXkuZnJvbShcbiAgICBhbGxUeXBlU2NyaXB0U25pcHBldHMoW1xuICAgICAge1xuICAgICAgICBhc3NlbWJseTogZmFrZUFzc2VtYmx5KHtcbiAgICAgICAgICB0eXBlczoge1xuICAgICAgICAgICAgJ2FzbS5NeVR5cGUnOiB7XG4gICAgICAgICAgICAgIGtpbmQ6IHNwZWMuVHlwZUtpbmQuQ2xhc3MsXG4gICAgICAgICAgICAgIGFzc2VtYmx5OiAnYXNtJyxcbiAgICAgICAgICAgICAgZnFuOiAnYXNtLk15VHlwZScsXG4gICAgICAgICAgICAgIG5hbWU6ICdNeVR5cGUnLFxuICAgICAgICAgICAgICBkb2NzOiB7XG4gICAgICAgICAgICAgICAgc3VtbWFyeTogJ015IFR5cGUnLFxuICAgICAgICAgICAgICAgIHJlbWFya3M6IFsnQmVmb3JlIHRoZSBleGFtcGxlLicsICdgYGB0cycsICdzb21lRXhhbXBsZSgpOycsICdgYGAnLCAnQWZ0ZXIgdGhlIGV4YW1wbGUuJ10uam9pbignXFxuJyksXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pLFxuICAgICAgICBkaXJlY3Rvcnk6IHBhdGguam9pbihfX2Rpcm5hbWUsICdmaXh0dXJlcycpLFxuICAgICAgfSxcbiAgICBdKSxcbiAgKTtcblxuICBleHBlY3Qoc25pcHBldHNbMF0udmlzaWJsZVNvdXJjZSkudG9FcXVhbCgnc29tZUV4YW1wbGUoKTsnKTtcbn0pO1xuXG50ZXN0KCdTbmlwcGV0IGNhbiBpbmNsdWRlIGZpeHR1cmUnLCAoKSA9PiB7XG4gIGNvbnN0IHNuaXBwZXRzID0gQXJyYXkuZnJvbShcbiAgICBhbGxUeXBlU2NyaXB0U25pcHBldHMoW1xuICAgICAge1xuICAgICAgICBhc3NlbWJseTogZmFrZUFzc2VtYmx5KHtcbiAgICAgICAgICByZWFkbWU6IHtcbiAgICAgICAgICAgIG1hcmtkb3duOiBbXG4gICAgICAgICAgICAgICdCZWZvcmUgdGhlIGV4YW1wbGUuJyxcbiAgICAgICAgICAgICAgJ2BgYHRzIGZpeHR1cmU9ZXhwbGljaXQnLFxuICAgICAgICAgICAgICAnc29tZUV4YW1wbGUoKTsnLFxuICAgICAgICAgICAgICAnYGBgJyxcbiAgICAgICAgICAgICAgJ0FmdGVyIHRoZSBleGFtcGxlLicsXG4gICAgICAgICAgICBdLmpvaW4oJ1xcbicpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pLFxuICAgICAgICBkaXJlY3Rvcnk6IHBhdGguam9pbihfX2Rpcm5hbWUsICdmaXh0dXJlcycpLFxuICAgICAgfSxcbiAgICBdKSxcbiAgKTtcblxuICBleHBlY3Qoc25pcHBldHNbMF0udmlzaWJsZVNvdXJjZSkudG9FcXVhbCgnc29tZUV4YW1wbGUoKTsnKTtcbiAgZXhwZWN0KHNuaXBwZXRzWzBdLmNvbXBsZXRlU291cmNlKS50b01hdGNoSW5saW5lU25hcHNob3QoYFxuICAgIFwiLy8gVGhpcyBpcyBhIGZpeHR1cmVcblxuICAgIC8vIFRoaXMgaXMgYSB3cmFwcGVyIHNvIHRoYXQgXFxgaW1wb3J0XFxgIHN0YXRlbWVudHMgYXJlIGludmFsaWQgaWYgaW5jbHVkZWQgaW5cbiAgICAvLyB0aGUgY29kZSBleGFtcGxlIHRoYXQnbGwgYmUgaW5saW5lZCBhdCB0aGUgXFxgaGVyZVxcYCBtYXJrZXIuXG4gICAgKGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vIENvZGUgc25pcHBldCBiZWdpbnMgYWZ0ZXIgIXNob3cgbWFya2VyIGJlbG93XG4gICAgLy8vICFzaG93XG4gICAgc29tZUV4YW1wbGUoKTtcbiAgICAvLy8gIWhpZGVcbiAgICAvLyBDb2RlIHNuaXBwZXQgZW5kZWQgYmVmb3JlICFoaWRlIG1hcmtlciBhYm92ZVxuICAgIH0pKClcbiAgICBcIlxuICBgKTtcbn0pO1xuXG50ZXN0KCdVc2UgZml4dHVyZSBmcm9tIGV4YW1wbGUnLCAoKSA9PiB7XG4gIGNvbnN0IHNuaXBwZXRzID0gQXJyYXkuZnJvbShcbiAgICBhbGxUeXBlU2NyaXB0U25pcHBldHMoW1xuICAgICAge1xuICAgICAgICBhc3NlbWJseTogZmFrZUFzc2VtYmx5KHtcbiAgICAgICAgICB0eXBlczoge1xuICAgICAgICAgICAgJ2FzbS5NeVR5cGUnOiB7XG4gICAgICAgICAgICAgIGtpbmQ6IHNwZWMuVHlwZUtpbmQuQ2xhc3MsXG4gICAgICAgICAgICAgIGFzc2VtYmx5OiAnYXNtJyxcbiAgICAgICAgICAgICAgZnFuOiAnYXNtLk15VHlwZScsXG4gICAgICAgICAgICAgIG5hbWU6ICdNeVR5cGUnLFxuICAgICAgICAgICAgICBkb2NzOiB7XG4gICAgICAgICAgICAgICAgZXhhbXBsZTogWycvLy8gZml4dHVyZT1leHBsaWNpdCcsICdzb21lRXhhbXBsZSgpOyddLmpvaW4oJ1xcbicpLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgICAgZGlyZWN0b3J5OiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnZml4dHVyZXMnKSxcbiAgICAgIH0sXG4gICAgXSksXG4gICk7XG5cbiAgZXhwZWN0KHNuaXBwZXRzWzBdLmNvbXBsZXRlU291cmNlKS50b01hdGNoSW5saW5lU25hcHNob3QoYFxuICAgIFwiLy8gVGhpcyBpcyBhIGZpeHR1cmVcblxuICAgIC8vIFRoaXMgaXMgYSB3cmFwcGVyIHNvIHRoYXQgXFxgaW1wb3J0XFxgIHN0YXRlbWVudHMgYXJlIGludmFsaWQgaWYgaW5jbHVkZWQgaW5cbiAgICAvLyB0aGUgY29kZSBleGFtcGxlIHRoYXQnbGwgYmUgaW5saW5lZCBhdCB0aGUgXFxgaGVyZVxcYCBtYXJrZXIuXG4gICAgKGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vIENvZGUgc25pcHBldCBiZWdpbnMgYWZ0ZXIgIXNob3cgbWFya2VyIGJlbG93XG4gICAgLy8vICFzaG93XG4gICAgc29tZUV4YW1wbGUoKTtcbiAgICAvLy8gIWhpZGVcbiAgICAvLyBDb2RlIHNuaXBwZXQgZW5kZWQgYmVmb3JlICFoaWRlIG1hcmtlciBhYm92ZVxuICAgIH0pKClcbiAgICBcIlxuICBgKTtcbiAgZXhwZWN0KHNuaXBwZXRzWzBdLnZpc2libGVTb3VyY2UpLnRvRXF1YWwoJ3NvbWVFeGFtcGxlKCk7Jyk7XG59KTtcblxudGVzdCgnRml4dHVyZSBhbGxvd3MgdXNlIG9mIGltcG9ydCBzdGF0ZW1lbnRzJywgKCkgPT4ge1xuICBjb25zdCBzbmlwcGV0cyA9IEFycmF5LmZyb20oXG4gICAgYWxsVHlwZVNjcmlwdFNuaXBwZXRzKFtcbiAgICAgIHtcbiAgICAgICAgYXNzZW1ibHk6IGZha2VBc3NlbWJseSh7XG4gICAgICAgICAgdHlwZXM6IHtcbiAgICAgICAgICAgICdhc20uTXlUeXBlJzoge1xuICAgICAgICAgICAgICBraW5kOiBzcGVjLlR5cGVLaW5kLkNsYXNzLFxuICAgICAgICAgICAgICBhc3NlbWJseTogJ2FzbScsXG4gICAgICAgICAgICAgIGZxbjogJ2FzbS5NeVR5cGUnLFxuICAgICAgICAgICAgICBuYW1lOiAnTXlUeXBlJyxcbiAgICAgICAgICAgICAgZG9jczoge1xuICAgICAgICAgICAgICAgIGV4YW1wbGU6IFsnLy8vIGZpeHR1cmU9ZXhwbGljaXQnLCAnaW1wb3J0IHsgZXhpdCB9IGZyb20gXCJwcm9jZXNzXCI7JywgJ3NvbWVFeGFtcGxlKCk7JywgJ2V4aXQoMCk7J10uam9pbihcbiAgICAgICAgICAgICAgICAgICdcXG4nLFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pLFxuICAgICAgICBkaXJlY3Rvcnk6IHBhdGguam9pbihfX2Rpcm5hbWUsICdmaXh0dXJlcycpLFxuICAgICAgfSxcbiAgICBdKSxcbiAgKTtcblxuICBleHBlY3Qoc25pcHBldHNbMF0uY29tcGxldGVTb3VyY2UpLnRvTWF0Y2hJbmxpbmVTbmFwc2hvdChgXG4gICAgXCIvLyBIb2lzdGVkIGltcG9ydHMgYmVnaW4gYWZ0ZXIgIXNob3cgbWFya2VyIGJlbG93XG4gICAgLy8vICFzaG93XG4gICAgaW1wb3J0IHsgZXhpdCB9IGZyb20gXFxcXFwicHJvY2Vzc1xcXFxcIjtcbiAgICAvLy8gIWhpZGVcbiAgICAvLyBIb2lzdGVkIGltcG9ydHMgZW5kZWQgYmVmb3JlICFoaWRlIG1hcmtlciBhYm92ZVxuICAgIC8vIFRoaXMgaXMgYSBmaXh0dXJlXG5cbiAgICAvLyBUaGlzIGlzIGEgd3JhcHBlciBzbyB0aGF0IFxcYGltcG9ydFxcYCBzdGF0ZW1lbnRzIGFyZSBpbnZhbGlkIGlmIGluY2x1ZGVkIGluXG4gICAgLy8gdGhlIGNvZGUgZXhhbXBsZSB0aGF0J2xsIGJlIGlubGluZWQgYXQgdGhlIFxcYGhlcmVcXGAgbWFya2VyLlxuICAgIChmdW5jdGlvbiAoKSB7XG4gICAgICAvLyBDb2RlIHNuaXBwZXQgYmVnaW5zIGFmdGVyICFzaG93IG1hcmtlciBiZWxvd1xuICAgIC8vLyAhc2hvd1xuXG4gICAgc29tZUV4YW1wbGUoKTtcbiAgICBleGl0KDApO1xuICAgIC8vLyAhaGlkZVxuICAgIC8vIENvZGUgc25pcHBldCBlbmRlZCBiZWZvcmUgIWhpZGUgbWFya2VyIGFib3ZlXG4gICAgfSkoKVxuICAgIFwiXG4gIGApO1xuICBleHBlY3Qoc25pcHBldHNbMF0udmlzaWJsZVNvdXJjZSkudG9FcXVhbChcbiAgICBbJ2ltcG9ydCB7IGV4aXQgfSBmcm9tIFwicHJvY2Vzc1wiOycsICdzb21lRXhhbXBsZSgpOycsICdleGl0KDApOyddLmpvaW4oJ1xcbicpLFxuICApO1xufSk7XG5cbnRlc3QoJ0JhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggbGl0ZXJhdGUgaW50ZWcgdGVzdHMnLCAoKSA9PiB7XG4gIG1vY2tmcyh7XG4gICAgJy9wYWNrYWdlL3Rlc3QvaW50ZWcuZXhhbXBsZS5saXQudHMnOiAnIyBTb21lIGxpdGVyYXRlIHNvdXJjZSBmaWxlJyxcbiAgfSk7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBzbmlwcGV0cyA9IEFycmF5LmZyb20oXG4gICAgICBhbGxUeXBlU2NyaXB0U25pcHBldHMoW1xuICAgICAgICB7XG4gICAgICAgICAgYXNzZW1ibHk6IGZha2VBc3NlbWJseSh7XG4gICAgICAgICAgICByZWFkbWU6IHtcbiAgICAgICAgICAgICAgbWFya2Rvd246IFtcbiAgICAgICAgICAgICAgICAnQmVmb3JlIHRoZSBleGFtcGxlLicsXG4gICAgICAgICAgICAgICAgJ2BgYHRzIGxpdD10ZXN0L2ludGVnLmV4YW1wbGUubGl0LnRzJyxcbiAgICAgICAgICAgICAgICAnc29tZUV4YW1wbGUoKTsnLFxuICAgICAgICAgICAgICAgICdgYGAnLFxuICAgICAgICAgICAgICAgICdBZnRlciB0aGUgZXhhbXBsZS4nLFxuICAgICAgICAgICAgICBdLmpvaW4oJ1xcbicpLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBkaXJlY3Rvcnk6ICcvcGFja2FnZScsXG4gICAgICAgIH0sXG4gICAgICBdKSxcbiAgICApO1xuXG4gICAgZXhwZWN0KHNuaXBwZXRzWzBdLnZpc2libGVTb3VyY2UpLnRvRXF1YWwoJ3NvbWVFeGFtcGxlKCk7Jyk7XG4gICAgZXhwZWN0KHNuaXBwZXRzWzBdLmNvbXBsZXRlU291cmNlKS50b0VxdWFsKCcjIFNvbWUgbGl0ZXJhdGUgc291cmNlIGZpbGUnKTtcbiAgICBleHBlY3Qoc25pcHBldHNbMF0/LnBhcmFtZXRlcnM/LltTbmlwcGV0UGFyYW1ldGVycy4kQ09NUElMQVRJT05fRElSRUNUT1JZXSkudG9FcXVhbChcbiAgICAgIHBhdGgubm9ybWFsaXplKCcvcGFja2FnZS90ZXN0JyksXG4gICAgKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBtb2NrZnMucmVzdG9yZSgpO1xuICB9XG59KTtcblxudGVzdCgncm9zZXR0YSBmaXh0dXJlIGZyb20gc3VibW9kdWxlIGlzIHByZWZlcnJlZCBpZiBpdCBleGlzdHMnLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IGpzaWlNb2R1bGUgPSBhd2FpdCBUZXN0SnNpaU1vZHVsZS5mcm9tU291cmNlKFxuICAgIHtcbiAgICAgICdpbmRleC50cyc6ICdleHBvcnQgKiBhcyBzdWJtb2R1bGUgZnJvbSBcIi4vc3VibW9kdWxlXCInLFxuICAgICAgJ3N1Ym1vZHVsZS50cyc6IGBcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBleGFtcGxlIG5ldyBDbGFzc0EoKTtcbiAgICAgICAgICovXG4gICAgICAgIGV4cG9ydCBjbGFzcyBDbGFzc0Ege1xuICAgICAgICAgIHB1YmxpYyBzb21lTWV0aG9kKCkge1xuICAgICAgICAgIH1cbiAgICAgICAgfWAsXG4gICAgfSxcbiAgICB7XG4gICAgICBuYW1lOiAnbXlfYXNzZW1ibHknLFxuICAgICAganNpaTogRFVNTVlfSlNJSV9DT05GSUcsXG4gICAgfSxcbiAgKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy5ta2RpcnAocGF0aC5qb2luKGpzaWlNb2R1bGUubW9kdWxlRGlyZWN0b3J5LCAncm9zZXR0YScsICdzdWJtb2R1bGUnKSk7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKFxuICAgICAgcGF0aC5qb2luKGpzaWlNb2R1bGUubW9kdWxlRGlyZWN0b3J5LCAncm9zZXR0YScsICdzdWJtb2R1bGUnLCAnZGVmYXVsdC50cy1maXh0dXJlJyksXG4gICAgICAncGljayBtZVxcbi8vLyBoZXJlJyxcbiAgICApO1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZShcbiAgICAgIHBhdGguam9pbihqc2lpTW9kdWxlLm1vZHVsZURpcmVjdG9yeSwgJ3Jvc2V0dGEnLCAnZGVmYXVsdC50cy1maXh0dXJlJyksXG4gICAgICAnZG9udCBwaWNrIG1lXFxuLy8vIGhlcmUnLFxuICAgICk7XG5cbiAgICBjb25zdCBzbmlwcGV0cyA9IGFsbFR5cGVTY3JpcHRTbmlwcGV0cyhbeyBhc3NlbWJseToganNpaU1vZHVsZS5hc3NlbWJseSwgZGlyZWN0b3J5OiBqc2lpTW9kdWxlLm1vZHVsZURpcmVjdG9yeSB9XSk7XG5cbiAgICBleHBlY3Qoc25pcHBldHNbMF0uY29tcGxldGVTb3VyY2UpLnRvTWF0Y2goL15waWNrIG1lLyk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQganNpaU1vZHVsZS5jbGVhbnVwKCk7XG4gIH1cbn0pO1xuIl19
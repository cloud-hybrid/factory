"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.withTemporaryDirectory = exports.DUMMY_JSII_CONFIG = exports.testSnippetLocation = exports.TestJsiiModule = void 0;
const fs = require("fs-extra");
const jsii_1 = require("jsii");
const os = require("os");
const path = require("path");
const lib_1 = require("../lib");
/**
 * Compile a jsii module from source, and produce an environment in which it is available as a module
 */
class TestJsiiModule {
    constructor(assembly, workspace) {
        this.assembly = assembly;
        this.workspace = workspace;
        this.moduleDirectory = workspace.dependencyDir(assembly.name);
        this.workspaceDirectory = workspace.rootDirectory;
    }
    static async fromSource(source, packageInfo) {
        const asm = await jsii_1.compileJsiiForTest(source, (pi) => {
            Object.assign(pi, packageInfo);
        });
        const ws = await jsii_1.TestWorkspace.create();
        await ws.addDependency(asm);
        return new TestJsiiModule(asm.assembly, ws);
    }
    /**
     * Make a snippet translator for the given source w.r.t this compiled assembly
     */
    successfullyCompile(source) {
        const location = testSnippetLocation('testutil');
        const snippet = lib_1.typeScriptSnippetFromCompleteSource(source, location, false, {
            [lib_1.SnippetParameters.$COMPILATION_DIRECTORY]: this.workspaceDirectory,
        });
        const ret = new lib_1.SnippetTranslator(snippet, {
            includeCompilerDiagnostics: true,
        });
        if (ret.compileDiagnostics.length > 0) {
            for (const diag of ret.compileDiagnostics.map(lib_1.rosettaDiagFromTypescript)) {
                console.error(diag.formattedMessage);
            }
            throw new Error('Compilation failures');
        }
        return ret;
    }
    translateHere(source) {
        const location = testSnippetLocation('testutil');
        const snip = lib_1.typeScriptSnippetFromCompleteSource(source.trimLeft(), location, true, {
            [lib_1.SnippetParameters.$COMPILATION_DIRECTORY]: this.workspaceDirectory,
        });
        const trans = new lib_1.Translator(true);
        const ret = trans.translate(snip);
        if (trans.diagnostics.length > 0) {
            for (const diag of trans.diagnostics) {
                console.error(diag.formattedMessage);
            }
            throw new Error('Compilation failures');
        }
        return ret;
    }
    /**
     * Update the file to reflect the latest changes to the assembly object.
     */
    async updateAssembly() {
        await fs.writeJSON(path.join(this.moduleDirectory, '.jsii'), this.assembly);
    }
    async cleanup() {
        await this.workspace.cleanup();
    }
}
exports.TestJsiiModule = TestJsiiModule;
function testSnippetLocation(fileName) {
    return { api: { api: 'file', fileName }, field: { field: 'example' } };
}
exports.testSnippetLocation = testSnippetLocation;
exports.DUMMY_JSII_CONFIG = {
    targets: {
        dotnet: {
            namespace: 'Example.Test.Demo',
            packageId: 'Example.Test.Demo',
        },
        go: { moduleName: 'example.test/demo' },
        java: {
            maven: {
                groupId: 'example.test',
                artifactId: 'demo',
            },
            package: 'example.test.demo',
        },
        python: {
            distName: 'example-test.demo',
            module: 'example_test_demo',
        },
    },
};
async function withTemporaryDirectory(callback) {
    const tmpdir = fs.mkdtempSync(path.join(os.tmpdir(), path.basename(__filename)));
    return callback(tmpdir).finally(() => fs.removeSync(tmpdir));
}
exports.withTemporaryDirectory = withTemporaryDirectory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdHV0aWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0ZXN0dXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSwrQkFBK0I7QUFDL0IsK0JBQXNFO0FBQ3RFLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFFN0IsZ0NBT2dCO0FBSWhCOztHQUVHO0FBQ0gsTUFBYSxjQUFjO0lBaUJ6QixZQUFvQyxRQUF1QixFQUFtQixTQUF3QjtRQUFsRSxhQUFRLEdBQVIsUUFBUSxDQUFlO1FBQW1CLGNBQVMsR0FBVCxTQUFTLENBQWU7UUFDcEcsSUFBSSxDQUFDLGVBQWUsR0FBRyxTQUFTLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5RCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsU0FBUyxDQUFDLGFBQWEsQ0FBQztJQUNwRCxDQUFDO0lBbkJNLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUM1QixNQUFnQyxFQUNoQyxXQUFtRjtRQUVuRixNQUFNLEdBQUcsR0FBRyxNQUFNLHlCQUFrQixDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFO1lBQ2xELE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ2pDLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxFQUFFLEdBQUcsTUFBTSxvQkFBYSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ3hDLE1BQU0sRUFBRSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM1QixPQUFPLElBQUksY0FBYyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQVVEOztPQUVHO0lBQ0ksbUJBQW1CLENBQUMsTUFBYztRQUN2QyxNQUFNLFFBQVEsR0FBRyxtQkFBbUIsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNqRCxNQUFNLE9BQU8sR0FBRyx5Q0FBbUMsQ0FBQyxNQUFNLEVBQUUsUUFBUSxF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QUUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakYsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztBQUMvRCxDQUFDO0FBSEQsd0RBR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBzcGVjIGZyb20gJ0Bqc2lpL3NwZWMnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgUGFja2FnZUluZm8sIGNvbXBpbGVKc2lpRm9yVGVzdCwgVGVzdFdvcmtzcGFjZSB9IGZyb20gJ2pzaWknO1xuaW1wb3J0ICogYXMgb3MgZnJvbSAnb3MnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IHtcbiAgU25pcHBldFRyYW5zbGF0b3IsXG4gIFNuaXBwZXRQYXJhbWV0ZXJzLFxuICByb3NldHRhRGlhZ0Zyb21UeXBlc2NyaXB0LFxuICBTbmlwcGV0TG9jYXRpb24sXG4gIHR5cGVTY3JpcHRTbmlwcGV0RnJvbUNvbXBsZXRlU291cmNlLFxuICBUcmFuc2xhdG9yLFxufSBmcm9tICcuLi9saWInO1xuXG5leHBvcnQgdHlwZSBNdWx0aXBsZVNvdXJjZXMgPSB7IFtrZXk6IHN0cmluZ106IHN0cmluZzsgJ2luZGV4LnRzJzogc3RyaW5nIH07XG5cbi8qKlxuICogQ29tcGlsZSBhIGpzaWkgbW9kdWxlIGZyb20gc291cmNlLCBhbmQgcHJvZHVjZSBhbiBlbnZpcm9ubWVudCBpbiB3aGljaCBpdCBpcyBhdmFpbGFibGUgYXMgYSBtb2R1bGVcbiAqL1xuZXhwb3J0IGNsYXNzIFRlc3RKc2lpTW9kdWxlIHtcbiAgcHVibGljIHN0YXRpYyBhc3luYyBmcm9tU291cmNlKFxuICAgIHNvdXJjZTogc3RyaW5nIHwgTXVsdGlwbGVTb3VyY2VzLFxuICAgIHBhY2thZ2VJbmZvOiBQYXJ0aWFsPFBhY2thZ2VJbmZvPiAmIHsgbmFtZTogc3RyaW5nOyBtYWluPzogc3RyaW5nOyB0eXBlcz86IHN0cmluZyB9LFxuICApIHtcbiAgICBjb25zdCBhc20gPSBhd2FpdCBjb21waWxlSnNpaUZvclRlc3Qoc291cmNlLCAocGkpID0+IHtcbiAgICAgIE9iamVjdC5hc3NpZ24ocGksIHBhY2thZ2VJbmZvKTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHdzID0gYXdhaXQgVGVzdFdvcmtzcGFjZS5jcmVhdGUoKTtcbiAgICBhd2FpdCB3cy5hZGREZXBlbmRlbmN5KGFzbSk7XG4gICAgcmV0dXJuIG5ldyBUZXN0SnNpaU1vZHVsZShhc20uYXNzZW1ibHksIHdzKTtcbiAgfVxuXG4gIHB1YmxpYyByZWFkb25seSBtb2R1bGVEaXJlY3Rvcnk6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IHdvcmtzcGFjZURpcmVjdG9yeTogc3RyaW5nO1xuXG4gIHByaXZhdGUgY29uc3RydWN0b3IocHVibGljIHJlYWRvbmx5IGFzc2VtYmx5OiBzcGVjLkFzc2VtYmx5LCBwcml2YXRlIHJlYWRvbmx5IHdvcmtzcGFjZTogVGVzdFdvcmtzcGFjZSkge1xuICAgIHRoaXMubW9kdWxlRGlyZWN0b3J5ID0gd29ya3NwYWNlLmRlcGVuZGVuY3lEaXIoYXNzZW1ibHkubmFtZSk7XG4gICAgdGhpcy53b3Jrc3BhY2VEaXJlY3RvcnkgPSB3b3Jrc3BhY2Uucm9vdERpcmVjdG9yeTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYWtlIGEgc25pcHBldCB0cmFuc2xhdG9yIGZvciB0aGUgZ2l2ZW4gc291cmNlIHcuci50IHRoaXMgY29tcGlsZWQgYXNzZW1ibHlcbiAgICovXG4gIHB1YmxpYyBzdWNjZXNzZnVsbHlDb21waWxlKHNvdXJjZTogc3RyaW5nKSB7XG4gICAgY29uc3QgbG9jYXRpb24gPSB0ZXN0U25pcHBldExvY2F0aW9uKCd0ZXN0dXRpbCcpO1xuICAgIGNvbnN0IHNuaXBwZXQgPSB0eXBlU2NyaXB0U25pcHBldEZyb21Db21wbGV0ZVNvdXJjZShzb3VyY2UsIGxvY2F0aW9uLCBmYWxzZSwge1xuICAgICAgW1NuaXBwZXRQYXJhbWV0ZXJzLiRDT01QSUxBVElPTl9ESVJFQ1RPUlldOiB0aGlzLndvcmtzcGFjZURpcmVjdG9yeSxcbiAgICB9KTtcbiAgICBjb25zdCByZXQgPSBuZXcgU25pcHBldFRyYW5zbGF0b3Ioc25pcHBldCwge1xuICAgICAgaW5jbHVkZUNvbXBpbGVyRGlhZ25vc3RpY3M6IHRydWUsXG4gICAgfSk7XG4gICAgaWYgKHJldC5jb21waWxlRGlhZ25vc3RpY3MubGVuZ3RoID4gMCkge1xuICAgICAgZm9yIChjb25zdCBkaWFnIG9mIHJldC5jb21waWxlRGlhZ25vc3RpY3MubWFwKHJvc2V0dGFEaWFnRnJvbVR5cGVzY3JpcHQpKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZGlhZy5mb3JtYXR0ZWRNZXNzYWdlKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcGlsYXRpb24gZmFpbHVyZXMnKTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbiAgfVxuXG4gIHB1YmxpYyB0cmFuc2xhdGVIZXJlKHNvdXJjZTogc3RyaW5nKSB7XG4gICAgY29uc3QgbG9jYXRpb24gPSB0ZXN0U25pcHBldExvY2F0aW9uKCd0ZXN0dXRpbCcpO1xuICAgIGNvbnN0IHNuaXAgPSB0eXBlU2NyaXB0U25pcHBldEZyb21Db21wbGV0ZVNvdXJjZShzb3VyY2UudHJpbUxlZnQoKSwgbG9jYXRpb24sIHRydWUsIHtcbiAgICAgIFtTbmlwcGV0UGFyYW1ldGVycy4kQ09NUElMQVRJT05fRElSRUNUT1JZXTogdGhpcy53b3Jrc3BhY2VEaXJlY3RvcnksXG4gICAgfSk7XG5cbiAgICBjb25zdCB0cmFucyA9IG5ldyBUcmFuc2xhdG9yKHRydWUpO1xuICAgIGNvbnN0IHJldCA9IHRyYW5zLnRyYW5zbGF0ZShzbmlwKTtcbiAgICBpZiAodHJhbnMuZGlhZ25vc3RpY3MubGVuZ3RoID4gMCkge1xuICAgICAgZm9yIChjb25zdCBkaWFnIG9mIHRyYW5zLmRpYWdub3N0aWNzKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZGlhZy5mb3JtYXR0ZWRNZXNzYWdlKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcGlsYXRpb24gZmFpbHVyZXMnKTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgdGhlIGZpbGUgdG8gcmVmbGVjdCB0aGUgbGF0ZXN0IGNoYW5nZXMgdG8gdGhlIGFzc2VtYmx5IG9iamVjdC5cbiAgICovXG4gIHB1YmxpYyBhc3luYyB1cGRhdGVBc3NlbWJseSgpIHtcbiAgICBhd2FpdCBmcy53cml0ZUpTT04ocGF0aC5qb2luKHRoaXMubW9kdWxlRGlyZWN0b3J5LCAnLmpzaWknKSwgdGhpcy5hc3NlbWJseSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY2xlYW51cCgpIHtcbiAgICBhd2FpdCB0aGlzLndvcmtzcGFjZS5jbGVhbnVwKCk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRlc3RTbmlwcGV0TG9jYXRpb24oZmlsZU5hbWU6IHN0cmluZyk6IFNuaXBwZXRMb2NhdGlvbiB7XG4gIHJldHVybiB7IGFwaTogeyBhcGk6ICdmaWxlJywgZmlsZU5hbWUgfSwgZmllbGQ6IHsgZmllbGQ6ICdleGFtcGxlJyB9IH07XG59XG5cbmV4cG9ydCBjb25zdCBEVU1NWV9KU0lJX0NPTkZJRyA9IHtcbiAgdGFyZ2V0czoge1xuICAgIGRvdG5ldDoge1xuICAgICAgbmFtZXNwYWNlOiAnRXhhbXBsZS5UZXN0LkRlbW8nLFxuICAgICAgcGFja2FnZUlkOiAnRXhhbXBsZS5UZXN0LkRlbW8nLFxuICAgIH0sXG4gICAgZ286IHsgbW9kdWxlTmFtZTogJ2V4YW1wbGUudGVzdC9kZW1vJyB9LFxuICAgIGphdmE6IHtcbiAgICAgIG1hdmVuOiB7XG4gICAgICAgIGdyb3VwSWQ6ICdleGFtcGxlLnRlc3QnLFxuICAgICAgICBhcnRpZmFjdElkOiAnZGVtbycsXG4gICAgICB9LFxuICAgICAgcGFja2FnZTogJ2V4YW1wbGUudGVzdC5kZW1vJyxcbiAgICB9LFxuICAgIHB5dGhvbjoge1xuICAgICAgZGlzdE5hbWU6ICdleGFtcGxlLXRlc3QuZGVtbycsXG4gICAgICBtb2R1bGU6ICdleGFtcGxlX3Rlc3RfZGVtbycsXG4gICAgfSxcbiAgfSxcbn07XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3aXRoVGVtcG9yYXJ5RGlyZWN0b3J5PFQ+KGNhbGxiYWNrOiAoZGlyOiBzdHJpbmcpID0+IFByb21pc2U8VD4pOiBQcm9taXNlPFQ+IHtcbiAgY29uc3QgdG1wZGlyID0gZnMubWtkdGVtcFN5bmMocGF0aC5qb2luKG9zLnRtcGRpcigpLCBwYXRoLmJhc2VuYW1lKF9fZmlsZW5hbWUpKSk7XG4gIHJldHVybiBjYWxsYmFjayh0bXBkaXIpLmZpbmFsbHkoKCkgPT4gZnMucmVtb3ZlU3luYyh0bXBkaXIpKTtcbn1cbiJdfQ==
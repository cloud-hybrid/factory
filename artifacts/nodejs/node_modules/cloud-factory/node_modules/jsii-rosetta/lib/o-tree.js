"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.renderTree = exports.OTreeSink = exports.UnknownSyntax = exports.NO_SYNTAX = exports.OTree = void 0;
/**
 * "Output" Tree
 *
 * Tree-like structure that holds sequences of trees and strings, which
 * can be rendered to an output sink.
 */
class OTree {
    constructor(prefix, children, options = {}) {
        this.options = options;
        this.prefix = OTree.simplify(prefix);
        this.children = OTree.simplify(children !== null && children !== void 0 ? children : []);
        this.attachComment = !!options.canBreakLine;
    }
    static simplify(xs) {
        return xs.filter(notUndefined).filter(notEmpty);
    }
    /**
     * Set the span in the source file this tree node relates to
     */
    setSpan(start, end) {
        this.span = { start, end };
    }
    write(sink) {
        var _a, _b;
        if (!sink.tagOnce(this.options.renderOnce)) {
            return;
        }
        const meVisible = sink.renderingForSpan(this.span);
        for (const x of this.prefix) {
            sink.write(x);
        }
        const popIndent = sink.requestIndentChange(meVisible ? (_a = this.options.indent) !== null && _a !== void 0 ? _a : 0 : 0);
        let mark = sink.mark();
        for (const child of (_b = this.children) !== null && _b !== void 0 ? _b : []) {
            if (this.options.separator && mark.wroteNonWhitespaceSinceMark) {
                sink.write(this.options.separator);
            }
            mark = sink.mark();
            sink.write(child);
        }
        popIndent();
        if (this.options.suffix) {
            sink.renderingForSpan(this.span);
            sink.write(this.options.suffix);
        }
    }
    get isEmpty() {
        return this.prefix.length + this.children.length === 0;
    }
    toString() {
        return `<INCORRECTLY STRINGIFIED ${this.prefix.toString()}>`;
    }
}
exports.OTree = OTree;
exports.NO_SYNTAX = new OTree([]);
class UnknownSyntax extends OTree {
}
exports.UnknownSyntax = UnknownSyntax;
/**
 * Output sink for OTree objects
 *
 * Maintains state about what has been rendered supports suppressing code
 * fragments based on their tagged source location.
 *
 * Basically: manages the state that was too hard to manage in the
 * tree :).
 */
class OTreeSink {
    constructor(options = {}) {
        this.options = options;
        this.indentLevels = [0];
        this.fragments = new Array();
        this.singletonsRendered = new Set();
        this.pendingIndentChange = 0;
        this.rendering = true;
    }
    tagOnce(key) {
        if (key === undefined) {
            return true;
        }
        if (this.singletonsRendered.has(key)) {
            return false;
        }
        this.singletonsRendered.add(key);
        return true;
    }
    /**
     * Get a mark for the current sink output location
     *
     * Marks can be used to query about things that have been written to output.
     */
    mark() {
        // eslint-disable-next-line @typescript-eslint/no-this-alias
        const self = this;
        const markIndex = this.fragments.length;
        return {
            get wroteNonWhitespaceSinceMark() {
                return self.fragments.slice(markIndex).some((s) => /[^\s]/.exec(s) != null);
            },
        };
    }
    write(text) {
        if (text instanceof OTree) {
            text.write(this);
        }
        else {
            if (!this.rendering) {
                return;
            }
            if (containsNewline(text)) {
                this.applyPendingIndentChange();
            }
            this.append(text.replace(/\n/g, `\n${' '.repeat(this.currentIndent)}`));
        }
    }
    renderingForSpan(span) {
        if (span && this.options.visibleSpans) {
            this.rendering = this.options.visibleSpans.fullyContainsSpan(span);
        }
        return this.rendering;
    }
    requestIndentChange(x) {
        if (x === 0) {
            return () => undefined;
        }
        this.pendingIndentChange = x;
        const currentIndentState = this.indentLevels.length;
        // Return a pop function which will reset to the current indent state,
        // regardless of whether the indent was actually applied or not.
        return () => {
            this.indentLevels.splice(currentIndentState);
            this.pendingIndentChange = 0;
        };
    }
    toString() {
        // Strip trailing whitespace from every line, and empty lines from the start and end
        return this.fragments
            .join('')
            .replace(/[ \t]+$/gm, '')
            .replace(/^\n+/, '')
            .replace(/\n+$/, '');
    }
    append(x) {
        this.fragments.push(x);
    }
    applyPendingIndentChange() {
        if (this.pendingIndentChange !== 0) {
            this.indentLevels.push(this.currentIndent + this.pendingIndentChange);
            this.pendingIndentChange = 0;
        }
    }
    get currentIndent() {
        return this.indentLevels[this.indentLevels.length - 1];
    }
}
exports.OTreeSink = OTreeSink;
function notUndefined(x) {
    return x !== undefined;
}
function notEmpty(x) {
    return x instanceof OTree ? !x.isEmpty : x !== '';
}
function renderTree(tree, options) {
    const sink = new OTreeSink(options);
    tree.write(sink);
    return sink.toString();
}
exports.renderTree = renderTree;
function containsNewline(x) {
    return x.includes('\n');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby10cmVlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiby10cmVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQStDQTs7Ozs7R0FLRztBQUNILE1BQWEsS0FBSztJQVdoQixZQUNFLE1BQXlDLEVBQ3pDLFFBQTRDLEVBQzNCLFVBQXdCLEVBQUU7UUFBMUIsWUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFFM0MsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxRQUFRLGFBQVIsUUFBUSxjQUFSLFFBQVEsR0FBSSxFQUFFLENBQUMsQ0FBQztRQUMvQyxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDO0lBQzlDLENBQUM7SUFsQk0sTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFxQztRQUMxRCxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFrQkQ7O09BRUc7SUFDSSxPQUFPLENBQUMsS0FBYSxFQUFFLEdBQVc7UUFDdkMsSUFBSSxDQUFDLElBQUksR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsQ0FBQztJQUM3QixDQUFDO0lBRU0sS0FBSyxDQUFDLElBQWU7O1FBQzFCLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDMUMsT0FBTztTQUNSO1FBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVuRCxLQUFLLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDM0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMs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LENBQUM7SUFDakIsT0FBTyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7QUFDekIsQ0FBQztBQUpELGdDQUlDO0FBRUQsU0FBUyxlQUFlLENBQUMsQ0FBUztJQUNoQyxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDMUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNwYW5zIH0gZnJvbSAnLi90eXBlc2NyaXB0L3Zpc2libGUtc3BhbnMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE9UcmVlT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBBZGp1c3QgaW5kZW50YXRpb24gd2l0aCB0aGUgZ2l2ZW4gbnVtYmVyXG4gICAqXG4gICAqIEluZGVudGF0aW9uIGFmZmVjdHMgY2hpbGRyZW4uXG4gICAqXG4gICAqIEBkZWZhdWx0IDBcbiAgICovXG4gIGluZGVudD86IG51bWJlcjtcblxuICAvKipcbiAgICogU2VwYXJhdGUgY2hpbGRyZW4gd2l0aCB0aGUgZ2l2ZW4gc3RyaW5nXG4gICAqXG4gICAqIEBkZWZhdWx0ICcnXG4gICAqL1xuICBzZXBhcmF0b3I/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFN1ZmZpeCB0aGUgdG9rZW4gYWZ0ZXIgb3V0ZGVudGluZ1xuICAgKlxuICAgKiBAZGVmYXVsdCAnJ1xuICAgKi9cbiAgc3VmZml4Pzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRoaXMgcGFydCBvZiB0aGUgZ2VuZXJhdGVkIHN5bnRheCBpcyBva2F5IHRvIGluc2VydCBuZXdsaW5lcyBhbmQgY29tbWVudHNcbiAgICpcbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIGNhbkJyZWFrTGluZT86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIElmIHNldCwgYSB1bmlxdWUga2V5IHdoaWNoIHdpbGwgY2F1c2Ugb25seSBvbmUgbm9kZSB3aXRoIHRoZSBnaXZlbiBrZXkgdG8gYmUgcmVuZGVyZWQuXG4gICAqXG4gICAqIFRoZSBvdXRlcm1vc3Qga2V5IGlzIHRoZSBvbmUgdGhhdCB3aWxsIGJlIHJlbmRlcmVkLlxuICAgKlxuICAgKiBVc2VkIHRvIG1ha2UgaXQgZWFzaWVyIHRvIGtlZXAgdGhlIHN0YXRlIG5lY2Vzc2FyeSB0byByZW5kZXIgY29tbWVudHNcbiAgICogb25seSBvbmNlIGluIHRoZSBvdXRwdXQgdHJlZSwgcmF0aGVyIHRoYW4ga2VlcCB0aGUgc3RhdGUgaW4gdGhlXG4gICAqIGxhbmd1YWdlIHJlbmRlcmVkLlxuICAgKlxuICAgKiBAZGVmYXVsdCBObyBjb25kaXRpb25hbCByZW5kZXJpbmdcbiAgICovXG4gIHJlbmRlck9uY2U/OiBzdHJpbmc7XG59XG5cbi8qKlxuICogXCJPdXRwdXRcIiBUcmVlXG4gKlxuICogVHJlZS1saWtlIHN0cnVjdHVyZSB0aGF0IGhvbGRzIHNlcXVlbmNlcyBvZiB0cmVlcyBhbmQgc3RyaW5ncywgd2hpY2hcbiAqIGNhbiBiZSByZW5kZXJlZCB0byBhbiBvdXRwdXQgc2luay5cbiAqL1xuZXhwb3J0IGNsYXNzIE9UcmVlIGltcGxlbWVudHMgT1RyZWUge1xuICBwdWJsaWMgc3RhdGljIHNpbXBsaWZ5KHhzOiBBcnJheTxPVHJlZSB8IHN0cmluZyB8IHVuZGVmaW5lZD4pOiBBcnJheTxPVHJlZSB8IHN0cmluZz4ge1xuICAgIHJldHVybiB4cy5maWx0ZXIobm90VW5kZWZpbmVkKS5maWx0ZXIobm90RW1wdHkpO1xuICB9XG5cbiAgcHVibGljIHJlYWRvbmx5IGF0dGFjaENvbW1lbnQ6IGJvb2xlYW47XG5cbiAgcHJpdmF0ZSByZWFkb25seSBwcmVmaXg6IEFycmF5PE9UcmVlIHwgc3RyaW5nPjtcbiAgcHJpdmF0ZSByZWFkb25seSBjaGlsZHJlbjogQXJyYXk8T1RyZWUgfCBzdHJpbmc+O1xuICBwcml2YXRlIHNwYW4/OiBTcGFuO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBwcmVmaXg6IEFycmF5PE9UcmVlIHwgc3RyaW5nIHwgdW5kZWZpbmVkPixcbiAgICBjaGlsZHJlbj86IEFycmF5PE9UcmVlIHwgc3RyaW5nIHwgdW5kZWZpbmVkPixcbiAgICBwcml2YXRlIHJlYWRvbmx5IG9wdGlvbnM6IE9UcmVlT3B0aW9ucyA9IHt9LFxuICApIHtcbiAgICB0aGlzLnByZWZpeCA9IE9UcmVlLnNpbXBsaWZ5KHByZWZpeCk7XG4gICAgdGhpcy5jaGlsZHJlbiA9IE9UcmVlLnNpbXBsaWZ5KGNoaWxkcmVuID8/IFtdKTtcbiAgICB0aGlzLmF0dGFjaENvbW1lbnQgPSAhIW9wdGlvbnMuY2FuQnJlYWtMaW5lO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgc3BhbiBpbiB0aGUgc291cmNlIGZpbGUgdGhpcyB0cmVlIG5vZGUgcmVsYXRlcyB0b1xuICAgKi9cbiAgcHVibGljIHNldFNwYW4oc3RhcnQ6IG51bWJlciwgZW5kOiBudW1iZXIpIHtcbiAgICB0aGlzLnNwYW4gPSB7IHN0YXJ0LCBlbmQgfTtcbiAgfVxuXG4gIHB1YmxpYyB3cml0ZShzaW5rOiBPVHJlZVNpbmspIHtcbiAgICBpZiAoIXNpbmsudGFnT25jZSh0aGlzLm9wdGlvbnMucmVuZGVyT25jZSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBtZVZpc2libGUgPSBzaW5rLnJlbmRlcmluZ0ZvclNwYW4odGhpcy5zcGFuKTtcblxuICAgIGZvciAoY29uc3QgeCBvZiB0aGlzLnByZWZpeCkge1xuICAgICAgc2luay53cml0ZSh4KTtcbiAgICB9XG5cbiAgICBjb25zdCBwb3BJbmRlbnQgPSBzaW5rLnJlcXVlc3RJbmRlbnRDaGFuZ2UobWVWaXNpYmxlID8gdGhpcy5vcHRpb25zLmluZGVudCA/PyAwIDogMCk7XG4gICAgbGV0IG1hcmsgPSBzaW5rLm1hcmsoKTtcbiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMuY2hpbGRyZW4gPz8gW10pIHtcbiAgICAgIGlmICh0aGlzLm9wdGlvbnMuc2VwYXJhdG9yICYmIG1hcmsud3JvdGVOb25XaGl0ZXNwYWNlU2luY2VNYXJrKSB7XG4gICAgICAgIHNpbmsud3JpdGUodGhpcy5vcHRpb25zLnNlcGFyYXRvcik7XG4gICAgICB9XG4gICAgICBtYXJrID0gc2luay5tYXJrKCk7XG5cbiAgICAgIHNpbmsud3JpdGUoY2hpbGQpO1xuICAgIH1cbiAgICBwb3BJbmRlbnQoKTtcblxuICAgIGlmICh0aGlzLm9wdGlvbnMuc3VmZml4KSB7XG4gICAgICBzaW5rLnJlbmRlcmluZ0ZvclNwYW4odGhpcy5zcGFuKTtcbiAgICAgIHNpbmsud3JpdGUodGhpcy5vcHRpb25zLnN1ZmZpeCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCBpc0VtcHR5KCkge1xuICAgIHJldHVybiB0aGlzLnByZWZpeC5sZW5ndGggKyB0aGlzLmNoaWxkcmVuLmxlbmd0aCA9PT0gMDtcbiAgfVxuXG4gIHB1YmxpYyB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gYDxJTkNPUlJFQ1RMWSBTVFJJTkdJRklFRCAke3RoaXMucHJlZml4LnRvU3RyaW5nKCl9PmA7XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IE5PX1NZTlRBWCA9IG5ldyBPVHJlZShbXSk7XG5cbmV4cG9ydCBjbGFzcyBVbmtub3duU3ludGF4IGV4dGVuZHMgT1RyZWUge31cblxuZXhwb3J0IGludGVyZmFjZSBTaW5rTWFyayB7XG4gIHJlYWRvbmx5IHdyb3RlTm9uV2hpdGVzcGFjZVNpbmNlTWFyazogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBPVHJlZVNpbmtPcHRpb25zIHtcbiAgdmlzaWJsZVNwYW5zPzogU3BhbnM7XG59XG5cbi8qKlxuICogT3V0cHV0IHNpbmsgZm9yIE9UcmVlIG9iamVjdHNcbiAqXG4gKiBNYWludGFpbnMgc3RhdGUgYWJvdXQgd2hhdCBoYXMgYmVlbiByZW5kZXJlZCBzdXBwb3J0cyBzdXBwcmVzc2luZyBjb2RlXG4gKiBmcmFnbWVudHMgYmFzZWQgb24gdGhlaXIgdGFnZ2VkIHNvdXJjZSBsb2NhdGlvbi5cbiAqXG4gKiBCYXNpY2FsbHk6IG1hbmFnZXMgdGhlIHN0YXRlIHRoYXQgd2FzIHRvbyBoYXJkIHRvIG1hbmFnZSBpbiB0aGVcbiAqIHRyZWUgOikuXG4gKi9cbmV4cG9ydCBjbGFzcyBPVHJlZVNpbmsge1xuICBwcml2YXRlIHJlYWRvbmx5IGluZGVudExldmVsczogbnVtYmVyW10gPSBbMF07XG4gIHByaXZhdGUgcmVhZG9ubHkgZnJhZ21lbnRzID0gbmV3IEFycmF5PHN0cmluZz4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSBzaW5nbGV0b25zUmVuZGVyZWQgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgcHJpdmF0ZSBwZW5kaW5nSW5kZW50Q2hhbmdlID0gMDtcbiAgcHJpdmF0ZSByZW5kZXJpbmcgPSB0cnVlO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IG9wdGlvbnM6IE9UcmVlU2lua09wdGlvbnMgPSB7fSkge31cblxuICBwdWJsaWMgdGFnT25jZShrZXk6IHN0cmluZyB8IHVuZGVmaW5lZCk6IGJvb2xlYW4ge1xuICAgIGlmIChrZXkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGlmICh0aGlzLnNpbmdsZXRvbnNSZW5kZXJlZC5oYXMoa2V5KSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLnNpbmdsZXRvbnNSZW5kZXJlZC5hZGQoa2V5KTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYSBtYXJrIGZvciB0aGUgY3VycmVudCBzaW5rIG91dHB1dCBsb2NhdGlvblxuICAgKlxuICAgKiBNYXJrcyBjYW4gYmUgdXNlZCB0byBxdWVyeSBhYm91dCB0aGluZ3MgdGhhdCBoYXZlIGJlZW4gd3JpdHRlbiB0byBvdXRwdXQuXG4gICAqL1xuICBwdWJsaWMgbWFyaygpOiBTaW5rTWFyayB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby10aGlzLWFsaWFzXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgY29uc3QgbWFya0luZGV4ID0gdGhpcy5mcmFnbWVudHMubGVuZ3RoO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGdldCB3cm90ZU5vbldoaXRlc3BhY2VTaW5jZU1hcmsoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBzZWxmLmZyYWdtZW50cy5zbGljZShtYXJrSW5kZXgpLnNvbWUoKHMpID0+IC9bXlxcc10vLmV4ZWMocykgIT0gbnVsbCk7XG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgd3JpdGUodGV4dDogc3RyaW5nIHwgT1RyZWUpIHtcbiAgICBpZiAodGV4dCBpbnN0YW5jZW9mIE9UcmVlKSB7XG4gICAgICB0ZXh0LndyaXRlKHRoaXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIXRoaXMucmVuZGVyaW5nKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKGNvbnRhaW5zTmV3bGluZSh0ZXh0KSkge1xuICAgICAgICB0aGlzLmFwcGx5UGVuZGluZ0luZGVudENoYW5nZSgpO1xuICAgICAgfVxuICAgICAgdGhpcy5hcHBlbmQodGV4dC5yZXBsYWNlKC9cXG4vZywgYFxcbiR7JyAnLnJlcGVhdCh0aGlzLmN1cnJlbnRJbmRlbnQpfWApKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcmVuZGVyaW5nRm9yU3BhbihzcGFuPzogU3Bhbik6IGJvb2xlYW4ge1xuICAgIGlmIChzcGFuICYmIHRoaXMub3B0aW9ucy52aXNpYmxlU3BhbnMpIHtcbiAgICAgIHRoaXMucmVuZGVyaW5nID0gdGhpcy5vcHRpb25zLnZpc2libGVTcGFucy5mdWxseUNvbnRhaW5zU3BhbihzcGFuKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucmVuZGVyaW5nO1xuICB9XG5cbiAgcHVibGljIHJlcXVlc3RJbmRlbnRDaGFuZ2UoeDogbnVtYmVyKTogKCkgPT4gdm9pZCB7XG4gICAgaWYgKHggPT09IDApIHtcbiAgICAgIHJldHVybiAoKSA9PiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgdGhpcy5wZW5kaW5nSW5kZW50Q2hhbmdlID0geDtcbiAgICBjb25zdCBjdXJyZW50SW5kZW50U3RhdGUgPSB0aGlzLmluZGVudExldmVscy5sZW5ndGg7XG5cbiAgICAvLyBSZXR1cm4gYSBwb3AgZnVuY3Rpb24gd2hpY2ggd2lsbCByZXNldCB0byB0aGUgY3VycmVudCBpbmRlbnQgc3RhdGUsXG4gICAgLy8gcmVnYXJkbGVzcyBvZiB3aGV0aGVyIHRoZSBpbmRlbnQgd2FzIGFjdHVhbGx5IGFwcGxpZWQgb3Igbm90LlxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICB0aGlzLmluZGVudExldmVscy5zcGxpY2UoY3VycmVudEluZGVudFN0YXRlKTtcbiAgICAgIHRoaXMucGVuZGluZ0luZGVudENoYW5nZSA9IDA7XG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyB0b1N0cmluZygpIHtcbiAgICAvLyBTdHJpcCB0cmFpbGluZyB3aGl0ZXNwYWNlIGZyb20gZXZlcnkgbGluZSwgYW5kIGVtcHR5IGxpbmVzIGZyb20gdGhlIHN0YXJ0IGFuZCBlbmRcbiAgICByZXR1cm4gdGhpcy5mcmFnbWVudHNcbiAgICAgIC5qb2luKCcnKVxuICAgICAgLnJlcGxhY2UoL1sgXFx0XSskL2dtLCAnJylcbiAgICAgIC5yZXBsYWNlKC9eXFxuKy8sICcnKVxuICAgICAgLnJlcGxhY2UoL1xcbiskLywgJycpO1xuICB9XG5cbiAgcHJpdmF0ZSBhcHBlbmQoeDogc3RyaW5nKSB7XG4gICAgdGhpcy5mcmFnbWVudHMucHVzaCh4KTtcbiAgfVxuXG4gIHByaXZhdGUgYXBwbHlQZW5kaW5nSW5kZW50Q2hhbmdlKCkge1xuICAgIGlmICh0aGlzLnBlbmRpbmdJbmRlbnRDaGFuZ2UgIT09IDApIHtcbiAgICAgIHRoaXMuaW5kZW50TGV2ZWxzLnB1c2godGhpcy5jdXJyZW50SW5kZW50ICsgdGhpcy5wZW5kaW5nSW5kZW50Q2hhbmdlKTtcbiAgICAgIHRoaXMucGVuZGluZ0luZGVudENoYW5nZSA9IDA7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXQgY3VycmVudEluZGVudCgpIHtcbiAgICByZXR1cm4gdGhpcy5pbmRlbnRMZXZlbHNbdGhpcy5pbmRlbnRMZXZlbHMubGVuZ3RoIC0gMV07XG4gIH1cbn1cblxuZnVuY3Rpb24gbm90VW5kZWZpbmVkPFQ+KHg6IFQgfCB1bmRlZmluZWQpOiB4IGlzIFQge1xuICByZXR1cm4geCAhPT0gdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiBub3RFbXB0eSh4OiBPVHJlZSB8IHN0cmluZykge1xuICByZXR1cm4geCBpbnN0YW5jZW9mIE9UcmVlID8gIXguaXNFbXB0eSA6IHggIT09ICcnO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVuZGVyVHJlZSh0cmVlOiBPVHJlZSwgb3B0aW9ucz86IE9UcmVlU2lua09wdGlvbnMpOiBzdHJpbmcge1xuICBjb25zdCBzaW5rID0gbmV3IE9UcmVlU2luayhvcHRpb25zKTtcbiAgdHJlZS53cml0ZShzaW5rKTtcbiAgcmV0dXJuIHNpbmsudG9TdHJpbmcoKTtcbn1cblxuZnVuY3Rpb24gY29udGFpbnNOZXdsaW5lKHg6IHN0cmluZykge1xuICByZXR1cm4geC5pbmNsdWRlcygnXFxuJyk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3BhbiB7XG4gIHJlYWRvbmx5IHN0YXJ0OiBudW1iZXI7XG4gIHJlYWRvbmx5IGVuZDogbnVtYmVyO1xufVxuIl19
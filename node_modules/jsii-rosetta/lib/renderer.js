"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.nimpl = exports.AstRenderer = void 0;
const ts = require("typescript");
const o_tree_1 = require("./o-tree");
const ast_utils_1 = require("./typescript/ast-utils");
const imports_1 = require("./typescript/imports");
const types_1 = require("./typescript/types");
/**
 * Render a TypeScript AST to some other representation (encoded in OTrees)
 *
 * Dispatch the actual conversion to a specific handler which will get the
 * appropriate method called for particular AST nodes. The handler may use
 * context to modify its own operations when traversing the tree hierarchy,
 * the type of which should be expressed via the C parameter.
 */
class AstRenderer {
    constructor(sourceFile, typeChecker, handler, options = {}) {
        this.sourceFile = sourceFile;
        this.typeChecker = typeChecker;
        this.handler = handler;
        this.options = options;
        this.diagnostics = new Array();
        this.currentContext = handler.defaultContext;
    }
    /**
     * Merge the new context with the current context and create a new Converter from it
     */
    updateContext(contextUpdate) {
        const newContext = this.handler.mergeContext(this.currentContext, contextUpdate);
        // Use prototypal inheritance to create a version of 'this' in which only
        // 'currentContext' is updated.
        return Object.assign(Object.create(this), {
            currentContext: newContext,
        });
    }
    /**
     * Convert a single node to an OTree
     */
    convert(node) {
        if (node === undefined) {
            return o_tree_1.NO_SYNTAX;
        }
        // Basic transform of node
        const transformed = this.dispatch(node);
        transformed.setSpan(node.getStart(this.sourceFile), node.getEnd());
        if (!transformed.attachComment) {
            return transformed;
        }
        const withTrivia = this.attachLeadingTrivia(node, transformed);
        withTrivia.setSpan(node.getStart(this.sourceFile), node.getEnd());
        return withTrivia;
    }
    /**
     * Convert a set of nodes, filtering out hidden nodes
     */
    convertAll(nodes) {
        return filterVisible(nodes).map(this.convert.bind(this));
    }
    convertWithModifier(nodes, makeContext) {
        const vis = assignVisibility(nodes);
        const result = new Array();
        for (const [idx, { node, visible, maskingVoid }] of vis.entries()) {
            const renderedNode = visible ? node : maskingVoid;
            if (renderedNode) {
                const context = makeContext(this, renderedNode, idx);
                result.push(context.convert(renderedNode));
            }
        }
        return result;
    }
    /**
     * Convert a set of nodes, but update the context for the last one.
     *
     * Takes visibility into account.
     */
    convertLastDifferently(nodes, lastContext) {
        const lastConverter = this.updateContext(lastContext);
        const convert = this.convert.bind(this);
        const lastConvert = lastConverter.convert.bind(lastConverter);
        const ret = [];
        const vis = assignVisibility(nodes);
        for (let i = 0; i < vis.length; i++) {
            const whichConvert = i === vis.length - 1 ? lastConvert : convert;
            const node = vis[i].visible ? vis[i].node : vis[i].maskingVoid;
            if (node) {
                ret.push(whichConvert(node));
            }
        }
        return ret;
    }
    getPosition(node) {
        return {
            start: node.getStart(this.sourceFile),
            end: node.getEnd(),
        };
    }
    textOf(node) {
        return node.getText(this.sourceFile);
    }
    textAt(pos, end) {
        return this.sourceFile.text.substring(pos, end);
    }
    /**
     * Infer type of expression by the argument it is assigned to
     *
     * If the type of the expression can include undefined (if the value is
     * optional), `undefined` will be removed from the union.
     *
     * (Will return undefined for object literals not unified with a declared type)
     *
     * @deprecated Use `inferredTypeOfExpression` instead
     */
    inferredTypeOfExpression(node) {
        return types_1.inferredTypeOfExpression(this.typeChecker, node);
    }
    /**
     * Type of expression from the text of the expression
     *
     * (Will return a map type for object literals)
     *
     * @deprecated Use `typeOfExpression` directly
     */
    typeOfExpression(node) {
        return types_1.typeOfExpression(this.typeChecker, node);
    }
    typeOfType(node) {
        return this.typeChecker.getTypeFromTypeNode(node);
    }
    typeToString(type) {
        return this.typeChecker.typeToString(type);
    }
    report(node, messageText, category = ts.DiagnosticCategory.Error) {
        this.diagnostics.push({
            category,
            code: 0,
            source: 'rosetta',
            messageText,
            file: this.sourceFile,
            start: node.getStart(this.sourceFile),
            length: node.getWidth(this.sourceFile),
        });
    }
    reportUnsupported(node, language) {
        const nodeKind = ts.SyntaxKind[node.kind];
        // tslint:disable-next-line:max-line-length
        if (language) {
            this.report(node, `This TypeScript feature (${nodeKind}) is not supported in examples because we cannot translate it to ${language}. Please rewrite this example.`);
        }
        else {
            this.report(node, `This TypeScript feature (${nodeKind}) is not supported in examples. Please rewrite this example.`);
        }
    }
    /**
     * Whether there is non-whitespace on the same line before the given position
     */
    codeOnLineBefore(pos) {
        const text = this.sourceFile.text;
        while (pos > 0) {
            const c = text[--pos];
            if (c === '\n') {
                return false;
            }
            if (c !== ' ' && c !== '\r' && c !== '\t') {
                return true;
            }
        }
        return false;
    }
    /**
     * Return a newline if the given node is preceded by at least one newline
     *
     * Used to mirror newline use between matchin brackets (such as { ... } and [ ... ]).
     */
    mirrorNewlineBefore(viz, suffix = '', otherwise = '') {
        if (viz === undefined) {
            return suffix;
        }
        // Return a newline if the given node is preceded by newlines
        const leadingRanges = ast_utils_1.scanText(this.sourceFile.text, viz.getFullStart(), viz.getStart(this.sourceFile));
        const newlines = [];
        for (const range of leadingRanges) {
            if (range.type === 'other') {
                newlines.push(ast_utils_1.repeatNewlines(this.sourceFile.text.substring(range.pos, range.end)));
            }
        }
        return (newlines.join('').length > 0 ? '\n' : otherwise) + suffix;
    }
    /**
     * Dispatch node to handler
     */
    dispatch(tree) {
        // Special nodes
        if (ts.isEmptyStatement(tree)) {
            // Additional semicolon where it doesn't belong.
            return o_tree_1.NO_SYNTAX;
        }
        const visitor = this.handler;
        // Nodes with meaning
        if (ts.isSourceFile(tree)) {
            return visitor.sourceFile(tree, this);
        }
        if (ts.isImportEqualsDeclaration(tree)) {
            return visitor.importStatement(imports_1.analyzeImportEquals(tree, this), this);
        }
        if (ts.isImportDeclaration(tree)) {
            return visitor.importStatement(imports_1.analyzeImportDeclaration(tree, this), this);
        }
        if (ts.isStringLiteral(tree) || ts.isNoSubstitutionTemplateLiteral(tree)) {
            return visitor.stringLiteral(tree, this);
        }
        if (ts.isFunctionDeclaration(tree)) {
            return visitor.functionDeclaration(tree, this);
        }
        if (ts.isIdentifier(tree)) {
            return visitor.identifier(tree, this);
        }
        if (ts.isBlock(tree)) {
            return visitor.block(tree, this);
        }
        if (ts.isParameter(tree)) {
            return visitor.parameterDeclaration(tree, this);
        }
        if (ts.isReturnStatement(tree)) {
            return visitor.returnStatement(tree, this);
        }
        if (ts.isBinaryExpression(tree)) {
            return visitor.binaryExpression(tree, this);
        }
        if (ts.isIfStatement(tree)) {
            return visitor.ifStatement(tree, this);
        }
        if (ts.isPropertyAccessExpression(tree)) {
            return visitor.propertyAccessExpression(tree, this);
        }
        if (ts.isCallExpression(tree)) {
            return visitor.callExpression(tree, this);
        }
        if (ts.isExpressionStatement(tree)) {
            return visitor.expressionStatement(tree, this);
        }
        if (ts.isToken(tree)) {
            return visitor.token(tree, this);
        }
        if (ts.isObjectLiteralExpression(tree)) {
            return visitor.objectLiteralExpression(tree, this);
        }
        if (ts.isNewExpression(tree)) {
            return visitor.newExpression(tree, this);
        }
        if (ts.isPropertyAssignment(tree)) {
            return visitor.propertyAssignment(tree, this);
        }
        if (ts.isVariableStatement(tree)) {
            return visitor.variableStatement(tree, this);
        }
        if (ts.isVariableDeclarationList(tree)) {
            return visitor.variableDeclarationList(tree, this);
        }
        if (ts.isVariableDeclaration(tree)) {
            return visitor.variableDeclaration(tree, this);
        }
        if (ts.isJSDoc(tree)) {
            return visitor.jsDoc(tree, this);
        }
        if (ts.isArrayLiteralExpression(tree)) {
            return visitor.arrayLiteralExpression(tree, this);
        }
        if (ts.isShorthandPropertyAssignment(tree)) {
            return visitor.shorthandPropertyAssignment(tree, this);
        }
        if (ts.isForOfStatement(tree)) {
            return visitor.forOfStatement(tree, this);
        }
        if (ts.isClassDeclaration(tree)) {
            return visitor.classDeclaration(tree, this);
        }
        if (ts.isConstructorDeclaration(tree)) {
            return visitor.constructorDeclaration(tree, this);
        }
        if (ts.isPropertyDeclaration(tree)) {
            return visitor.propertyDeclaration(tree, this);
        }
        if (ts.isComputedPropertyName(tree)) {
            return visitor.computedPropertyName(tree.expression, this);
        }
        if (ts.isMethodDeclaration(tree)) {
            return visitor.methodDeclaration(tree, this);
        }
        if (ts.isInterfaceDeclaration(tree)) {
            return visitor.interfaceDeclaration(tree, this);
        }
        if (ts.isPropertySignature(tree)) {
            return visitor.propertySignature(tree, this);
        }
        if (ts.isMethodSignature(tree)) {
            return visitor.methodSignature(tree, this);
        }
        if (ts.isAsExpression(tree)) {
            return visitor.asExpression(tree, this);
        }
        if (ts.isPrefixUnaryExpression(tree)) {
            return visitor.prefixUnaryExpression(tree, this);
        }
        if (ts.isSpreadAssignment(tree)) {
            if (this.textOf(tree) === '...') {
                return visitor.ellipsis(tree, this);
            }
            return visitor.spreadAssignment(tree, this);
        }
        if (ts.isSpreadElement(tree)) {
            if (this.textOf(tree) === '...') {
                return visitor.ellipsis(tree, this);
            }
            return visitor.spreadElement(tree, this);
        }
        if (ts.isElementAccessExpression(tree)) {
            return visitor.elementAccessExpression(tree, this);
        }
        if (ts.isTemplateExpression(tree)) {
            return visitor.templateExpression(tree, this);
        }
        if (ts.isNonNullExpression(tree)) {
            return visitor.nonNullExpression(tree, this);
        }
        if (ts.isParenthesizedExpression(tree)) {
            return visitor.parenthesizedExpression(tree, this);
        }
        if (ts.isVoidExpression(tree)) {
            return visitor.maskingVoidExpression(tree, this);
        }
        this.reportUnsupported(tree, undefined);
        if (this.options.bestEffort !== false) {
            // When doing best-effort conversion and we don't understand the node type, just return the complete text of it as-is
            return new o_tree_1.OTree([this.textOf(tree)]);
        }
        // Otherwise, show a placeholder indicating we don't recognize the type
        const nodeKind = ts.SyntaxKind[tree.kind];
        return new o_tree_1.UnknownSyntax([`<${nodeKind} ${this.textOf(tree)}>`], ['\n', ...ast_utils_1.nodeChildren(tree).map(this.convert.bind(this))], {
            indent: 2,
        });
    }
    /**
     * Attach any leading whitespace and comments to the given output tree
     *
     * Regardless of whether it's declared to be able to accept such or not.
     */
    attachLeadingTrivia(node, transformed) {
        // Add comments and leading whitespace
        const leadingRanges = ast_utils_1.scanText(this.sourceFile.text, node.getFullStart(), node.getStart(this.sourceFile));
        const precede = [];
        for (const range of leadingRanges) {
            let trivia = undefined;
            switch (range.type) {
                case 'other':
                    trivia = new o_tree_1.OTree([ast_utils_1.repeatNewlines(this.sourceFile.text.substring(range.pos, range.end))], [], {
                        renderOnce: `ws-${range.pos}`,
                    });
                    break;
                case 'linecomment':
                case 'blockcomment':
                    trivia = this.handler.commentRange(commentSyntaxFromCommentRange(ast_utils_1.commentRangeFromTextRange(range), this), this);
                    break;
                case 'directive':
                    break;
            }
            if (trivia != null) {
                // Set spans on comments to make sure their visibility is toggled correctly.
                trivia.setSpan(range.pos, range.end);
                precede.push(trivia);
            }
        }
        // FIXME: No trailing comments for now, they're too tricky
        if (precede.length > 0 && !transformed.isEmpty) {
            return new o_tree_1.OTree([...precede, transformed], [], { canBreakLine: true });
        }
        return transformed;
    }
}
exports.AstRenderer = AstRenderer;
function nimpl(node, context, options = {}) {
    const children = ast_utils_1.nodeChildren(node).map((c) => context.convert(c));
    let syntaxKind = ts.SyntaxKind[node.kind];
    if (syntaxKind === 'FirstPunctuation') {
        // These have the same identifier but this name is more descriptive
        syntaxKind = 'OpenBraceToken';
    }
    const parts = [`(${syntaxKind}`];
    if (options.additionalInfo) {
        parts.push(`{${options.additionalInfo}}`);
    }
    parts.push(context.textOf(node));
    return new o_tree_1.UnknownSyntax([parts.join(' ')], children.length > 0 ? ['\n', ...children] : [], {
        indent: 2,
        suffix: ')',
        separator: '\n',
        canBreakLine: true,
    });
}
exports.nimpl = nimpl;
function filterVisible(nodes) {
    return assignVisibility(nodes)
        .map((c) => (c.visible ? c.node : c.maskingVoid))
        .filter(notUndefined);
}
function assignVisibility(nodes) {
    const ret = [];
    let visible = true;
    for (const node of nodes) {
        const maskingVoid = ast_utils_1.extractMaskingVoidExpression(node);
        if (visible && maskingVoid) {
            visible = false;
        }
        ret.push({ node, maskingVoid, visible });
        if (!visible) {
            const showing = ast_utils_1.extractShowingVoidExpression(node);
            if (showing) {
                visible = true;
            }
        }
    }
    return ret;
}
function notUndefined(x) {
    return x !== undefined;
}
function commentSyntaxFromCommentRange(rng, renderer) {
    return {
        hasTrailingNewLine: rng.hasTrailingNewLine,
        kind: rng.kind,
        pos: rng.pos,
        text: renderer.textAt(rng.pos, rng.end),
        isTrailing: renderer.codeOnLineBefore(rng.pos),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZW5kZXJlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxpQ0FBaUM7QUFHakMscUNBQWlFO0FBQ2pFLHNEQU9nQztBQUNoQyxrREFBc0c7QUFDdEcsOENBQWdGO0FBRWhGOzs7Ozs7O0dBT0c7QUFDSCxNQUFhLFdBQVc7SUFJdEIsWUFDbUIsVUFBeUIsRUFDMUIsV0FBMkIsRUFDMUIsT0FBc0IsRUFDdEIsVUFBOEIsRUFBRTtRQUhoQyxlQUFVLEdBQVYsVUFBVSxDQUFlO1FBQzFCLGdCQUFXLEdBQVgsV0FBVyxDQUFnQjtRQUMxQixZQUFPLEdBQVAsT0FBTyxDQUFlO1FBQ3RCLFlBQU8sR0FBUCxPQUFPLENBQXlCO1FBUG5DLGdCQUFXLEdBQUcsSUFBSSxLQUFLLEVBQWlCLENBQUM7UUFTdkQsSUFBSSxDQUFDLGNBQWMsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDO0lBQy9DLENBQUM7SUFFRDs7T0FFRztJQUNJLGFBQWEsQ0FBQyxhQUF5QjtRQUM1QyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRWpGLHlFQUF5RTtRQUN6RSwrQkFBK0I7UUFDL0IsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDeEMsY0FBYyxFQUFFLFVBQVU7U0FDM0IsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0ksT0FBTyxDQUFDLElBQXlCO1FBQ3RDLElBQUksSUFBSSxLQUFLLFNBQVMsRUFBRTtZQUN0QixPQUFPLGtCQUFTLENBQUM7U0FDbEI7UUFFRCwwQkFBMEI7UUFDMUIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4QyxXQUFXLENBQUMsT0FBTyxDQUFD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Q3JGLE9BQU87UUFDTCxrQkFBa0IsRUFBRSxHQUFHLENBQUMsa0JBQWtCO1FBQzFDLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSTtRQUNkLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRztRQUNaLElBQUksRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQztRQUN2QyxVQUFVLEVBQUUsUUFBUSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7S0FDL0MsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB0cyBmcm9tICd0eXBlc2NyaXB0JztcblxuaW1wb3J0IHsgVGFyZ2V0TGFuZ3VhZ2UgfSBmcm9tICcuL2xhbmd1YWdlcyc7XG5pbXBvcnQgeyBOT19TWU5UQVgsIE9UcmVlLCBVbmtub3duU3ludGF4LCBTcGFuIH0gZnJvbSAnLi9vLXRyZWUnO1xuaW1wb3J0IHtcbiAgY29tbWVudFJhbmdlRnJvbVRleHRSYW5nZSxcbiAgZXh0cmFjdE1hc2tpbmdWb2lkRXhwcmVzc2lvbixcbiAgZXh0cmFjdFNob3dpbmdWb2lkRXhwcmVzc2lvbixcbiAgbm9kZUNoaWxkcmVuLFxuICByZXBlYXROZXdsaW5lcyxcbiAgc2NhblRleHQsXG59IGZyb20gJy4vdHlwZXNjcmlwdC9hc3QtdXRpbHMnO1xuaW1wb3J0IHsgYW5hbHl6ZUltcG9ydERlY2xhcmF0aW9uLCBhbmFseXplSW1wb3J0RXF1YWxzLCBJbXBvcnRTdGF0ZW1lbnQgfSBmcm9tICcuL3R5cGVzY3JpcHQvaW1wb3J0cyc7XG5pbXBvcnQgeyB0eXBlT2ZFeHByZXNzaW9uLCBpbmZlcnJlZFR5cGVPZkV4cHJlc3Npb24gfSBmcm9tICcuL3R5cGVzY3JpcHQvdHlwZXMnO1xuXG4vKipcbiAqIFJlbmRlciBhIFR5cGVTY3JpcHQgQVNUIHRvIHNvbWUgb3RoZXIgcmVwcmVzZW50YXRpb24gKGVuY29kZWQgaW4gT1RyZWVzKVxuICpcbiAqIERpc3BhdGNoIHRoZSBhY3R1YWwgY29udmVyc2lvbiB0byBhIHNwZWNpZmljIGhhbmRsZXIgd2hpY2ggd2lsbCBnZXQgdGhlXG4gKiBhcHByb3ByaWF0ZSBtZXRob2QgY2FsbGVkIGZvciBwYXJ0aWN1bGFyIEFTVCBub2Rlcy4gVGhlIGhhbmRsZXIgbWF5IHVzZVxuICogY29udGV4dCB0byBtb2RpZnkgaXRzIG93biBvcGVyYXRpb25zIHdoZW4gdHJhdmVyc2luZyB0aGUgdHJlZSBoaWVyYXJjaHksXG4gKiB0aGUgdHlwZSBvZiB3aGljaCBzaG91bGQgYmUgZXhwcmVzc2VkIHZpYSB0aGUgQyBwYXJhbWV0ZXIuXG4gKi9cbmV4cG9ydCBjbGFzcyBBc3RSZW5kZXJlcjxDPiB7XG4gIHB1YmxpYyByZWFkb25seSBkaWFnbm9zdGljcyA9IG5ldyBBcnJheTx0cy5EaWFnbm9zdGljPigpO1xuICBwdWJsaWMgcmVhZG9ubHkgY3VycmVudENvbnRleHQ6IEM7XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc291cmNlRmlsZTogdHMuU291cmNlRmlsZSxcbiAgICBwdWJsaWMgcmVhZG9ubHkgdHlwZUNoZWNrZXI6IHRzLlR5cGVDaGVja2VyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgaGFuZGxlcjogQXN0SGFuZGxlcjxDPixcbiAgICBwcml2YXRlIHJlYWRvbmx5IG9wdGlvbnM6IEFzdFJlbmRlcmVyT3B0aW9ucyA9IHt9LFxuICApIHtcbiAgICB0aGlzLmN1cnJlbnRDb250ZXh0ID0gaGFuZGxlci5kZWZhdWx0Q29udGV4dDtcbiAgfVxuXG4gIC8qKlxuICAgKiBNZXJnZSB0aGUgbmV3IGNvbnRleHQgd2l0aCB0aGUgY3VycmVudCBjb250ZXh0IGFuZCBjcmVhdGUgYSBuZXcgQ29udmVydGVyIGZyb20gaXRcbiAgICovXG4gIHB1YmxpYyB1cGRhdGVDb250ZXh0KGNvbnRleHRVcGRhdGU6IFBhcnRpYWw8Qz4pOiBBc3RSZW5kZXJlcjxDPiB7XG4gICAgY29uc3QgbmV3Q29udGV4dCA9IHRoaXMuaGFuZGxlci5tZXJnZUNvbnRleHQodGhpcy5jdXJyZW50Q29udGV4dCwgY29udGV4dFVwZGF0ZSk7XG5cbiAgICAvLyBVc2UgcHJvdG90eXBhbCBpbmhlcml0YW5jZSB0byBjcmVhdGUgYSB2ZXJzaW9uIG9mICd0aGlzJyBpbiB3aGljaCBvbmx5XG4gICAgLy8gJ2N1cnJlbnRDb250ZXh0JyBpcyB1cGRhdGVkLlxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKE9iamVjdC5jcmVhdGUodGhpcyksIHtcbiAgICAgIGN1cnJlbnRDb250ZXh0OiBuZXdDb250ZXh0LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgYSBzaW5nbGUgbm9kZSB0byBhbiBPVHJlZVxuICAgKi9cbiAgcHVibGljIGNvbnZlcnQobm9kZTogdHMuTm9kZSB8IHVuZGVmaW5lZCk6IE9UcmVlIHtcbiAgICBpZiAobm9kZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gTk9fU1lOVEFYO1xuICAgIH1cblxuICAgIC8vIEJhc2ljIHRyYW5zZm9ybSBvZiBub2RlXG4gICAgY29uc3QgdHJhbnNmb3JtZWQgPSB0aGlzLmRpc3BhdGNoKG5vZGUpO1xuICAgIHRyYW5zZm9ybWVkLnNldFNwYW4obm9kZS5nZXRTdGFydCh0aGlzLnNvdXJjZUZpbGUpLCBub2RlLmdldEVuZCgpKTtcbiAgICBpZiAoIXRyYW5zZm9ybWVkLmF0dGFjaENvbW1lbnQpIHtcbiAgICAgIHJldHVybiB0cmFuc2Zvcm1lZDtcbiAgICB9XG5cbiAgICBjb25zdCB3aXRoVHJpdmlhID0gdGhpcy5hdHRhY2hMZWFkaW5nVHJpdmlhKG5vZGUsIHRyYW5zZm9ybWVkKTtcbiAgICB3aXRoVHJpdmlhLnNldFNwYW4obm9kZS5nZXRTdGFydCh0aGlzLnNvdXJjZUZpbGUpLCBub2RlLmdldEVuZCgpKTtcbiAgICByZXR1cm4gd2l0aFRyaXZpYTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0IGEgc2V0IG9mIG5vZGVzLCBmaWx0ZXJpbmcgb3V0IGhpZGRlbiBub2Rlc1xuICAgKi9cbiAgcHVibGljIGNvbnZlcnRBbGwobm9kZXM6IHJlYWRvbmx5IHRzLk5vZGVbXSk6IE9UcmVlW10ge1xuICAgIHJldHVybiBmaWx0ZXJWaXNpYmxlKG5vZGVzKS5tYXAodGhpcy5jb252ZXJ0LmJpbmQodGhpcykpO1xuICB9XG5cbiAgcHVibGljIGNvbnZlcnRXaXRoTW9kaWZpZXIoXG4gICAgbm9kZXM6IHJlYWRvbmx5IHRzLk5vZGVbXSxcbiAgICBtYWtlQ29udGV4dDogKGNvbnRleHQ6IHRoaXMsIG5vZGU6IHRzLk5vZGUsIGluZGV4OiBudW1iZXIpID0+IEFzdFJlbmRlcmVyPEM+LFxuICApOiBPVHJlZVtdIHtcbiAgICBjb25zdCB2aXMgPSBhc3NpZ25WaXNpYmlsaXR5KG5vZGVzKTtcbiAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXk8T1RyZWU+KCk7XG4gICAgZm9yIChjb25zdCBbaWR4LCB7IG5vZGUsIHZpc2libGUsIG1hc2tpbmdWb2lkIH1dIG9mIHZpcy5lbnRyaWVzKCkpIHtcbiAgICAgIGNvbnN0IHJlbmRlcmVkTm9kZSA9IHZpc2libGUgPyBub2RlIDogbWFza2luZ1ZvaWQ7XG4gICAgICBpZiAocmVuZGVyZWROb2RlKSB7XG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSBtYWtlQ29udGV4dCh0aGlzLCByZW5kZXJlZE5vZGUsIGlkeCk7XG4gICAgICAgIHJlc3VsdC5wdXNoKGNvbnRleHQuY29udmVydChyZW5kZXJlZE5vZGUpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0IGEgc2V0IG9mIG5vZGVzLCBidXQgdXBkYXRlIHRoZSBjb250ZXh0IGZvciB0aGUgbGFzdCBvbmUuXG4gICAqXG4gICAqIFRha2VzIHZpc2liaWxpdHkgaW50byBhY2NvdW50LlxuICAgKi9cbiAgcHVibGljIGNvbnZlcnRMYXN0RGlmZmVyZW50bHkobm9kZXM6IHJlYWRvbmx5IHRzLk5vZGVbXSwgbGFzdENvbnRleHQ6IEMpOiBPVHJlZVtdIHtcbiAgICBjb25zdCBsYXN0Q29udmVydGVyID0gdGhpcy51cGRhdGVDb250ZXh0KGxhc3RDb250ZXh0KTtcblxuICAgIGNvbnN0IGNvbnZlcnQgPSB0aGlzLmNvbnZlcnQuYmluZCh0aGlzKTtcbiAgICBjb25zdCBsYXN0Q29udmVydCA9IGxhc3RDb252ZXJ0ZXIuY29udmVydC5iaW5kKGxhc3RDb252ZXJ0ZXIpO1xuXG4gICAgY29uc3QgcmV0OiBPVHJlZVtdID0gW107XG5cbiAgICBjb25zdCB2aXMgPSBhc3NpZ25WaXNpYmlsaXR5KG5vZGVzKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZpcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3Qgd2hpY2hDb252ZXJ0ID0gaSA9PT0gdmlzLmxlbmd0aCAtIDEgPyBsYXN0Q29udmVydCA6IGNvbnZlcnQ7XG5cbiAgICAgIGNvbnN0IG5vZGUgPSB2aXNbaV0udmlzaWJsZSA/IHZpc1tpXS5ub2RlIDogdmlzW2ldLm1hc2tpbmdWb2lkO1xuICAgICAgaWYgKG5vZGUpIHtcbiAgICAgICAgcmV0LnB1c2god2hpY2hDb252ZXJ0KG5vZGUpKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmV0O1xuICB9XG5cbiAgcHVibGljIGdldFBvc2l0aW9uKG5vZGU6IHRzLk5vZGUpOiBTcGFuIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhcnQ6IG5vZGUuZ2V0U3RhcnQodGhpcy5zb3VyY2VGaWxlKSxcbiAgICAgIGVuZDogbm9kZS5nZXRFbmQoKSxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIHRleHRPZihub2RlOiB0cy5Ob2RlKTogc3RyaW5nIHtcbiAgICByZXR1cm4gbm9kZS5nZXRUZXh0KHRoaXMuc291cmNlRmlsZSk7XG4gIH1cblxuICBwdWJsaWMgdGV4dEF0KHBvczogbnVtYmVyLCBlbmQ6IG51bWJlcik6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuc291cmNlRmlsZS50ZXh0LnN1YnN0cmluZyhwb3MsIGVuZCk7XG4gIH1cblxuICAvKipcbiAgICogSW5mZXIgdHlwZSBvZiBleHByZXNzaW9uIGJ5IHRoZSBhcmd1bWVudCBpdCBpcyBhc3NpZ25lZCB0b1xuICAgKlxuICAgKiBJZiB0aGUgdHlwZSBvZiB0aGUgZXhwcmVzc2lvbiBjYW4gaW5jbHVkZSB1bmRlZmluZWQgKGlmIHRoZSB2YWx1ZSBpc1xuICAgKiBvcHRpb25hbCksIGB1bmRlZmluZWRgIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSB1bmlvbi5cbiAgICpcbiAgICogKFdpbGwgcmV0dXJuIHVuZGVmaW5lZCBmb3Igb2JqZWN0IGxpdGVyYWxzIG5vdCB1bmlmaWVkIHdpdGggYSBkZWNsYXJlZCB0eXBlKVxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCBVc2UgYGluZmVycmVkVHlwZU9mRXhwcmVzc2lvbmAgaW5zdGVhZFxuICAgKi9cbiAgcHVibGljIGluZmVycmVkVHlwZU9mRXhwcmVzc2lvbihub2RlOiB0cy5FeHByZXNzaW9uKSB7XG4gICAgcmV0dXJuIGluZmVycmVkVHlwZU9mRXhwcmVzc2lvbih0aGlzLnR5cGVDaGVja2VyLCBub2RlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUeXBlIG9mIGV4cHJlc3Npb24gZnJvbSB0aGUgdGV4dCBvZiB0aGUgZXhwcmVzc2lvblxuICAgKlxuICAgKiAoV2lsbCByZXR1cm4gYSBtYXAgdHlwZSBmb3Igb2JqZWN0IGxpdGVyYWxzKVxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCBVc2UgYHR5cGVPZkV4cHJlc3Npb25gIGRpcmVjdGx5XG4gICAqL1xuICBwdWJsaWMgdHlwZU9mRXhwcmVzc2lvbihub2RlOiB0cy5FeHByZXNzaW9uKTogdHMuVHlwZSB7XG4gICAgcmV0dXJuIHR5cGVPZkV4cHJlc3Npb24odGhpcy50eXBlQ2hlY2tlciwgbm9kZSk7XG4gIH1cblxuICBwdWJsaWMgdHlwZU9mVHlwZShub2RlOiB0cy5UeXBlTm9kZSk6IHRzLlR5cGUge1xuICAgIHJldHVybiB0aGlzLnR5cGVDaGVja2VyLmdldFR5cGVGcm9tVHlwZU5vZGUobm9kZSk7XG4gIH1cblxuICBwdWJsaWMgdHlwZVRvU3RyaW5nKHR5cGU6IHRzLlR5cGUpIHtcbiAgICByZXR1cm4gdGhpcy50eXBlQ2hlY2tlci50eXBlVG9TdHJpbmcodHlwZSk7XG4gIH1cblxuICBwdWJsaWMgcmVwb3J0KG5vZGU6IHRzLk5vZGUsIG1lc3NhZ2VUZXh0OiBzdHJpbmcsIGNhdGVnb3J5OiB0cy5EaWFnbm9zdGljQ2F0ZWdvcnkgPSB0cy5EaWFnbm9zdGljQ2F0ZWdvcnkuRXJyb3IpIHtcbiAgICB0aGlzLmRpYWdub3N0aWNzLnB1c2goe1xuICAgICAgY2F0ZWdvcnksXG4gICAgICBjb2RlOiAwLFxuICAgICAgc291cmNlOiAncm9zZXR0YScsXG4gICAgICBtZXNzYWdlVGV4dCxcbiAgICAgIGZpbGU6IHRoaXMuc291cmNlRmlsZSxcbiAgICAgIHN0YXJ0OiBub2RlLmdldFN0YXJ0KHRoaXMuc291cmNlRmlsZSksXG4gICAgICBsZW5ndGg6IG5vZGUuZ2V0V2lkdGgodGhpcy5zb3VyY2VGaWxlKSxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyByZXBvcnRVbnN1cHBvcnRlZChub2RlOiB0cy5Ob2RlLCBsYW5ndWFnZTogVGFyZ2V0TGFuZ3VhZ2UgfCB1bmRlZmluZWQpOiB2b2lkIHtcbiAgICBjb25zdCBub2RlS2luZCA9IHRzLlN5bnRheEtpbmRbbm9kZS5raW5kXTtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgaWYgKGxhbmd1YWdlKSB7XG4gICAgICB0aGlzLnJlcG9ydChcbiAgICAgICAgbm9kZSxcbiAgICAgICAgYFRoaXMgVHlwZVNjcmlwdCBmZWF0dXJlICgke25vZGVLaW5kfSkgaXMgbm90IHN1cHBvcnRlZCBpbiBleGFtcGxlcyBiZWNhdXNlIHdlIGNhbm5vdCB0cmFuc2xhdGUgaXQgdG8gJHtsYW5ndWFnZX0uIFBsZWFzZSByZXdyaXRlIHRoaXMgZXhhbXBsZS5gLFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yZXBvcnQoXG4gICAgICAgIG5vZGUsXG4gICAgICAgIGBUaGlzIFR5cGVTY3JpcHQgZmVhdHVyZSAoJHtub2RlS2luZH0pIGlzIG5vdCBzdXBwb3J0ZWQgaW4gZXhhbXBsZXMuIFBsZWFzZSByZXdyaXRlIHRoaXMgZXhhbXBsZS5gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogV2hldGhlciB0aGVyZSBpcyBub24td2hpdGVzcGFjZSBvbiB0aGUgc2FtZSBsaW5lIGJlZm9yZSB0aGUgZ2l2ZW4gcG9zaXRpb25cbiAgICovXG4gIHB1YmxpYyBjb2RlT25MaW5lQmVmb3JlKHBvczogbnVtYmVyKSB7XG4gICAgY29uc3QgdGV4dCA9IHRoaXMuc291cmNlRmlsZS50ZXh0O1xuICAgIHdoaWxlIChwb3MgPiAwKSB7XG4gICAgICBjb25zdCBjID0gdGV4dFstLXBvc107XG4gICAgICBpZiAoYyA9PT0gJ1xcbicpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKGMgIT09ICcgJyAmJiBjICE9PSAnXFxyJyAmJiBjICE9PSAnXFx0Jykge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiBhIG5ld2xpbmUgaWYgdGhlIGdpdmVuIG5vZGUgaXMgcHJlY2VkZWQgYnkgYXQgbGVhc3Qgb25lIG5ld2xpbmVcbiAgICpcbiAgICogVXNlZCB0byBtaXJyb3IgbmV3bGluZSB1c2UgYmV0d2VlbiBtYXRjaGluIGJyYWNrZXRzIChzdWNoIGFzIHsgLi4uIH0gYW5kIFsgLi4uIF0pLlxuICAgKi9cbiAgcHVibGljIG1pcnJvck5ld2xpbmVCZWZvcmUodml6PzogdHMuTm9kZSwgc3VmZml4ID0gJycsIG90aGVyd2lzZSA9ICcnKTogc3RyaW5nIHtcbiAgICBpZiAodml6ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBzdWZmaXg7XG4gICAgfVxuXG4gICAgLy8gUmV0dXJuIGEgbmV3bGluZSBpZiB0aGUgZ2l2ZW4gbm9kZSBpcyBwcmVjZWRlZCBieSBuZXdsaW5lc1xuICAgIGNvbnN0IGxlYWRpbmdSYW5nZXMgPSBzY2FuVGV4dCh0aGlzLnNvdXJjZUZpbGUudGV4dCwgdml6LmdldEZ1bGxTdGFydCgpLCB2aXouZ2V0U3RhcnQodGhpcy5zb3VyY2VGaWxlKSk7XG4gICAgY29uc3QgbmV3bGluZXMgPSBbXTtcblxuICAgIGZvciAoY29uc3QgcmFuZ2Ugb2YgbGVhZGluZ1Jhbmdlcykge1xuICAgICAgaWYgKHJhbmdlLnR5cGUgPT09ICdvdGhlcicpIHtcbiAgICAgICAgbmV3bGluZXMucHVzaChyZXBlYXROZXdsaW5lcyh0aGlzLnNvdXJjZUZpbGUudGV4dC5zdWJzdHJpbmcocmFuZ2UucG9zLCByYW5nZS5lbmQpKSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIChuZXdsaW5lcy5qb2luKCcnKS5sZW5ndGggPiAwID8gJ1xcbicgOiBvdGhlcndpc2UpICsgc3VmZml4O1xuICB9XG5cbiAgLyoqXG4gICAqIERpc3BhdGNoIG5vZGUgdG8gaGFuZGxlclxuICAgKi9cbiAgcHJpdmF0ZSBkaXNwYXRjaCh0cmVlOiB0cy5Ob2RlKTogT1RyZWUge1xuICAgIC8vIFNwZWNpYWwgbm9kZXNcbiAgICBpZiAodHMuaXNFbXB0eVN0YXRlbWVudCh0cmVlKSkge1xuICAgICAgLy8gQWRkaXRpb25hbCBzZW1pY29sb24gd2hlcmUgaXQgZG9lc24ndCBiZWxvbmcuXG4gICAgICByZXR1cm4gTk9fU1lOVEFYO1xuICAgIH1cblxuICAgIGNvbnN0IHZpc2l0b3IgPSB0aGlzLmhhbmRsZXI7XG5cbiAgICAvLyBOb2RlcyB3aXRoIG1lYW5pbmdcbiAgICBpZiAodHMuaXNTb3VyY2VGaWxlKHRyZWUpKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5zb3VyY2VGaWxlKHRyZWUsIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNJbXBvcnRFcXVhbHNEZWNsYXJhdGlvbih0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3IuaW1wb3J0U3RhdGVtZW50KGFuYWx5emVJbXBvcnRFcXVhbHModHJlZSwgdGhpcyksIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNJbXBvcnREZWNsYXJhdGlvbih0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3IuaW1wb3J0U3RhdGVtZW50KGFuYWx5emVJbXBvcnREZWNsYXJhdGlvbih0cmVlLCB0aGlzKSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICh0cy5pc1N0cmluZ0xpdGVyYWwodHJlZSkgfHwgdHMuaXNOb1N1YnN0aXR1dGlvblRlbXBsYXRlTGl0ZXJhbCh0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3Iuc3RyaW5nTGl0ZXJhbCh0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzRnVuY3Rpb25EZWNsYXJhdGlvbih0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3IuZnVuY3Rpb25EZWNsYXJhdGlvbih0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzSWRlbnRpZmllcih0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3IuaWRlbnRpZmllcih0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzQmxvY2sodHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLmJsb2NrKHRyZWUsIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNQYXJhbWV0ZXIodHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLnBhcmFtZXRlckRlY2xhcmF0aW9uKHRyZWUsIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNSZXR1cm5TdGF0ZW1lbnQodHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLnJldHVyblN0YXRlbWVudCh0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzQmluYXJ5RXhwcmVzc2lvbih0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3IuYmluYXJ5RXhwcmVzc2lvbih0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzSWZTdGF0ZW1lbnQodHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLmlmU3RhdGVtZW50KHRyZWUsIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNQcm9wZXJ0eUFjY2Vzc0V4cHJlc3Npb24odHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLnByb3BlcnR5QWNjZXNzRXhwcmVzc2lvbih0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzQ2FsbEV4cHJlc3Npb24odHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLmNhbGxFeHByZXNzaW9uKHRyZWUsIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNFeHByZXNzaW9uU3RhdGVtZW50KHRyZWUpKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5leHByZXNzaW9uU3RhdGVtZW50KHRyZWUsIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNUb2tlbih0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3IudG9rZW4odHJlZSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICh0cy5pc09iamVjdExpdGVyYWxFeHByZXNzaW9uKHRyZWUpKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5vYmplY3RMaXRlcmFsRXhwcmVzc2lvbih0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzTmV3RXhwcmVzc2lvbih0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3IubmV3RXhwcmVzc2lvbih0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzUHJvcGVydHlBc3NpZ25tZW50KHRyZWUpKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5wcm9wZXJ0eUFzc2lnbm1lbnQodHJlZSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICh0cy5pc1ZhcmlhYmxlU3RhdGVtZW50KHRyZWUpKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci52YXJpYWJsZVN0YXRlbWVudCh0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzVmFyaWFibGVEZWNsYXJhdGlvbkxpc3QodHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLnZhcmlhYmxlRGVjbGFyYXRpb25MaXN0KHRyZWUsIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNWYXJpYWJsZURlY2xhcmF0aW9uKHRyZWUpKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci52YXJpYWJsZURlY2xhcmF0aW9uKHRyZWUsIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNKU0RvYyh0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3IuanNEb2ModHJlZSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICh0cy5pc0FycmF5TGl0ZXJhbEV4cHJlc3Npb24odHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLmFycmF5TGl0ZXJhbEV4cHJlc3Npb24odHJlZSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICh0cy5pc1Nob3J0aGFuZFByb3BlcnR5QXNzaWdubWVudCh0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3Iuc2hvcnRoYW5kUHJvcGVydHlBc3NpZ25tZW50KHRyZWUsIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNGb3JPZlN0YXRlbWVudCh0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3IuZm9yT2ZTdGF0ZW1lbnQodHJlZSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICh0cy5pc0NsYXNzRGVjbGFyYXRpb24odHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLmNsYXNzRGVjbGFyYXRpb24odHJlZSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICh0cy5pc0NvbnN0cnVjdG9yRGVjbGFyYXRpb24odHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLmNvbnN0cnVjdG9yRGVjbGFyYXRpb24odHJlZSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICh0cy5pc1Byb3BlcnR5RGVjbGFyYXRpb24odHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLnByb3BlcnR5RGVjbGFyYXRpb24odHJlZSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICh0cy5pc0NvbXB1dGVkUHJvcGVydHlOYW1lKHRyZWUpKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5jb21wdXRlZFByb3BlcnR5TmFtZSh0cmVlLmV4cHJlc3Npb24sIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNNZXRob2REZWNsYXJhdGlvbih0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3IubWV0aG9kRGVjbGFyYXRpb24odHJlZSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICh0cy5pc0ludGVyZmFjZURlY2xhcmF0aW9uKHRyZWUpKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5pbnRlcmZhY2VEZWNsYXJhdGlvbih0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzUHJvcGVydHlTaWduYXR1cmUodHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLnByb3BlcnR5U2lnbmF0dXJlKHRyZWUsIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNNZXRob2RTaWduYXR1cmUodHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLm1ldGhvZFNpZ25hdHVyZSh0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzQXNFeHByZXNzaW9uKHRyZWUpKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5hc0V4cHJlc3Npb24odHJlZSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICh0cy5pc1ByZWZpeFVuYXJ5RXhwcmVzc2lvbih0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3IucHJlZml4VW5hcnlFeHByZXNzaW9uKHRyZWUsIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNTcHJlYWRBc3NpZ25tZW50KHRyZWUpKSB7XG4gICAgICBpZiAodGhpcy50ZXh0T2YodHJlZSkgPT09ICcuLi4nKSB7XG4gICAgICAgIHJldHVybiB2aXNpdG9yLmVsbGlwc2lzKHRyZWUsIHRoaXMpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHZpc2l0b3Iuc3ByZWFkQXNzaWdubWVudCh0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzU3ByZWFkRWxlbWVudCh0cmVlKSkge1xuICAgICAgaWYgKHRoaXMudGV4dE9mKHRyZWUpID09PSAnLi4uJykge1xuICAgICAgICByZXR1cm4gdmlzaXRvci5lbGxpcHNpcyh0cmVlLCB0aGlzKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB2aXNpdG9yLnNwcmVhZEVsZW1lbnQodHJlZSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICh0cy5pc0VsZW1lbnRBY2Nlc3NFeHByZXNzaW9uKHRyZWUpKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5lbGVtZW50QWNjZXNzRXhwcmVzc2lvbih0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzVGVtcGxhdGVFeHByZXNzaW9uKHRyZWUpKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci50ZW1wbGF0ZUV4cHJlc3Npb24odHJlZSwgdGhpcyk7XG4gICAgfVxuICAgIGlmICh0cy5pc05vbk51bGxFeHByZXNzaW9uKHRyZWUpKSB7XG4gICAgICByZXR1cm4gdmlzaXRvci5ub25OdWxsRXhwcmVzc2lvbih0cmVlLCB0aGlzKTtcbiAgICB9XG4gICAgaWYgKHRzLmlzUGFyZW50aGVzaXplZEV4cHJlc3Npb24odHJlZSkpIHtcbiAgICAgIHJldHVybiB2aXNpdG9yLnBhcmVudGhlc2l6ZWRFeHByZXNzaW9uKHRyZWUsIHRoaXMpO1xuICAgIH1cbiAgICBpZiAodHMuaXNWb2lkRXhwcmVzc2lvbih0cmVlKSkge1xuICAgICAgcmV0dXJuIHZpc2l0b3IubWFza2luZ1ZvaWRFeHByZXNzaW9uKHRyZWUsIHRoaXMpO1xuICAgIH1cblxuICAgIHRoaXMucmVwb3J0VW5zdXBwb3J0ZWQodHJlZSwgdW5kZWZpbmVkKTtcblxuICAgIGlmICh0aGlzLm9wdGlvbnMuYmVzdEVmZm9ydCAhPT0gZmFsc2UpIHtcbiAgICAgIC8vIFdoZW4gZG9pbmcgYmVzdC1lZmZvcnQgY29udmVyc2lvbiBhbmQgd2UgZG9uJ3QgdW5kZXJzdGFuZCB0aGUgbm9kZSB0eXBlLCBqdXN0IHJldHVybiB0aGUgY29tcGxldGUgdGV4dCBvZiBpdCBhcy1pc1xuICAgICAgcmV0dXJuIG5ldyBPVHJlZShbdGhpcy50ZXh0T2YodHJlZSldKTtcbiAgICB9XG4gICAgLy8gT3RoZXJ3aXNlLCBzaG93IGEgcGxhY2Vob2xkZXIgaW5kaWNhdGluZyB3ZSBkb24ndCByZWNvZ25pemUgdGhlIHR5cGVcbiAgICBjb25zdCBub2RlS2luZCA9IHRzLlN5bnRheEtpbmRbdHJlZS5raW5kXTtcbiAgICByZXR1cm4gbmV3IFVua25vd25TeW50YXgoXG4gICAgICBbYDwke25vZGVLaW5kfSAke3RoaXMudGV4dE9mKHRyZWUpfT5gXSxcbiAgICAgIFsnXFxuJywgLi4ubm9kZUNoaWxkcmVuKHRyZWUpLm1hcCh0aGlzLmNvbnZlcnQuYmluZCh0aGlzKSldLFxuICAgICAge1xuICAgICAgICBpbmRlbnQ6IDIsXG4gICAgICB9LFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQXR0YWNoIGFueSBsZWFkaW5nIHdoaXRlc3BhY2UgYW5kIGNvbW1lbnRzIHRvIHRoZSBnaXZlbiBvdXRwdXQgdHJlZVxuICAgKlxuICAgKiBSZWdhcmRsZXNzIG9mIHdoZXRoZXIgaXQncyBkZWNsYXJlZCB0byBiZSBhYmxlIHRvIGFjY2VwdCBzdWNoIG9yIG5vdC5cbiAgICovXG4gIHByaXZhdGUgYXR0YWNoTGVhZGluZ1RyaXZpYShub2RlOiB0cy5Ob2RlLCB0cmFuc2Zvcm1lZDogT1RyZWUpOiBPVHJlZSB7XG4gICAgLy8gQWRkIGNvbW1lbnRzIGFuZCBsZWFkaW5nIHdoaXRlc3BhY2VcbiAgICBjb25zdCBsZWFkaW5nUmFuZ2VzID0gc2NhblRleHQodGhpcy5zb3VyY2VGaWxlLnRleHQsIG5vZGUuZ2V0RnVsbFN0YXJ0KCksIG5vZGUuZ2V0U3RhcnQodGhpcy5zb3VyY2VGaWxlKSk7XG5cbiAgICBjb25zdCBwcmVjZWRlOiBPVHJlZVtdID0gW107XG4gICAgZm9yIChjb25zdCByYW5nZSBvZiBsZWFkaW5nUmFuZ2VzKSB7XG4gICAgICBsZXQgdHJpdmlhOiBPVHJlZSB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgICAgIHN3aXRjaCAocmFuZ2UudHlwZSkge1xuICAgICAgICBjYXNlICdvdGhlcic6XG4gICAgICAgICAgdHJpdmlhID0gbmV3IE9UcmVlKFtyZXBlYXROZXdsaW5lcyh0aGlzLnNvdXJjZUZpbGUudGV4dC5zdWJzdHJpbmcocmFuZ2UucG9zLCByYW5nZS5lbmQpKV0sIFtdLCB7XG4gICAgICAgICAgICByZW5kZXJPbmNlOiBgd3MtJHtyYW5nZS5wb3N9YCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnbGluZWNvbW1lbnQnOlxuICAgICAgICBjYXNlICdibG9ja2NvbW1lbnQnOlxuICAgICAgICAgIHRyaXZpYSA9IHRoaXMuaGFuZGxlci5jb21tZW50UmFuZ2UoXG4gICAgICAgICAgICBjb21tZW50U3ludGF4RnJvbUNvbW1lbnRSYW5nZShjb21tZW50UmFuZ2VGcm9tVGV4dFJhbmdlKHJhbmdlKSwgdGhpcyksXG4gICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnZGlyZWN0aXZlJzpcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGlmICh0cml2aWEgIT0gbnVsbCkge1xuICAgICAgICAvLyBTZXQgc3BhbnMgb24gY29tbWVudHMgdG8gbWFrZSBzdXJlIHRoZWlyIHZpc2liaWxpdHkgaXMgdG9nZ2xlZCBjb3JyZWN0bHkuXG4gICAgICAgIHRyaXZpYS5zZXRTcGFuKHJhbmdlLnBvcywgcmFuZ2UuZW5kKTtcbiAgICAgICAgcHJlY2VkZS5wdXNoKHRyaXZpYSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gRklYTUU6IE5vIHRyYWlsaW5nIGNvbW1lbnRzIGZvciBub3csIHRoZXkncmUgdG9vIHRyaWNreVxuXG4gICAgaWYgKHByZWNlZGUubGVuZ3RoID4gMCAmJiAhdHJhbnNmb3JtZWQuaXNFbXB0eSkge1xuICAgICAgcmV0dXJuIG5ldyBPVHJlZShbLi4ucHJlY2VkZSwgdHJhbnNmb3JtZWRdLCBbXSwgeyBjYW5CcmVha0xpbmU6IHRydWUgfSk7XG4gICAgfVxuICAgIHJldHVybiB0cmFuc2Zvcm1lZDtcbiAgfVxufVxuXG4vKipcbiAqIEludGVyZmFjZSBmb3IgQVNUIGhhbmRsZXJzXG4gKlxuICogQyBpcyB0aGUgdHlwZSBvZiBoaWVyYXJjaGljYWwgY29udGV4dCB0aGUgaGFuZGxlciB1c2VzLiBDb250ZXh0XG4gKiBuZWVkcyAyIG9wZXJhdGlvbnM6IGEgY29uc3RydWN0b3IgZm9yIGEgZGVmYXVsdCBjb250ZXh0LCBhbmQgYVxuICogbWVyZ2Ugb3BlcmF0aW9uIHRvIGNvbWJpbmUgMiBjb250ZXh0cyB0byB5aWVsZCBhIG5ldyBvbmUuXG4gKlxuICogT3RoZXJ3aXNlLCB0aGUgaGFuZGxlciBzaG91bGQgcmV0dXJuIGFuIE9UcmVlIGZvciBldmVyeSB0eXBlXG4gKiBvZiBBU1Qgbm9kZS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBBc3RIYW5kbGVyPEM+IHtcbiAgcmVhZG9ubHkgZGVmYXVsdENvbnRleHQ6IEM7XG4gIG1lcmdlQ29udGV4dChvbGQ6IEMsIHVwZGF0ZTogUGFydGlhbDxDPik6IEM7XG5cbiAgc291cmNlRmlsZShub2RlOiB0cy5Tb3VyY2VGaWxlLCBjb250ZXh0OiBBc3RSZW5kZXJlcjxDPik6IE9UcmVlO1xuICBjb21tZW50UmFuZ2Uobm9kZTogQ29tbWVudFN5bnRheCwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgaW1wb3J0U3RhdGVtZW50KG5vZGU6IEltcG9ydFN0YXRlbWVudCwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgc3RyaW5nTGl0ZXJhbChub2RlOiB0cy5TdHJpbmdMaXRlcmFsIHwgdHMuTm9TdWJzdGl0dXRpb25UZW1wbGF0ZUxpdGVyYWwsIGNoaWxkcmVuOiBBc3RSZW5kZXJlcjxDPik6IE9UcmVlO1xuICBmdW5jdGlvbkRlY2xhcmF0aW9uKG5vZGU6IHRzLkZ1bmN0aW9uRGVjbGFyYXRpb24sIGNoaWxkcmVuOiBBc3RSZW5kZXJlcjxDPik6IE9UcmVlO1xuICBpZGVudGlmaWVyKG5vZGU6IHRzLklkZW50aWZpZXIsIGNoaWxkcmVuOiBBc3RSZW5kZXJlcjxDPik6IE9UcmVlO1xuICBibG9jayhub2RlOiB0cy5CbG9jaywgY2hpbGRyZW46IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG4gIHBhcmFtZXRlckRlY2xhcmF0aW9uKG5vZGU6IHRzLlBhcmFtZXRlckRlY2xhcmF0aW9uLCBjaGlsZHJlbjogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgcmV0dXJuU3RhdGVtZW50KG5vZGU6IHRzLlJldHVyblN0YXRlbWVudCwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgYmluYXJ5RXhwcmVzc2lvbihub2RlOiB0cy5CaW5hcnlFeHByZXNzaW9uLCBjb250ZXh0OiBBc3RSZW5kZXJlcjxDPik6IE9UcmVlO1xuICBpZlN0YXRlbWVudChub2RlOiB0cy5JZlN0YXRlbWVudCwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgcHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uKG5vZGU6IHRzLlByb3BlcnR5QWNjZXNzRXhwcmVzc2lvbiwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgY2FsbEV4cHJlc3Npb24obm9kZTogdHMuQ2FsbEV4cHJlc3Npb24sIGNvbnRleHQ6IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG4gIGV4cHJlc3Npb25TdGF0ZW1lbnQobm9kZTogdHMuRXhwcmVzc2lvblN0YXRlbWVudCwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgdG9rZW48QSBleHRlbmRzIHRzLlN5bnRheEtpbmQ+KG5vZGU6IHRzLlRva2VuPEE+LCBjb250ZXh0OiBBc3RSZW5kZXJlcjxDPik6IE9UcmVlO1xuICBvYmplY3RMaXRlcmFsRXhwcmVzc2lvbihub2RlOiB0cy5PYmplY3RMaXRlcmFsRXhwcmVzc2lvbiwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgbmV3RXhwcmVzc2lvbihub2RlOiB0cy5OZXdFeHByZXNzaW9uLCBjb250ZXh0OiBBc3RSZW5kZXJlcjxDPik6IE9UcmVlO1xuICBwcm9wZXJ0eUFzc2lnbm1lbnQobm9kZTogdHMuUHJvcGVydHlBc3NpZ25tZW50LCBjb250ZXh0OiBBc3RSZW5kZXJlcjxDPik6IE9UcmVlO1xuICB2YXJpYWJsZVN0YXRlbWVudChub2RlOiB0cy5WYXJpYWJsZVN0YXRlbWVudCwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgdmFyaWFibGVEZWNsYXJhdGlvbkxpc3Qobm9kZTogdHMuVmFyaWFibGVEZWNsYXJhdGlvbkxpc3QsIGNvbnRleHQ6IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG4gIHZhcmlhYmxlRGVjbGFyYXRpb24obm9kZTogdHMuVmFyaWFibGVEZWNsYXJhdGlvbiwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAganNEb2Mobm9kZTogdHMuSlNEb2MsIGNvbnRleHQ6IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG4gIGFycmF5TGl0ZXJhbEV4cHJlc3Npb24obm9kZTogdHMuQXJyYXlMaXRlcmFsRXhwcmVzc2lvbiwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgc2hvcnRoYW5kUHJvcGVydHlBc3NpZ25tZW50KG5vZGU6IHRzLlNob3J0aGFuZFByb3BlcnR5QXNzaWdubWVudCwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgZm9yT2ZTdGF0ZW1lbnQobm9kZTogdHMuRm9yT2ZTdGF0ZW1lbnQsIGNvbnRleHQ6IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG4gIGNsYXNzRGVjbGFyYXRpb24obm9kZTogdHMuQ2xhc3NEZWNsYXJhdGlvbiwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgY29uc3RydWN0b3JEZWNsYXJhdGlvbihub2RlOiB0cy5Db25zdHJ1Y3RvckRlY2xhcmF0aW9uLCBjb250ZXh0OiBBc3RSZW5kZXJlcjxDPik6IE9UcmVlO1xuICBwcm9wZXJ0eURlY2xhcmF0aW9uKG5vZGU6IHRzLlByb3BlcnR5RGVjbGFyYXRpb24sIGNvbnRleHQ6IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG4gIGNvbXB1dGVkUHJvcGVydHlOYW1lKG5vZGU6IHRzLkV4cHJlc3Npb24sIGNvbnRleHQ6IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG4gIG1ldGhvZERlY2xhcmF0aW9uKG5vZGU6IHRzLk1ldGhvZERlY2xhcmF0aW9uLCBjb250ZXh0OiBBc3RSZW5kZXJlcjxDPik6IE9UcmVlO1xuICBpbnRlcmZhY2VEZWNsYXJhdGlvbihub2RlOiB0cy5JbnRlcmZhY2VEZWNsYXJhdGlvbiwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgcHJvcGVydHlTaWduYXR1cmUobm9kZTogdHMuUHJvcGVydHlTaWduYXR1cmUsIGNvbnRleHQ6IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG4gIG1ldGhvZFNpZ25hdHVyZShub2RlOiB0cy5NZXRob2RTaWduYXR1cmUsIGNvbnRleHQ6IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG4gIGFzRXhwcmVzc2lvbihub2RlOiB0cy5Bc0V4cHJlc3Npb24sIGNvbnRleHQ6IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG4gIHByZWZpeFVuYXJ5RXhwcmVzc2lvbihub2RlOiB0cy5QcmVmaXhVbmFyeUV4cHJlc3Npb24sIGNvbnRleHQ6IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG4gIHNwcmVhZEVsZW1lbnQobm9kZTogdHMuU3ByZWFkRWxlbWVudCwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgc3ByZWFkQXNzaWdubWVudChub2RlOiB0cy5TcHJlYWRBc3NpZ25tZW50LCBjb250ZXh0OiBBc3RSZW5kZXJlcjxDPik6IE9UcmVlO1xuICB0ZW1wbGF0ZUV4cHJlc3Npb24obm9kZTogdHMuVGVtcGxhdGVFeHByZXNzaW9uLCBjb250ZXh0OiBBc3RSZW5kZXJlcjxDPik6IE9UcmVlO1xuICBub25OdWxsRXhwcmVzc2lvbihub2RlOiB0cy5Ob25OdWxsRXhwcmVzc2lvbiwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgcGFyZW50aGVzaXplZEV4cHJlc3Npb24obm9kZTogdHMuUGFyZW50aGVzaXplZEV4cHJlc3Npb24sIGNvbnRleHQ6IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG4gIG1hc2tpbmdWb2lkRXhwcmVzc2lvbihub2RlOiB0cy5Wb2lkRXhwcmVzc2lvbiwgY29udGV4dDogQXN0UmVuZGVyZXI8Qz4pOiBPVHJlZTtcbiAgZWxlbWVudEFjY2Vzc0V4cHJlc3Npb24obm9kZTogdHMuRWxlbWVudEFjY2Vzc0V4cHJlc3Npb24sIGNvbnRleHQ6IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG5cbiAgLy8gTm90IGEgbm9kZSwgY2FsbGVkIHdoZW4gd2UgcmVjb2duaXplIGEgc3ByZWFkIGVsZW1lbnQvYXNzaWdubWVudCB0aGF0IGlzIG9ubHlcbiAgLy8gJy4uLicgYW5kIG5vdGhpbmcgZWxzZS5cbiAgZWxsaXBzaXMobm9kZTogdHMuU3ByZWFkRWxlbWVudCB8IHRzLlNwcmVhZEFzc2lnbm1lbnQsIGNvbnRleHQ6IEFzdFJlbmRlcmVyPEM+KTogT1RyZWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBuaW1wbDxDPihub2RlOiB0cy5Ob2RlLCBjb250ZXh0OiBBc3RSZW5kZXJlcjxDPiwgb3B0aW9uczogeyBhZGRpdGlvbmFsSW5mbz86IHN0cmluZyB9ID0ge30pIHtcbiAgY29uc3QgY2hpbGRyZW4gPSBub2RlQ2hpbGRyZW4obm9kZSkubWFwKChjKSA9PiBjb250ZXh0LmNvbnZlcnQoYykpO1xuXG4gIGxldCBzeW50YXhLaW5kID0gdHMuU3ludGF4S2luZFtub2RlLmtpbmRdO1xuICBpZiAoc3ludGF4S2luZCA9PT0gJ0ZpcnN0UHVuY3R1YXRpb24nKSB7XG4gICAgLy8gVGhlc2UgaGF2ZSB0aGUgc2FtZSBpZGVudGlmaWVyIGJ1dCB0aGlzIG5hbWUgaXMgbW9yZSBkZXNjcmlwdGl2ZVxuICAgIHN5bnRheEtpbmQgPSAnT3BlbkJyYWNlVG9rZW4nO1xuICB9XG5cbiAgY29uc3QgcGFydHMgPSBbYCgke3N5bnRheEtpbmR9YF07XG4gIGlmIChvcHRpb25zLmFkZGl0aW9uYWxJbmZvKSB7XG4gICAgcGFydHMucHVzaChgeyR7b3B0aW9ucy5hZGRpdGlvbmFsSW5mb319YCk7XG4gIH1cbiAgcGFydHMucHVzaChjb250ZXh0LnRleHRPZihub2RlKSk7XG5cbiAgcmV0dXJuIG5ldyBVbmtub3duU3ludGF4KFtwYXJ0cy5qb2luKCcgJyldLCBjaGlsZHJlbi5sZW5ndGggPiAwID8gWydcXG4nLCAuLi5jaGlsZHJlbl0gOiBbXSwge1xuICAgIGluZGVudDogMixcbiAgICBzdWZmaXg6ICcpJyxcbiAgICBzZXBhcmF0b3I6ICdcXG4nLFxuICAgIGNhbkJyZWFrTGluZTogdHJ1ZSxcbiAgfSk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXN0UmVuZGVyZXJPcHRpb25zIHtcbiAgLyoqXG4gICAqIElmIGVuYWJsZWQsIGRvbid0IHRyYW5zbGF0ZSB0aGUgdGV4dCBvZiB1bmtub3duIG5vZGVzXG4gICAqXG4gICAqIEBkZWZhdWx0IHRydWVcbiAgICovXG4gIGJlc3RFZmZvcnQ/OiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgQ2xhc3NpZmllZE5vZGUge1xuICBub2RlOiB0cy5Ob2RlO1xuICB2aXNpYmxlOiBib29sZWFuO1xuICBtYXNraW5nVm9pZD86IHRzLlZvaWRFeHByZXNzaW9uO1xufVxuXG5mdW5jdGlvbiBmaWx0ZXJWaXNpYmxlKG5vZGVzOiByZWFkb25seSB0cy5Ob2RlW10pOiB0cy5Ob2RlW10ge1xuICByZXR1cm4gYXNzaWduVmlzaWJpbGl0eShub2RlcylcbiAgICAubWFwKChjKSA9PiAoYy52aXNpYmxlID8gYy5ub2RlIDogYy5tYXNraW5nVm9pZCkpXG4gICAgLmZpbHRlcihub3RVbmRlZmluZWQpO1xufVxuXG5mdW5jdGlvbiBhc3NpZ25WaXNpYmlsaXR5KG5vZGVzOiByZWFkb25seSB0cy5Ob2RlW10pOiBDbGFzc2lmaWVkTm9kZVtdIHtcbiAgY29uc3QgcmV0OiBDbGFzc2lmaWVkTm9kZVtdID0gW107XG5cbiAgbGV0IHZpc2libGUgPSB0cnVlO1xuICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIHtcbiAgICBjb25zdCBtYXNraW5nVm9pZCA9IGV4dHJhY3RNYXNraW5nVm9pZEV4cHJlc3Npb24obm9kZSk7XG4gICAgaWYgKHZpc2libGUgJiYgbWFza2luZ1ZvaWQpIHtcbiAgICAgIHZpc2libGUgPSBmYWxzZTtcbiAgICB9XG5cbiAgICByZXQucHVzaCh7IG5vZGUsIG1hc2tpbmdWb2lkLCB2aXNpYmxlIH0pO1xuXG4gICAgaWYgKCF2aXNpYmxlKSB7XG4gICAgICBjb25zdCBzaG93aW5nID0gZXh0cmFjdFNob3dpbmdWb2lkRXhwcmVzc2lvbihub2RlKTtcbiAgICAgIGlmIChzaG93aW5nKSB7XG4gICAgICAgIHZpc2libGUgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiByZXQ7XG59XG5cbmZ1bmN0aW9uIG5vdFVuZGVmaW5lZDxBPih4OiBBIHwgdW5kZWZpbmVkKTogeCBpcyBBIHtcbiAgcmV0dXJuIHggIT09IHVuZGVmaW5lZDtcbn1cblxuLyoqXG4gKiBPdXIgb3duIHJlcHJlc2VudGF0aW9uIG9mIGNvbW1lbnRzXG4gKlxuICogKFNvIHdlIGNhbiBzeW50aGVzaXplICdlbVxuICovXG5leHBvcnQgaW50ZXJmYWNlIENvbW1lbnRTeW50YXgge1xuICBwb3M6IG51bWJlcjtcbiAgdGV4dDogc3RyaW5nO1xuICBoYXNUcmFpbGluZ05ld0xpbmU/OiBib29sZWFuO1xuICBraW5kOiB0cy5Db21tZW50S2luZDtcblxuICAvKipcbiAgICogV2hldGhlciBpdCdzIGF0IHRoZSBlbmQgb2YgYSBjb2RlIGxpbmUgKHNvIHdlIGNhbiByZW5kZXIgYSBzZXBhcmF0aW5nIHNwYWNlKVxuICAgKi9cbiAgaXNUcmFpbGluZz86IGJvb2xlYW47XG59XG5cbmZ1bmN0aW9uIGNvbW1lbnRTeW50YXhGcm9tQ29tbWVudFJhbmdlKHJuZzogdHMuQ29tbWVudFJhbmdlLCByZW5kZXJlcjogQXN0UmVuZGVyZXI8YW55Pik6IENvbW1lbnRTeW50YXgge1xuICByZXR1cm4ge1xuICAgIGhhc1RyYWlsaW5nTmV3TGluZTogcm5nLmhhc1RyYWlsaW5nTmV3TGluZSxcbiAgICBraW5kOiBybmcua2luZCxcbiAgICBwb3M6IHJuZy5wb3MsXG4gICAgdGV4dDogcmVuZGVyZXIudGV4dEF0KHJuZy5wb3MsIHJuZy5lbmQpLFxuICAgIGlzVHJhaWxpbmc6IHJlbmRlcmVyLmNvZGVPbkxpbmVCZWZvcmUocm5nLnBvcyksXG4gIH07XG59XG4iXX0=
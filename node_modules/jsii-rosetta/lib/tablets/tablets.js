"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TranslatedSnippet = exports.LanguageTablet = exports.CURRENT_SCHEMA_VERSION = exports.DEFAULT_TABLET_NAME = void 0;
const fs = require("fs-extra");
const path = require("path");
const logging = require("../logging");
const snippet_1 = require("../snippet");
const util_1 = require("../util");
const key_1 = require("./key");
const schema_1 = require("./schema");
// eslint-disable-next-line @typescript-eslint/no-require-imports,@typescript-eslint/no-var-requires
const TOOL_VERSION = require('../../package.json').version;
exports.DEFAULT_TABLET_NAME = '.jsii.tabl.json';
exports.CURRENT_SCHEMA_VERSION = '2';
/**
 * A tablet containing various snippets in multiple languages
 */
class LanguageTablet {
    constructor() {
        this.snippets = {};
    }
    /**
     * Load a tablet from a file
     */
    static async fromFile(filename) {
        const ret = new LanguageTablet();
        await ret.load(filename);
        return ret;
    }
    /**
     * Load a tablet from a file that may not exist
     *
     * Will return an empty tablet if the file does not exist
     */
    static async fromOptionalFile(filename) {
        const ret = new LanguageTablet();
        if (fs.existsSync(filename)) {
            try {
                await ret.load(filename);
            }
            catch (e) {
                logging.warn(`${filename}: ${e}`);
            }
        }
        return ret;
    }
    /**
     * Add one or more snippets to this tablet
     */
    addSnippets(...snippets) {
        for (const snippet of snippets) {
            const existingSnippet = this.snippets[snippet.key];
            this.snippets[snippet.key] = existingSnippet ? existingSnippet.mergeTranslations(snippet) : snippet;
        }
    }
    /**
     * Add one snippet to this tablet
     *
     * @deprecated use addSnippets instead
     */
    addSnippet(snippet) {
        this.addSnippets(snippet);
    }
    get snippetKeys() {
        return Object.keys(this.snippets);
    }
    /**
     * Add all snippets from the given tablets into this one
     */
    addTablets(...tablets) {
        for (const tablet of tablets) {
            for (const snippet of Object.values(tablet.snippets)) {
                this.addSnippet(snippet);
            }
        }
    }
    /**
     * Add all snippets from the given tablet into this one
     *
     * @deprecated Use `addTablets()` instead.
     */
    addTablet(tablet) {
        this.addTablets(tablet);
    }
    tryGetSnippet(key) {
        return this.snippets[key];
    }
    /**
     * Look up a single translation of a source snippet
     *
     * @deprecated Use `lookupTranslationBySource` instead.
     */
    lookup(typeScriptSource, language) {
        return this.lookupTranslationBySource(typeScriptSource, language);
    }
    /**
     * Look up a single translation of a source snippet
     */
    lookupTranslationBySource(typeScriptSource, language) {
        const snippet = this.snippets[key_1.snippetKey(typeScriptSource)];
        return snippet === null || snippet === void 0 ? void 0 : snippet.get(language);
    }
    /**
     * Lookup the translated verion of a TypeScript snippet
     */
    lookupBySource(typeScriptSource) {
        return this.snippets[key_1.snippetKey(typeScriptSource)];
    }
    async load(filename) {
        const obj = (await fs.readJson(filename, { encoding: 'utf-8' }));
        if (!obj.toolVersion || !obj.snippets) {
            throw new Error(`File '${filename}' does not seem to be a Tablet file`);
        }
        if (obj.version !== exports.CURRENT_SCHEMA_VERSION) {
            // If we're ever changing the schema version in a backwards incompatible way,
            // do upconversion here.
            throw new Error(`Tablet file '${filename}' has schema version '${obj.version}', this program expects '${exports.CURRENT_SCHEMA_VERSION}'`);
        }
        Object.assign(this.snippets, util_1.mapValues(obj.snippets, TranslatedSnippet.fromSchema));
    }
    get count() {
        return Object.keys(this.snippets).length;
    }
    get translatedSnippets() {
        return Object.values(this.snippets);
    }
    async save(filename) {
        await fs.mkdirp(path.dirname(filename));
        await fs.writeJson(filename, this.toSchema(), {
            encoding: 'utf-8',
            spaces: 2,
        });
    }
    toSchema() {
        return {
            version: exports.CURRENT_SCHEMA_VERSION,
            toolVersion: TOOL_VERSION,
            snippets: util_1.mapValues(this.snippets, (s) => s.snippet),
        };
    }
}
exports.LanguageTablet = LanguageTablet;
/**
 * Mutable operations on an underlying TranslatedSnippetSchema
 */
class TranslatedSnippet {
    constructor(snippet) {
        this._snippet = { ...snippet };
        this.snippet = this._snippet;
    }
    static fromSchema(schema) {
        if (!schema.translations[schema_1.ORIGINAL_SNIPPET_KEY]) {
            throw new Error(`Input schema must have '${schema_1.ORIGINAL_SNIPPET_KEY}' key set in translations`);
        }
        return new TranslatedSnippet(schema);
    }
    static fromTypeScript(original, didCompile) {
        return new TranslatedSnippet({
            translations: {
                [schema_1.ORIGINAL_SNIPPET_KEY]: { source: original.visibleSource, version: '0' },
            },
            didCompile: didCompile,
            location: original.location,
            fullSource: snippet_1.completeSource(original),
        });
    }
    get key() {
        if (this._key === undefined) {
            this._key = key_1.snippetKey(this.asTypescriptSnippet());
        }
        return this._key;
    }
    get originalSource() {
        return {
            source: this.snippet.translations[schema_1.ORIGINAL_SNIPPET_KEY].source,
            language: 'typescript',
            didCompile: this.snippet.didCompile,
        };
    }
    addTranslation(language, translation, version) {
        this.snippet.translations[language] = { source: translation, version };
        return {
            source: translation,
            language,
            didCompile: this.snippet.didCompile,
        };
    }
    fqnsReferenced() {
        var _a;
        return (_a = this._snippet.fqnsReferenced) !== null && _a !== void 0 ? _a : [];
    }
    addSyntaxKindCounter(syntaxKindCounter) {
        var _a;
        if (!this._snippet.syntaxKindCounter) {
            this._snippet.syntaxKindCounter = {};
        }
        for (const [key, value] of Object.entries(syntaxKindCounter)) {
            const x = (_a = this._snippet.syntaxKindCounter[key]) !== null && _a !== void 0 ? _a : 0;
            this._snippet.syntaxKindCounter[key] = value + x;
        }
    }
    get languages() {
        return Object.keys(this.snippet.translations).filter((x) => x !== schema_1.ORIGINAL_SNIPPET_KEY);
    }
    get(language) {
        const t = this.snippet.translations[language];
        return t && { source: t.source, language, didCompile: this.snippet.didCompile };
    }
    mergeTranslations(other) {
        return new TranslatedSnippet({
            ...this.snippet,
            translations: { ...this.snippet.translations, ...other.snippet.translations },
        });
    }
    withFingerprint(fp) {
        return new TranslatedSnippet({
            ...this.snippet,
            fqnsFingerprint: fp,
        });
    }
    withLocation(location) {
        return new TranslatedSnippet({
            ...this.snippet,
            location,
        });
    }
    toJSON() {
        return this._snippet;
    }
    asTypescriptSnippet() {
        return {
            visibleSource: this.snippet.translations[schema_1.ORIGINAL_SNIPPET_KEY].source,
            location: this.snippet.location,
        };
    }
}
exports.TranslatedSnippet = TranslatedSnippet;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGV0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRhYmxldHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQStCO0FBQy9CLDZCQUE2QjtBQUc3QixzQ0FBc0M7QUFDdEMsd0NBQWdGO0FBQ2hGLGtDQUFvQztBQUNwQywrQkFBbUM7QUFDbkMscUNBQXVGO0FBRXZGLG9HQUFvRztBQUNwRyxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFFOUMsUUFBQSxtQkFBbUIsR0FBRyxpQkFBaUIsQ0FBQztBQUV4QyxRQUFBLHNCQUFzQixHQUFHLEdBQUcsQ0FBQztBQUUxQzs7R0FFRztBQUNILE1BQWEsY0FBYztJQUEzQjtRQTJCbUIsYUFBUSxHQUFzQyxFQUFFLENBQUM7SUFxSHBFLENBQUM7SUEvSUM7O09BRUc7SUFDSSxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxRQUFnQjtRQUMzQyxNQUFNLEdBQUcsR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDO1FBQ2pDLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN6QixPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksTUFBTSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFnQjtRQUNuRCxNQUFNLEdBQUcsR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDO1FBQ2pDLElBQUksRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUMzQixJQUFJO2dCQUNGLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUMxQjtZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNWLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUNuQztTQUNGO1FBQ0QsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFD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O1lBQ2YsWUFBWSxFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFO1NBQzlFLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTSxlQUFlLENBQUMsRUFBVTtRQUMvQixPQUFPLElBQUksaUJBQWlCLENBQUM7WUFDM0IsR0FBRyxJQUFJLENBQUMsT0FBTztZQUNmLGVBQWUsRUFBRSxFQUFFO1NBQ3BCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTSxZQUFZLENBQUMsUUFBeUI7UUFDM0MsT0FBTyxJQUFJLGlCQUFpQixDQUFDO1lBQzNCLEdBQUcsSUFBSSxDQUFDLE9BQU87WUFDZixRQUFRO1NBQ1QsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLE1BQU07UUFDWCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdkIsQ0FBQztJQUVPLG1CQUFtQjtRQUN6QixPQUFPO1lBQ0wsYUFBYSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLDZCQUFvQixDQUFDLENBQUMsTUFBTTtZQUNyRSxRQUFRLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRO1NBQ2hDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUE1R0QsOENBNEdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IHsgVGFyZ2V0TGFuZ3VhZ2UgfSBmcm9tICcuLi9sYW5ndWFnZXMnO1xuaW1wb3J0ICogYXMgbG9nZ2luZyBmcm9tICcuLi9sb2dnaW5nJztcbmltcG9ydCB7IFR5cGVTY3JpcHRTbmlwcGV0LCBTbmlwcGV0TG9jYXRpb24sIGNvbXBsZXRlU291cmNlIH0gZnJvbSAnLi4vc25pcHBldCc7XG5pbXBvcnQgeyBtYXBWYWx1ZXMgfSBmcm9tICcuLi91dGlsJztcbmltcG9ydCB7IHNuaXBwZXRLZXkgfSBmcm9tICcuL2tleSc7XG5pbXBvcnQgeyBUYWJsZXRTY2hlbWEsIFRyYW5zbGF0ZWRTbmlwcGV0U2NoZW1hLCBPUklHSU5BTF9TTklQUEVUX0tFWSB9IGZyb20gJy4vc2NoZW1hJztcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1yZXF1aXJlLWltcG9ydHMsQHR5cGVzY3JpcHQtZXNsaW50L25vLXZhci1yZXF1aXJlc1xuY29uc3QgVE9PTF9WRVJTSU9OID0gcmVxdWlyZSgnLi4vLi4vcGFja2FnZS5qc29uJykudmVyc2lvbjtcblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfVEFCTEVUX05BTUUgPSAnLmpzaWkudGFibC5qc29uJztcblxuZXhwb3J0IGNvbnN0IENVUlJFTlRfU0NIRU1BX1ZFUlNJT04gPSAnMic7XG5cbi8qKlxuICogQSB0YWJsZXQgY29udGFpbmluZyB2YXJpb3VzIHNuaXBwZXRzIGluIG11bHRpcGxlIGxhbmd1YWdlc1xuICovXG5leHBvcnQgY2xhc3MgTGFuZ3VhZ2VUYWJsZXQge1xuICAvKipcbiAgICogTG9hZCBhIHRhYmxldCBmcm9tIGEgZmlsZVxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBhc3luYyBmcm9tRmlsZShmaWxlbmFtZTogc3RyaW5nKSB7XG4gICAgY29uc3QgcmV0ID0gbmV3IExhbmd1YWdlVGFibGV0KCk7XG4gICAgYXdhaXQgcmV0LmxvYWQoZmlsZW5hbWUpO1xuICAgIHJldHVybiByZXQ7XG4gIH1cblxuICAvKipcbiAgICogTG9hZCBhIHRhYmxldCBmcm9tIGEgZmlsZSB0aGF0IG1heSBub3QgZXhpc3RcbiAgICpcbiAgICogV2lsbCByZXR1cm4gYW4gZW1wdHkgdGFibGV0IGlmIHRoZSBmaWxlIGRvZXMgbm90IGV4aXN0XG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGFzeW5jIGZyb21PcHRpb25hbEZpbGUoZmlsZW5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IHJldCA9IG5ldyBMYW5ndWFnZVRhYmxldCgpO1xuICAgIGlmIChmcy5leGlzdHNTeW5jKGZpbGVuYW1lKSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgcmV0LmxvYWQoZmlsZW5hbWUpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2dnaW5nLndhcm4oYCR7ZmlsZW5hbWV9OiAke2V9YCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG4gIH1cblxuICBwcml2YXRlIHJlYWRvbmx5IHNuaXBwZXRzOiBSZWNvcmQ8c3RyaW5nLCBUcmFuc2xhdGVkU25pcHBldD4gPSB7fTtcblxuICAvKipcbiAgICogQWRkIG9uZSBvciBtb3JlIHNuaXBwZXRzIHRvIHRoaXMgdGFibGV0XG4gICAqL1xuICBwdWJsaWMgYWRkU25pcHBldHMoLi4uc25pcHBldHM6IFRyYW5zbGF0ZWRTbmlwcGV0W10pIHtcbiAgICBmb3IgKGNvbnN0IHNuaXBwZXQgb2Ygc25pcHBldHMpIHtcbiAgICAgIGNvbnN0IGV4aXN0aW5nU25pcHBldCA9IHRoaXMuc25pcHBldHNbc25pcHBldC5rZXldO1xuICAgICAgdGhpcy5zbmlwcGV0c1tzbmlwcGV0LmtleV0gPSBleGlzdGluZ1NuaXBwZXQgPyBleGlzdGluZ1NuaXBwZXQubWVyZ2VUcmFuc2xhdGlvbnMoc25pcHBldCkgOiBzbmlwcGV0O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgb25lIHNuaXBwZXQgdG8gdGhpcyB0YWJsZXRcbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgdXNlIGFkZFNuaXBwZXRzIGluc3RlYWRcbiAgICovXG4gIHB1YmxpYyBhZGRTbmlwcGV0KHNuaXBwZXQ6IFRyYW5zbGF0ZWRTbmlwcGV0KSB7XG4gICAgdGhpcy5hZGRTbmlwcGV0cyhzbmlwcGV0KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc25pcHBldEtleXMoKSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuc25pcHBldHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhbGwgc25pcHBldHMgZnJvbSB0aGUgZ2l2ZW4gdGFibGV0cyBpbnRvIHRoaXMgb25lXG4gICAqL1xuICBwdWJsaWMgYWRkVGFibGV0cyguLi50YWJsZXRzOiBMYW5ndWFnZVRhYmxldFtdKSB7XG4gICAgZm9yIChjb25zdCB0YWJsZXQgb2YgdGFibGV0cykge1xuICAgICAgZm9yIChjb25zdCBzbmlwcGV0IG9mIE9iamVjdC52YWx1ZXModGFibGV0LnNuaXBwZXRzKSkge1xuICAgICAgICB0aGlzLmFkZFNuaXBwZXQoc25pcHBldCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhbGwgc25pcHBldHMgZnJvbSB0aGUgZ2l2ZW4gdGFibGV0IGludG8gdGhpcyBvbmVcbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgVXNlIGBhZGRUYWJsZXRzKClgIGluc3RlYWQuXG4gICAqL1xuICBwdWJsaWMgYWRkVGFibGV0KHRhYmxldDogTGFuZ3VhZ2VUYWJsZXQpIHtcbiAgICB0aGlzLmFkZFRhYmxldHModGFibGV0KTtcbiAgfVxuXG4gIHB1YmxpYyB0cnlHZXRTbmlwcGV0KGtleTogc3RyaW5nKTogVHJhbnNsYXRlZFNuaXBwZXQgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLnNuaXBwZXRzW2tleV07XG4gIH1cblxuICAvKipcbiAgICogTG9vayB1cCBhIHNpbmdsZSB0cmFuc2xhdGlvbiBvZiBhIHNvdXJjZSBzbmlwcGV0XG4gICAqXG4gICAqIEBkZXByZWNhdGVkIFVzZSBgbG9va3VwVHJhbnNsYXRpb25CeVNvdXJjZWAgaW5zdGVhZC5cbiAgICovXG4gIHB1YmxpYyBsb29rdXAodHlwZVNjcmlwdFNvdXJjZTogVHlwZVNjcmlwdFNuaXBwZXQsIGxhbmd1YWdlOiBUYXJnZXRMYW5ndWFnZSk6IFRyYW5zbGF0aW9uIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5sb29rdXBUcmFuc2xhdGlvbkJ5U291cmNlKHR5cGVTY3JpcHRTb3VyY2UsIGxhbmd1YWdlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMb29rIHVwIGEgc2luZ2xlIHRyYW5zbGF0aW9uIG9mIGEgc291cmNlIHNuaXBwZXRcbiAgICovXG4gIHB1YmxpYyBsb29rdXBUcmFuc2xhdGlvbkJ5U291cmNlKFxuICAgIHR5cGVTY3JpcHRTb3VyY2U6IFR5cGVTY3JpcHRTbmlwcGV0LFxuICAgIGxhbmd1YWdlOiBUYXJnZXRMYW5ndWFnZSxcbiAgKTogVHJhbnNsYXRpb24gfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHNuaXBwZXQgPSB0aGlzLnNuaXBwZXRzW3NuaXBwZXRLZXkodHlwZVNjcmlwdFNvdXJjZSldO1xuICAgIHJldHVybiBzbmlwcGV0Py5nZXQobGFuZ3VhZ2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIExvb2t1cCB0aGUgdHJhbnNsYXRlZCB2ZXJpb24gb2YgYSBUeXBlU2NyaXB0IHNuaXBwZXRcbiAgICovXG4gIHB1YmxpYyBsb29rdXBCeVNvdXJjZSh0eXBlU2NyaXB0U291cmNlOiBUeXBlU2NyaXB0U25pcHBldCk6IFRyYW5zbGF0ZWRTbmlwcGV0IHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5zbmlwcGV0c1tzbmlwcGV0S2V5KHR5cGVTY3JpcHRTb3VyY2UpXTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsb2FkKGZpbGVuYW1lOiBzdHJpbmcpIHtcbiAgICBjb25zdCBvYmogPSAoYXdhaXQgZnMucmVhZEpzb24oZmlsZW5hbWUsIHsgZW5jb2Rpbmc6ICd1dGYtOCcgfSkpIGFzIFRhYmxldFNjaGVtYTtcblxuICAgIGlmICghb2JqLnRvb2xWZXJzaW9uIHx8ICFvYmouc25pcHBldHMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmlsZSAnJHtmaWxlbmFtZX0nIGRvZXMgbm90IHNlZW0gdG8gYmUgYSBUYWJsZXQgZmlsZWApO1xuICAgIH1cblxuICAgIGlmIChvYmoudmVyc2lvbiAhPT0gQ1VSUkVOVF9TQ0hFTUFfVkVSU0lPTikge1xuICAgICAgLy8gSWYgd2UncmUgZXZlciBjaGFuZ2luZyB0aGUgc2NoZW1hIHZlcnNpb24gaW4gYSBiYWNrd2FyZHMgaW5jb21wYXRpYmxlIHdheSxcbiAgICAgIC8vIGRvIHVwY29udmVyc2lvbiBoZXJlLlxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgVGFibGV0IGZpbGUgJyR7ZmlsZW5hbWV9JyBoYXMgc2NoZW1hIHZlcnNpb24gJyR7b2JqLnZlcnNpb259JywgdGhpcyBwcm9ncmFtIGV4cGVjdHMgJyR7Q1VSUkVOVF9TQ0hFTUFfVkVSU0lPTn0nYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLnNuaXBwZXRzLCBtYXBWYWx1ZXMob2JqLnNuaXBwZXRzLCBUcmFuc2xhdGVkU25pcHBldC5mcm9tU2NoZW1hKSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGNvdW50KCkge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnNuaXBwZXRzKS5sZW5ndGg7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHRyYW5zbGF0ZWRTbmlwcGV0cygpIHtcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzLnNuaXBwZXRzKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzYXZlKGZpbGVuYW1lOiBzdHJpbmcpIHtcbiAgICBhd2FpdCBmcy5ta2RpcnAocGF0aC5kaXJuYW1lKGZpbGVuYW1lKSk7XG4gICAgYXdhaXQgZnMud3JpdGVKc29uKGZpbGVuYW1lLCB0aGlzLnRvU2NoZW1hKCksIHtcbiAgICAgIGVuY29kaW5nOiAndXRmLTgnLFxuICAgICAgc3BhY2VzOiAyLFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSB0b1NjaGVtYSgpOiBUYWJsZXRTY2hlbWEge1xuICAgIHJldHVybiB7XG4gICAgICB2ZXJzaW9uOiBDVVJSRU5UX1NDSEVNQV9WRVJTSU9OLFxuICAgICAgdG9vbFZlcnNpb246IFRPT0xfVkVSU0lPTixcbiAgICAgIHNuaXBwZXRzOiBtYXBWYWx1ZXModGhpcy5zbmlwcGV0cywgKHMpID0+IHMuc25pcHBldCksXG4gICAgfTtcbiAgfVxufVxuXG4vKipcbiAqIE11dGFibGUgb3BlcmF0aW9ucyBvbiBhbiB1bmRlcmx5aW5nIFRyYW5zbGF0ZWRTbmlwcGV0U2NoZW1hXG4gKi9cbmV4cG9ydCBjbGFzcyBUcmFuc2xhdGVkU25pcHBldCB7XG4gIHB1YmxpYyBzdGF0aWMgZnJvbVNjaGVtYShzY2hlbWE6IFRyYW5zbGF0ZWRTbmlwcGV0U2NoZW1hKSB7XG4gICAgaWYgKCFzY2hlbWEudHJhbnNsYXRpb25zW09SSUdJTkFMX1NOSVBQRVRfS0VZXSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnB1dCBzY2hlbWEgbXVzdCBoYXZlICcke09SSUdJTkFMX1NOSVBQRVRfS0VZfScga2V5IHNldCBpbiB0cmFuc2xhdGlvbnNgKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBUcmFuc2xhdGVkU25pcHBldChzY2hlbWEpO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBmcm9tVHlwZVNjcmlwdChvcmlnaW5hbDogVHlwZVNjcmlwdFNuaXBwZXQsIGRpZENvbXBpbGU/OiBib29sZWFuKSB7XG4gICAgcmV0dXJuIG5ldyBUcmFuc2xhdGVkU25pcHBldCh7XG4gICAgICB0cmFuc2xhdGlvbnM6IHtcbiAgICAgICAgW09SSUdJTkFMX1NOSVBQRVRfS0VZXTogeyBzb3VyY2U6IG9yaWdpbmFsLnZpc2libGVTb3VyY2UsIHZlcnNpb246ICcwJyB9LFxuICAgICAgfSxcbiAgICAgIGRpZENvbXBpbGU6IGRpZENvbXBpbGUsXG4gICAgICBsb2NhdGlvbjogb3JpZ2luYWwubG9jYXRpb24sXG4gICAgICBmdWxsU291cmNlOiBjb21wbGV0ZVNvdXJjZShvcmlnaW5hbCksXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgcmVhZG9ubHkgc25pcHBldDogVHJhbnNsYXRlZFNuaXBwZXRTY2hlbWE7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBfc25pcHBldDogTXV0YWJsZTxUcmFuc2xhdGVkU25pcHBldFNjaGVtYT47XG4gIHByaXZhdGUgX2tleT86IHN0cmluZztcblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKHNuaXBwZXQ6IFRyYW5zbGF0ZWRTbmlwcGV0U2NoZW1hKSB7XG4gICAgdGhpcy5fc25pcHBldCA9IHsgLi4uc25pcHBldCB9O1xuICAgIHRoaXMuc25pcHBldCA9IHRoaXMuX3NuaXBwZXQ7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGtleSgpIHtcbiAgICBpZiAodGhpcy5fa2V5ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuX2tleSA9IHNuaXBwZXRLZXkodGhpcy5hc1R5cGVzY3JpcHRTbmlwcGV0KCkpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fa2V5O1xuICB9XG5cbiAgcHVibGljIGdldCBvcmlnaW5hbFNvdXJjZSgpOiBUcmFuc2xhdGlvbiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNvdXJjZTogdGhpcy5zbmlwcGV0LnRyYW5zbGF0aW9uc1tPUklHSU5BTF9TTklQUEVUX0tFWV0uc291cmNlLFxuICAgICAgbGFuZ3VhZ2U6ICd0eXBlc2NyaXB0JyxcbiAgICAgIGRpZENvbXBpbGU6IHRoaXMuc25pcHBldC5kaWRDb21waWxlLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgYWRkVHJhbnNsYXRpb24obGFuZ3VhZ2U6IFRhcmdldExhbmd1YWdlLCB0cmFuc2xhdGlvbjogc3RyaW5nLCB2ZXJzaW9uOiBzdHJpbmcpOiBUcmFuc2xhdGlvbiB7XG4gICAgdGhpcy5zbmlwcGV0LnRyYW5zbGF0aW9uc1tsYW5ndWFnZV0gPSB7IHNvdXJjZTogdHJhbnNsYXRpb24sIHZlcnNpb24gfTtcblxuICAgIHJldHVybiB7XG4gICAgICBzb3VyY2U6IHRyYW5zbGF0aW9uLFxuICAgICAgbGFuZ3VhZ2UsXG4gICAgICBkaWRDb21waWxlOiB0aGlzLnNuaXBwZXQuZGlkQ29tcGlsZSxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIGZxbnNSZWZlcmVuY2VkKCkge1xuICAgIHJldHVybiB0aGlzLl9zbmlwcGV0LmZxbnNSZWZlcmVuY2VkID8/IFtdO1xuICB9XG5cbiAgcHVibGljIGFkZFN5bnRheEtpbmRDb3VudGVyKHN5bnRheEtpbmRDb3VudGVyOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+KSB7XG4gICAgaWYgKCF0aGlzLl9zbmlwcGV0LnN5bnRheEtpbmRDb3VudGVyKSB7XG4gICAgICB0aGlzLl9zbmlwcGV0LnN5bnRheEtpbmRDb3VudGVyID0ge307XG4gICAgfVxuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHN5bnRheEtpbmRDb3VudGVyKSkge1xuICAgICAgY29uc3QgeCA9IHRoaXMuX3NuaXBwZXQuc3ludGF4S2luZENvdW50ZXJba2V5XSA/PyAwO1xuICAgICAgdGhpcy5fc25pcHBldC5zeW50YXhLaW5kQ291bnRlcltrZXldID0gdmFsdWUgKyB4O1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXQgbGFuZ3VhZ2VzKCk6IFRhcmdldExhbmd1YWdlW10ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnNuaXBwZXQudHJhbnNsYXRpb25zKS5maWx0ZXIoKHgpID0+IHggIT09IE9SSUdJTkFMX1NOSVBQRVRfS0VZKSBhcyBUYXJnZXRMYW5ndWFnZVtdO1xuICB9XG5cbiAgcHVibGljIGdldChsYW5ndWFnZTogVGFyZ2V0TGFuZ3VhZ2UpOiBUcmFuc2xhdGlvbiB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgdCA9IHRoaXMuc25pcHBldC50cmFuc2xhdGlvbnNbbGFuZ3VhZ2VdO1xuICAgIHJldHVybiB0ICYmIHsgc291cmNlOiB0LnNvdXJjZSwgbGFuZ3VhZ2UsIGRpZENvbXBpbGU6IHRoaXMuc25pcHBldC5kaWRDb21waWxlIH07XG4gIH1cblxuICBwdWJsaWMgbWVyZ2VUcmFuc2xhdGlvbnMob3RoZXI6IFRyYW5zbGF0ZWRTbmlwcGV0KSB7XG4gICAgcmV0dXJuIG5ldyBUcmFuc2xhdGVkU25pcHBldCh7XG4gICAgICAuLi50aGlzLnNuaXBwZXQsXG4gICAgICB0cmFuc2xhdGlvbnM6IHsgLi4udGhpcy5zbmlwcGV0LnRyYW5zbGF0aW9ucywgLi4ub3RoZXIuc25pcHBldC50cmFuc2xhdGlvbnMgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyB3aXRoRmluZ2VycHJpbnQoZnA6IHN0cmluZykge1xuICAgIHJldHVybiBuZXcgVHJhbnNsYXRlZFNuaXBwZXQoe1xuICAgICAgLi4udGhpcy5zbmlwcGV0LFxuICAgICAgZnFuc0ZpbmdlcnByaW50OiBmcCxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyB3aXRoTG9jYXRpb24obG9jYXRpb246IFNuaXBwZXRMb2NhdGlvbikge1xuICAgIHJldHVybiBuZXcgVHJhbnNsYXRlZFNuaXBwZXQoe1xuICAgICAgLi4udGhpcy5zbmlwcGV0LFxuICAgICAgbG9jYXRpb24sXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgdG9KU09OKCkge1xuICAgIHJldHVybiB0aGlzLl9zbmlwcGV0O1xuICB9XG5cbiAgcHJpdmF0ZSBhc1R5cGVzY3JpcHRTbmlwcGV0KCk6IFR5cGVTY3JpcHRTbmlwcGV0IHtcbiAgICByZXR1cm4ge1xuICAgICAgdmlzaWJsZVNvdXJjZTogdGhpcy5zbmlwcGV0LnRyYW5zbGF0aW9uc1tPUklHSU5BTF9TTklQUEVUX0tFWV0uc291cmNlLFxuICAgICAgbG9jYXRpb246IHRoaXMuc25pcHBldC5sb2NhdGlvbixcbiAgICB9O1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHJhbnNsYXRpb24ge1xuICBzb3VyY2U6IHN0cmluZztcbiAgbGFuZ3VhZ2U6IHN0cmluZztcbiAgZGlkQ29tcGlsZT86IGJvb2xlYW47XG59XG5cbnR5cGUgTXV0YWJsZTxUPiA9IHsgLXJlYWRvbmx5IFtQIGluIGtleW9mIFRdOiBNdXRhYmxlPFRbUF0+IH07XG4iXX0=
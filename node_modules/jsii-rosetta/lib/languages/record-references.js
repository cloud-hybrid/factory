"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RecordReferencesVisitor = void 0;
const jsii_utils_1 = require("../jsii/jsii-utils");
const target_language_1 = require("../languages/target-language");
const o_tree_1 = require("../o-tree");
const default_1 = require("./default");
/**
 * A visitor that collects all types referenced in a particular piece of sample code
 */
class RecordReferencesVisitor extends default_1.DefaultVisitor {
    constructor(visibleSpans) {
        super();
        this.visibleSpans = visibleSpans;
        this.language = target_language_1.TargetLanguage.PYTHON; // Doesn't matter, but we need it to use the visitor infra :(
        this.defaultContext = {};
        this.references = new Set();
    }
    fqnsReferenced() {
        return Array.from(this.references).sort();
    }
    mergeContext(old, update) {
        return Object.assign({}, old, update);
    }
    /**
     * For a variable declaration, a type counts as "referenced" if it gets assigned a value via an initializer
     *
     * This skips "declare" statements which aren't really interesting.
     */
    variableDeclaration(node, renderer) {
        if (this.visibleSpans.containsStartOfNode(node) && node.initializer) {
            const type = (node.type && renderer.typeOfType(node.type)) ||
                (node.initializer && renderer.typeOfExpression(node.initializer));
            this.recordSymbol(type.symbol, renderer);
        }
        return super.variableDeclaration(node, renderer);
    }
    newExpression(node, context) {
        // Constructor
        if (this.visibleSpans.containsStartOfNode(node)) {
            this.recordNode(node.expression, context);
            if (node.arguments) {
                this.visitArgumentTypes(node.arguments, context);
            }
        }
        return super.newExpression(node, context);
    }
    propertyAccessExpression(node, context) {
        if (this.visibleSpans.containsStartOfNode(node)) {
            // The property itself
            this.recordNode(node, context);
            // Not currently considering the return type as "referenced"
        }
        return super.propertyAccessExpression(node, context);
    }
    regularCallExpression(node, context) {
        if (this.visibleSpans.containsStartOfNode(node)) {
            // The method itself
            this.recordNode(node.expression, context);
            if (node.arguments) {
                this.visitArgumentTypes(node.arguments, context);
            }
            // Not currently considering the return type as "referenced"
        }
        return super.regularCallExpression(node, context);
    }
    objectLiteralExpression(node, context) {
        context.convertAll(node.properties);
        return o_tree_1.NO_SYNTAX;
    }
    propertyAssignment(node, renderer) {
        const type = renderer.typeOfExpression(node.initializer).getNonNullableType();
        this.recordSymbol(type === null || type === void 0 ? void 0 : type.symbol, renderer);
        return super.propertyAssignment(node, renderer);
    }
    shorthandPropertyAssignment(node, renderer) {
        const type = renderer.typeOfExpression(node.name).getNonNullableType();
        this.recordSymbol(type === null || type === void 0 ? void 0 : type.symbol, renderer);
        return super.shorthandPropertyAssignment(node, renderer);
    }
    /**
     * Visit the arguments by type (instead of by node)
     *
     * This will make sure we recognize the use of a `BucketProps` in a `new Bucket(..., { ... })` call.
     */
    visitArgumentTypes(args, context) {
        for (const argument of args) {
            const type = context.inferredTypeOfExpression(argument);
            this.recordSymbol(type === null || type === void 0 ? void 0 : type.symbol, context);
        }
    }
    recordNode(node, context) {
        this.recordSymbol(context.typeChecker.getSymbolAtLocation(node), context);
    }
    recordSymbol(symbol, context) {
        if (!symbol) {
            return;
        }
        const jsiiSym = jsii_utils_1.lookupJsiiSymbol(context.typeChecker, symbol);
        if (!jsiiSym) {
            return;
        }
        this.references.add(jsiiSym.fqn);
    }
}
exports.RecordReferencesVisitor = RecordReferencesVisitor;
RecordReferencesVisitor.VERSION = '2';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVjb3JkLXJlZmVyZW5jZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWNvcmQtcmVmZXJlbmNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSxtREFBc0Q7QUFDdEQsa0VBQThEO0FBQzlELHNDQUE2QztBQUc3Qyx1Q0FBMkM7QUFPM0M7O0dBRUc7QUFDSCxNQUFhLHVCQUF3QixTQUFRLHdCQUF1QztJQU9sRixZQUFvQyxZQUFtQjtRQUNyRCxLQUFLLEVBQUUsQ0FBQztRQUQwQixpQkFBWSxHQUFaLFlBQVksQ0FBTztRQUp2QyxhQUFRLEdBQUcsZ0NBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyw2REFBNkQ7UUFDL0YsbUJBQWMsR0FBRyxFQUFFLENBQUM7UUFDbkIsZUFBVSxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7SUFJaEQsQ0FBQztJQUVNLGNBQWM7UUFDbkIsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUM1QyxDQUFDO0lBRU0sWUFBWSxDQUFDLEdBQTRCLEVBQUUsTUFBd0M7UUFDeEYsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSxtQkFBbUIsQ0FBQyxJQUE0QixFQUFFLFFBQWtDO1FBQ3pGLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ25FLE1BQU0sSUFBSSxHQUNSLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDN0MsQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FB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SSxFQUFFO1lBQzNCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN4RCxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDMUM7SUFDSCxDQUFDO0lBRU8sVUFBVSxDQUFDLElBQWEsRUFBRSxPQUFpQztRQUNqRSxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDNUUsQ0FBQztJQUVPLFlBQVksQ0FBQyxNQUE2QixFQUFFLE9BQWlDO1FBQ25GLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxPQUFPO1NBQ1I7UUFDRCxNQUFNLE9BQU8sR0FBRyw2QkFBZ0IsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzlELElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDWixPQUFPO1NBQ1I7UUFFRCxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDbkMsQ0FBQzs7QUFySEgsMERBc0hDO0FBckh3QiwrQkFBTyxHQUFHLEdBQUcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuXG5pbXBvcnQgeyBsb29rdXBKc2lpU3ltYm9sIH0gZnJvbSAnLi4vanNpaS9qc2lpLXV0aWxzJztcbmltcG9ydCB7IFRhcmdldExhbmd1YWdlIH0gZnJvbSAnLi4vbGFuZ3VhZ2VzL3RhcmdldC1sYW5ndWFnZSc7XG5pbXBvcnQgeyBPVHJlZSwgTk9fU1lOVEFYIH0gZnJvbSAnLi4vby10cmVlJztcbmltcG9ydCB7IEFzdFJlbmRlcmVyIH0gZnJvbSAnLi4vcmVuZGVyZXInO1xuaW1wb3J0IHsgU3BhbnMgfSBmcm9tICcuLi90eXBlc2NyaXB0L3Zpc2libGUtc3BhbnMnO1xuaW1wb3J0IHsgRGVmYXVsdFZpc2l0b3IgfSBmcm9tICcuL2RlZmF1bHQnO1xuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWVtcHR5LWludGVyZmFjZVxuaW50ZXJmYWNlIFJlY29yZFJlZmVyZW5jZXNDb250ZXh0IHt9XG5cbnR5cGUgUmVjb3JkUmVmZXJlbmNlc1JlbmRlcmVyID0gQXN0UmVuZGVyZXI8UmVjb3JkUmVmZXJlbmNlc0NvbnRleHQ+O1xuXG4vKipcbiAqIEEgdmlzaXRvciB0aGF0IGNvbGxlY3RzIGFsbCB0eXBlcyByZWZlcmVuY2VkIGluIGEgcGFydGljdWxhciBwaWVjZSBvZiBzYW1wbGUgY29kZVxuICovXG5leHBvcnQgY2xhc3MgUmVjb3JkUmVmZXJlbmNlc1Zpc2l0b3IgZXh0ZW5kcyBEZWZhdWx0VmlzaXRvcjxSZWNvcmRSZWZlcmVuY2VzQ29udGV4dD4ge1xuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IFZFUlNJT04gPSAnMic7XG5cbiAgcHVibGljIHJlYWRvbmx5IGxhbmd1YWdlID0gVGFyZ2V0TGFuZ3VhZ2UuUFlUSE9OOyAvLyBEb2Vzbid0IG1hdHRlciwgYnV0IHdlIG5lZWQgaXQgdG8gdXNlIHRoZSB2aXNpdG9yIGluZnJhIDooXG4gIHB1YmxpYyByZWFkb25seSBkZWZhdWx0Q29udGV4dCA9IHt9O1xuICBwcml2YXRlIHJlYWRvbmx5IHJlZmVyZW5jZXMgPSBuZXcgU2V0PHN0cmluZz4oKTtcblxuICBwdWJsaWMgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSB2aXNpYmxlU3BhbnM6IFNwYW5zKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIHB1YmxpYyBmcW5zUmVmZXJlbmNlZCgpIHtcbiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLnJlZmVyZW5jZXMpLnNvcnQoKTtcbiAgfVxuXG4gIHB1YmxpYyBtZXJnZUNvbnRleHQob2xkOiBSZWNvcmRSZWZlcmVuY2VzQ29udGV4dCwgdXBkYXRlOiBQYXJ0aWFsPFJlY29yZFJlZmVyZW5jZXNDb250ZXh0Pik6IFJlY29yZFJlZmVyZW5jZXNDb250ZXh0IHtcbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgb2xkLCB1cGRhdGUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEZvciBhIHZhcmlhYmxlIGRlY2xhcmF0aW9uLCBhIHR5cGUgY291bnRzIGFzIFwicmVmZXJlbmNlZFwiIGlmIGl0IGdldHMgYXNzaWduZWQgYSB2YWx1ZSB2aWEgYW4gaW5pdGlhbGl6ZXJcbiAgICpcbiAgICogVGhpcyBza2lwcyBcImRlY2xhcmVcIiBzdGF0ZW1lbnRzIHdoaWNoIGFyZW4ndCByZWFsbHkgaW50ZXJlc3RpbmcuXG4gICAqL1xuICBwdWJsaWMgdmFyaWFibGVEZWNsYXJhdGlvbihub2RlOiB0cy5WYXJpYWJsZURlY2xhcmF0aW9uLCByZW5kZXJlcjogUmVjb3JkUmVmZXJlbmNlc1JlbmRlcmVyKTogT1RyZWUge1xuICAgIGlmICh0aGlzLnZpc2libGVTcGFucy5jb250YWluc1N0YXJ0T2ZOb2RlKG5vZGUpICYmIG5vZGUuaW5pdGlhbGl6ZXIpIHtcbiAgICAgIGNvbnN0IHR5cGUgPVxuICAgICAgICAobm9kZS50eXBlICYmIHJlbmRlcmVyLnR5cGVPZlR5cGUobm9kZS50eXBlKSkgfHxcbiAgICAgICAgKG5vZGUuaW5pdGlhbGl6ZXIgJiYgcmVuZGVyZXIudHlwZU9mRXhwcmVzc2lvbihub2RlLmluaXRpYWxpemVyKSk7XG5cbiAgICAgIHRoaXMucmVjb3JkU3ltYm9sKHR5cGUuc3ltYm9sLCByZW5kZXJlcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN1cGVyLnZhcmlhYmxlRGVjbGFyYXRpb24obm9kZSwgcmVuZGVyZXIpO1xuICB9XG5cbiAgcHVibGljIG5ld0V4cHJlc3Npb24obm9kZTogdHMuTmV3RXhwcmVzc2lvbiwgY29udGV4dDogUmVjb3JkUmVmZXJlbmNlc1JlbmRlcmVyKTogT1RyZWUge1xuICAgIC8vIENvbnN0cnVjdG9yXG4gICAgaWYgKHRoaXMudmlzaWJsZVNwYW5zLmNvbnRhaW5zU3RhcnRPZk5vZGUobm9kZSkpIHtcbiAgICAgIHRoaXMucmVjb3JkTm9kZShub2RlLmV4cHJlc3Npb24sIGNvbnRleHQpO1xuICAgICAgaWYgKG5vZGUuYXJndW1lbnRzKSB7XG4gICAgICAgIHRoaXMudmlzaXRBcmd1bWVudFR5cGVzKG5vZGUuYXJndW1lbnRzLCBjb250ZXh0KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gc3VwZXIubmV3RXhwcmVzc2lvbihub2RlLCBjb250ZXh0KTtcbiAgfVxuXG4gIHB1YmxpYyBwcm9wZXJ0eUFjY2Vzc0V4cHJlc3Npb24obm9kZTogdHMuUHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uLCBjb250ZXh0OiBSZWNvcmRSZWZlcmVuY2VzUmVuZGVyZXIpOiBPVHJlZSB7XG4gICAgaWYgKHRoaXMudmlzaWJsZVNwYW5zLmNvbnRhaW5zU3RhcnRPZk5vZGUobm9kZSkpIHtcbiAgICAgIC8vIFRoZSBwcm9wZXJ0eSBpdHNlbGZcbiAgICAgIHRoaXMucmVjb3JkTm9kZShub2RlLCBjb250ZXh0KTtcblxuICAgICAgLy8gTm90IGN1cnJlbnRseSBjb25zaWRlcmluZyB0aGUgcmV0dXJuIHR5cGUgYXMgXCJyZWZlcmVuY2VkXCJcbiAgICB9XG5cbiAgICByZXR1cm4gc3VwZXIucHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpO1xuICB9XG5cbiAgcHVibGljIHJlZ3VsYXJDYWxsRXhwcmVzc2lvbihub2RlOiB0cy5DYWxsRXhwcmVzc2lvbiwgY29udGV4dDogUmVjb3JkUmVmZXJlbmNlc1JlbmRlcmVyKTogT1RyZWUge1xuICAgIGlmICh0aGlzLnZpc2libGVTcGFucy5jb250YWluc1N0YXJ0T2ZOb2RlKG5vZGUpKSB7XG4gICAgICAvLyBUaGUgbWV0aG9kIGl0c2VsZlxuICAgICAgdGhpcy5yZWNvcmROb2RlKG5vZGUuZXhwcmVzc2lvbiwgY29udGV4dCk7XG5cbiAgICAgIGlmIChub2RlLmFyZ3VtZW50cykge1xuICAgICAgICB0aGlzLnZpc2l0QXJndW1lbnRUeXBlcyhub2RlLmFyZ3VtZW50cywgY29udGV4dCk7XG4gICAgICB9XG5cbiAgICAgIC8vIE5vdCBjdXJyZW50bHkgY29uc2lkZXJpbmcgdGhlIHJldHVybiB0eXBlIGFzIFwicmVmZXJlbmNlZFwiXG4gICAgfVxuXG4gICAgcmV0dXJuIHN1cGVyLnJlZ3VsYXJDYWxsRXhwcmVzc2lvbihub2RlLCBjb250ZXh0KTtcbiAgfVxuXG4gIHB1YmxpYyBvYmplY3RMaXRlcmFsRXhwcmVzc2lvbihub2RlOiB0cy5PYmplY3RMaXRlcmFsRXhwcmVzc2lvbiwgY29udGV4dDogUmVjb3JkUmVmZXJlbmNlc1JlbmRlcmVyKTogT1RyZWUge1xuICAgIGNvbnRleHQuY29udmVydEFsbChub2RlLnByb3BlcnRpZXMpO1xuICAgIHJldHVybiBOT19TWU5UQVg7XG4gIH1cblxuICBwdWJsaWMgcHJvcGVydHlBc3NpZ25tZW50KG5vZGU6IHRzLlByb3BlcnR5QXNzaWdubWVudCwgcmVuZGVyZXI6IFJlY29yZFJlZmVyZW5jZXNSZW5kZXJlcik6IE9UcmVlIHtcbiAgICBjb25zdCB0eXBlID0gcmVuZGVyZXIudHlwZU9mRXhwcmVzc2lvbihub2RlLmluaXRpYWxpemVyKS5nZXROb25OdWxsYWJsZVR5cGUoKTtcbiAgICB0aGlzLnJlY29yZFN5bWJvbCh0eXBlPy5zeW1ib2wsIHJlbmRlcmVyKTtcbiAgICByZXR1cm4gc3VwZXIucHJvcGVydHlBc3NpZ25tZW50KG5vZGUsIHJlbmRlcmVyKTtcbiAgfVxuXG4gIHB1YmxpYyBzaG9ydGhhbmRQcm9wZXJ0eUFzc2lnbm1lbnQobm9kZTogdHMuU2hvcnRoYW5kUHJvcGVydHlBc3NpZ25tZW50LCByZW5kZXJlcjogUmVjb3JkUmVmZXJlbmNlc1JlbmRlcmVyKTogT1RyZWUge1xuICAgIGNvbnN0IHR5cGUgPSByZW5kZXJlci50eXBlT2ZFeHByZXNzaW9uKG5vZGUubmFtZSkuZ2V0Tm9uTnVsbGFibGVUeXBlKCk7XG4gICAgdGhpcy5yZWNvcmRTeW1ib2wodHlwZT8uc3ltYm9sLCByZW5kZXJlcik7XG4gICAgcmV0dXJuIHN1cGVyLnNob3J0aGFuZFByb3BlcnR5QXNzaWdubWVudChub2RlLCByZW5kZXJlcik7XG4gIH1cblxuICAvKipcbiAgICogVmlzaXQgdGhlIGFyZ3VtZW50cyBieSB0eXBlIChpbnN0ZWFkIG9mIGJ5IG5vZGUpXG4gICAqXG4gICAqIFRoaXMgd2lsbCBtYWtlIHN1cmUgd2UgcmVjb2duaXplIHRoZSB1c2Ugb2YgYSBgQnVja2V0UHJvcHNgIGluIGEgYG5ldyBCdWNrZXQoLi4uLCB7IC4uLiB9KWAgY2FsbC5cbiAgICovXG4gIHByaXZhdGUgdmlzaXRBcmd1bWVudFR5cGVzKGFyZ3M6IHRzLk5vZGVBcnJheTx0cy5FeHByZXNzaW9uPiwgY29udGV4dDogUmVjb3JkUmVmZXJlbmNlc1JlbmRlcmVyKSB7XG4gICAgZm9yIChjb25zdCBhcmd1bWVudCBvZiBhcmdzKSB7XG4gICAgICBjb25zdCB0eXBlID0gY29udGV4dC5pbmZlcnJlZFR5cGVPZkV4cHJlc3Npb24oYXJndW1lbnQpO1xuICAgICAgdGhpcy5yZWNvcmRTeW1ib2wodHlwZT8uc3ltYm9sLCBjb250ZXh0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlY29yZE5vZGUobm9kZTogdHMuTm9kZSwgY29udGV4dDogUmVjb3JkUmVmZXJlbmNlc1JlbmRlcmVyKSB7XG4gICAgdGhpcy5yZWNvcmRTeW1ib2woY29udGV4dC50eXBlQ2hlY2tlci5nZXRTeW1ib2xBdExvY2F0aW9uKG5vZGUpLCBjb250ZXh0KTtcbiAgfVxuXG4gIHByaXZhdGUgcmVjb3JkU3ltYm9sKHN5bWJvbDogdHMuU3ltYm9sIHwgdW5kZWZpbmVkLCBjb250ZXh0OiBSZWNvcmRSZWZlcmVuY2VzUmVuZGVyZXIpIHtcbiAgICBpZiAoIXN5bWJvbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBqc2lpU3ltID0gbG9va3VwSnNpaVN5bWJvbChjb250ZXh0LnR5cGVDaGVja2VyLCBzeW1ib2wpO1xuICAgIGlmICghanNpaVN5bSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMucmVmZXJlbmNlcy5hZGQoanNpaVN5bS5mcW4pO1xuICB9XG59XG4iXX0=
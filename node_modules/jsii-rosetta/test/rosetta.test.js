"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const mockfs = require("mock-fs");
const lib_1 = require("../lib");
const languages_1 = require("../lib/languages");
const fake_assembly_1 = require("./jsii/fake-assembly");
const testutil_1 = require("./testutil");
const SAMPLE_CODE = {
    visibleSource: 'callThisFunction();',
    location: testutil_1.testSnippetLocation('sample'),
};
describe('Rosetta object can do live translation', () => {
    let rosetta;
    let translated;
    beforeEach(() => {
        // GIVEN
        rosetta = new lib_1.Rosetta({
            unknownSnippets: lib_1.UnknownSnippetMode.TRANSLATE,
            targetLanguages: [languages_1.TargetLanguage.PYTHON],
        });
        // WHEN
        translated = rosetta.translateSnippet(SAMPLE_CODE, languages_1.TargetLanguage.PYTHON);
    });
    test('output is correct', () => {
        expect(translated).toMatchObject({
            source: 'call_this_function()',
            language: 'python',
        });
    });
    test('translations are added to liveTablet', () => {
        expect(rosetta.liveTablet.count).toEqual(1);
    });
});
test('Can use preloaded tablet', () => {
    // GIVEN
    const rosetta = new lib_1.Rosetta();
    const tablet = new lib_1.LanguageTablet();
    tablet.addSnippet(makeSnippet(SAMPLE_CODE, {
        python: 'Not Really Translated',
        csharp: 'Not Really Translated C#',
        java: 'Not Really Translated Java',
    }));
    rosetta.addTablet(tablet);
    // WHEN
    const translated = rosetta.translateSnippet(SAMPLE_CODE, languages_1.TargetLanguage.PYTHON);
    // THEN
    expect(translated).toMatchObject({
        source: 'Not Really Translated',
        language: 'python',
    });
});
test('Rosetta object can do live translation', () => {
    // GIVEN
    const rosetta = new lib_1.Rosetta({
        unknownSnippets: lib_1.UnknownSnippetMode.TRANSLATE,
        targetLanguages: [languages_1.TargetLanguage.PYTHON],
    });
    // WHEN
    const translated = rosetta.translateSnippet(SAMPLE_CODE, languages_1.TargetLanguage.PYTHON);
    // THEN
    expect(translated).toMatchObject({
        source: 'call_this_function()',
        language: 'python',
    });
});
test('Rosetta object can fail on untranslated snippet', () => {
    // GIVEN
    const rosetta = new lib_1.Rosetta({
        unknownSnippets: lib_1.UnknownSnippetMode.FAIL,
        targetLanguages: [languages_1.TargetLanguage.PYTHON],
    });
    // WHEN
    expect(() => {
        rosetta.translateSnippet(SAMPLE_CODE, languages_1.TargetLanguage.PYTHON);
    }).toThrow(/snippet was not found/);
});
test('Rosetta can give you an untranslated snippet back', () => {
    // GIVEN
    const rosetta = new lib_1.Rosetta({
        unknownSnippets: lib_1.UnknownSnippetMode.VERBATIM,
        targetLanguages: [languages_1.TargetLanguage.PYTHON],
    });
    // WHEN
    const translated = rosetta.translateSnippet(SAMPLE_CODE, languages_1.TargetLanguage.PYTHON);
    expect(translated === null || translated === void 0 ? void 0 : translated.source).toEqual('callThisFunction();');
});
test('Rosetta object can do translation and annotation of snippets in MarkDown', () => {
    // GIVEN
    const rosetta = new lib_1.Rosetta({
        unknownSnippets: lib_1.UnknownSnippetMode.TRANSLATE,
        targetLanguages: [languages_1.TargetLanguage.PYTHON],
    });
    // WHEN
    const translated = rosetta.translateSnippetsInMarkdown({ api: 'file', fileName: 'markdown' }, [
        '# MarkDown Translation',
        '',
        'Now follows a snippet:',
        '```ts',
        SAMPLE_CODE.visibleSource,
        '```',
        'That was it, thank you for your attention.',
    ].join('\n'), languages_1.TargetLanguage.PYTHON, false, (trans) => {
        return {
            ...trans,
            source: `# We translated something!\n${trans.source}`,
        };
    });
    // THEN
    expect(translated).toEqual([
        '# MarkDown Translation',
        '',
        'Now follows a snippet:',
        '',
        '```python',
        '# We translated something!',
        'call_this_function()',
        '```',
        '',
        'That was it, thank you for your attention.',
    ].join('\n'));
});
describe('with mocked filesystem', () => {
    beforeEach(() => {
        mockfs();
    });
    afterEach(() => {
        mockfs.restore();
    });
    const tablet = new lib_1.LanguageTablet();
    tablet.addSnippet(makeSnippet(SAMPLE_CODE, {
        python: 'My Stored Translation',
        csharp: 'My Stored Translation C#',
        java: 'My Stored Translation Java',
    }));
    test('Can save language tablet and load it in Rosetta class', async () => {
        // GIVEN
        await tablet.save('/test.tablet');
        // WHEN
        const rosetta = new lib_1.Rosetta();
        await rosetta.loadTabletFromFile('/test.tablet');
        const translated = rosetta.translateSnippet(SAMPLE_CODE, languages_1.TargetLanguage.PYTHON);
        // THEN
        expect(translated).toMatchObject({
            source: 'My Stored Translation',
            language: 'python',
        });
    });
    test('Rosetta class automatically loads default-named tablets in same directory as assembly', async () => {
        // GIVEN
        await tablet.save(`/${lib_1.DEFAULT_TABLET_NAME}`);
        // WHEN
        const rosetta = new lib_1.Rosetta();
        await rosetta.addAssembly(fake_assembly_1.fakeAssembly({}), '/');
        const translated = rosetta.translateSnippet(SAMPLE_CODE, languages_1.TargetLanguage.PYTHON);
        // THEN
        expect(translated).toMatchObject({
            source: 'My Stored Translation',
            language: 'python',
        });
    });
});
function makeSnippet(original, translations) {
    const snippet = lib_1.TranslatedSnippet.fromTypeScript(original);
    for (const [key, value] of Object.entries(translations)) {
        snippet.addTranslation(key, value, 'x');
    }
    return snippet;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm9zZXR0YS50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicm9zZXR0YS50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsa0NBQWtDO0FBRWxDLGdDQVFnQjtBQUNoQixnREFBa0Q7QUFDbEQsd0RBQW9EO0FBQ3BELHlDQUFpRDtBQUVqRCxNQUFNLFdBQVcsR0FBc0I7SUFDckMsYUFBYSxFQUFFLHFCQUFxQjtJQUNwQyxRQUFRLEVBQUUsOEJBQW1CLENBQUMsUUFBUSxDQUFDO0NBQ3hDLENBQUM7QUFFRixRQUFRLENBQUMsd0NBQXdDLEVBQUUsR0FBRyxFQUFFO0lBQ3RELElBQUksT0FBZ0IsQ0FBQztJQUNyQixJQUFJLFVBQW1DLENBQUM7SUFDeEMsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLFFBQVE7UUFDUixPQUFPLEdBQUcsSUFBSSxhQUFPLENBQUM7WUFDcEIsZUFBZSxFQUFFLHdCQUFrQixDQUFDLFNBQVM7WUFDN0MsZUFBZSxFQUFFLENBQUMsMEJBQWMsQ0FBQyxNQUFNLENBQUM7U0FDekMsQ0FBQyxDQUFDO1FBRUgsT0FBTztRQUNQLFVBQVUsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLDBCQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDNUUsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO1FBQzdCLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxhQUFhLENBQUM7WUFDL0IsTUFBTSxFQUFFLHNCQUFzQjtZQUM5QixRQUFRLEVBQUUsUUFBUTtTQUNuQixDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxzQ0FBc0MsRUFBRSxHQUFHLEVBQUU7UUFDaEQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzlDLENBQUMsQ0FBQyxDQUFD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UTtTQUNuQixDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxXQUFXLENBQUMsUUFBMkIsRUFBRSxZQUE0QztJQUM1RixNQUFNLE9BQU8sR0FBRyx1QkFBaUIsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDM0QsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEVBQUU7UUFDdkQsT0FBTyxDQUFDLGNBQWMsQ0FBQyxHQUFxQixFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztLQUMzRDtJQUNELE9BQU8sT0FBTyxDQUFDO0FBQ2pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBtb2NrZnMgZnJvbSAnbW9jay1mcyc7XG5cbmltcG9ydCB7XG4gIFJvc2V0dGEsXG4gIExhbmd1YWdlVGFibGV0LFxuICBUcmFuc2xhdGVkU25pcHBldCxcbiAgVHlwZVNjcmlwdFNuaXBwZXQsXG4gIERFRkFVTFRfVEFCTEVUX05BTUUsXG4gIFRyYW5zbGF0aW9uLFxuICBVbmtub3duU25pcHBldE1vZGUsXG59IGZyb20gJy4uL2xpYic7XG5pbXBvcnQgeyBUYXJnZXRMYW5ndWFnZSB9IGZyb20gJy4uL2xpYi9sYW5ndWFnZXMnO1xuaW1wb3J0IHsgZmFrZUFzc2VtYmx5IH0gZnJvbSAnLi9qc2lpL2Zha2UtYXNzZW1ibHknO1xuaW1wb3J0IHsgdGVzdFNuaXBwZXRMb2NhdGlvbiB9IGZyb20gJy4vdGVzdHV0aWwnO1xuXG5jb25zdCBTQU1QTEVfQ09ERTogVHlwZVNjcmlwdFNuaXBwZXQgPSB7XG4gIHZpc2libGVTb3VyY2U6ICdjYWxsVGhpc0Z1bmN0aW9uKCk7JyxcbiAgbG9jYXRpb246IHRlc3RTbmlwcGV0TG9jYXRpb24oJ3NhbXBsZScpLFxufTtcblxuZGVzY3JpYmUoJ1Jvc2V0dGEgb2JqZWN0IGNhbiBkbyBsaXZlIHRyYW5zbGF0aW9uJywgKCkgPT4ge1xuICBsZXQgcm9zZXR0YTogUm9zZXR0YTtcbiAgbGV0IHRyYW5zbGF0ZWQ6IFRyYW5zbGF0aW9uIHwgdW5kZWZpbmVkO1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIHJvc2V0dGEgPSBuZXcgUm9zZXR0YSh7XG4gICAgICB1bmtub3duU25pcHBldHM6IFVua25vd25TbmlwcGV0TW9kZS5UUkFOU0xBVEUsXG4gICAgICB0YXJnZXRMYW5ndWFnZXM6IFtUYXJnZXRMYW5ndWFnZS5QWVRIT05dLFxuICAgIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIHRyYW5zbGF0ZWQgPSByb3NldHRhLnRyYW5zbGF0ZVNuaXBwZXQoU0FNUExFX0NPREUsIFRhcmdldExhbmd1YWdlLlBZVEhPTik7XG4gIH0pO1xuXG4gIHRlc3QoJ291dHB1dCBpcyBjb3JyZWN0JywgKCkgPT4ge1xuICAgIGV4cGVjdCh0cmFuc2xhdGVkKS50b01hdGNoT2JqZWN0KHtcbiAgICAgIHNvdXJjZTogJ2NhbGxfdGhpc19mdW5jdGlvbigpJyxcbiAgICAgIGxhbmd1YWdlOiAncHl0aG9uJyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgndHJhbnNsYXRpb25zIGFyZSBhZGRlZCB0byBsaXZlVGFibGV0JywgKCkgPT4ge1xuICAgIGV4cGVjdChyb3NldHRhLmxpdmVUYWJsZXQuY291bnQpLnRvRXF1YWwoMSk7XG4gIH0pO1xufSk7XG5cbnRlc3QoJ0NhbiB1c2UgcHJlbG9hZGVkIHRhYmxldCcsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgcm9zZXR0YSA9IG5ldyBSb3NldHRhKCk7XG5cbiAgY29uc3QgdGFibGV0ID0gbmV3IExhbmd1YWdlVGFibGV0KCk7XG4gIHRhYmxldC5hZGRTbmlwcGV0KFxuICAgIG1ha2VTbmlwcGV0KFNBTVBMRV9DT0RFLCB7XG4gICAgICBweXRob246ICdOb3QgUmVhbGx5IFRyYW5zbGF0ZWQnLFxuICAgICAgY3NoYXJwOiAnTm90IFJlYWxseSBUcmFuc2xhdGVkIEMjJyxcbiAgICAgIGphdmE6ICdOb3QgUmVhbGx5IFRyYW5zbGF0ZWQgSmF2YScsXG4gICAgfSksXG4gICk7XG4gIHJvc2V0dGEuYWRkVGFibGV0KHRhYmxldCk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCB0cmFuc2xhdGVkID0gcm9zZXR0YS50cmFuc2xhdGVTbmlwcGV0KFNBTVBMRV9DT0RFLCBUYXJnZXRMYW5ndWFnZS5QWVRIT04pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHRyYW5zbGF0ZWQpLnRvTWF0Y2hPYmplY3Qoe1xuICAgIHNvdXJjZTogJ05vdCBSZWFsbHkgVHJhbnNsYXRlZCcsXG4gICAgbGFuZ3VhZ2U6ICdweXRob24nLFxuICB9KTtcbn0pO1xuXG50ZXN0KCdSb3NldHRhIG9iamVjdCBjYW4gZG8gbGl2ZSB0cmFuc2xhdGlvbicsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgcm9zZXR0YSA9IG5ldyBSb3NldHRhKHtcbiAgICB1bmtub3duU25pcHBldHM6IFVua25vd25TbmlwcGV0TW9kZS5UUkFOU0xBVEUsXG4gICAgdGFyZ2V0TGFuZ3VhZ2VzOiBbVGFyZ2V0TGFuZ3VhZ2UuUFlUSE9OXSxcbiAgfSk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCB0cmFuc2xhdGVkID0gcm9zZXR0YS50cmFuc2xhdGVTbmlwcGV0KFNBTVBMRV9DT0RFLCBUYXJnZXRMYW5ndWFnZS5QWVRIT04pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHRyYW5zbGF0ZWQpLnRvTWF0Y2hPYmplY3Qoe1xuICAgIHNvdXJjZTogJ2NhbGxfdGhpc19mdW5jdGlvbigpJyxcbiAgICBsYW5ndWFnZTogJ3B5dGhvbicsXG4gIH0pO1xufSk7XG5cbnRlc3QoJ1Jvc2V0dGEgb2JqZWN0IGNhbiBmYWlsIG9uIHVudHJhbnNsYXRlZCBzbmlwcGV0JywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCByb3NldHRhID0gbmV3IFJvc2V0dGEoe1xuICAgIHVua25vd25TbmlwcGV0czogVW5rbm93blNuaXBwZXRNb2RlLkZBSUwsXG4gICAgdGFyZ2V0TGFuZ3VhZ2VzOiBbVGFyZ2V0TGFuZ3VhZ2UuUFlUSE9OXSxcbiAgfSk7XG5cbiAgLy8gV0hFTlxuICBleHBlY3QoKCkgPT4ge1xuICAgIHJvc2V0dGEudHJhbnNsYXRlU25pcHBldChTQU1QTEVfQ09ERSwgVGFyZ2V0TGFuZ3VhZ2UuUFlUSE9OKTtcbiAgfSkudG9UaHJvdygvc25pcHBldCB3YXMgbm90IGZvdW5kLyk7XG59KTtcblxudGVzdCgnUm9zZXR0YSBjYW4gZ2l2ZSB5b3UgYW4gdW50cmFuc2xhdGVkIHNuaXBwZXQgYmFjaycsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgcm9zZXR0YSA9IG5ldyBSb3NldHRhKHtcbiAgICB1bmtub3duU25pcHBldHM6IFVua25vd25TbmlwcGV0TW9kZS5WRVJCQVRJTSxcbiAgICB0YXJnZXRMYW5ndWFnZXM6IFtUYXJnZXRMYW5ndWFnZS5QWVRIT05dLFxuICB9KTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IHRyYW5zbGF0ZWQgPSByb3NldHRhLnRyYW5zbGF0ZVNuaXBwZXQoU0FNUExFX0NPREUsIFRhcmdldExhbmd1YWdlLlBZVEhPTik7XG5cbiAgZXhwZWN0KHRyYW5zbGF0ZWQ/LnNvdXJjZSkudG9FcXVhbCgnY2FsbFRoaXNGdW5jdGlvbigpOycpO1xufSk7XG5cbnRlc3QoJ1Jvc2V0dGEgb2JqZWN0IGNhbiBkbyB0cmFuc2xhdGlvbiBhbmQgYW5ub3RhdGlvbiBvZiBzbmlwcGV0cyBpbiBNYXJrRG93bicsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgcm9zZXR0YSA9IG5ldyBSb3NldHRhKHtcbiAgICB1bmtub3duU25pcHBldHM6IFVua25vd25TbmlwcGV0TW9kZS5UUkFOU0xBVEUsXG4gICAgdGFyZ2V0TGFuZ3VhZ2VzOiBbVGFyZ2V0TGFuZ3VhZ2UuUFlUSE9OXSxcbiAgfSk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCB0cmFuc2xhdGVkID0gcm9zZXR0YS50cmFuc2xhdGVTbmlwcGV0c0luTWFya2Rvd24oXG4gICAgeyBhcGk6ICdmaWxlJywgZmlsZU5hbWU6ICdtYXJrZG93bicgfSxcbiAgICBbXG4gICAgICAnIyBNYXJrRG93biBUcmFuc2xhdGlvbicsXG4gICAgICAnJyxcbiAgICAgICdOb3cgZm9sbG93cyBhIHNuaXBwZXQ6JyxcbiAgICAgICdgYGB0cycsXG4gICAgICBTQU1QTEVfQ09ERS52aXNpYmxlU291cmNlLFxuICAgICAgJ2BgYCcsXG4gICAgICAnVGhhdCB3YXMgaXQsIHRoYW5rIHlvdSBmb3IgeW91ciBhdHRlbnRpb24uJyxcbiAgICBdLmpvaW4oJ1xcbicpLFxuICAgIFRhcmdldExhbmd1YWdlLlBZVEhPTixcbiAgICBmYWxzZSxcbiAgICAodHJhbnMpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnRyYW5zLFxuICAgICAgICBzb3VyY2U6IGAjIFdlIHRyYW5zbGF0ZWQgc29tZXRoaW5nIVxcbiR7dHJhbnMuc291cmNlfWAsXG4gICAgICB9O1xuICAgIH0sXG4gICk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QodHJhbnNsYXRlZCkudG9FcXVhbChcbiAgICBbXG4gICAgICAnIyBNYXJrRG93biBUcmFuc2xhdGlvbicsXG4gICAgICAnJyxcbiAgICAgICdOb3cgZm9sbG93cyBhIHNuaXBwZXQ6JyxcbiAgICAgICcnLFxuICAgICAgJ2BgYHB5dGhvbicsXG4gICAgICAnIyBXZSB0cmFuc2xhdGVkIHNvbWV0aGluZyEnLFxuICAgICAgJ2NhbGxfdGhpc19mdW5jdGlvbigpJyxcbiAgICAgICdgYGAnLFxuICAgICAgJycsXG4gICAgICAnVGhhdCB3YXMgaXQsIHRoYW5rIHlvdSBmb3IgeW91ciBhdHRlbnRpb24uJyxcbiAgICBdLmpvaW4oJ1xcbicpLFxuICApO1xufSk7XG5cbmRlc2NyaWJlKCd3aXRoIG1vY2tlZCBmaWxlc3lzdGVtJywgKCkgPT4ge1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBtb2NrZnMoKTtcbiAgfSk7XG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgbW9ja2ZzLnJlc3RvcmUoKTtcbiAgfSk7XG5cbiAgY29uc3QgdGFibGV0ID0gbmV3IExhbmd1YWdlVGFibGV0KCk7XG4gIHRhYmxldC5hZGRTbmlwcGV0KFxuICAgIG1ha2VTbmlwcGV0KFNBTVBMRV9DT0RFLCB7XG4gICAgICBweXRob246ICdNeSBTdG9yZWQgVHJhbnNsYXRpb24nLFxuICAgICAgY3NoYXJwOiAnTXkgU3RvcmVkIFRyYW5zbGF0aW9uIEMjJyxcbiAgICAgIGphdmE6ICdNeSBTdG9yZWQgVHJhbnNsYXRpb24gSmF2YScsXG4gICAgfSksXG4gICk7XG5cbiAgdGVzdCgnQ2FuIHNhdmUgbGFuZ3VhZ2UgdGFibGV0IGFuZCBsb2FkIGl0IGluIFJvc2V0dGEgY2xhc3MnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBhd2FpdCB0YWJsZXQuc2F2ZSgnL3Rlc3QudGFibGV0Jyk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3Qgcm9zZXR0YSA9IG5ldyBSb3NldHRhKCk7XG4gICAgYXdhaXQgcm9zZXR0YS5sb2FkVGFibGV0RnJvbUZpbGUoJy90ZXN0LnRhYmxldCcpO1xuICAgIGNvbnN0IHRyYW5zbGF0ZWQgPSByb3NldHRhLnRyYW5zbGF0ZVNuaXBwZXQoU0FNUExFX0NPREUsIFRhcmdldExhbmd1YWdlLlBZVEhPTik7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHRyYW5zbGF0ZWQpLnRvTWF0Y2hPYmplY3Qoe1xuICAgICAgc291cmNlOiAnTXkgU3RvcmVkIFRyYW5zbGF0aW9uJyxcbiAgICAgIGxhbmd1YWdlOiAncHl0aG9uJyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnUm9zZXR0YSBjbGFzcyBhdXRvbWF0aWNhbGx5IGxvYWRzIGRlZmF1bHQtbmFtZWQgdGFibGV0cyBpbiBzYW1lIGRpcmVjdG9yeSBhcyBhc3NlbWJseScsIGFzeW5jICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGF3YWl0IHRhYmxldC5zYXZlKGAvJHtERUZBVUxUX1RBQkxFVF9OQU1FfWApO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHJvc2V0dGEgPSBuZXcgUm9zZXR0YSgpO1xuICAgIGF3YWl0IHJvc2V0dGEuYWRkQXNzZW1ibHkoZmFrZUFzc2VtYmx5KHt9KSwgJy8nKTtcbiAgICBjb25zdCB0cmFuc2xhdGVkID0gcm9zZXR0YS50cmFuc2xhdGVTbmlwcGV0KFNBTVBMRV9DT0RFLCBUYXJnZXRMYW5ndWFnZS5QWVRIT04pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdCh0cmFuc2xhdGVkKS50b01hdGNoT2JqZWN0KHtcbiAgICAgIHNvdXJjZTogJ015IFN0b3JlZCBUcmFuc2xhdGlvbicsXG4gICAgICBsYW5ndWFnZTogJ3B5dGhvbicsXG4gICAgfSk7XG4gIH0pO1xufSk7XG5cbmZ1bmN0aW9uIG1ha2VTbmlwcGV0KG9yaWdpbmFsOiBUeXBlU2NyaXB0U25pcHBldCwgdHJhbnNsYXRpb25zOiBSZWNvcmQ8VGFyZ2V0TGFuZ3VhZ2UsIHN0cmluZz4pIHtcbiAgY29uc3Qgc25pcHBldCA9IFRyYW5zbGF0ZWRTbmlwcGV0LmZyb21UeXBlU2NyaXB0KG9yaWdpbmFsKTtcbiAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXModHJhbnNsYXRpb25zKSkge1xuICAgIHNuaXBwZXQuYWRkVHJhbnNsYXRpb24oa2V5IGFzIFRhcmdldExhbmd1YWdlLCB2YWx1ZSwgJ3gnKTtcbiAgfVxuICByZXR1cm4gc25pcHBldDtcbn1cbiJdfQ==
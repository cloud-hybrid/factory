"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TerraformCloud = exports.TerraformCloudPlan = void 0;
/* eslint-disable @typescript-eslint/no-unused-vars */
const path = __importStar(require("path"));
const os = __importStar(require("os"));
const fs = __importStar(require("fs"));
const terraform_1 = require("./terraform");
const TerraformCloudClient = __importStar(require("@skorfmann/terraform-cloud"));
const archiver_1 = __importDefault(require("archiver"));
const stream_buffers_1 = require("stream-buffers");
const logging_1 = require("../../../../lib/logging");
class TerraformCloudPlan extends terraform_1.AbstractTerraformPlan {
    constructor(planFile, plan, url) {
        super(planFile, plan.resourceChanges, plan.outputChanges);
        this.planFile = planFile;
        this.plan = plan;
        this.url = url;
    }
}
exports.TerraformCloudPlan = TerraformCloudPlan;
const zipDirectory = (source) => {
    const archive = archiver_1.default("tar", { gzip: true });
    const stream = new stream_buffers_1.WritableStreamBuffer();
    return new Promise((resolve, reject) => {
        archive
            .directory(source, false)
            .on("error", (err) => reject(err))
            .on("end", () => resolve(stream.getContents()))
            .pipe(stream);
        archive.finalize();
    });
};
const wait = (ms = 1000) => {
    return new Promise((resolve) => {
        setTimeout(resolve, ms);
    });
};
function BeautifyErrors(name) {
    return (target, propertyKey, descriptor) => {
        const isMethod = descriptor && descriptor.value instanceof Function;
        if (!isMethod)
            return;
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        const originalMethod = descriptor.value;
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        descriptor.value = async function (...args) {
            var _a;
            try {
                return await originalMethod.apply(this, args);
            }
            catch (e) {
                if (e.response &&
                    e.response.status >= 400 &&
                    e.response.status <= 599) {
                    const errors = (_a = e.response.data) === null || _a === void 0 ? void 0 : _a.errors;
                    logging_1.logger.error(`Error in ${name}: ${JSON.stringify(e)}`);
                    if (errors) {
                        throw new Error(`${name}: Request to Terraform Cloud failed with status ${e.response.status}: ${errors.map((e) => JSON.stringify(e)).join(", ")}`);
                    }
                }
                else {
                    logging_1.logger.warn(`Error in ${name}: ${JSON.stringify(e)}`);
                }
                throw e;
            }
        };
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        Object.defineProperty(target, propertyKey, descriptor);
    };
}
class TerraformCloud {
    constructor(stack, config, isSpeculative = false) {
        this.stack = stack;
        this.config = config;
        this.terraformConfigFilePath = path.join(os.homedir(), ".terraform.d", "credentials.tfrc.json");
        if (!config.workspaces.name)
            throw new Error("Please provide a workspace name for Terraform Cloud");
        if (!config.organization)
            throw new Error("Please provide an organization for Terraform Cloud");
        this.workDir = stack.workingDirectory;
        this.hostname = config.hostname || "app.terraform.io";
        this.workspaceName = config.workspaces.name;
        this.organizationName = config.organization;
        this.isSpeculative = isSpeculative;
        if (config.token) {
            this.token = config.token;
        }
        else if (process.env.TERRAFORM_CLOUD_TOKEN) {
            this.token = process.env.TERRAFORM_CLOUD_TOKEN;
        }
        else {
            if (!fs.existsSync(this.terraformConfigFilePath))
                throw new Error("Please provide token for Terraform Cloud");
            const configFile = JSON.parse(fs.readFileSync(this.terraformConfigFilePath, "utf8"));
            this.token = configFile.credentials[this.hostname].token;
        }
        this.client = new TerraformCloudClient.TerraformCloud(this.token);
    }
    async isRemoteWorkspace() {
        const workspace = await this.workspace();
        return workspace.attributes.executionMode !== "local";
    }
    async init() {
        if (fs.existsSync(path.join(process.cwd(), `terraform.${this.stack.name}.tfstate`)))
            throw new Error('Found a "terraform.tfstate" file in your current working directory. Please migrate the state manually to Terraform Cloud and delete the file afterwards. https://cdk.tf/migrate-state');
        const workspace = await this.workspace();
        const version = await this.client.ConfigurationVersion.create(workspace.id, {
            data: {
                type: "configuration-version",
                attributes: {
                    autoQueueRuns: false,
                    speculative: this.isSpeculative,
                },
            },
        });
        this.configurationVersionId = version.id;
        this.removeLocalTerraformDirectory();
        const zipBuffer = await zipDirectory(this.workDir);
        if (!zipBuffer)
            throw new Error("Couldn't upload directory to Terraform Cloud");
        await this.client.ConfigurationVersion.upload(version.attributes.uploadUrl, zipBuffer);
        // we might get an HTTP 422 error if we don't wait for the processing and try to run too early. see #647
        await this.waitForConfigurationVersionToBeReady();
    }
    async plan(destroy = false) {
        var _a, _b, _c, _d, _e, _f, _g;
        if (!this.configurationVersionId)
            throw new Error("Please create a ConfigurationVersion before planning");
        const workspace = await this.workspace();
        const workspaceUrl = `https://app.terraform.io/app/${this.organizationName}/workspaces/${this.workspaceName}`;
        if (workspace.attributes.locked &&
            ((_c = (_b = (_a = workspace.relationships) === null || _a === void 0 ? void 0 : _a.lockedBy) === null || _b === void 0 ? void 0 : _b.data) === null || _c === void 0 ? void 0 : _c.type) === "users") {
            throw new Error(`Can not plan, the workspace ${this.organizationName}/${this.workspaceName} is locked by a user. You can find more information at ${workspaceUrl}`);
        }
        if (workspace.attributes.locked &&
            ((_f = (_e = (_d = workspace.relationships) === null || _d === void 0 ? void 0 : _d.lockedBy) === null || _e === void 0 ? void 0 : _e.data) === null || _f === void 0 ? void 0 : _f.type) === "runs") {
            throw new Error(`Can not plan, the workspace ${this.organizationName}/${this.workspaceName} is locked by a previous run, please wait until it's done. You can find more information at ${workspaceUrl}`);
        }
        if (workspace.attributes.locked) {
            throw new Error(`Can not plan, the workspace ${this.organizationName}/${this.workspaceName} is locked for an unknown reason: ${JSON.stringify((_g = workspace.relationships) === null || _g === void 0 ? void 0 : _g.lockedBy)}. You can find more information at ${workspaceUrl}`);
        }
        let result = await this.client.Runs.create({
            data: {
                attributes: {
                    isDestroy: destroy,
                    message: "cdktf",
                },
                relationships: {
                    configurationVersion: {
                        data: {
                            id: this.configurationVersionId,
                            type: "configuration-versions",
                        },
                    },
                    workspace: {
                        data: {
                            id: workspace.id,
                            type: "workspaces",
                        },
                    },
                },
            },
        });
        const pendingStates = ["pending", "plan_queued", "planning"];
        while (pendingStates.includes(result.attributes.status)) {
            result = await this.client.Runs.show(result.id);
            await wait(1000);
        }
        const url = `https://app.terraform.io/app/${this.organizationName}/workspaces/${this.workspaceName}/runs/${result.id}`;
        if (result.attributes.status === "errored") {
            throw new Error(`Error planning the run, please take a look at ${url}`);
        }
        const plan = await this.client.Plans.jsonOutput(result.relationships.plan.data.id);
        this.run = result;
        return new TerraformCloudPlan("terraform-cloud", plan, url);
    }
    async deploy(_planFile, stdout) {
        if (!this.run)
            throw new Error("Please create a ConfigurationVersion / Plan before deploying");
        const deployingStates = ["confirmed", "apply_queued", "applying"];
        const runId = this.run.id;
        await this.client.Runs.action("apply", runId);
        let result = await this.client.Runs.show(runId);
        async function update(client) {
            const res = await client.Runs.show(runId);
            // fetch logs and update UI in the background
            client.Applies.logs(result.relationships.apply.data.id).then(({ data }) => {
                // In rare cases the backend sends an empty chunk of data back.
                if (data && data.length) {
                    stdout(Buffer.from(data, "utf8"));
                }
            });
            return res;
        }
        while (deployingStates.includes(result.attributes.status)) {
            result = await update(this.client);
            await wait(1000);
        }
        switch (result.attributes.status) {
            case "applied":
                break;
            default:
                throw new Error(`error: ${result.attributes.status}`);
        }
    }
    async destroy(stdout) {
        if (!this.run)
            throw new Error("Please create a ConfigurationVersion / Plan before destroying");
        const destroyingStates = ["confirmed", "apply_queued", "applying"];
        const runId = this.run.id;
        await this.client.Runs.action("apply", runId);
        let result = await this.client.Runs.show(runId);
        async function update(client) {
            const res = await client.Runs.show(runId);
            // fetch logs and update UI in the background
            client.Applies.logs(result.relationships.apply.data.id).then(({ data }) => stdout(Buffer.from(data, "utf8")));
            return res;
        }
        while (destroyingStates.includes(result.attributes.status)) {
            result = await update(this.client);
            await wait(1000);
        }
        switch (result.attributes.status) {
            case "applied":
                break;
            default:
                throw new Error(`error: ${result.attributes.status}`);
        }
    }
    async version() {
        return (await this.workspace()).attributes.terraformVersion;
    }
    async output() {
        const stateVersion = await this.client.StateVersions.current((await this.workspace()).id, true);
        if (!stateVersion.included)
            return {};
        const outputs = stateVersion.included.reduce((acc, output) => {
            acc[output.attributes.name] = {
                sensitive: output.attributes.sensitive,
                type: output.attributes.type,
                value: output.attributes.value,
            };
            return acc;
        }, {});
        return outputs;
    }
    async workspace() {
        var _a;
        try {
            return await this.client.Workspaces.showByName(this.organizationName, this.workspaceName);
        }
        catch (e) {
            if (((_a = e.response) === null || _a === void 0 ? void 0 : _a.status) === 404) {
                // return a more descriptive error message as http response is not descriptive enough
                // will not be touched by BeautifyErrors decorator
                throw new Error(`TerraformCloud returned an HTTP 404 error. Please make sure the configured organization (${this.organizationName}) and workspace (${this.workspaceName}) exist and you have the correct access rights.`);
            }
            throw e;
        }
    }
    async isConfigurationVersionReady() {
        if (!this.configurationVersionId)
            throw new Error("No ConfigurationVersionId known. Cannot wait for ConfigurationVersion to become ready");
        const configVersion = await this.client.ConfigurationVersion.show(this.configurationVersionId);
        const { status } = configVersion.attributes;
        switch (status) {
            case "uploaded":
                return true;
            case "errored": {
                const { error, errorMessage } = configVersion.attributes;
                logging_1.logger.error(`ConfigurationVersion in Terraform Cloud has status "${status}". Returned config version was ${JSON.stringify(configVersion)}`);
                throw new Error(`Terraform Cloud ConfigurationVersion ${this.configurationVersionId} has status "errored" ${JSON.stringify({ error, errorMessage })}`);
            }
            case "pending": // fallthrough
            default:
                logging_1.logger.debug(`ConfigurationVersion in Terraform Cloud not considered ready with status "${status}".`);
                return false;
        }
    }
    async waitForConfigurationVersionToBeReady(timeoutMs = 60000) {
        logging_1.logger.debug("waiting for Configuration Version to be ready in Terraform Cloud");
        let timeoutReached = false;
        const ready = async () => {
            while (!((await this.isConfigurationVersionReady()) && !timeoutReached)) {
                await wait(1000);
            }
        };
        const timeout = async () => {
            await wait(timeoutMs);
            timeoutReached = true;
            throw new Error(`Waiting for Terraform Cloud ConfigurationVersion to become ready timed out (timeout was ${timeoutMs}ms)`);
        };
        await Promise.race([ready(), timeout()]);
        logging_1.logger.debug("Configuration Version is ready in Terraform Cloud");
    }
    removeLocalTerraformDirectory() {
        try {
            fs.rmdirSync(path.resolve(this.stack.synthesizedStackPath, ".terraform"), { recursive: true });
        }
        catch (error) {
            logging_1.logger.debug(`Could not remove .terraform folder`, error);
        }
    }
}
__decorate([
    BeautifyErrors("IsRemoteWorkspace")
], TerraformCloud.prototype, "isRemoteWorkspace", null);
__decorate([
    BeautifyErrors("Init")
], TerraformCloud.prototype, "init", null);
__decorate([
    BeautifyErrors("Plan")
], TerraformCloud.prototype, "plan", null);
__decorate([
    BeautifyErrors("Deploy")
], TerraformCloud.prototype, "deploy", null);
__decorate([
    BeautifyErrors("Destroy")
], TerraformCloud.prototype, "destroy", null);
__decorate([
    BeautifyErrors("Version")
], TerraformCloud.prototype, "version", null);
__decorate([
    BeautifyErrors("Output")
], TerraformCloud.prototype, "output", null);
__decorate([
    BeautifyErrors("Workspace")
], TerraformCloud.prototype, "workspace", null);
exports.TerraformCloud = TerraformCloud;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVycmFmb3JtLWNsb3VkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVycmFmb3JtLWNsb3VkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxzREFBc0Q7QUFDdEQsMkNBQTZCO0FBQzdCLHVDQUF5QjtBQUN6Qix1Q0FBeUI7QUFDekIsMkNBS3FCO0FBRXJCLGlGQUFtRTtBQUNuRSx3REFBZ0M7QUFDaEMsbURBQXNEO0FBRXRELHFEQUFpRDtBQUNqRCxNQUFhLGtCQUNYLFNBQVEsaUNBQXFCO0lBRzdCLFlBQ2tCLFFBQWdCLEVBQ2hCLElBQTRCLEVBQzVCLEdBQVc7UUFFM0IsS0FBSyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUoxQyxhQUFRLEdBQVIsUUFBUSxDQUFRO1FBQ2hCLFNBQUksR0FBSixJQUFJLENBQXdCO1FBQzVCLFFBQUcsR0FBSCxHQUFHLENBQVE7SUFHN0IsQ0FBQztDQUNGO0FBWEQsZ0RBV0M7QUFhRCxNQUFNLFlBQVksR0FBRyxDQUFDLE1BQWMsRUFBMkIsRUFBRTtJQUMvRCxNQUFNLE9BQU8sR0FBRyxrQkFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ2hELE1BQU0sTUFBTSxHQUFHLElBQUkscUNBQW9CLEVBQUUsQ0FBQztJQUUxQyxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQ3JDLE9BQU87YUFDSixTQUFTLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQzthQUN4QixFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDakMsRUFBRSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFB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RkFBMkYsU0FBUyxLQUFLLENBQzFHLENBQUM7UUFDSixDQUFDLENBQUM7UUFDRixNQUFNLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDekMsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsbURBQW1ELENBQUMsQ0FBQztJQUNwRSxDQUFDO0lBRU8sNkJBQTZCO1FBQ25DLElBQUk7WUFDRixFQUFFLENBQUMsU0FBUyxDQUNWLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsRUFBRSxZQUFZLENBQUMsRUFDM0QsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQ3BCLENBQUM7U0FDSDtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDM0Q7SUFDSCxDQUFDO0NBQ0Y7QUE5VEM7SUFEQyxjQUFjLENBQUMsbUJBQW1CLENBQUM7dURBSW5DO0FBR0Q7SUFEQyxjQUFjLENBQUMsTUFBTSxDQUFDOzBDQXVDdEI7QUFHRDtJQURDLGNBQWMsQ0FBQyxNQUFNLENBQUM7MENBOEV0QjtBQUdEO0lBREMsY0FBYyxDQUFDLFFBQVEsQ0FBQzs0Q0F5Q3hCO0FBR0Q7SUFEQyxjQUFjLENBQUMsU0FBUyxDQUFDOzZDQWlDekI7QUFHRDtJQURDLGNBQWMsQ0FBQyxTQUFTLENBQUM7NkNBR3pCO0FBR0Q7SUFEQyxjQUFjLENBQUMsUUFBUSxDQUFDOzRDQXFCeEI7QUFHRDtJQURDLGNBQWMsQ0FBQyxXQUFXLENBQUM7K0NBaUIzQjtBQXpTSCx3Q0E4V0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnMgKi9cbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIG9zIGZyb20gXCJvc1wiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQge1xuICBUZXJyYWZvcm0sXG4gIFRlcnJhZm9ybVBsYW4sXG4gIFRlcnJhZm9ybU91dHB1dCxcbiAgQWJzdHJhY3RUZXJyYWZvcm1QbGFuLFxufSBmcm9tIFwiLi90ZXJyYWZvcm1cIjtcbmltcG9ydCB7IFRlcnJhZm9ybUpzb25Db25maWdCYWNrZW5kUmVtb3RlIH0gZnJvbSBcIi4uL3RlcnJhZm9ybS1qc29uXCI7XG5pbXBvcnQgKiBhcyBUZXJyYWZvcm1DbG91ZENsaWVudCBmcm9tIFwiQHNrb3JmbWFubi90ZXJyYWZvcm0tY2xvdWRcIjtcbmltcG9ydCBhcmNoaXZlciBmcm9tIFwiYXJjaGl2ZXJcIjtcbmltcG9ydCB7IFdyaXRhYmxlU3RyZWFtQnVmZmVyIH0gZnJvbSBcInN0cmVhbS1idWZmZXJzXCI7XG5pbXBvcnQgeyBTeW50aGVzaXplZFN0YWNrIH0gZnJvbSBcIi4uLy4uL2hlbHBlci9zeW50aC1zdGFja1wiO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIi4uLy4uLy4uLy4uL2xpYi9sb2dnaW5nXCI7XG5leHBvcnQgY2xhc3MgVGVycmFmb3JtQ2xvdWRQbGFuXG4gIGV4dGVuZHMgQWJzdHJhY3RUZXJyYWZvcm1QbGFuXG4gIGltcGxlbWVudHMgVGVycmFmb3JtUGxhblxue1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGxhbkZpbGU6IHN0cmluZyxcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGxhbjogeyBba2V5OiBzdHJpbmddOiBhbnkgfSxcbiAgICBwdWJsaWMgcmVhZG9ubHkgdXJsOiBzdHJpbmdcbiAgKSB7XG4gICAgc3VwZXIocGxhbkZpbGUsIHBsYW4ucmVzb3VyY2VDaGFuZ2VzLCBwbGFuLm91dHB1dENoYW5nZXMpO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGVycmFmb3JtQ3JlZGVudGlhbHNJdGVtIHtcbiAgdG9rZW46IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUZXJyYWZvcm1DcmVkZW50aWFscyB7XG4gIFtob3N0bmFtZTogc3RyaW5nXTogVGVycmFmb3JtQ3JlZGVudGlhbHNJdGVtO1xufVxuZXhwb3J0IGludGVyZmFjZSBUZXJyYWZvcm1DcmVkZW50aWFsc0ZpbGUge1xuICBjcmVkZW50aWFsczogVGVycmFmb3JtQ3JlZGVudGlhbHM7XG59XG5cbmNvbnN0IHppcERpcmVjdG9yeSA9IChzb3VyY2U6IHN0cmluZyk6IFByb21pc2U8QnVmZmVyIHwgZmFsc2U+ID0+IHtcbiAgY29uc3QgYXJjaGl2ZSA9IGFyY2hpdmVyKFwidGFyXCIsIHsgZ3ppcDogdHJ1ZSB9KTtcbiAgY29uc3Qgc3RyZWFtID0gbmV3IFdyaXRhYmxlU3RyZWFtQnVmZmVyKCk7XG5cbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBhcmNoaXZlXG4gICAgICAuZGlyZWN0b3J5KHNvdXJjZSwgZmFsc2UpXG4gICAgICAub24oXCJlcnJvclwiLCAoZXJyKSA9PiByZWplY3QoZXJyKSlcbiAgICAgIC5vbihcImVuZFwiLCAoKSA9PiByZXNvbHZlKHN0cmVhbS5nZXRDb250ZW50cygpKSlcbiAgICAgIC5waXBlKHN0cmVhbSk7XG4gICAgYXJjaGl2ZS5maW5hbGl6ZSgpO1xuICB9KTtcbn07XG5cbmNvbnN0IHdhaXQgPSAobXMgPSAxMDAwKSA9PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpO1xuICB9KTtcbn07XG5cbmZ1bmN0aW9uIEJlYXV0aWZ5RXJyb3JzKG5hbWU6IHN0cmluZykge1xuICByZXR1cm4gKHRhcmdldDogYW55LCBwcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3IpID0+IHtcbiAgICBjb25zdCBpc01ldGhvZCA9IGRlc2NyaXB0b3IgJiYgZGVzY3JpcHRvci52YWx1ZSBpbnN0YW5jZW9mIEZ1bmN0aW9uO1xuICAgIGlmICghaXNNZXRob2QpIHJldHVybjtcblxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgY29uc3Qgb3JpZ2luYWxNZXRob2QgPSBkZXNjcmlwdG9yIS52YWx1ZTtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICAgIGRlc2NyaXB0b3IhLnZhbHVlID0gYXN5bmMgZnVuY3Rpb24gKC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gYXdhaXQgb3JpZ2luYWxNZXRob2QuYXBwbHkodGhpcywgYXJncyk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBlLnJlc3BvbnNlICYmXG4gICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPj0gNDAwICYmXG4gICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPD0gNTk5XG4gICAgICAgICkge1xuICAgICAgICAgIGNvbnN0IGVycm9ycyA9IGUucmVzcG9uc2UuZGF0YT8uZXJyb3JzIGFzXG4gICAgICAgICAgICB8IFJlY29yZDxzdHJpbmcsIHVua25vd24+W11cbiAgICAgICAgICAgIHwgdW5kZWZpbmVkO1xuICAgICAgICAgIGxvZ2dlci5lcnJvcihgRXJyb3IgaW4gJHtuYW1lfTogJHtKU09OLnN0cmluZ2lmeShlKX1gKTtcbiAgICAgICAgICBpZiAoZXJyb3JzKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgIGAke25hbWV9OiBSZXF1ZXN0IHRvIFRlcnJhZm9ybSBDbG91ZCBmYWlsZWQgd2l0aCBzdGF0dXMgJHtcbiAgICAgICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1c1xuICAgICAgICAgICAgICB9OiAke2Vycm9ycy5tYXAoKGUpID0+IEpTT04uc3RyaW5naWZ5KGUpKS5qb2luKFwiLCBcIil9YFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbG9nZ2VyLndhcm4oYEVycm9yIGluICR7bmFtZX06ICR7SlNPTi5zdHJpbmdpZnkoZSl9YCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBwcm9wZXJ0eUtleSwgZGVzY3JpcHRvciEpO1xuICB9O1xufVxuZXhwb3J0IGNsYXNzIFRlcnJhZm9ybUNsb3VkIGltcGxlbWVudHMgVGVycmFmb3JtIHtcbiAgcHJpdmF0ZSByZWFkb25seSB0ZXJyYWZvcm1Db25maWdGaWxlUGF0aCA9IHBhdGguam9pbihcbiAgICBvcy5ob21lZGlyKCksXG4gICAgXCIudGVycmFmb3JtLmRcIixcbiAgICBcImNyZWRlbnRpYWxzLnRmcmMuanNvblwiXG4gICk7XG4gIHByaXZhdGUgcmVhZG9ubHkgdG9rZW46IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBob3N0bmFtZTogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IHdvcmtzcGFjZU5hbWU6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBvcmdhbml6YXRpb25OYW1lOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgY2xpZW50OiBUZXJyYWZvcm1DbG91ZENsaWVudC5UZXJyYWZvcm1DbG91ZDtcbiAgcHJpdmF0ZSByZWFkb25seSBpc1NwZWN1bGF0aXZlOiBib29sZWFuO1xuICBwcml2YXRlIGNvbmZpZ3VyYXRpb25WZXJzaW9uSWQ/OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSB3b3JrRGlyOiBzdHJpbmc7XG4gIHB1YmxpYyBydW4/OiBUZXJyYWZvcm1DbG91ZENsaWVudC5SdW47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHJlYWRvbmx5IHN0YWNrOiBTeW50aGVzaXplZFN0YWNrLFxuICAgIHB1YmxpYyByZWFkb25seSBjb25maWc6IFRlcnJhZm9ybUpzb25Db25maWdCYWNrZW5kUmVtb3RlLFxuICAgIGlzU3BlY3VsYXRpdmUgPSBmYWxzZVxuICApIHtcbiAgICBpZiAoIWNvbmZpZy53b3Jrc3BhY2VzLm5hbWUpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJQbGVhc2UgcHJvdmlkZSBhIHdvcmtzcGFjZSBuYW1lIGZvciBUZXJyYWZvcm0gQ2xvdWRcIik7XG4gICAgaWYgKCFjb25maWcub3JnYW5pemF0aW9uKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUGxlYXNlIHByb3ZpZGUgYW4gb3JnYW5pemF0aW9uIGZvciBUZXJyYWZvcm0gQ2xvdWRcIik7XG4gICAgdGhpcy53b3JrRGlyID0gc3RhY2sud29ya2luZ0RpcmVjdG9yeTtcblxuICAgIHRoaXMuaG9zdG5hbWUgPSBjb25maWcuaG9zdG5hbWUgfHwgXCJhcHAudGVycmFmb3JtLmlvXCI7XG4gICAgdGhpcy53b3Jrc3BhY2VOYW1lID0gY29uZmlnLndvcmtzcGFjZXMubmFtZTtcbiAgICB0aGlzLm9yZ2FuaXphdGlvbk5hbWUgPSBjb25maWcub3JnYW5pemF0aW9uO1xuICAgIHRoaXMuaXNTcGVjdWxhdGl2ZSA9IGlzU3BlY3VsYXRpdmU7XG4gICAgaWYgKGNvbmZpZy50b2tlbikge1xuICAgICAgdGhpcy50b2tlbiA9IGNvbmZpZy50b2tlbjtcbiAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52LlRFUlJBRk9STV9DTE9VRF9UT0tFTikge1xuICAgICAgdGhpcy50b2tlbiA9IHByb2Nlc3MuZW52LlRFUlJBRk9STV9DTE9VRF9UT0tFTjtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHRoaXMudGVycmFmb3JtQ29uZmlnRmlsZVBhdGgpKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJQbGVhc2UgcHJvdmlkZSB0b2tlbiBmb3IgVGVycmFmb3JtIENsb3VkXCIpO1xuICAgICAgY29uc3QgY29uZmlnRmlsZSA9IEpTT04ucGFyc2UoXG4gICAgICAgIGZzLnJlYWRGaWxlU3luYyh0aGlzLnRlcnJhZm9ybUNvbmZpZ0ZpbGVQYXRoLCBcInV0ZjhcIilcbiAgICAgICkgYXMgVGVycmFmb3JtQ3JlZGVudGlhbHNGaWxlO1xuICAgICAgdGhpcy50b2tlbiA9IGNvbmZpZ0ZpbGUuY3JlZGVudGlhbHNbdGhpcy5ob3N0bmFtZV0udG9rZW47XG4gICAgfVxuXG4gICAgdGhpcy5jbGllbnQgPSBuZXcgVGVycmFmb3JtQ2xvdWRDbGllbnQuVGVycmFmb3JtQ2xvdWQodGhpcy50b2tlbik7XG4gIH1cblxuICBAQmVhdXRpZnlFcnJvcnMoXCJJc1JlbW90ZVdvcmtzcGFjZVwiKVxuICBwdWJsaWMgYXN5bmMgaXNSZW1vdGVXb3Jrc3BhY2UoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3Qgd29ya3NwYWNlID0gYXdhaXQgdGhpcy53b3Jrc3BhY2UoKTtcbiAgICByZXR1cm4gd29ya3NwYWNlLmF0dHJpYnV0ZXMuZXhlY3V0aW9uTW9kZSAhPT0gXCJsb2NhbFwiO1xuICB9XG5cbiAgQEJlYXV0aWZ5RXJyb3JzKFwiSW5pdFwiKVxuICBwdWJsaWMgYXN5bmMgaW5pdCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoXG4gICAgICBmcy5leGlzdHNTeW5jKFxuICAgICAgICBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgYHRlcnJhZm9ybS4ke3RoaXMuc3RhY2submFtZX0udGZzdGF0ZWApXG4gICAgICApXG4gICAgKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnRm91bmQgYSBcInRlcnJhZm9ybS50ZnN0YXRlXCIgZmlsZSBpbiB5b3VyIGN1cnJlbnQgd29ya2luZyBkaXJlY3RvcnkuIFBsZWFzZSBtaWdyYXRlIHRoZSBzdGF0ZSBtYW51YWxseSB0byBUZXJyYWZvcm0gQ2xvdWQgYW5kIGRlbGV0ZSB0aGUgZmlsZSBhZnRlcndhcmRzLiBodHRwczovL2Nkay50Zi9taWdyYXRlLXN0YXRlJ1xuICAgICAgKTtcbiAgICBjb25zdCB3b3Jrc3BhY2UgPSBhd2FpdCB0aGlzLndvcmtzcGFjZSgpO1xuICAgIGNvbnN0IHZlcnNpb24gPSBhd2FpdCB0aGlzLmNsaWVudC5Db25maWd1cmF0aW9uVmVyc2lvbi5jcmVhdGUoXG4gICAgICB3b3Jrc3BhY2UuaWQsXG4gICAgICB7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB0eXBlOiBcImNvbmZpZ3VyYXRpb24tdmVyc2lvblwiLFxuICAgICAgICAgIGF0dHJpYnV0ZXM6IHtcbiAgICAgICAgICAgIGF1dG9RdWV1ZVJ1bnM6IGZhbHNlLFxuICAgICAgICAgICAgc3BlY3VsYXRpdmU6IHRoaXMuaXNTcGVjdWxhdGl2ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfVxuICAgICk7XG5cbiAgICB0aGlzLmNvbmZpZ3VyYXRpb25WZXJzaW9uSWQgPSB2ZXJzaW9uLmlkO1xuXG4gICAgdGhpcy5yZW1vdmVMb2NhbFRlcnJhZm9ybURpcmVjdG9yeSgpO1xuXG4gICAgY29uc3QgemlwQnVmZmVyID0gYXdhaXQgemlwRGlyZWN0b3J5KHRoaXMud29ya0Rpcik7XG4gICAgaWYgKCF6aXBCdWZmZXIpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZG4ndCB1cGxvYWQgZGlyZWN0b3J5IHRvIFRlcnJhZm9ybSBDbG91ZFwiKTtcblxuICAgIGF3YWl0IHRoaXMuY2xpZW50LkNvbmZpZ3VyYXRpb25WZXJzaW9uLnVwbG9hZChcbiAgICAgIHZlcnNpb24uYXR0cmlidXRlcy51cGxvYWRVcmwsXG4gICAgICB6aXBCdWZmZXJcbiAgICApO1xuXG4gICAgLy8gd2UgbWlnaHQgZ2V0IGFuIEhUVFAgNDIyIGVycm9yIGlmIHdlIGRvbid0IHdhaXQgZm9yIHRoZSBwcm9jZXNzaW5nIGFuZCB0cnkgdG8gcnVuIHRvbyBlYXJseS4gc2VlICM2NDdcbiAgICBhd2FpdCB0aGlzLndhaXRGb3JDb25maWd1cmF0aW9uVmVyc2lvblRvQmVSZWFkeSgpO1xuICB9XG5cbiAgQEJlYXV0aWZ5RXJyb3JzKFwiUGxhblwiKVxuICBwdWJsaWMgYXN5bmMgcGxhbihkZXN0cm95ID0gZmFsc2UpOiBQcm9taXNlPFRlcnJhZm9ybVBsYW4+IHtcbiAgICBpZiAoIXRoaXMuY29uZmlndXJhdGlvblZlcnNpb25JZClcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlBsZWFzZSBjcmVhdGUgYSBDb25maWd1cmF0aW9uVmVyc2lvbiBiZWZvcmUgcGxhbm5pbmdcIik7XG4gICAgY29uc3Qgd29ya3NwYWNlID0gYXdhaXQgdGhpcy53b3Jrc3BhY2UoKTtcbiAgICBjb25zdCB3b3Jrc3BhY2VVcmwgPSBgaHR0cHM6Ly9hcHAudGVycmFmb3JtLmlvL2FwcC8ke3RoaXMub3JnYW5pemF0aW9uTmFtZX0vd29ya3NwYWNlcy8ke3RoaXMud29ya3NwYWNlTmFtZX1gO1xuXG4gICAgaWYgKFxuICAgICAgd29ya3NwYWNlLmF0dHJpYnV0ZXMubG9ja2VkICYmXG4gICAgICB3b3Jrc3BhY2UucmVsYXRpb25zaGlwcz8ubG9ja2VkQnk/LmRhdGE/LnR5cGUgPT09IFwidXNlcnNcIlxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ2FuIG5vdCBwbGFuLCB0aGUgd29ya3NwYWNlICR7dGhpcy5vcmdhbml6YXRpb25OYW1lfS8ke3RoaXMud29ya3NwYWNlTmFtZX0gaXMgbG9ja2VkIGJ5IGEgdXNlci4gWW91IGNhbiBmaW5kIG1vcmUgaW5mb3JtYXRpb24gYXQgJHt3b3Jrc3BhY2VVcmx9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICB3b3Jrc3BhY2UuYXR0cmlidXRlcy5sb2NrZWQgJiZcbiAgICAgIHdvcmtzcGFjZS5yZWxhdGlvbnNoaXBzPy5sb2NrZWRCeT8uZGF0YT8udHlwZSA9PT0gXCJydW5zXCJcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENhbiBub3QgcGxhbiwgdGhlIHdvcmtzcGFjZSAke3RoaXMub3JnYW5pemF0aW9uTmFtZX0vJHt0aGlzLndvcmtzcGFjZU5hbWV9IGlzIGxvY2tlZCBieSBhIHByZXZpb3VzIHJ1biwgcGxlYXNlIHdhaXQgdW50aWwgaXQncyBkb25lLiBZb3UgY2FuIGZpbmQgbW9yZSBpbmZvcm1hdGlvbiBhdCAke3dvcmtzcGFjZVVybH1gXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICh3b3Jrc3BhY2UuYXR0cmlidXRlcy5sb2NrZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENhbiBub3QgcGxhbiwgdGhlIHdvcmtzcGFjZSAke3RoaXMub3JnYW5pemF0aW9uTmFtZX0vJHtcbiAgICAgICAgICB0aGlzLndvcmtzcGFjZU5hbWVcbiAgICAgICAgfSBpcyBsb2NrZWQgZm9yIGFuIHVua25vd24gcmVhc29uOiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICAgIHdvcmtzcGFjZS5yZWxhdGlvbnNoaXBzPy5sb2NrZWRCeVxuICAgICAgICApfS4gWW91IGNhbiBmaW5kIG1vcmUgaW5mb3JtYXRpb24gYXQgJHt3b3Jrc3BhY2VVcmx9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBsZXQgcmVzdWx0ID0gYXdhaXQgdGhpcy5jbGllbnQuUnVucy5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICBhdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgaXNEZXN0cm95OiBkZXN0cm95LFxuICAgICAgICAgIG1lc3NhZ2U6IFwiY2RrdGZcIixcbiAgICAgICAgfSxcbiAgICAgICAgcmVsYXRpb25zaGlwczoge1xuICAgICAgICAgIGNvbmZpZ3VyYXRpb25WZXJzaW9uOiB7XG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgIGlkOiB0aGlzLmNvbmZpZ3VyYXRpb25WZXJzaW9uSWQsXG4gICAgICAgICAgICAgIHR5cGU6IFwiY29uZmlndXJhdGlvbi12ZXJzaW9uc1wiLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHdvcmtzcGFjZToge1xuICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICBpZDogd29ya3NwYWNlLmlkLFxuICAgICAgICAgICAgICB0eXBlOiBcIndvcmtzcGFjZXNcIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBwZW5kaW5nU3RhdGVzID0gW1wicGVuZGluZ1wiLCBcInBsYW5fcXVldWVkXCIsIFwicGxhbm5pbmdcIl07XG4gICAgd2hpbGUgKHBlbmRpbmdTdGF0ZXMuaW5jbHVkZXMocmVzdWx0LmF0dHJpYnV0ZXMuc3RhdHVzKSkge1xuICAgICAgcmVzdWx0ID0gYXdhaXQgdGhpcy5jbGllbnQuUnVucy5zaG93KHJlc3VsdC5pZCk7XG4gICAgICBhd2FpdCB3YWl0KDEwMDApO1xuICAgIH1cblxuICAgIGNvbnN0IHVybCA9IGBodHRwczovL2FwcC50ZXJyYWZvcm0uaW8vYXBwLyR7dGhpcy5vcmdhbml6YXRpb25OYW1lfS93b3Jrc3BhY2VzLyR7dGhpcy53b3Jrc3BhY2VOYW1lfS9ydW5zLyR7cmVzdWx0LmlkfWA7XG4gICAgaWYgKHJlc3VsdC5hdHRyaWJ1dGVzLnN0YXR1cyA9PT0gXCJlcnJvcmVkXCIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRXJyb3IgcGxhbm5pbmcgdGhlIHJ1biwgcGxlYXNlIHRha2UgYSBsb29rIGF0ICR7dXJsfWApO1xuICAgIH1cblxuICAgIGNvbnN0IHBsYW4gPSBhd2FpdCB0aGlzLmNsaWVudC5QbGFucy5qc29uT3V0cHV0KFxuICAgICAgcmVzdWx0LnJlbGF0aW9uc2hpcHMucGxhbi5kYXRhLmlkXG4gICAgKTtcbiAgICB0aGlzLnJ1biA9IHJlc3VsdDtcbiAgICByZXR1cm4gbmV3IFRlcnJhZm9ybUNsb3VkUGxhbihcbiAgICAgIFwidGVycmFmb3JtLWNsb3VkXCIsXG4gICAgICBwbGFuIGFzIHVua25vd24gYXMgYW55LFxuICAgICAgdXJsXG4gICAgKTtcbiAgfVxuXG4gIEBCZWF1dGlmeUVycm9ycyhcIkRlcGxveVwiKVxuICBwdWJsaWMgYXN5bmMgZGVwbG95KFxuICAgIF9wbGFuRmlsZTogc3RyaW5nLFxuICAgIHN0ZG91dDogKGNodW5rOiBCdWZmZXIpID0+IGFueVxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMucnVuKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBcIlBsZWFzZSBjcmVhdGUgYSBDb25maWd1cmF0aW9uVmVyc2lvbiAvIFBsYW4gYmVmb3JlIGRlcGxveWluZ1wiXG4gICAgICApO1xuXG4gICAgY29uc3QgZGVwbG95aW5nU3RhdGVzID0gW1wiY29uZmlybWVkXCIsIFwiYXBwbHlfcXVldWVkXCIsIFwiYXBwbHlpbmdcIl07XG4gICAgY29uc3QgcnVuSWQgPSB0aGlzLnJ1bi5pZDtcbiAgICBhd2FpdCB0aGlzLmNsaWVudC5SdW5zLmFjdGlvbihcImFwcGx5XCIsIHJ1bklkKTtcbiAgICBsZXQgcmVzdWx0ID0gYXdhaXQgdGhpcy5jbGllbnQuUnVucy5zaG93KHJ1bklkKTtcblxuICAgIGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZShjbGllbnQ6IFRlcnJhZm9ybUNsb3VkQ2xpZW50LlRlcnJhZm9ybUNsb3VkKSB7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCBjbGllbnQuUnVucy5zaG93KHJ1bklkKTtcblxuICAgICAgLy8gZmV0Y2ggbG9ncyBhbmQgdXBkYXRlIFVJIGluIHRoZSBiYWNrZ3JvdW5kXG4gICAgICBjbGllbnQuQXBwbGllcy5sb2dzKHJlc3VsdC5yZWxhdGlvbnNoaXBzLmFwcGx5LmRhdGEuaWQpLnRoZW4oXG4gICAgICAgICh7IGRhdGEgfSkgPT4ge1xuICAgICAgICAgIC8vIEluIHJhcmUgY2FzZXMgdGhlIGJhY2tlbmQgc2VuZHMgYW4gZW1wdHkgY2h1bmsgb2YgZGF0YSBiYWNrLlxuICAgICAgICAgIGlmIChkYXRhICYmIGRhdGEubGVuZ3RoKSB7XG4gICAgICAgICAgICBzdGRvdXQoQnVmZmVyLmZyb20oZGF0YSwgXCJ1dGY4XCIpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICByZXR1cm4gcmVzO1xuICAgIH1cblxuICAgIHdoaWxlIChkZXBsb3lpbmdTdGF0ZXMuaW5jbHVkZXMocmVzdWx0LmF0dHJpYnV0ZXMuc3RhdHVzKSkge1xuICAgICAgcmVzdWx0ID0gYXdhaXQgdXBkYXRlKHRoaXMuY2xpZW50KTtcbiAgICAgIGF3YWl0IHdhaXQoMTAwMCk7XG4gICAgfVxuXG4gICAgc3dpdGNoIChyZXN1bHQuYXR0cmlidXRlcy5zdGF0dXMpIHtcbiAgICAgIGNhc2UgXCJhcHBsaWVkXCI6XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBlcnJvcjogJHtyZXN1bHQuYXR0cmlidXRlcy5zdGF0dXN9YCk7XG4gICAgfVxuICB9XG5cbiAgQEJlYXV0aWZ5RXJyb3JzKFwiRGVzdHJveVwiKVxuICBwdWJsaWMgYXN5bmMgZGVzdHJveShzdGRvdXQ6IChjaHVuazogQnVmZmVyKSA9PiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMucnVuKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBcIlBsZWFzZSBjcmVhdGUgYSBDb25maWd1cmF0aW9uVmVyc2lvbiAvIFBsYW4gYmVmb3JlIGRlc3Ryb3lpbmdcIlxuICAgICAgKTtcblxuICAgIGNvbnN0IGRlc3Ryb3lpbmdTdGF0ZXMgPSBbXCJjb25maXJtZWRcIiwgXCJhcHBseV9xdWV1ZWRcIiwgXCJhcHBseWluZ1wiXTtcbiAgICBjb25zdCBydW5JZCA9IHRoaXMucnVuLmlkO1xuICAgIGF3YWl0IHRoaXMuY2xpZW50LlJ1bnMuYWN0aW9uKFwiYXBwbHlcIiwgcnVuSWQpO1xuICAgIGxldCByZXN1bHQgPSBhd2FpdCB0aGlzLmNsaWVudC5SdW5zLnNob3cocnVuSWQpO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gdXBkYXRlKGNsaWVudDogVGVycmFmb3JtQ2xvdWRDbGllbnQuVGVycmFmb3JtQ2xvdWQpIHtcbiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGNsaWVudC5SdW5zLnNob3cocnVuSWQpO1xuXG4gICAgICAvLyBmZXRjaCBsb2dzIGFuZCB1cGRhdGUgVUkgaW4gdGhlIGJhY2tncm91bmRcbiAgICAgIGNsaWVudC5BcHBsaWVzLmxvZ3MocmVzdWx0LnJlbGF0aW9uc2hpcHMuYXBwbHkuZGF0YS5pZCkudGhlbigoeyBkYXRhIH0pID0+XG4gICAgICAgIHN0ZG91dChCdWZmZXIuZnJvbShkYXRhLCBcInV0ZjhcIikpXG4gICAgICApO1xuICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG5cbiAgICB3aGlsZSAoZGVzdHJveWluZ1N0YXRlcy5pbmNsdWRlcyhyZXN1bHQuYXR0cmlidXRlcy5zdGF0dXMpKSB7XG4gICAgICByZXN1bHQgPSBhd2FpdCB1cGRhdGUodGhpcy5jbGllbnQpO1xuICAgICAgYXdhaXQgd2FpdCgxMDAwKTtcbiAgICB9XG5cbiAgICBzd2l0Y2ggKHJlc3VsdC5hdHRyaWJ1dGVzLnN0YXR1cykge1xuICAgICAgY2FzZSBcImFwcGxpZWRcIjpcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGVycm9yOiAke3Jlc3VsdC5hdHRyaWJ1dGVzLnN0YXR1c31gKTtcbiAgICB9XG4gIH1cblxuICBAQmVhdXRpZnlFcnJvcnMoXCJWZXJzaW9uXCIpXG4gIHB1YmxpYyBhc3luYyB2ZXJzaW9uKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLndvcmtzcGFjZSgpKS5hdHRyaWJ1dGVzLnRlcnJhZm9ybVZlcnNpb247XG4gIH1cblxuICBAQmVhdXRpZnlFcnJvcnMoXCJPdXRwdXRcIilcbiAgcHVibGljIGFzeW5jIG91dHB1dCgpOiBQcm9taXNlPHsgW2tleTogc3RyaW5nXTogVGVycmFmb3JtT3V0cHV0IH0+IHtcbiAgICBjb25zdCBzdGF0ZVZlcnNpb24gPSBhd2FpdCB0aGlzLmNsaWVudC5TdGF0ZVZlcnNpb25zLmN1cnJlbnQoXG4gICAgICAoXG4gICAgICAgIGF3YWl0IHRoaXMud29ya3NwYWNlKClcbiAgICAgICkuaWQsXG4gICAgICB0cnVlXG4gICAgKTtcbiAgICBpZiAoIXN0YXRlVmVyc2lvbi5pbmNsdWRlZCkgcmV0dXJuIHt9O1xuXG4gICAgY29uc3Qgb3V0cHV0cyA9IHN0YXRlVmVyc2lvbi5pbmNsdWRlZC5yZWR1Y2UoKGFjYywgb3V0cHV0KSA9PiB7XG4gICAgICBhY2Nbb3V0cHV0LmF0dHJpYnV0ZXMubmFtZV0gPSB7XG4gICAgICAgIHNlbnNpdGl2ZTogb3V0cHV0LmF0dHJpYnV0ZXMuc2Vuc2l0aXZlLFxuICAgICAgICB0eXBlOiBvdXRwdXQuYXR0cmlidXRlcy50eXBlLFxuICAgICAgICB2YWx1ZTogb3V0cHV0LmF0dHJpYnV0ZXMudmFsdWUsXG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9IGFzIHsgW2tleTogc3RyaW5nXTogVGVycmFmb3JtT3V0cHV0IH0pO1xuXG4gICAgcmV0dXJuIG91dHB1dHM7XG4gIH1cblxuICBAQmVhdXRpZnlFcnJvcnMoXCJXb3Jrc3BhY2VcIilcbiAgcHJpdmF0ZSBhc3luYyB3b3Jrc3BhY2UoKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmNsaWVudC5Xb3Jrc3BhY2VzLnNob3dCeU5hbWUoXG4gICAgICAgIHRoaXMub3JnYW5pemF0aW9uTmFtZSxcbiAgICAgICAgdGhpcy53b3Jrc3BhY2VOYW1lXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlLnJlc3BvbnNlPy5zdGF0dXMgPT09IDQwNCkge1xuICAgICAgICAvLyByZXR1cm4gYSBtb3JlIGRlc2NyaXB0aXZlIGVycm9yIG1lc3NhZ2UgYXMgaHR0cCByZXNwb25zZSBpcyBub3QgZGVzY3JpcHRpdmUgZW5vdWdoXG4gICAgICAgIC8vIHdpbGwgbm90IGJlIHRvdWNoZWQgYnkgQmVhdXRpZnlFcnJvcnMgZGVjb3JhdG9yXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVGVycmFmb3JtQ2xvdWQgcmV0dXJuZWQgYW4gSFRUUCA0MDQgZXJyb3IuIFBsZWFzZSBtYWtlIHN1cmUgdGhlIGNvbmZpZ3VyZWQgb3JnYW5pemF0aW9uICgke3RoaXMub3JnYW5pemF0aW9uTmFtZX0pIGFuZCB3b3Jrc3BhY2UgKCR7dGhpcy53b3Jrc3BhY2VOYW1lfSkgZXhpc3QgYW5kIHlvdSBoYXZlIHRoZSBjb3JyZWN0IGFjY2VzcyByaWdodHMuYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGlzQ29uZmlndXJhdGlvblZlcnNpb25SZWFkeSgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBpZiAoIXRoaXMuY29uZmlndXJhdGlvblZlcnNpb25JZClcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJObyBDb25maWd1cmF0aW9uVmVyc2lvbklkIGtub3duLiBDYW5ub3Qgd2FpdCBmb3IgQ29uZmlndXJhdGlvblZlcnNpb24gdG8gYmVjb21lIHJlYWR5XCJcbiAgICAgICk7XG4gICAgY29uc3QgY29uZmlnVmVyc2lvbiA9IGF3YWl0IHRoaXMuY2xpZW50LkNvbmZpZ3VyYXRpb25WZXJzaW9uLnNob3coXG4gICAgICB0aGlzLmNvbmZpZ3VyYXRpb25WZXJzaW9uSWRcbiAgICApO1xuICAgIGNvbnN0IHsgc3RhdHVzIH0gPSBjb25maWdWZXJzaW9uLmF0dHJpYnV0ZXM7XG4gICAgc3dpdGNoIChzdGF0dXMpIHtcbiAgICAgIGNhc2UgXCJ1cGxvYWRlZFwiOlxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIGNhc2UgXCJlcnJvcmVkXCI6IHtcbiAgICAgICAgY29uc3QgeyBlcnJvciwgZXJyb3JNZXNzYWdlIH0gPSBjb25maWdWZXJzaW9uLmF0dHJpYnV0ZXM7XG4gICAgICAgIGxvZ2dlci5lcnJvcihcbiAgICAgICAgICBgQ29uZmlndXJhdGlvblZlcnNpb24gaW4gVGVycmFmb3JtIENsb3VkIGhhcyBzdGF0dXMgXCIke3N0YXR1c31cIi4gUmV0dXJuZWQgY29uZmlnIHZlcnNpb24gd2FzICR7SlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgICBjb25maWdWZXJzaW9uXG4gICAgICAgICAgKX1gXG4gICAgICAgICk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVGVycmFmb3JtIENsb3VkIENvbmZpZ3VyYXRpb25WZXJzaW9uICR7XG4gICAgICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb25WZXJzaW9uSWRcbiAgICAgICAgICB9IGhhcyBzdGF0dXMgXCJlcnJvcmVkXCIgJHtKU09OLnN0cmluZ2lmeSh7IGVycm9yLCBlcnJvck1lc3NhZ2UgfSl9YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgY2FzZSBcInBlbmRpbmdcIjogLy8gZmFsbHRocm91Z2hcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICBgQ29uZmlndXJhdGlvblZlcnNpb24gaW4gVGVycmFmb3JtIENsb3VkIG5vdCBjb25zaWRlcmVkIHJlYWR5IHdpdGggc3RhdHVzIFwiJHtzdGF0dXN9XCIuYFxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB3YWl0Rm9yQ29uZmlndXJhdGlvblZlcnNpb25Ub0JlUmVhZHkoXG4gICAgdGltZW91dE1zID0gNjBfMDAwXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgIFwid2FpdGluZyBmb3IgQ29uZmlndXJhdGlvbiBWZXJzaW9uIHRvIGJlIHJlYWR5IGluIFRlcnJhZm9ybSBDbG91ZFwiXG4gICAgKTtcbiAgICBsZXQgdGltZW91dFJlYWNoZWQgPSBmYWxzZTtcbiAgICBjb25zdCByZWFkeSA9IGFzeW5jICgpID0+IHtcbiAgICAgIHdoaWxlICghKChhd2FpdCB0aGlzLmlzQ29uZmlndXJhdGlvblZlcnNpb25SZWFkeSgpKSAmJiAhdGltZW91dFJlYWNoZWQpKSB7XG4gICAgICAgIGF3YWl0IHdhaXQoMTAwMCk7XG4gICAgICB9XG4gICAgfTtcbiAgICBjb25zdCB0aW1lb3V0ID0gYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgd2FpdCh0aW1lb3V0TXMpO1xuICAgICAgdGltZW91dFJlYWNoZWQgPSB0cnVlO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgV2FpdGluZyBmb3IgVGVycmFmb3JtIENsb3VkIENvbmZpZ3VyYXRpb25WZXJzaW9uIHRvIGJlY29tZSByZWFkeSB0aW1lZCBvdXQgKHRpbWVvdXQgd2FzICR7dGltZW91dE1zfW1zKWBcbiAgICAgICk7XG4gICAgfTtcbiAgICBhd2FpdCBQcm9taXNlLnJhY2UoW3JlYWR5KCksIHRpbWVvdXQoKV0pO1xuICAgIGxvZ2dlci5kZWJ1ZyhcIkNvbmZpZ3VyYXRpb24gVmVyc2lvbiBpcyByZWFkeSBpbiBUZXJyYWZvcm0gQ2xvdWRcIik7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUxvY2FsVGVycmFmb3JtRGlyZWN0b3J5KCkge1xuICAgIHRyeSB7XG4gICAgICBmcy5ybWRpclN5bmMoXG4gICAgICAgIHBhdGgucmVzb2x2ZSh0aGlzLnN0YWNrLnN5bnRoZXNpemVkU3RhY2tQYXRoLCBcIi50ZXJyYWZvcm1cIiksXG4gICAgICAgIHsgcmVjdXJzaXZlOiB0cnVlIH1cbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgQ291bGQgbm90IHJlbW92ZSAudGVycmFmb3JtIGZvbGRlcmAsIGVycm9yKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Diff = exports.Plan = exports.CloudRunInfo = void 0;
const react_1 = __importStar(require("react"));
const ink_1 = require("ink");
const ink_spinner_1 = __importDefault(require("ink-spinner"));
const components_1 = require("./components");
const terraform_context_1 = require("./terraform-context");
const PlanSummary = ({ resources }) => {
    const summary = resources.reduce((accumulator, resource) => {
        if (accumulator[resource.action] !== undefined) {
            accumulator[resource.action] += 1;
        }
        return accumulator;
    }, {
        create: 0,
        update: 0,
        delete: 0,
    });
    return (react_1.default.createElement(react_1.default.Fragment, null, Object.keys(summary).map((key, i) => (react_1.default.createElement(ink_1.Box, { key: key },
        i > 0 && react_1.default.createElement(ink_1.Text, null, ", "),
        react_1.default.createElement(ink_1.Text, null,
            summary[key],
            " to ",
            key))))));
};
exports.CloudRunInfo = () => {
    const { url } = terraform_context_1.useTerraformState();
    if (url == undefined)
        return react_1.default.createElement(react_1.default.Fragment, null);
    const staticElements = [url];
    return (react_1.default.createElement(ink_1.Static, { items: staticElements }, (e) => (react_1.default.createElement(ink_1.Text, { key: e },
        "Running plan in the remote backend. To view this run in a browser, visit: ",
        e))));
};
exports.Plan = () => {
    const { plan, currentStack } = terraform_context_1.useTerraformState();
    return (react_1.default.createElement(react_1.Fragment, null,
        react_1.default.createElement(ink_1.Box, { flexDirection: "column" },
            react_1.default.createElement(exports.CloudRunInfo, null),
            react_1.default.createElement(ink_1.Box, null,
                react_1.default.createElement(ink_1.Text, null, "Stack: "),
                react_1.default.createElement(ink_1.Text, { bold: true }, currentStack.name)),
            (plan === null || plan === void 0 ? void 0 : plan.needsApply) ? react_1.default.createElement(ink_1.Text, { bold: true }, "Resources") : react_1.default.createElement(react_1.default.Fragment, null), plan === null || plan === void 0 ? void 0 :
            plan.applyableResources.map((resource) => (react_1.default.createElement(ink_1.Box, { key: resource.id, marginLeft: 1 },
                react_1.default.createElement(components_1.PlanElement, { resource: resource, stackName: currentStack.name })))),
            react_1.default.createElement(ink_1.Box, { marginTop: 1 },
                react_1.default.createElement(ink_1.Text, { bold: true }, "Diff: "),
                react_1.default.createElement(PlanSummary, { resources: (plan === null || plan === void 0 ? void 0 : plan.applyableResources) || [] }),
                react_1.default.createElement(ink_1.Text, null, ".")))));
};
exports.Diff = ({ targetDir, targetStack, synthCommand, }) => {
    const { status, currentStack, errors } = terraform_context_1.useRunDiff({
        targetDir,
        targetStack,
        synthCommand,
        isSpeculative: true,
    });
    const isPlanning = status != terraform_context_1.Status.PLANNED;
    const statusText = currentStack.name === "" ? (`${status}...`) : (react_1.default.createElement(ink_1.Text, null,
        status,
        react_1.default.createElement(ink_1.Text, { bold: true },
            "\u00A0",
            currentStack.name),
        "..."));
    if (errors)
        return react_1.default.createElement(ink_1.Box, null, errors);
    return (react_1.default.createElement(ink_1.Box, null,
        react_1.default.createElement(exports.CloudRunInfo, null),
        isPlanning ? (react_1.default.createElement(react_1.Fragment, null,
            react_1.default.createElement(ink_1.Text, { color: "green" },
                react_1.default.createElement(ink_spinner_1.default, { type: "dots" })),
            react_1.default.createElement(ink_1.Box, { paddingLeft: 1 },
                react_1.default.createElement(ink_1.Text, null, statusText)))) : (react_1.default.createElement(exports.Plan, null))));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlmZi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRpZmYudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwrQ0FBd0M7QUFDeEMsNkJBQXdDO0FBQ3hDLDhEQUFrQztBQUVsQyw2Q0FBMkM7QUFDM0MsMkRBQTRFO0FBWTVFLE1BQU0sV0FBVyxHQUFHLENBQUMsRUFBRSxTQUFTLEVBQXFCLEVBQXNCLEVBQUU7SUFDM0UsTUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FDOUIsQ0FBQyxXQUFXLEVBQUUsUUFBUSxFQUFFLEVBQUU7UUFDeEIsSUFBSSxXQUFXLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLFNBQVMsRUFBRTtZQUM5QyxXQUFXLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNuQztRQUVELE9BQU8sV0FBVyxDQUFDO0lBQ3JCLENBQUMsRUFDRDtRQUNFLE1BQU0sRUFBRSxDQUFDO1FBQ1QsTUFBTSxFQUFFLENBQUM7UUFDVCxNQUFNLEVBQUUsQ0FBQztLQUNILENBQ1QsQ0FBQztJQUVGLE9BQU8sQ0FDTCw4REFDRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQ3BDLDhCQUFDLFNBQUcsSUFBQyxHQUFHLEVBQUUsR0FBRztRQUNWLENBQUMsR0FBRyxDQUFDLElBQUksOEJBQUMsVUFBSSxhQUFVO1FBQ3pCLDhCQUFDLFVBQUk7WUFDRixPQUFPLENBQUMsR0FBRyxDQUFDOztZQUFNLEdBQUcsQ0FDakIsQ0FDSCxDQUNQLENBQUMsQ0FDRCxDQUNKLENBQUM7QUFDSixDQUFDLENBQUM7QUFFVyxRQUFBLFlBQVksR0FBRyxHQUF1QixFQUFFO0lBQ25ELE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxxQ0FBaUIsRUFBRSxDQUFDO0lBQ3BDLElB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Q0FBQztnQkFDakIsOEJBQUMsVUFBSSxRQUFFLFVBQVUsQ0FBUSxDQUNyQixDQUNHLENBQ1osQ0FBQyxDQUFDLENBQUMsQ0FDRiw4QkFBQyxZQUFJLE9BQUcsQ0FDVCxDQUNHLENBQ1AsQ0FBQztBQUNKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBGcmFnbWVudCB9IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0IHsgVGV4dCwgQm94LCBTdGF0aWMgfSBmcm9tIFwiaW5rXCI7XG5pbXBvcnQgU3Bpbm5lciBmcm9tIFwiaW5rLXNwaW5uZXJcIjtcbmltcG9ydCB7IFBsYW5uZWRSZXNvdXJjZSB9IGZyb20gXCIuL21vZGVscy90ZXJyYWZvcm1cIjtcbmltcG9ydCB7IFBsYW5FbGVtZW50IH0gZnJvbSBcIi4vY29tcG9uZW50c1wiO1xuaW1wb3J0IHsgU3RhdHVzLCB1c2VUZXJyYWZvcm1TdGF0ZSwgdXNlUnVuRGlmZiB9IGZyb20gXCIuL3RlcnJhZm9ybS1jb250ZXh0XCI7XG5cbmludGVyZmFjZSBEaWZmQ29uZmlnIHtcbiAgdGFyZ2V0RGlyOiBzdHJpbmc7XG4gIHRhcmdldFN0YWNrPzogc3RyaW5nO1xuICBzeW50aENvbW1hbmQ6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIFBsYW5TdW1tYXJ5Q29uZmlnIHtcbiAgcmVzb3VyY2VzOiBQbGFubmVkUmVzb3VyY2VbXTtcbn1cblxuY29uc3QgUGxhblN1bW1hcnkgPSAoeyByZXNvdXJjZXMgfTogUGxhblN1bW1hcnlDb25maWcpOiBSZWFjdC5SZWFjdEVsZW1lbnQgPT4ge1xuICBjb25zdCBzdW1tYXJ5ID0gcmVzb3VyY2VzLnJlZHVjZShcbiAgICAoYWNjdW11bGF0b3IsIHJlc291cmNlKSA9PiB7XG4gICAgICBpZiAoYWNjdW11bGF0b3JbcmVzb3VyY2UuYWN0aW9uXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGFjY3VtdWxhdG9yW3Jlc291cmNlLmFjdGlvbl0gKz0gMTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yO1xuICAgIH0sXG4gICAge1xuICAgICAgY3JlYXRlOiAwLFxuICAgICAgdXBkYXRlOiAwLFxuICAgICAgZGVsZXRlOiAwLFxuICAgIH0gYXMgYW55XG4gICk7XG5cbiAgcmV0dXJuIChcbiAgICA8PlxuICAgICAge09iamVjdC5rZXlzKHN1bW1hcnkpLm1hcCgoa2V5LCBpKSA9PiAoXG4gICAgICAgIDxCb3gga2V5PXtrZXl9PlxuICAgICAgICAgIHtpID4gMCAmJiA8VGV4dD4sIDwvVGV4dD59XG4gICAgICAgICAgPFRleHQ+XG4gICAgICAgICAgICB7c3VtbWFyeVtrZXldfSB0byB7a2V5fVxuICAgICAgICAgIDwvVGV4dD5cbiAgICAgICAgPC9Cb3g+XG4gICAgICApKX1cbiAgICA8Lz5cbiAgKTtcbn07XG5cbmV4cG9ydCBjb25zdCBDbG91ZFJ1bkluZm8gPSAoKTogUmVhY3QuUmVhY3RFbGVtZW50ID0+IHtcbiAgY29uc3QgeyB1cmwgfSA9IHVzZVRlcnJhZm9ybVN0YXRlKCk7XG4gIGlmICh1cmwgPT0gdW5kZWZpbmVkKSByZXR1cm4gPD48Lz47XG5cbiAgY29uc3Qgc3RhdGljRWxlbWVudHMgPSBbdXJsXTtcblxuICByZXR1cm4gKFxuICAgIDxTdGF0aWMgaXRlbXM9e3N0YXRpY0VsZW1lbnRzfT5cbiAgICAgIHsoZSkgPT4gKFxuICAgICAgICA8VGV4dCBrZXk9e2V9PlxuICAgICAgICAgIFJ1bm5pbmcgcGxhbiBpbiB0aGUgcmVtb3RlIGJhY2tlbmQuIFRvIHZpZXcgdGhpcyBydW4gaW4gYSBicm93c2VyLFxuICAgICAgICAgIHZpc2l0OiB7ZX1cbiAgICAgICAgPC9UZXh0PlxuICAgICAgKX1cbiAgICA8L1N0YXRpYz5cbiAgKTtcbn07XG5cbmV4cG9ydCBjb25zdCBQbGFuID0gKCk6IFJlYWN0LlJlYWN0RWxlbWVudCA9PiB7XG4gIGNvbnN0IHsgcGxhbiwgY3VycmVudFN0YWNrIH0gPSB1c2VUZXJyYWZvcm1TdGF0ZSgpO1xuXG4gIHJldHVybiAoXG4gICAgPEZyYWdtZW50PlxuICAgICAgPEJveCBmbGV4RGlyZWN0aW9uPVwiY29sdW1uXCI+XG4gICAgICAgIDxDbG91ZFJ1bkluZm8gLz5cbiAgICAgICAgPEJveD5cbiAgICAgICAgICA8VGV4dD5TdGFjazogPC9UZXh0PlxuICAgICAgICAgIDxUZXh0IGJvbGQ+e2N1cnJlbnRTdGFjay5uYW1lfTwvVGV4dD5cbiAgICAgICAgPC9Cb3g+XG4gICAgICAgIHtwbGFuPy5uZWVkc0FwcGx5ID8gPFRleHQgYm9sZD5SZXNvdXJjZXM8L1RleHQ+IDogPD48Lz59XG4gICAgICAgIHtwbGFuPy5hcHBseWFibGVSZXNvdXJjZXMubWFwKChyZXNvdXJjZSkgPT4gKFxuICAgICAgICAgIDxCb3gga2V5PXtyZXNvdXJjZS5pZH0gbWFyZ2luTGVmdD17MX0+XG4gICAgICAgICAgICA8UGxhbkVsZW1lbnQgcmVzb3VyY2U9e3Jlc291cmNlfSBzdGFja05hbWU9e2N1cnJlbnRTdGFjay5uYW1lfSAvPlxuICAgICAgICAgIDwvQm94PlxuICAgICAgICApKX1cbiAgICAgICAgPEJveCBtYXJnaW5Ub3A9ezF9PlxuICAgICAgICAgIDxUZXh0IGJvbGQ+RGlmZjogPC9UZXh0PlxuICAgICAgICAgIDxQbGFuU3VtbWFyeSByZXNvdXJjZXM9e3BsYW4/LmFwcGx5YWJsZVJlc291cmNlcyB8fCBbXX0gLz5cbiAgICAgICAgICA8VGV4dD4uPC9UZXh0PlxuICAgICAgICA8L0JveD5cbiAgICAgIDwvQm94PlxuICAgIDwvRnJhZ21lbnQ+XG4gICk7XG59O1xuXG5leHBvcnQgY29uc3QgRGlmZiA9ICh7XG4gIHRhcmdldERpcixcbiAgdGFyZ2V0U3RhY2ssXG4gIHN5bnRoQ29tbWFuZCxcbn06IERpZmZDb25maWcpOiBSZWFjdC5SZWFjdEVsZW1lbnQgPT4ge1xuICBjb25zdCB7IHN0YXR1cywgY3VycmVudFN0YWNrLCBlcnJvcnMgfSA9IHVzZVJ1bkRpZmYoe1xuICAgIHRhcmdldERpcixcbiAgICB0YXJnZXRTdGFjayxcbiAgICBzeW50aENvbW1hbmQsXG4gICAgaXNTcGVjdWxhdGl2ZTogdHJ1ZSxcbiAgfSk7XG5cbiAgY29uc3QgaXNQbGFubmluZzogYm9vbGVhbiA9IHN0YXR1cyAhPSBTdGF0dXMuUExBTk5FRDtcbiAgY29uc3Qgc3RhdHVzVGV4dCA9XG4gICAgY3VycmVudFN0YWNrLm5hbWUgPT09IFwiXCIgPyAoXG4gICAgICBgJHtzdGF0dXN9Li4uYFxuICAgICkgOiAoXG4gICAgICA8VGV4dD5cbiAgICAgICAge3N0YXR1c31cbiAgICAgICAgPFRleHQgYm9sZD4mbmJzcDt7Y3VycmVudFN0YWNrLm5hbWV9PC9UZXh0Pi4uLlxuICAgICAgPC9UZXh0PlxuICAgICk7XG5cbiAgaWYgKGVycm9ycykgcmV0dXJuIDxCb3g+e2Vycm9yc308L0JveD47XG5cbiAgcmV0dXJuIChcbiAgICA8Qm94PlxuICAgICAgPENsb3VkUnVuSW5mbyAvPlxuICAgICAge2lzUGxhbm5pbmcgPyAoXG4gICAgICAgIDxGcmFnbWVudD5cbiAgICAgICAgICA8VGV4dCBjb2xvcj1cImdyZWVuXCI+XG4gICAgICAgICAgICA8U3Bpbm5lciB0eXBlPVwiZG90c1wiIC8+XG4gICAgICAgICAgPC9UZXh0PlxuICAgICAgICAgIDxCb3ggcGFkZGluZ0xlZnQ9ezF9PlxuICAgICAgICAgICAgPFRleHQ+e3N0YXR1c1RleHR9PC9UZXh0PlxuICAgICAgICAgIDwvQm94PlxuICAgICAgICA8L0ZyYWdtZW50PlxuICAgICAgKSA6IChcbiAgICAgICAgPFBsYW4gLz5cbiAgICAgICl9XG4gICAgPC9Cb3g+XG4gICk7XG59O1xuIl19
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Deploy = exports.Apply = exports.Output = exports.DeploySummary = void 0;
/* eslint-disable no-control-regex */
const react_1 = __importStar(require("react"));
const ink_1 = require("ink");
const ink_spinner_1 = __importDefault(require("ink-spinner"));
const ink_confirm_input_1 = __importDefault(require("@skorfmann/ink-confirm-input"));
const components_1 = require("./components");
const terraform_1 = require("./models/terraform");
const terraform_context_1 = require("./terraform-context");
const diff_1 = require("./diff");
exports.DeploySummary = ({ resources, }) => {
    const summary = resources.reduce((accumulator, resource) => {
        if (accumulator[resource.applyState] !== undefined) {
            accumulator[resource.applyState] += 1;
        }
        return accumulator;
    }, {
        created: 0,
        updated: 0,
        destroyed: 0,
    });
    return (react_1.default.createElement(react_1.default.Fragment, null, Object.keys(summary).map((key, i) => (react_1.default.createElement(ink_1.Box, { key: key },
        i > 0 && react_1.default.createElement(ink_1.Text, null, ", "),
        react_1.default.createElement(ink_1.Text, null,
            summary[key],
            " ",
            key))))));
};
function sanitize(value) {
    if (typeof value === "object") {
        return JSON.stringify(value, null, 2);
    }
    return value;
}
exports.Output = ({ output }) => {
    return (react_1.default.createElement(ink_1.Box, { flexDirection: "column" }, Object.keys(output).map((key) => (react_1.default.createElement(ink_1.Box, { key: key },
        react_1.default.createElement(ink_1.Text, null,
            key,
            " =",
            " ",
            output[key].sensitive
                ? "<sensitive>"
                : sanitize(output[key].value)))))));
};
const Confirm = ({ callback }) => {
    const [value, setValue] = react_1.useState("");
    return (react_1.default.createElement(ink_1.Box, { flexDirection: "column", marginTop: 1 },
        react_1.default.createElement(ink_1.Text, { bold: true }, "Do you want to perform these actions?"),
        react_1.default.createElement(ink_1.Text, null, " CDK for Terraform will perform the actions described above."),
        react_1.default.createElement(ink_1.Text, null, " Only 'yes' will be accepted to approve."),
        react_1.default.createElement(ink_1.Box, { flexDirection: "row", marginTop: 1 },
            react_1.default.createElement(ink_1.Text, { bold: true }, " Enter a value:"),
            react_1.default.createElement(ink_confirm_input_1.default, { value: value, onChange: setValue, onSubmit: callback }))));
};
const ApplyableResources = ({ resources, stackName, }) => {
    if (!resources.length) {
        return react_1.default.createElement(react_1.default.Fragment, null);
    }
    return (react_1.default.createElement(react_1.default.Fragment, null,
        react_1.default.createElement(ink_1.Text, { bold: true }, "Resources"),
        resources.map((resource) => (react_1.default.createElement(ink_1.Box, { key: resource.id, marginLeft: 1 },
            react_1.default.createElement(components_1.DeployingElement, { resource: resource, stackName: stackName })))),
        react_1.default.createElement(ink_1.Box, { marginTop: 1 },
            react_1.default.createElement(ink_1.Text, { bold: true }, "Summary: "),
            react_1.default.createElement(exports.DeploySummary, { resources: resources }),
            react_1.default.createElement(ink_1.Text, null, "."))));
};
exports.Apply = () => {
    const { resources, status, currentStack, output } = terraform_context_1.useTerraformState();
    const applyActions = [
        terraform_1.PlannedResourceAction.UPDATE,
        terraform_1.PlannedResourceAction.CREATE,
        terraform_1.PlannedResourceAction.DELETE,
        terraform_1.PlannedResourceAction.READ,
    ];
    const applyableResources = resources.filter((resource) => applyActions.includes(resource.action));
    return (react_1.default.createElement(react_1.Fragment, null,
        react_1.default.createElement(ink_1.Box, { flexDirection: "column" },
            react_1.default.createElement(ink_1.Box, null, terraform_context_1.Status.DEPLOYING == status ? (react_1.default.createElement(react_1.default.Fragment, null,
                react_1.default.createElement(ink_1.Text, { color: "green" },
                    react_1.default.createElement(ink_spinner_1.default, { type: "dots" })),
                react_1.default.createElement(ink_1.Box, { paddingLeft: 1 },
                    react_1.default.createElement(ink_1.Text, null, "Deploying Stack: "),
                    react_1.default.createElement(ink_1.Text, { bold: true }, currentStack.name)))) : (react_1.default.createElement(react_1.default.Fragment, null,
                react_1.default.createElement(ink_1.Text, null, "Deploying Stack: "),
                react_1.default.createElement(ink_1.Text, { bold: true }, currentStack.name)))),
            react_1.default.createElement(ApplyableResources, { resources: applyableResources, stackName: currentStack.name }),
            output && Object.keys(output).length > 0 && (react_1.default.createElement(ink_1.Box, { marginTop: 1 },
                react_1.default.createElement(ink_1.Text, { bold: true }, "Output: "),
                react_1.default.createElement(exports.Output, { output: output }))))));
};
exports.Deploy = ({ targetDir, targetStack, synthCommand, autoApprove, }) => {
    const { state: { status, currentStack, errors, plan }, confirmation, isConfirmed, } = terraform_context_1.useRunDeploy({
        targetDir,
        targetStack,
        synthCommand,
        autoApprove,
    });
    const planStages = [
        terraform_context_1.Status.INITIALIZING,
        terraform_context_1.Status.PLANNING,
        terraform_context_1.Status.SYNTHESIZING,
        terraform_context_1.Status.SYNTHESIZED,
        terraform_context_1.Status.STARTING,
    ];
    const isPlanning = planStages.includes(status);
    const statusText = currentStack.name === "" ? (react_1.default.createElement(ink_1.Text, null,
        status,
        "...")) : (react_1.default.createElement(ink_1.Text, null,
        status,
        react_1.default.createElement(ink_1.Text, { bold: true },
            "\u00A0",
            currentStack.name),
        "..."));
    if (errors)
        return react_1.default.createElement(ink_1.Box, null, errors.map((e) => e.message));
    if (plan && !plan.needsApply)
        return (react_1.default.createElement(react_1.default.Fragment, null,
            react_1.default.createElement(ink_1.Text, null,
                "No changes for Stack: ",
                react_1.default.createElement(ink_1.Text, { bold: true }, currentStack.name))));
    return (react_1.default.createElement(ink_1.Box, null, isPlanning ? (react_1.default.createElement(react_1.Fragment, null,
        react_1.default.createElement(ink_1.Text, { color: "green" },
            react_1.default.createElement(ink_spinner_1.default, { type: "dots" })),
        react_1.default.createElement(ink_1.Box, { paddingLeft: 1 },
            react_1.default.createElement(ink_1.Text, null, statusText)))) : (react_1.default.createElement(react_1.default.Fragment, null,
        !isConfirmed && (react_1.default.createElement(ink_1.Box, { flexDirection: "column" },
            react_1.default.createElement(diff_1.Plan, null),
            react_1.default.createElement(Confirm, { callback: confirmation }))),
        isConfirmed && react_1.default.createElement(exports.Apply, null)))));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwbG95LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGVwbG95LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEscUNBQXFDO0FBQ3JDLCtDQUFrRDtBQUNsRCw2QkFBZ0M7QUFDaEMsOERBQWtDO0FBQ2xDLHFGQUF3RDtBQUN4RCw2Q0FBZ0Q7QUFDaEQsa0RBSTRCO0FBQzVCLDJEQUE4RTtBQUM5RSxpQ0FBOEI7QUFNakIsUUFBQSxhQUFhLEdBQUcsQ0FBQyxFQUM1QixTQUFTLEdBQ1csRUFBc0IsRUFBRTtJQUM1QyxNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsTUFBTSxDQUM5QixDQUFDLFdBQVcsRUFBRSxRQUFRLEVBQUUsRUFBRTtRQUN4QixJQUFJLFdBQVcsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLEtBQUssU0FBUyxFQUFFO1lBQ2xELFdBQVcsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3ZDO1FBRUQsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQyxFQUNEO1FBQ0UsT0FBTyxFQUFFLENBQUM7UUFDVixPQUFPLEVBQUUsQ0FBQztRQUNWLFNBQVMsRUFBRSxDQUFDO0tBQ04sQ0FDVCxDQUFDO0lBRUYsT0FBTyxDQUNMLDhEQUNHLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FDcEMsOEJBQUMsU0FBRyxJQUFDLEdBQUcsRUFBRSxHQUFHO1FBQ1YsQ0FBQyxHQUFHLENBQUMsSUFBSSw4QkFBQyxVQUFJLGFBQVU7UUFDekIsOEJBQUMsVUFBSTtZQUNGLE9BQU8sQ0FBQyxHQUFHLENBQUM7O1lBQUcsR0FBRyxDQUNkLENBQ0gsQ0FDUCxDQUFDLENBQ0QsQ0FDSixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBS0YsU0FBUyxRQUFRLENBQUMsS0FBVTtJQUMxQixJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtRQUM3QixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztLQUN2QztJQUVELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQztBQUNZLFFBQUEsTUFBTSxHQUFHLENBQUMsRUFBRSxNQUFNLEVBQWdCLEVBQXNCLEVBQUU7SUFDckUsT0FBTyxDQUNMLDhCQUFDLFNBQUcsSUFBQyxhQUFhLEVBQUMsUUFBUSxJQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FDaEMsOEJBQUMsU0FBRyxJQUFDLEdBQUcsRUFBRSxHQUFHO1FBQ1gsOEJBQUMsVUFBSTtZQUNGLEdBQUc7O1lBQUksR0FBRztZQUNWLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTO2dCQUNwQixDQUFDLENBQUMsYUFBYTtnQkFDZixDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FDMUIsQ0FDSCxDQUNQLENBQUMsQ0FDRSxDQUNQLENBQUM7QUFDSixDQUFDLENBQUM7QUFNRixNQUFNLE9BQU8sR0FBRyxDQUFDLEVBQUUsUUFBUSxFQUFpQixFQUFzQixFQUFFO0lBQ2xFLE1BQU0sQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLEdBQUcsZ0JBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUV2QyxPQUFPLENBQ0wsOEJBQUMsU0FBRyxJQUFDLGFBQWEsRUFBQyxRQUFRLEVBQUMsU0FBUyxFQUFFLENBQUM7UUFDdEMsOEJBQUMsVUFBSSxJQUFDLElBQUksa0RBQTZDO1FBQ3ZELDhCQUFDLFVBQUksdUVBQW9FO1FBQ3pFLDhCQUFDLFVBQUksbURBQWdEO1FBRXJELDhCQUFDLFNBQUcsSUFBQyxhQUFhLEVBQUMsS0FBSyxFQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ25DLDhCQUFDLFVBQUksSUFBQyxJQUFJLDRCQUF1QjtZQUNqQyw4QkFBQywyQkFBWSxJQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUSxHQUFJLENBQ2xFLENBQ0YsQ0FDUCxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBTUYsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLEVBQzFCLFNBQVMsRUFDVCxTQUFTLEdBQ2dCLEVBQXNCLEVBQUU7SUFDakQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7UUFDckIsT0FBTyw2REFBSyxDQUFDO0tBQ2Q7SUFFRCxPQUFPLENBQ0w7UUFDRSw4QkFBQyxVQUFJLElBQUMsSUFBSSxzQkFBaUI7UUFDMUIsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQWEsRUFBRSxFQUFFLENBQUMsQ0FDaEMsOEJBQUMsU0FBRyxJQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsRUFBRSxFQUFFLFVBQVUsRUFBRSxDQUFDO1lBQ2xDLDhCQUFDLDZCQUFnQixJQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFNBQVMsR0FBSSxDQUMxRCxDQUNQLENBQUM7UUFDRiw4QkFBQyxTQUFHLElBQUMsU0FBUyxFQUFFLENBQUM7WUFDZiw4QkFBQyxVQUFJLElBQUMsSUFBSSxzQkFBaUI7WUFDM0IsOEJBQUMscUJBQWEsSUFBQyxTQUFTLEVBQUUsU0FBUyxHQUFJO1lBQ3ZDLDhCQUFDLFVBQUksWUFBUyxDQUNWLENBQ0wsQ0FDSixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRVcsUUFBQSxLQUFLLEdBQUcsR0FBdUIsRUFBRTtJQUM1QyxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLEdBQUcscUNBQWlCLEVBQUUsQ0FBQztJQUN4RSxNQUFNLFlBQVksR0FBRztRQUNuQixpQ0FBcUIsQ0FBQyxNQUFNO1FBQzVCLGlDQUFxQixDQUFDLE1BQU07UUFDNUIsaUNBQXFCLENBQUMsTUFBTTtRQUM1QixpQ0FBcUIsQ0FBQyxJQUFJO0tBQzNCLENBQUM7SUFDRixNQUFNLGtCQUFrQixHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUN2RCxZQUFZLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FDdkMsQ0FBQztJQUNGLE9BQU8sQ0FDTCw4QkFBQyxnQkFBUTtRQUNQLDhCQUFDLFNBQUcsSUFBQyxhQUFhLEVBQUMsUUFBUTtZQUN6Qiw4QkFBQyxTQUFHLFFBQ0QsMEJBQU0sQ0FBQyxTQUFTLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUM1QjtnQkFDRSw4QkFBQyxVQUFJLElBQUMsS0FBSyxFQUFDLE9BQU87b0JBQ2pCLDhCQUFDLHFCQUFPLElBQUMsSUFBSSxFQUFDLE1BQU0sR0FBRyxDQUNsQjtnQkFDUCw4QkFBQyxTQUFHLElBQUMsV0FBVyxFQUFFLENBQUM7b0JBQ2pCLDhCQUFDLFVBQUksNEJBQXlCO29CQUM5Qiw4QkFBQyxVQUFJLElBQUMsSUFBSSxVQUFFLFlBQVksQ0FBQyxJQUFJLENBQVEsQ0FDakMsQ0FDTCxDQUNKLENBQUMsQ0FBQyxDQUFDLENBQ0Y7Z0JBQ0UsOEJBQUMsVUFBSSw0QkFBeUI7Z0JBQzlCLDhCQUFDLFVBQUksSUFBQyxJQUFJLFVBQUUsWUFBWSxDQUFDLElBQUksQ0FBUSxDQUNwQyxDQUNKLENBQ0c7WUFDTiw4QkFBQyxrQkFBa0IsSUFDakIsU0FBUyxFQUFFLGtCQUFrQixFQUM3QixTQUFTLEVBQUUsWUFBWSxDQUFDLElBQUksR0FDNUI7WUFDRCxNQUFNLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQzNDLDhCQUFDLFNBQUcsSUFBQyxTQUFTLEVBQUUsQ0FBQztnQkFDZiw4QkFBQyxVQUFJLElBQUMsSUFBSSxxQkFBZ0I7Z0JBQzFCLDhCQUFDLGNBQU0sSUFBQyxNQUFNLEVBQUUsTUFBTSxHQUFJLENBQ3RCLENBQ1AsQ0FDRyxDQUNHLENBQ1osQ0FBQztBQUNKLENBQUMsQ0FBQztBQVNXLFFBQUEsTUFBTSxHQUFHLENBQUMsRUFDckIsU0FBUyxFQUNULFdBQVcsRUFDWCxZQUFZLEVBQ1osV0FBVyxHQUNFLEVBQXNCLEVBQUU7SUFDckMsTUFBTSxFQUNKLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxFQUM3QyxZQUFZLEVBQ1osV0FBVyxHQUNaLEdBQUcsZ0NBQVksQ0FBQztRQUNmLFNBQVM7UUFDVCxXQUFXO1FBQ1gsWUFBWTtRQUNaLFdBQVc7S0FDWixDQUFDLENBQUM7SUFFSCxNQUFNLFVBQVUsR0FBRztRQUNqQiwwQkFBTSxDQUFDLFlBQVk7UUFDbkIsMEJBQU0sQ0FBQyxRQUFRO1FBQ2YsMEJBQU0sQ0FBQyxZQUFZO1FBQ25CLDBCQUFNLENBQUMsV0FBVztRQUNsQiwwQkFBTSxDQUFDLFFBQVE7S0FDaEIsQ0FBQztJQUNGLE1BQU0sVUFBVSxHQUFHLFVBQVUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDL0MsTUFBTSxVQUFVLEdBQ2QsWUFBWSxDQUFDLElBQUksS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQ3pCLDhCQUFDLFVBQUk7UUFBRSxNQUFNO2NBQVcsQ0FDekIsQ0FBQyxDQUFDLENBQUMsQ0FDRiw4QkFBQyxVQUFJO1FBQ0YsTUFBTTtRQUNQLDhCQUFDLFVBQUksSUFBQyxJQUFJOztZQUFRLFlBQVksQ0FBQyxJQUFJLENBQVE7Y0FDdEMsQ0FDUixDQUFDO0lBRUosSUFBSSxNQUFNO1FBQUUsT0FBTyw4QkFBQyxTQUFHLFFBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFPLENBQUM7SUFDbEUsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVTtRQUMxQixPQUFPLENBQ0w7WUFDRSw4QkFBQyxVQUFJOztnQkFDbUIsOEJBQUMsVUFBSSxJQUFDLElBQUksVUFBRSxZQUFZLENBQUMsSUFBSSxDQUFRLENBQ3RELENBQ04sQ0FDSixDQUFDO0lBRUosT0FBTyxDQUNMLDhCQUFDLFNBQUcsUUFDRCxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQ1osOEJBQUMsZ0JBQVE7UUFDUCw4QkFBQyxVQUFJLElBQUMsS0FBSyxFQUFDLE9BQU87WUFDakIsOEJBQUMscUJBQU8sSUFBQyxJQUFJLEVBQUMsTUFBTSxHQUFHLENBQ2xCO1FBQ1AsOEJBQUMsU0FBRyxJQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ2pCLDhCQUFDLFVBQUksUUFBRSxVQUFVLENBQVEsQ0FDckIsQ0FDRyxDQUNaLENBQUMsQ0FBQyxDQUFDLENBQ0Y7UUFDRyxDQUFDLFdBQVcsSUFBSSxDQUNmLDhCQUFDLFNBQUcsSUFBQyxhQUFhLEVBQUMsUUFBUTtZQUN6Qiw4QkFBQyxXQUFJLE9BQUc7WUFDUiw4QkFBQyxPQUFPLElBQUMsUUFBUSxFQUFFLFlBQVksR0FBSSxDQUMvQixDQUNQO1FBQ0EsV0FBVyxJQUFJLDhCQUFDLGFBQUssT0FBRyxDQUN4QixDQUNKLENBQ0csQ0FDUCxDQUFDO0FBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tY29udHJvbC1yZWdleCAqL1xuaW1wb3J0IFJlYWN0LCB7IEZyYWdtZW50LCB1c2VTdGF0ZSB9IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0IHsgVGV4dCwgQm94IH0gZnJvbSBcImlua1wiO1xuaW1wb3J0IFNwaW5uZXIgZnJvbSBcImluay1zcGlubmVyXCI7XG5pbXBvcnQgQ29uZmlybUlucHV0IGZyb20gXCJAc2tvcmZtYW5uL2luay1jb25maXJtLWlucHV0XCI7XG5pbXBvcnQgeyBEZXBsb3lpbmdFbGVtZW50IH0gZnJvbSBcIi4vY29tcG9uZW50c1wiO1xuaW1wb3J0IHtcbiAgRGVwbG95aW5nUmVzb3VyY2UsXG4gIFRlcnJhZm9ybU91dHB1dCxcbiAgUGxhbm5lZFJlc291cmNlQWN0aW9uLFxufSBmcm9tIFwiLi9tb2RlbHMvdGVycmFmb3JtXCI7XG5pbXBvcnQgeyBTdGF0dXMsIHVzZVRlcnJhZm9ybVN0YXRlLCB1c2VSdW5EZXBsb3kgfSBmcm9tIFwiLi90ZXJyYWZvcm0tY29udGV4dFwiO1xuaW1wb3J0IHsgUGxhbiB9IGZyb20gXCIuL2RpZmZcIjtcblxuaW50ZXJmYWNlIERlcGxveVN1bW1hcnlDb25maWcge1xuICByZXNvdXJjZXM6IERlcGxveWluZ1Jlc291cmNlW107XG59XG5cbmV4cG9ydCBjb25zdCBEZXBsb3lTdW1tYXJ5ID0gKHtcbiAgcmVzb3VyY2VzLFxufTogRGVwbG95U3VtbWFyeUNvbmZpZyk6IFJlYWN0LlJlYWN0RWxlbWVudCA9PiB7XG4gIGNvbnN0IHN1bW1hcnkgPSByZXNvdXJjZXMucmVkdWNlKFxuICAgIChhY2N1bXVsYXRvciwgcmVzb3VyY2UpID0+IHtcbiAgICAgIGlmIChhY2N1bXVsYXRvcltyZXNvdXJjZS5hcHBseVN0YXRlXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGFjY3VtdWxhdG9yW3Jlc291cmNlLmFwcGx5U3RhdGVdICs9IDE7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBhY2N1bXVsYXRvcjtcbiAgICB9LFxuICAgIHtcbiAgICAgIGNyZWF0ZWQ6IDAsXG4gICAgICB1cGRhdGVkOiAwLFxuICAgICAgZGVzdHJveWVkOiAwLFxuICAgIH0gYXMgYW55XG4gICk7XG5cbiAgcmV0dXJuIChcbiAgICA8PlxuICAgICAge09iamVjdC5rZXlzKHN1bW1hcnkpLm1hcCgoa2V5LCBpKSA9PiAoXG4gICAgICAgIDxCb3gga2V5PXtrZXl9PlxuICAgICAgICAgIHtpID4gMCAmJiA8VGV4dD4sIDwvVGV4dD59XG4gICAgICAgICAgPFRleHQ+XG4gICAgICAgICAgICB7c3VtbWFyeVtrZXldfSB7a2V5fVxuICAgICAgICAgIDwvVGV4dD5cbiAgICAgICAgPC9Cb3g+XG4gICAgICApKX1cbiAgICA8Lz5cbiAgKTtcbn07XG5cbmludGVyZmFjZSBPdXRwdXRDb25maWcge1xuICBvdXRwdXQ6IHsgW2tleTogc3RyaW5nXTogVGVycmFmb3JtT3V0cHV0IH07XG59XG5mdW5jdGlvbiBzYW5pdGl6ZSh2YWx1ZTogYW55KSB7XG4gIGlmICh0eXBlb2YgdmFsdWUgPT09IFwib2JqZWN0XCIpIHtcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodmFsdWUsIG51bGwsIDIpO1xuICB9XG5cbiAgcmV0dXJuIHZhbHVlO1xufVxuZXhwb3J0IGNvbnN0IE91dHB1dCA9ICh7IG91dHB1dCB9OiBPdXRwdXRDb25maWcpOiBSZWFjdC5SZWFjdEVsZW1lbnQgPT4ge1xuICByZXR1cm4gKFxuICAgIDxCb3ggZmxleERpcmVjdGlvbj1cImNvbHVtblwiPlxuICAgICAge09iamVjdC5rZXlzKG91dHB1dCkubWFwKChrZXkpID0+IChcbiAgICAgICAgPEJveCBrZXk9e2tleX0+XG4gICAgICAgICAgPFRleHQ+XG4gICAgICAgICAgICB7a2V5fSA9e1wiIFwifVxuICAgICAgICAgICAge291dHB1dFtrZXldLnNlbnNpdGl2ZVxuICAgICAgICAgICAgICA/IFwiPHNlbnNpdGl2ZT5cIlxuICAgICAgICAgICAgICA6IHNhbml0aXplKG91dHB1dFtrZXldLnZhbHVlKX1cbiAgICAgICAgICA8L1RleHQ+XG4gICAgICAgIDwvQm94PlxuICAgICAgKSl9XG4gICAgPC9Cb3g+XG4gICk7XG59O1xuXG5pbnRlcmZhY2UgQ29uZmlybUNvbmZpZyB7XG4gIGNhbGxiYWNrOiAodmFsdWU6IGFueSkgPT4gYW55O1xufVxuXG5jb25zdCBDb25maXJtID0gKHsgY2FsbGJhY2sgfTogQ29uZmlybUNvbmZpZyk6IFJlYWN0LlJlYWN0RWxlbWVudCA9PiB7XG4gIGNvbnN0IFt2YWx1ZSwgc2V0VmFsdWVdID0gdXNlU3RhdGUoXCJcIik7XG5cbiAgcmV0dXJuIChcbiAgICA8Qm94IGZsZXhEaXJlY3Rpb249XCJjb2x1bW5cIiBtYXJnaW5Ub3A9ezF9PlxuICAgICAgPFRleHQgYm9sZD5EbyB5b3Ugd2FudCB0byBwZXJmb3JtIHRoZXNlIGFjdGlvbnM/PC9UZXh0PlxuICAgICAgPFRleHQ+IENESyBmb3IgVGVycmFmb3JtIHdpbGwgcGVyZm9ybSB0aGUgYWN0aW9ucyBkZXNjcmliZWQgYWJvdmUuPC9UZXh0PlxuICAgICAgPFRleHQ+IE9ubHkgJ3llcycgd2lsbCBiZSBhY2NlcHRlZCB0byBhcHByb3ZlLjwvVGV4dD5cblxuICAgICAgPEJveCBmbGV4RGlyZWN0aW9uPVwicm93XCIgbWFyZ2luVG9wPXsxfT5cbiAgICAgICAgPFRleHQgYm9sZD4gRW50ZXIgYSB2YWx1ZTo8L1RleHQ+XG4gICAgICAgIDxDb25maXJtSW5wdXQgdmFsdWU9e3ZhbHVlfSBvbkNoYW5nZT17c2V0VmFsdWV9IG9uU3VibWl0PXtjYWxsYmFja30gLz5cbiAgICAgIDwvQm94PlxuICAgIDwvQm94PlxuICApO1xufTtcblxuaW50ZXJmYWNlIEFwcGx5YWJsZVJlc291cmNlc0NvbmZpZyB7XG4gIHJlc291cmNlczogRGVwbG95aW5nUmVzb3VyY2VbXTtcbiAgc3RhY2tOYW1lOiBzdHJpbmc7XG59XG5jb25zdCBBcHBseWFibGVSZXNvdXJjZXMgPSAoe1xuICByZXNvdXJjZXMsXG4gIHN0YWNrTmFtZSxcbn06IEFwcGx5YWJsZVJlc291cmNlc0NvbmZpZyk6IFJlYWN0LlJlYWN0RWxlbWVudCA9PiB7XG4gIGlmICghcmVzb3VyY2VzLmxlbmd0aCkge1xuICAgIHJldHVybiA8PjwvPjtcbiAgfVxuXG4gIHJldHVybiAoXG4gICAgPD5cbiAgICAgIDxUZXh0IGJvbGQ+UmVzb3VyY2VzPC9UZXh0PlxuICAgICAge3Jlc291cmNlcy5tYXAoKHJlc291cmNlOiBhbnkpID0+IChcbiAgICAgICAgPEJveCBrZXk9e3Jlc291cmNlLmlkfSBtYXJnaW5MZWZ0PXsxfT5cbiAgICAgICAgICA8RGVwbG95aW5nRWxlbWVudCByZXNvdXJjZT17cmVzb3VyY2V9IHN0YWNrTmFtZT17c3RhY2tOYW1lfSAvPlxuICAgICAgICA8L0JveD5cbiAgICAgICkpfVxuICAgICAgPEJveCBtYXJnaW5Ub3A9ezF9PlxuICAgICAgICA8VGV4dCBib2xkPlN1bW1hcnk6IDwvVGV4dD5cbiAgICAgICAgPERlcGxveVN1bW1hcnkgcmVzb3VyY2VzPXtyZXNvdXJjZXN9IC8+XG4gICAgICAgIDxUZXh0Pi48L1RleHQ+XG4gICAgICA8L0JveD5cbiAgICA8Lz5cbiAgKTtcbn07XG5cbmV4cG9ydCBjb25zdCBBcHBseSA9ICgpOiBSZWFjdC5SZWFjdEVsZW1lbnQgPT4ge1xuICBjb25zdCB7IHJlc291cmNlcywgc3RhdHVzLCBjdXJyZW50U3RhY2ssIG91dHB1dCB9ID0gdXNlVGVycmFmb3JtU3RhdGUoKTtcbiAgY29uc3QgYXBwbHlBY3Rpb25zID0gW1xuICAgIFBsYW5uZWRSZXNvdXJjZUFjdGlvbi5VUERBVEUsXG4gICAgUGxhbm5lZFJlc291cmNlQWN0aW9uLkNSRUFURSxcbiAgICBQbGFubmVkUmVzb3VyY2VBY3Rpb24uREVMRVRFLFxuICAgIFBsYW5uZWRSZXNvdXJjZUFjdGlvbi5SRUFELFxuICBdO1xuICBjb25zdCBhcHBseWFibGVSZXNvdXJjZXMgPSByZXNvdXJjZXMuZmlsdGVyKChyZXNvdXJjZSkgPT5cbiAgICBhcHBseUFjdGlvbnMuaW5jbHVkZXMocmVzb3VyY2UuYWN0aW9uKVxuICApO1xuICByZXR1cm4gKFxuICAgIDxGcmFnbWVudD5cbiAgICAgIDxCb3ggZmxleERpcmVjdGlvbj1cImNvbHVtblwiPlxuICAgICAgICA8Qm94PlxuICAgICAgICAgIHtTdGF0dXMuREVQTE9ZSU5HID09IHN0YXR1cyA/IChcbiAgICAgICAgICAgIDw+XG4gICAgICAgICAgICAgIDxUZXh0IGNvbG9yPVwiZ3JlZW5cIj5cbiAgICAgICAgICAgICAgICA8U3Bpbm5lciB0eXBlPVwiZG90c1wiIC8+XG4gICAgICAgICAgICAgIDwvVGV4dD5cbiAgICAgICAgICAgICAgPEJveCBwYWRkaW5nTGVmdD17MX0+XG4gICAgICAgICAgICAgICAgPFRleHQ+RGVwbG95aW5nIFN0YWNrOiA8L1RleHQ+XG4gICAgICAgICAgICAgICAgPFRleHQgYm9sZD57Y3VycmVudFN0YWNrLm5hbWV9PC9UZXh0PlxuICAgICAgICAgICAgICA8L0JveD5cbiAgICAgICAgICAgIDwvPlxuICAgICAgICAgICkgOiAoXG4gICAgICAgICAgICA8PlxuICAgICAgICAgICAgICA8VGV4dD5EZXBsb3lpbmcgU3RhY2s6IDwvVGV4dD5cbiAgICAgICAgICAgICAgPFRleHQgYm9sZD57Y3VycmVudFN0YWNrLm5hbWV9PC9UZXh0PlxuICAgICAgICAgICAgPC8+XG4gICAgICAgICAgKX1cbiAgICAgICAgPC9Cb3g+XG4gICAgICAgIDxBcHBseWFibGVSZXNvdXJjZXNcbiAgICAgICAgICByZXNvdXJjZXM9e2FwcGx5YWJsZVJlc291cmNlc31cbiAgICAgICAgICBzdGFja05hbWU9e2N1cnJlbnRTdGFjay5uYW1lfVxuICAgICAgICAvPlxuICAgICAgICB7b3V0cHV0ICYmIE9iamVjdC5rZXlzKG91dHB1dCkubGVuZ3RoID4gMCAmJiAoXG4gICAgICAgICAgPEJveCBtYXJnaW5Ub3A9ezF9PlxuICAgICAgICAgICAgPFRleHQgYm9sZD5PdXRwdXQ6IDwvVGV4dD5cbiAgICAgICAgICAgIDxPdXRwdXQgb3V0cHV0PXtvdXRwdXR9IC8+XG4gICAgICAgICAgPC9Cb3g+XG4gICAgICAgICl9XG4gICAgICA8L0JveD5cbiAgICA8L0ZyYWdtZW50PlxuICApO1xufTtcblxuaW50ZXJmYWNlIERlcGxveUNvbmZpZyB7XG4gIHRhcmdldERpcjogc3RyaW5nO1xuICB0YXJnZXRTdGFjaz86IHN0cmluZztcbiAgc3ludGhDb21tYW5kOiBzdHJpbmc7XG4gIGF1dG9BcHByb3ZlOiBib29sZWFuO1xufVxuXG5leHBvcnQgY29uc3QgRGVwbG95ID0gKHtcbiAgdGFyZ2V0RGlyLFxuICB0YXJnZXRTdGFjayxcbiAgc3ludGhDb21tYW5kLFxuICBhdXRvQXBwcm92ZSxcbn06IERlcGxveUNvbmZpZyk6IFJlYWN0LlJlYWN0RWxlbWVudCA9PiB7XG4gIGNvbnN0IHtcbiAgICBzdGF0ZTogeyBzdGF0dXMsIGN1cnJlbnRTdGFjaywgZXJyb3JzLCBwbGFuIH0sXG4gICAgY29uZmlybWF0aW9uLFxuICAgIGlzQ29uZmlybWVkLFxuICB9ID0gdXNlUnVuRGVwbG95KHtcbiAgICB0YXJnZXREaXIsXG4gICAgdGFyZ2V0U3RhY2ssXG4gICAgc3ludGhDb21tYW5kLFxuICAgIGF1dG9BcHByb3ZlLFxuICB9KTtcblxuICBjb25zdCBwbGFuU3RhZ2VzID0gW1xuICAgIFN0YXR1cy5JTklUSUFMSVpJTkcsXG4gICAgU3RhdHVzLlBMQU5OSU5HLFxuICAgIFN0YXR1cy5TWU5USEVTSVpJTkcsXG4gICAgU3RhdHVzLlNZTlRIRVNJWkVELFxuICAgIFN0YXR1cy5TVEFSVElORyxcbiAgXTtcbiAgY29uc3QgaXNQbGFubmluZyA9IHBsYW5TdGFnZXMuaW5jbHVkZXMoc3RhdHVzKTtcbiAgY29uc3Qgc3RhdHVzVGV4dCA9XG4gICAgY3VycmVudFN0YWNrLm5hbWUgPT09IFwiXCIgPyAoXG4gICAgICA8VGV4dD57c3RhdHVzfS4uLjwvVGV4dD5cbiAgICApIDogKFxuICAgICAgPFRleHQ+XG4gICAgICAgIHtzdGF0dXN9XG4gICAgICAgIDxUZXh0IGJvbGQ+Jm5ic3A7e2N1cnJlbnRTdGFjay5uYW1lfTwvVGV4dD4uLi5cbiAgICAgIDwvVGV4dD5cbiAgICApO1xuXG4gIGlmIChlcnJvcnMpIHJldHVybiA8Qm94PntlcnJvcnMubWFwKChlOiBhbnkpID0+IGUubWVzc2FnZSl9PC9Cb3g+O1xuICBpZiAocGxhbiAmJiAhcGxhbi5uZWVkc0FwcGx5KVxuICAgIHJldHVybiAoXG4gICAgICA8PlxuICAgICAgICA8VGV4dD5cbiAgICAgICAgICBObyBjaGFuZ2VzIGZvciBTdGFjazogPFRleHQgYm9sZD57Y3VycmVudFN0YWNrLm5hbWV9PC9UZXh0PlxuICAgICAgICA8L1RleHQ+XG4gICAgICA8Lz5cbiAgICApO1xuXG4gIHJldHVybiAoXG4gICAgPEJveD5cbiAgICAgIHtpc1BsYW5uaW5nID8gKFxuICAgICAgICA8RnJhZ21lbnQ+XG4gICAgICAgICAgPFRleHQgY29sb3I9XCJncmVlblwiPlxuICAgICAgICAgICAgPFNwaW5uZXIgdHlwZT1cImRvdHNcIiAvPlxuICAgICAgICAgIDwvVGV4dD5cbiAgICAgICAgICA8Qm94IHBhZGRpbmdMZWZ0PXsxfT5cbiAgICAgICAgICAgIDxUZXh0PntzdGF0dXNUZXh0fTwvVGV4dD5cbiAgICAgICAgICA8L0JveD5cbiAgICAgICAgPC9GcmFnbWVudD5cbiAgICAgICkgOiAoXG4gICAgICAgIDw+XG4gICAgICAgICAgeyFpc0NvbmZpcm1lZCAmJiAoXG4gICAgICAgICAgICA8Qm94IGZsZXhEaXJlY3Rpb249XCJjb2x1bW5cIj5cbiAgICAgICAgICAgICAgPFBsYW4gLz5cbiAgICAgICAgICAgICAgPENvbmZpcm0gY2FsbGJhY2s9e2NvbmZpcm1hdGlvbn0gLz5cbiAgICAgICAgICAgIDwvQm94PlxuICAgICAgICAgICl9XG4gICAgICAgICAge2lzQ29uZmlybWVkICYmIDxBcHBseSAvPn1cbiAgICAgICAgPC8+XG4gICAgICApfVxuICAgIDwvQm94PlxuICApO1xufTtcbiJdfQ==
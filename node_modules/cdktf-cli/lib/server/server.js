"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const http_1 = require("http");
const apollo_server_express_1 = require("apollo-server-express");
const graphql_1 = require("graphql");
const apollo_server_core_1 = require("apollo-server-core");
const subscriptions_transport_ws_1 = require("subscriptions-transport-ws");
const load_1 = require("@graphql-tools/load");
const graphql_file_loader_1 = require("@graphql-tools/graphql-file-loader");
const graphql_subscriptions_1 = require("graphql-subscriptions");
const WatchClient_1 = require("./WatchClient");
const util_1 = require("./util");
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const utilities_1 = require("../../bin/cmds/helper/utilities");
const loadFile = (file) => {
    // if file exists relative ot this file return its file path
    // otherwise return the file path relative to the project root
    const filePath = path.resolve(path.join(__dirname, file));
    if (fs.existsSync(filePath)) {
        return filePath;
    }
    return path.resolve(path.join(utilities_1.projectRootPath(), "bundle", "lib", "server", file));
};
const graphqlSchemaPath = loadFile("schema.graphql");
const pubsub = new graphql_subscriptions_1.PubSub();
const WATCH_EVENT = "WATCH";
const PORT = process.argv[2];
let watchClient;
async function startApolloServer() {
    // Provide resolver functions for your schema fields
    const resolvers = {
        Query: {
            hello: () => "Hello world!!!",
        },
        Subscription: {
            watch: {
                subscribe: async (_parent, args) => {
                    // create this here so that events with errors published
                    // while startup reach the client
                    const iterator = pubsub.asyncIterator([WATCH_EVENT]);
                    if (watchClient && watchClient.isRunning()) {
                        console.warn("There is already a watch running, you will receive the updates from that run but no new one is started.");
                    }
                    else {
                        try {
                            watchClient = new WatchClient_1.WatchClient(args.inputs);
                            // subscribe returns an unsubscribe function but that connect reliably
                            // be used with PubSub â€“ that lib is recommended by Apollo docs but seems to
                            // be unmaintained, maybe ditch it? see https://github.com/apollographql/graphql-subscriptions/issues/240#issuecomment-767568596
                            watchClient.subscribe((state) => pubsub.publish(WATCH_EVENT, {
                                watch: util_1.mapWatchState(state),
                            }));
                            await watchClient.start();
                        }
                        catch (e) {
                            const state = {
                                resources: [],
                                stacks: [],
                                status: "IDLE",
                                error: {
                                    origin: "SERVER",
                                    message: e.message,
                                    timestamp: Date.now(),
                                    recoverable: false,
                                },
                            };
                            // we should get rid if this hack somehow.
                            // this has to be done because the client won't receive this
                            // error if it is published before the iterator has been returned
                            setTimeout(() => pubsub.publish(WATCH_EVENT, { watch: state }), 1000);
                        }
                    }
                    return iterator;
                },
            },
        },
    };
    const schema = await load_1.loadSchema(graphqlSchemaPath, {
        // load from a single schema file
        loaders: [new graphql_file_loader_1.GraphQLFileLoader()],
        resolvers,
    });
    // setup express and base http server
    const app = express_1.default();
    app.get("/up", (_, res) => res.send("OK"));
    const httpServer = http_1.createServer(app);
    // setup apollo server
    const server = new apollo_server_express_1.ApolloServer({
        schema,
        introspection: true,
        plugins: [apollo_server_core_1.ApolloServerPluginLandingPageGraphQLPlayground()],
        debug: true,
    });
    await server.start();
    server.applyMiddleware({ app });
    // setup subscription server
    const subscriptionServer = subscriptions_transport_ws_1.SubscriptionServer.create({ schema, execute: graphql_1.execute, subscribe: graphql_1.subscribe }, { server: httpServer, path: server.graphqlPath });
    ["SIGINT", "SIGTERM"].forEach((signal) => {
        process.on(signal, () => {
            subscriptionServer.close();
            process.exit();
        });
    });
    await new Promise((resolve) => httpServer.listen({ port: PORT }, resolve));
    console.log(`ðŸš€ Server ready at http://localhost:${PORT}${server.graphqlPath}`);
    return { server, app };
}
startApolloServer();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHNEQUE4QjtBQUM5QiwrQkFBb0M7QUFDcEMsaUVBQXFEO0FBQ3JELHFDQUE2QztBQUM3QywyREFBb0Y7QUFDcEYsMkVBQWdFO0FBQ2hFLDhDQUFpRDtBQUNqRCw0RUFBdUU7QUFDdkUsaUVBQStDO0FBQy9DLCtDQUF3RDtBQUN4RCxpQ0FBMEQ7QUFDMUQsMkNBQTZCO0FBQzdCLDZDQUErQjtBQUMvQiwrREFBa0U7QUFFbEUsTUFBTSxRQUFRLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBRTtJQUNoQyw0REFBNEQ7SUFDNUQsOERBQThEO0lBQzlELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUMxRCxJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUU7UUFDM0IsT0FBTyxRQUFRLENBQUM7S0FDakI7SUFDRCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQ2pCLElBQUksQ0FBQyxJQUFJLENBQUMsMkJBQWUsRUFBRSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUM5RCxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUYsTUFBTSxpQkFBaUIsR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQVNyRCxNQUFNLE1BQU0sR0FBRyxJQUFJLDhCQUFNLEVBQUUsQ0FBQztBQUM1QixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUM7QUFFNUIsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUU3QixJQUFJLFdBQW9DLENBQUM7QUFFekMsS0FBSyxVQUFVLGlCQUFpQjtJQUM5QixvREFBb0Q7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RUFBRSxTQUFTLEVBQVQsbUJBQVMsRUFBRSxFQUM5QixFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FDakQsQ0FBQztJQUVGLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1FBQ3ZDLE9BQU8sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRTtZQUN0QixrQkFBa0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUMzQixPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDakIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUM1QixVQUFVLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFLE9BQXFCLENBQUMsQ0FDekQsQ0FBQztJQUNGLE9BQU8sQ0FBQyxHQUFHLENBQ1QsdUNBQXVDLElBQUksR0FBRyxNQUFNLENBQUMsV0FBVyxFQUFFLENBQ25FLENBQUM7SUFDRixPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDO0FBQ3pCLENBQUM7QUFDRCxpQkFBaUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MgZnJvbSBcImV4cHJlc3NcIjtcbmltcG9ydCB7IGNyZWF0ZVNlcnZlciB9IGZyb20gXCJodHRwXCI7XG5pbXBvcnQgeyBBcG9sbG9TZXJ2ZXIgfSBmcm9tIFwiYXBvbGxvLXNlcnZlci1leHByZXNzXCI7XG5pbXBvcnQgeyBleGVjdXRlLCBzdWJzY3JpYmUgfSBmcm9tIFwiZ3JhcGhxbFwiO1xuaW1wb3J0IHsgQXBvbGxvU2VydmVyUGx1Z2luTGFuZGluZ1BhZ2VHcmFwaFFMUGxheWdyb3VuZCB9IGZyb20gXCJhcG9sbG8tc2VydmVyLWNvcmVcIjtcbmltcG9ydCB7IFN1YnNjcmlwdGlvblNlcnZlciB9IGZyb20gXCJzdWJzY3JpcHRpb25zLXRyYW5zcG9ydC13c1wiO1xuaW1wb3J0IHsgbG9hZFNjaGVtYSB9IGZyb20gXCJAZ3JhcGhxbC10b29scy9sb2FkXCI7XG5pbXBvcnQgeyBHcmFwaFFMRmlsZUxvYWRlciB9IGZyb20gXCJAZ3JhcGhxbC10b29scy9ncmFwaHFsLWZpbGUtbG9hZGVyXCI7XG5pbXBvcnQgeyBQdWJTdWIgfSBmcm9tIFwiZ3JhcGhxbC1zdWJzY3JpcHRpb25zXCI7XG5pbXBvcnQgeyBXYXRjaENsaWVudCwgV2F0Y2hTdGF0ZSB9IGZyb20gXCIuL1dhdGNoQ2xpZW50XCI7XG5pbXBvcnQgeyBHcmFwaFFMV2F0Y2hTdGF0ZSwgbWFwV2F0Y2hTdGF0ZSB9IGZyb20gXCIuL3V0aWxcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmcy1leHRyYVwiO1xuaW1wb3J0IHsgcHJvamVjdFJvb3RQYXRoIH0gZnJvbSBcIi4uLy4uL2Jpbi9jbWRzL2hlbHBlci91dGlsaXRpZXNcIjtcblxuY29uc3QgbG9hZEZpbGUgPSAoZmlsZTogc3RyaW5nKSA9PiB7XG4gIC8vIGlmIGZpbGUgZXhpc3RzIHJlbGF0aXZlIG90IHRoaXMgZmlsZSByZXR1cm4gaXRzIGZpbGUgcGF0aFxuICAvLyBvdGhlcndpc2UgcmV0dXJuIHRoZSBmaWxlIHBhdGggcmVsYXRpdmUgdG8gdGhlIHByb2plY3Qgcm9vdFxuICBjb25zdCBmaWxlUGF0aCA9IHBhdGgucmVzb2x2ZShwYXRoLmpvaW4oX19kaXJuYW1lLCBmaWxlKSk7XG4gIGlmIChmcy5leGlzdHNTeW5jKGZpbGVQYXRoKSkge1xuICAgIHJldHVybiBmaWxlUGF0aDtcbiAgfVxuICByZXR1cm4gcGF0aC5yZXNvbHZlKFxuICAgIHBhdGguam9pbihwcm9qZWN0Um9vdFBhdGgoKSwgXCJidW5kbGVcIiwgXCJsaWJcIiwgXCJzZXJ2ZXJcIiwgZmlsZSlcbiAgKTtcbn07XG5cbmNvbnN0IGdyYXBocWxTY2hlbWFQYXRoID0gbG9hZEZpbGUoXCJzY2hlbWEuZ3JhcGhxbFwiKTtcblxudHlwZSBXYXRjaElucHV0cyA9IHtcbiAgdGFyZ2V0RGlyOiBzdHJpbmc7XG4gIHN5bnRoQ29tbWFuZDogc3RyaW5nO1xuICBhdXRvQXBwcm92ZTogYm9vbGVhbjtcbiAgdGFyZ2V0U3RhY2s/OiBzdHJpbmc7XG59O1xuXG5jb25zdCBwdWJzdWIgPSBuZXcgUHViU3ViKCk7XG5jb25zdCBXQVRDSF9FVkVOVCA9IFwiV0FUQ0hcIjtcblxuY29uc3QgUE9SVCA9IHByb2Nlc3MuYXJndlsyXTtcblxubGV0IHdhdGNoQ2xpZW50OiBXYXRjaENsaWVudCB8IHVuZGVmaW5lZDtcblxuYXN5bmMgZnVuY3Rpb24gc3RhcnRBcG9sbG9TZXJ2ZXIoKSB7XG4gIC8vIFByb3ZpZGUgcmVzb2x2ZXIgZnVuY3Rpb25zIGZvciB5b3VyIHNjaGVtYSBmaWVsZHNcbiAgY29uc3QgcmVzb2x2ZXJzID0ge1xuICAgIFF1ZXJ5OiB7XG4gICAgICBoZWxsbzogKCkgPT4gXCJIZWxsbyB3b3JsZCEhIVwiLFxuICAgIH0sXG4gICAgU3Vic2NyaXB0aW9uOiB7XG4gICAgICB3YXRjaDoge1xuICAgICAgICBzdWJzY3JpYmU6IGFzeW5jIChcbiAgICAgICAgICBfcGFyZW50OiB1bmRlZmluZWQsXG4gICAgICAgICAgYXJnczogeyBpbnB1dHM6IFdhdGNoSW5wdXRzIH1cbiAgICAgICAgKSA9PiB7XG4gICAgICAgICAgLy8gY3JlYXRlIHRoaXMgaGVyZSBzbyB0aGF0IGV2ZW50cyB3aXRoIGVycm9ycyBwdWJsaXNoZWRcbiAgICAgICAgICAvLyB3aGlsZSBzdGFydHVwIHJlYWNoIHRoZSBjbGllbnRcbiAgICAgICAgICBjb25zdCBpdGVyYXRvciA9IHB1YnN1Yi5hc3luY0l0ZXJhdG9yKFtXQVRDSF9FVkVOVF0pO1xuXG4gICAgICAgICAgaWYgKHdhdGNoQ2xpZW50ICYmIHdhdGNoQ2xpZW50LmlzUnVubmluZygpKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgICAgIFwiVGhlcmUgaXMgYWxyZWFkeSBhIHdhdGNoIHJ1bm5pbmcsIHlvdSB3aWxsIHJlY2VpdmUgdGhlIHVwZGF0ZXMgZnJvbSB0aGF0IHJ1biBidXQgbm8gbmV3IG9uZSBpcyBzdGFydGVkLlwiXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICB3YXRjaENsaWVudCA9IG5ldyBXYXRjaENsaWVudChhcmdzLmlucHV0cyk7XG5cbiAgICAgICAgICAgICAgLy8gc3Vic2NyaWJlIHJldHVybnMgYW4gdW5zdWJzY3JpYmUgZnVuY3Rpb24gYnV0IHRoYXQgY29ubmVjdCByZWxpYWJseVxuICAgICAgICAgICAgICAvLyBiZSB1c2VkIHdpdGggUHViU3ViIOKAkyB0aGF0IGxpYiBpcyByZWNvbW1lbmRlZCBieSBBcG9sbG8gZG9jcyBidXQgc2VlbXMgdG9cbiAgICAgICAgICAgICAgLy8gYmUgdW5tYWludGFpbmVkLCBtYXliZSBkaXRjaCBpdD8gc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hcG9sbG9ncmFwaHFsL2dyYXBocWwtc3Vic2NyaXB0aW9ucy9pc3N1ZXMvMjQwI2lzc3VlY29tbWVudC03Njc1Njg1OTZcbiAgICAgICAgICAgICAgd2F0Y2hDbGllbnQuc3Vic2NyaWJlKChzdGF0ZTogV2F0Y2hTdGF0ZSkgPT5cbiAgICAgICAgICAgICAgICBwdWJzdWIucHVibGlzaChXQVRDSF9FVkVOVCwge1xuICAgICAgICAgICAgICAgICAgd2F0Y2g6IG1hcFdhdGNoU3RhdGUoc3RhdGUpLFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIGF3YWl0IHdhdGNoQ2xpZW50LnN0YXJ0KCk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHN0YXRlOiBHcmFwaFFMV2F0Y2hTdGF0ZSA9IHtcbiAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtdLFxuICAgICAgICAgICAgICAgIHN0YWNrczogW10sXG4gICAgICAgICAgICAgICAgc3RhdHVzOiBcIklETEVcIixcbiAgICAgICAgICAgICAgICBlcnJvcjoge1xuICAgICAgICAgICAgICAgICAgb3JpZ2luOiBcIlNFUlZFUlwiLFxuICAgICAgICAgICAgICAgICAgbWVzc2FnZTogZS5tZXNzYWdlLFxuICAgICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICAgICAgICAgICAgcmVjb3ZlcmFibGU6IGZhbHNlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgIC8vIHdlIHNob3VsZCBnZXQgcmlkIGlmIHRoaXMgaGFjayBzb21laG93LlxuICAgICAgICAgICAgICAvLyB0aGlzIGhhcyB0byBiZSBkb25lIGJlY2F1c2UgdGhlIGNsaWVudCB3b24ndCByZWNlaXZlIHRoaXNcbiAgICAgICAgICAgICAgLy8gZXJyb3IgaWYgaXQgaXMgcHVibGlzaGVkIGJlZm9yZSB0aGUgaXRlcmF0b3IgaGFzIGJlZW4gcmV0dXJuZWRcbiAgICAgICAgICAgICAgc2V0VGltZW91dChcbiAgICAgICAgICAgICAgICAoKSA9PiBwdWJzdWIucHVibGlzaChXQVRDSF9FVkVOVCwgeyB3YXRjaDogc3RhdGUgfSksXG4gICAgICAgICAgICAgICAgMTAwMFxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBpdGVyYXRvcjtcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfTtcblxuICBjb25zdCBzY2hlbWEgPSBhd2FpdCBsb2FkU2NoZW1hKGdyYXBocWxTY2hlbWFQYXRoLCB7XG4gICAgLy8gbG9hZCBmcm9tIGEgc2luZ2xlIHNjaGVtYSBmaWxlXG4gICAgbG9hZGVyczogW25ldyBHcmFwaFFMRmlsZUxvYWRlcigpXSxcbiAgICByZXNvbHZlcnMsXG4gIH0pO1xuXG4gIC8vIHNldHVwIGV4cHJlc3MgYW5kIGJhc2UgaHR0cCBzZXJ2ZXJcbiAgY29uc3QgYXBwID0gZXhwcmVzcygpO1xuICBhcHAuZ2V0KFwiL3VwXCIsIChfLCByZXMpID0+IHJlcy5zZW5kKFwiT0tcIikpO1xuICBjb25zdCBodHRwU2VydmVyID0gY3JlYXRlU2VydmVyKGFwcCk7XG5cbiAgLy8gc2V0dXAgYXBvbGxvIHNlcnZlclxuICBjb25zdCBzZXJ2ZXIgPSBuZXcgQXBvbGxvU2VydmVyKHtcbiAgICBzY2hlbWEsXG4gICAgaW50cm9zcGVjdGlvbjogdHJ1ZSxcbiAgICBwbHVnaW5zOiBbQXBvbGxvU2VydmVyUGx1Z2luTGFuZGluZ1BhZ2VHcmFwaFFMUGxheWdyb3VuZCgpXSxcbiAgICBkZWJ1ZzogdHJ1ZSxcbiAgfSk7XG4gIGF3YWl0IHNlcnZlci5zdGFydCgpO1xuICBzZXJ2ZXIuYXBwbHlNaWRkbGV3YXJlKHsgYXBwIH0pO1xuXG4gIC8vIHNldHVwIHN1YnNjcmlwdGlvbiBzZXJ2ZXJcbiAgY29uc3Qgc3Vic2NyaXB0aW9uU2VydmVyID0gU3Vic2NyaXB0aW9uU2VydmVyLmNyZWF0ZShcbiAgICB7IHNjaGVtYSwgZXhlY3V0ZSwgc3Vic2NyaWJlIH0sXG4gICAgeyBzZXJ2ZXI6IGh0dHBTZXJ2ZXIsIHBhdGg6IHNlcnZlci5ncmFwaHFsUGF0aCB9XG4gICk7XG5cbiAgW1wiU0lHSU5UXCIsIFwiU0lHVEVSTVwiXS5mb3JFYWNoKChzaWduYWwpID0+IHtcbiAgICBwcm9jZXNzLm9uKHNpZ25hbCwgKCkgPT4ge1xuICAgICAgc3Vic2NyaXB0aW9uU2VydmVyLmNsb3NlKCk7XG4gICAgICBwcm9jZXNzLmV4aXQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+XG4gICAgaHR0cFNlcnZlci5saXN0ZW4oeyBwb3J0OiBQT1JUIH0sIHJlc29sdmUgYXMgKCkgPT4gdm9pZClcbiAgKTtcbiAgY29uc29sZS5sb2coXG4gICAgYPCfmoAgU2VydmVyIHJlYWR5IGF0IGh0dHA6Ly9sb2NhbGhvc3Q6JHtQT1JUfSR7c2VydmVyLmdyYXBocWxQYXRofWBcbiAgKTtcbiAgcmV0dXJuIHsgc2VydmVyLCBhcHAgfTtcbn1cbnN0YXJ0QXBvbGxvU2VydmVyKCk7XG4iXX0=
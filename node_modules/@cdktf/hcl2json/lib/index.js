"use strict";
// eslint-disable-next-line @typescript-eslint/triple-slash-reference
/// <reference lib="dom" />
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.convertFiles = exports.parse = void 0;
// Inspired by
// https://github.com/ts-terraform/ts-terraform
// https://github.com/aaronpowell/webpack-golang-wasm-async-loader
const fs_extra_1 = __importDefault(require("fs-extra"));
const path_1 = __importDefault(require("path"));
const wasm_exec_1 = require("./wasm_exec");
const deepmerge_1 = require("./deepmerge");
const zlib_1 = require("zlib");
// eslint-disable-next-line @typescript-eslint/ban-types
const jsRoot = {};
function sleep() {
    return new Promise((resolve) => {
        setTimeout(resolve, 0);
    });
}
function goBridge(getBytes) {
    let ready = false;
    async function init() {
        const go = new wasm_exec_1.Go();
        const bytes = await getBytes;
        const result = await WebAssembly.instantiate(bytes, go.importObject);
        void go.run(result.instance, { __parse_terraform_config_wasm__: jsRoot });
        ready = true;
    }
    init().catch((error) => {
        throw error;
    });
    const proxy = new Proxy({}, {
        get: (_, key) => {
            return async (...args) => {
                while (!ready) {
                    await sleep();
                }
                if (!(key in jsRoot)) {
                    throw new Error(`There is nothing defined with the name "${key.toString()}"`);
                }
                if (typeof jsRoot[key] !== "function") {
                    return jsRoot[key];
                }
                return new Promise((resolve, reject) => {
                    const cb = (err, ...msg) => 
                    // @ts-ignore
                    err ? reject(new Error(err)) : resolve(...msg);
                    const run = () => {
                        jsRoot[key].apply(undefined, [...args, cb]);
                    };
                    run();
                });
            };
        },
    });
    return proxy;
}
const loadWasm = async () => {
    return zlib_1.gunzipSync(await fs_extra_1.default.readFile(path_1.default.join(__dirname, "..", "main.wasm.gz")));
};
const wasm = goBridge(loadWasm());
async function parse(filename, contents) {
    const res = await wasm.parse(filename, contents);
    return JSON.parse(res);
}
exports.parse = parse;
async function convertFiles(workingDirectory) {
    let tfFileContents = "";
    const tfJSONFileContents = [];
    for (const file of fs_extra_1.default.readdirSync(workingDirectory)) {
        const filePath = path_1.default.resolve(workingDirectory, file);
        if (!fs_extra_1.default.lstatSync(filePath).isDirectory()) {
            if (file.match(/\.tf$/)) {
                tfFileContents += fs_extra_1.default.readFileSync(filePath, "utf-8");
                tfFileContents += "\n";
            }
            else if (file.match(/\.tf\.json$/)) {
                tfJSONFileContents.push(JSON.parse(fs_extra_1.default.readFileSync(filePath, "utf-8")));
            }
        }
    }
    if (tfFileContents === "" && tfJSONFileContents === []) {
        console.error(`No '.tf' or '.tf.json' files found in ${workingDirectory}`);
        return;
    }
    return deepmerge_1.deepMerge(await parse("hcl2json.tf", tfFileContents), ...tfJSONFileContents);
}
exports.convertFiles = convertFiles;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEscUVBQXFFO0FBQ3JFLDJCQUEyQjs7Ozs7O0FBRTNCLGNBQWM7QUFDZCwrQ0FBK0M7QUFDL0Msa0VBQWtFO0FBRWxFLHdEQUEwQjtBQUMxQixnREFBd0I7QUFDeEIsMkNBQWlDO0FBQ2pDLDJDQUF3QztBQUN4QywrQkFBa0M7QUFNbEMsd0RBQXdEO0FBQ3hELE1BQU0sTUFBTSxHQUE2QixFQUFFLENBQUM7QUFFNUMsU0FBUyxLQUFLO0lBQ1osT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQzdCLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDekIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsU0FBUyxRQUFRLENBQUMsUUFBeUI7SUFDekMsSUFBSSxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBRWxCLEtBQUssVUFBVSxJQUFJO1FBQ2pCLE1BQU0sRUFBRSxHQUFHLElBQUksY0FBRSxFQUFFLENBQUM7UUFDcEIsTUFBTSxLQUFLLEdBQUcsTUFBTSxRQUFRLENBQUM7UUFDN0IsTUFBTSxNQUFNLEdBQUcsTUFBTSxXQUFXLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDckUsS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsRUFBRSwrQkFBK0IsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQzFFLEtBQUssR0FBRyxJQUFJLENBQUM7SUFDZixDQUFDO0lBRUQsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7UUFDckIsTUFBTSxLQUFLLENBQUM7SUFDZCxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLEVBQWMsRUFBRTtR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QUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUN6RTtTQUNGO0tBQ0Y7SUFFRCxJQUFJLGNBQWMsS0FBSyxFQUFFLElBQUksa0JBQWtCLEtBQUssRUFBRSxFQUFFO1FBQ3RELE9BQU8sQ0FBQyxLQUFLLENBQUMseUNBQXlDLGdCQUFnQixFQUFFLENBQUMsQ0FBQztRQUMzRSxPQUFPO0tBQ1I7SUFFRCxPQUFPLHFCQUFTLENBQ2QsTUFBTSxLQUFLLENBQUMsYUFBYSxFQUFFLGNBQWMsQ0FBQyxFQUMxQyxHQUFHLGtCQUFrQixDQUN0QixDQUFDO0FBQ0osQ0FBQztBQTNCRCxvQ0EyQkMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L3RyaXBsZS1zbGFzaC1yZWZlcmVuY2Vcbi8vLyA8cmVmZXJlbmNlIGxpYj1cImRvbVwiIC8+XG5cbi8vIEluc3BpcmVkIGJ5XG4vLyBodHRwczovL2dpdGh1Yi5jb20vdHMtdGVycmFmb3JtL3RzLXRlcnJhZm9ybVxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2Fhcm9ucG93ZWxsL3dlYnBhY2stZ29sYW5nLXdhc20tYXN5bmMtbG9hZGVyXG5cbmltcG9ydCBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBHbyB9IGZyb20gXCIuL3dhc21fZXhlY1wiO1xuaW1wb3J0IHsgZGVlcE1lcmdlIH0gZnJvbSBcIi4vZGVlcG1lcmdlXCI7XG5pbXBvcnQgeyBndW56aXBTeW5jIH0gZnJvbSBcInpsaWJcIjtcblxuaW50ZXJmYWNlIEdvQnJpZGdlIHtcbiAgcGFyc2U6IChmaWxlbmFtZTogc3RyaW5nLCBoY2w6IHN0cmluZykgPT4gUHJvbWlzZTxzdHJpbmc+O1xufVxuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10eXBlc1xuY29uc3QganNSb290OiBSZWNvcmQ8c3RyaW5nLCBGdW5jdGlvbj4gPSB7fTtcblxuZnVuY3Rpb24gc2xlZXAoKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIHNldFRpbWVvdXQocmVzb2x2ZSwgMCk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBnb0JyaWRnZShnZXRCeXRlczogUHJvbWlzZTxCdWZmZXI+KSB7XG4gIGxldCByZWFkeSA9IGZhbHNlO1xuXG4gIGFzeW5jIGZ1bmN0aW9uIGluaXQoKSB7XG4gICAgY29uc3QgZ28gPSBuZXcgR28oKTtcbiAgICBjb25zdCBieXRlcyA9IGF3YWl0IGdldEJ5dGVzO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFdlYkFzc2VtYmx5Lmluc3RhbnRpYXRlKGJ5dGVzLCBnby5pbXBvcnRPYmplY3QpO1xuICAgIHZvaWQgZ28ucnVuKHJlc3VsdC5pbnN0YW5jZSwgeyBfX3BhcnNlX3RlcnJhZm9ybV9jb25maWdfd2FzbV9fOiBqc1Jvb3QgfSk7XG4gICAgcmVhZHkgPSB0cnVlO1xuICB9XG5cbiAgaW5pdCgpLmNhdGNoKChlcnJvcikgPT4ge1xuICAgIHRocm93IGVycm9yO1xuICB9KTtcblxuICBjb25zdCBwcm94eSA9IG5ldyBQcm94eSh7fSBhcyBHb0JyaWRnZSwge1xuICAgIGdldDogKF8sIGtleTogc3RyaW5nKSA9PiB7XG4gICAgICByZXR1cm4gYXN5bmMgKC4uLmFyZ3M6IHVua25vd25bXSkgPT4ge1xuICAgICAgICB3aGlsZSAoIXJlYWR5KSB7XG4gICAgICAgICAgYXdhaXQgc2xlZXAoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghKGtleSBpbiBqc1Jvb3QpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYFRoZXJlIGlzIG5vdGhpbmcgZGVmaW5lZCB3aXRoIHRoZSBuYW1lIFwiJHtrZXkudG9TdHJpbmcoKX1cImBcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHR5cGVvZiBqc1Jvb3Rba2V5XSAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgcmV0dXJuIGpzUm9vdFtrZXldO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICBjb25zdCBjYiA9IChlcnI6IHN0cmluZywgLi4ubXNnOiBzdHJpbmdbXSkgPT5cbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIGVyciA/IHJlamVjdChuZXcgRXJyb3IoZXJyKSkgOiByZXNvbHZlKC4uLm1zZyk7XG5cbiAgICAgICAgICBjb25zdCBydW4gPSAoKSA9PiB7XG4gICAgICAgICAgICBqc1Jvb3Rba2V5XS5hcHBseSh1bmRlZmluZWQsIFsuLi5hcmdzLCBjYl0pO1xuICAgICAgICAgIH07XG5cbiAgICAgICAgICBydW4oKTtcbiAgICAgICAgfSk7XG4gICAgICB9O1xuICAgIH0sXG4gIH0pO1xuXG4gIHJldHVybiBwcm94eTtcbn1cblxuY29uc3QgbG9hZFdhc20gPSBhc3luYyAoKSA9PiB7XG4gIHJldHVybiBndW56aXBTeW5jKFxuICAgIGF3YWl0IGZzLnJlYWRGaWxlKHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi5cIiwgXCJtYWluLndhc20uZ3pcIikpXG4gICk7XG59O1xuXG5jb25zdCB3YXNtID0gZ29CcmlkZ2UobG9hZFdhc20oKSk7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwYXJzZShcbiAgZmlsZW5hbWU6IHN0cmluZyxcbiAgY29udGVudHM6IHN0cmluZ1xuKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBhbnk+PiB7XG4gIGNvbnN0IHJlcyA9IGF3YWl0IHdhc20ucGFyc2UoZmlsZW5hbWUsIGNvbnRlbnRzKTtcbiAgcmV0dXJuIEpTT04ucGFyc2UocmVzKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNvbnZlcnRGaWxlcyhcbiAgd29ya2luZ0RpcmVjdG9yeTogc3RyaW5nXG4pOiBQcm9taXNlPFJlY29yZDxzdHJpbmcsIGFueT4gfCB2b2lkPiB7XG4gIGxldCB0ZkZpbGVDb250ZW50cyA9IFwiXCI7XG4gIGNvbnN0IHRmSlNPTkZpbGVDb250ZW50czogUmVjb3JkPHN0cmluZywgYW55PltdID0gW107XG5cbiAgZm9yIChjb25zdCBmaWxlIG9mIGZzLnJlYWRkaXJTeW5jKHdvcmtpbmdEaXJlY3RvcnkpKSB7XG4gICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLnJlc29sdmUod29ya2luZ0RpcmVjdG9yeSwgZmlsZSk7XG4gICAgaWYgKCFmcy5sc3RhdFN5bmMoZmlsZVBhdGgpLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgIGlmIChmaWxlLm1hdGNoKC9cXC50ZiQvKSkge1xuICAgICAgICB0ZkZpbGVDb250ZW50cyArPSBmcy5yZWFkRmlsZVN5bmMoZmlsZVBhdGgsIFwidXRmLThcIik7XG4gICAgICAgIHRmRmlsZUNvbnRlbnRzICs9IFwiXFxuXCI7XG4gICAgICB9IGVsc2UgaWYgKGZpbGUubWF0Y2goL1xcLnRmXFwuanNvbiQvKSkge1xuICAgICAgICB0ZkpTT05GaWxlQ29udGVudHMucHVzaChKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhmaWxlUGF0aCwgXCJ1dGYtOFwiKSkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmICh0ZkZpbGVDb250ZW50cyA9PT0gXCJcIiAmJiB0ZkpTT05GaWxlQ29udGVudHMgPT09IFtdKSB7XG4gICAgY29uc29sZS5lcnJvcihgTm8gJy50Zicgb3IgJy50Zi5qc29uJyBmaWxlcyBmb3VuZCBpbiAke3dvcmtpbmdEaXJlY3Rvcnl9YCk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgcmV0dXJuIGRlZXBNZXJnZShcbiAgICBhd2FpdCBwYXJzZShcImhjbDJqc29uLnRmXCIsIHRmRmlsZUNvbnRlbnRzKSxcbiAgICAuLi50ZkpTT05GaWxlQ29udGVudHNcbiAgKTtcbn1cbiJdfQ==
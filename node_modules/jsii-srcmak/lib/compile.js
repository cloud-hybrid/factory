"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.compile = void 0;
const crypto = __importStar(require("crypto"));
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const util_1 = require("./util");
const compilerModule = require.resolve('jsii/bin/jsii');
/**
 * Compiles the source files in `workdir` with jsii.
 */
async function compile(workdir, options) {
    var _a, _b, _c, _d;
    (0, util_1.validateOptions)(options);
    const args = ['--silence-warnings', 'reserved-word'];
    const entrypoint = (_a = options.entrypoint) !== null && _a !== void 0 ? _a : 'index.ts';
    if (path.extname(entrypoint) !== '.ts') {
        throw new Error(`jsii entrypoint must be a .ts file: ${entrypoint}`);
    }
    if (!(await fs.pathExists(path.join(workdir, entrypoint)))) {
        throw new Error(`unable to find typescript entrypoint: ${path.join(workdir, entrypoint)}`);
    }
    // path to entrypoint without extension
    const basepath = path.join(path.dirname(entrypoint), path.basename(entrypoint, '.ts'));
    const moduleKey = (_c = (_b = options.moduleKey) === null || _b === void 0 ? void 0 : _b.replace(/\./g, '').replace(/\//g, '')) !== null && _c !== void 0 ? _c : crypto.createHash('sha256').update(basepath, 'utf8').digest('hex');
    // jsii modules to include
    const moduleDirs = (_d = options.deps) !== null && _d !== void 0 ? _d : [];
    const targets = {};
    const deps = {};
    for (const dir of moduleDirs) {
        // read module metadata
        const metadata = await fs.readJson(path.join(dir, 'package.json'));
        const moduleName = metadata.name;
        const moduleVersion = metadata.version;
        const targetdir = path.join(path.join(workdir, 'node_modules'), moduleName);
        await fs.mkdirp(path.dirname(targetdir));
        await fs.copy(dir, targetdir);
        // add to "deps" and "peer deps"
        if (!moduleName.startsWith('@types/')) {
            deps[moduleName] = moduleVersion;
        }
    }
    const pkg = {
        name: moduleKey,
        version: '0.0.0',
        author: 'generated@generated.com',
        main: `${basepath}.js`,
        types: `${basepath}.d.ts`,
        license: 'UNLICENSED',
        repository: { url: 'http://generated', type: 'git' },
        jsii: {
            outdir: 'dist',
            targets: targets,
        },
        dependencies: deps,
        peerDependencies: deps,
    };
    if (options.python) {
        targets.python = {
            distName: 'generated',
            module: options.python.moduleName,
        };
    }
    if (options.java) {
        targets.java = {
            package: options.java.package,
            maven: {
                groupId: 'generated',
                artifactId: 'generated',
            },
        };
    }
    if (options.csharp) {
        targets.dotnet = {
            namespace: options.csharp.namespace,
            packageId: options.csharp.namespace,
        };
    }
    if (options.golang) {
        targets.go = {
            moduleName: options.golang.moduleName,
            packageName: options.golang.packageName,
        };
    }
    await fs.writeFile(path.join(workdir, 'package.json'), JSON.stringify(pkg, undefined, 2));
    await (0, util_1.exec)(compilerModule, args, {
        cwd: workdir,
    });
}
exports.compile = compile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21waWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwrQ0FBaUM7QUFDakMsMkNBQTZCO0FBQzdCLDZDQUErQjtBQUUvQixpQ0FBK0M7QUFFL0MsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUV4RDs7R0FFRztBQUNJLEtBQUssVUFBVSxPQUFPLENBQUMsT0FBZSxFQUFFLE9BQWdCOztJQUM3RCxJQUFBLHNCQUFlLEVBQUMsT0FBTyxDQUFDLENBQUM7SUFFekIsTUFBTSxJQUFJLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxlQUFlLENBQUMsQ0FBQztJQUNyRCxNQUFNLFVBQVUsR0FBRyxNQUFBLE9BQU8sQ0FBQyxVQUFVLG1DQUFJLFVBQVUsQ0FBQztJQUVwRCxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEtBQUssS0FBSyxFQUFFO1FBQ3RDLE1BQU0sSUFBSSxLQUFLLENBQUMsdUNBQXVDLFVBQVUsRUFBRSxDQUFDLENBQUM7S0FDdEU7SUFFRCxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQzFELE1BQU0sSUFBSSxLQUFLLENBQUMseUNBQXlDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUM1RjtJQUVELHVDQUF1QztJQUN2QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUV2RixNQUFNLFNBQVMsR0FB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VTtZQUNyQyxXQUFXLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxXQUFXO1NBQ3hDLENBQUM7S0FDSDtJQUVELE1BQU0sRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxjQUFjLENBQUMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUUxRixNQUFNLElBQUEsV0FBSSxFQUFDLGNBQWMsRUFBRSxJQUFJLEVBQUU7UUFDL0IsR0FBRyxFQUFFLE9BQU87S0FDYixDQUFDLENBQUM7QUFDTCxDQUFDO0FBOUZELDBCQThGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCB7IE9wdGlvbnMgfSBmcm9tICcuL29wdGlvbnMnO1xuaW1wb3J0IHsgZXhlYywgdmFsaWRhdGVPcHRpb25zIH0gZnJvbSAnLi91dGlsJztcblxuY29uc3QgY29tcGlsZXJNb2R1bGUgPSByZXF1aXJlLnJlc29sdmUoJ2pzaWkvYmluL2pzaWknKTtcblxuLyoqXG4gKiBDb21waWxlcyB0aGUgc291cmNlIGZpbGVzIGluIGB3b3JrZGlyYCB3aXRoIGpzaWkuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb21waWxlKHdvcmtkaXI6IHN0cmluZywgb3B0aW9uczogT3B0aW9ucykge1xuICB2YWxpZGF0ZU9wdGlvbnMob3B0aW9ucyk7XG5cbiAgY29uc3QgYXJncyA9IFsnLS1zaWxlbmNlLXdhcm5pbmdzJywgJ3Jlc2VydmVkLXdvcmQnXTtcbiAgY29uc3QgZW50cnlwb2ludCA9IG9wdGlvbnMuZW50cnlwb2ludCA/PyAnaW5kZXgudHMnO1xuXG4gIGlmIChwYXRoLmV4dG5hbWUoZW50cnlwb2ludCkgIT09ICcudHMnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBqc2lpIGVudHJ5cG9pbnQgbXVzdCBiZSBhIC50cyBmaWxlOiAke2VudHJ5cG9pbnR9YCk7XG4gIH1cblxuICBpZiAoIShhd2FpdCBmcy5wYXRoRXhpc3RzKHBhdGguam9pbih3b3JrZGlyLCBlbnRyeXBvaW50KSkpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGB1bmFibGUgdG8gZmluZCB0eXBlc2NyaXB0IGVudHJ5cG9pbnQ6ICR7cGF0aC5qb2luKHdvcmtkaXIsIGVudHJ5cG9pbnQpfWApO1xuICB9XG5cbiAgLy8gcGF0aCB0byBlbnRyeXBvaW50IHdpdGhvdXQgZXh0ZW5zaW9uXG4gIGNvbnN0IGJhc2VwYXRoID0gcGF0aC5qb2luKHBhdGguZGlybmFtZShlbnRyeXBvaW50KSwgcGF0aC5iYXNlbmFtZShlbnRyeXBvaW50LCAnLnRzJykpO1xuXG4gIGNvbnN0IG1vZHVsZUtleSA9IG9wdGlvbnMubW9kdWxlS2V5Py5yZXBsYWNlKC9cXC4vZywgJycpLnJlcGxhY2UoL1xcLy9nLCAnJykgPz8gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTI1NicpLnVwZGF0ZShiYXNlcGF0aCwgJ3V0ZjgnKS5kaWdlc3QoJ2hleCcpO1xuXG4gIC8vIGpzaWkgbW9kdWxlcyB0byBpbmNsdWRlXG4gIGNvbnN0IG1vZHVsZURpcnMgPSBvcHRpb25zLmRlcHMgPz8gW107XG5cbiAgY29uc3QgdGFyZ2V0czogUmVjb3JkPHN0cmluZywgYW55PiA9IHsgfTtcblxuICBjb25zdCBkZXBzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0geyB9O1xuXG4gIGZvciAoY29uc3QgZGlyIG9mIG1vZHVsZURpcnMpIHtcbiAgICAvLyByZWFkIG1vZHVsZSBtZXRhZGF0YVxuICAgIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgZnMucmVhZEpzb24ocGF0aC5qb2luKGRpciwgJ3BhY2thZ2UuanNvbicpKTtcbiAgICBjb25zdCBtb2R1bGVOYW1lOiBzdHJpbmcgPSBtZXRhZGF0YS5uYW1lO1xuICAgIGNvbnN0IG1vZHVsZVZlcnNpb246IHN0cmluZyA9IG1ldGFkYXRhLnZlcnNpb247XG5cbiAgICBjb25zdCB0YXJnZXRkaXIgPSBwYXRoLmpvaW4ocGF0aC5qb2luKHdvcmtkaXIsICdub2RlX21vZHVsZXMnKSwgbW9kdWxlTmFtZSk7XG4gICAgYXdhaXQgZnMubWtkaXJwKHBhdGguZGlybmFtZSh0YXJnZXRkaXIpKTtcbiAgICBhd2FpdCBmcy5jb3B5KGRpciwgdGFyZ2V0ZGlyKTtcblxuICAgIC8vIGFkZCB0byBcImRlcHNcIiBhbmQgXCJwZWVyIGRlcHNcIlxuICAgIGlmICghbW9kdWxlTmFtZS5zdGFydHNXaXRoKCdAdHlwZXMvJykpIHtcbiAgICAgIGRlcHNbbW9kdWxlTmFtZV0gPSBtb2R1bGVWZXJzaW9uO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHBrZyA9IHtcbiAgICBuYW1lOiBtb2R1bGVLZXksXG4gICAgdmVyc2lvbjogJzAuMC4wJyxcbiAgICBhdXRob3I6ICdnZW5lcmF0ZWRAZ2VuZXJhdGVkLmNvbScsXG4gICAgbWFpbjogYCR7YmFzZXBhdGh9LmpzYCxcbiAgICB0eXBlczogYCR7YmFzZXBhdGh9LmQudHNgLFxuICAgIGxpY2Vuc2U6ICdVTkxJQ0VOU0VEJyxcbiAgICByZXBvc2l0b3J5OiB7IHVybDogJ2h0dHA6Ly9nZW5lcmF0ZWQnLCB0eXBlOiAnZ2l0JyB9LFxuICAgIGpzaWk6IHtcbiAgICAgIG91dGRpcjogJ2Rpc3QnLFxuICAgICAgdGFyZ2V0czogdGFyZ2V0cyxcbiAgICB9LFxuICAgIGRlcGVuZGVuY2llczogZGVwcyxcbiAgICBwZWVyRGVwZW5kZW5jaWVzOiBkZXBzLFxuICB9O1xuXG4gIGlmIChvcHRpb25zLnB5dGhvbikge1xuICAgIHRhcmdldHMucHl0aG9uID0ge1xuICAgICAgZGlzdE5hbWU6ICdnZW5lcmF0ZWQnLFxuICAgICAgbW9kdWxlOiBvcHRpb25zLnB5dGhvbi5tb2R1bGVOYW1lLFxuICAgIH07XG4gIH1cblxuICBpZiAob3B0aW9ucy5qYXZhKSB7XG4gICAgdGFyZ2V0cy5qYXZhID0ge1xuICAgICAgcGFja2FnZTogb3B0aW9ucy5qYXZhLnBhY2thZ2UsXG4gICAgICBtYXZlbjoge1xuICAgICAgICBncm91cElkOiAnZ2VuZXJhdGVkJyxcbiAgICAgICAgYXJ0aWZhY3RJZDogJ2dlbmVyYXRlZCcsXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBpZiAob3B0aW9ucy5jc2hhcnApIHtcbiAgICB0YXJnZXRzLmRvdG5ldCA9IHtcbiAgICAgIG5hbWVzcGFjZTogb3B0aW9ucy5jc2hhcnAubmFtZXNwYWNlLFxuICAgICAgcGFja2FnZUlkOiBvcHRpb25zLmNzaGFycC5uYW1lc3BhY2UsXG4gICAgfTtcbiAgfVxuXG4gIGlmIChvcHRpb25zLmdvbGFuZykge1xuICAgIHRhcmdldHMuZ28gPSB7XG4gICAgICBtb2R1bGVOYW1lOiBvcHRpb25zLmdvbGFuZy5tb2R1bGVOYW1lLFxuICAgICAgcGFja2FnZU5hbWU6IG9wdGlvbnMuZ29sYW5nLnBhY2thZ2VOYW1lLFxuICAgIH07XG4gIH1cblxuICBhd2FpdCBmcy53cml0ZUZpbGUocGF0aC5qb2luKHdvcmtkaXIsICdwYWNrYWdlLmpzb24nKSwgSlNPTi5zdHJpbmdpZnkocGtnLCB1bmRlZmluZWQsIDIpKTtcblxuICBhd2FpdCBleGVjKGNvbXBpbGVyTW9kdWxlLCBhcmdzLCB7XG4gICAgY3dkOiB3b3JrZGlyLFxuICB9KTtcbn1cbiJdfQ==